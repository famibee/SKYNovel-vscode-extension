var L=Object.create;var P=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var X=(e,s)=>{for(var a in s)P(e,a,{get:s[a],enumerable:!0})},N=(e,s,a,u)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of C(s))!D.call(e,t)&&t!==a&&P(e,t,{get:()=>s[t],enumerable:!(u=q(s,t))||u.enumerable});return e};var U=(e,s,a)=>(a=e!=null?L(M(e)):{},N(s||!e||!e.__esModule?P(a,"default",{value:e,enumerable:!0}):a,e)),V=e=>N(P({},"__esModule",{value:!0}),e);var Z={};X(Z,{chkUpdate:()=>B});module.exports=V(Z);var r=require("node:path"),k=require("node:util"),n=require("fs-extra"),J=U(require("p-queue"));const[,,$,A,b,l=""]=process.argv,F=require("sharp");F.cache(!1);const H=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function p(e,s,a){for(const u of(0,n.readdirSync)(e,{withFileTypes:!0})){const t=String(u.name).normalize("NFC");if(H.test(t))continue;if(u.isDirectory()){a(t);continue}const i=(0,r.resolve)(e,t);s(i,t)}}function g(e,s,a,u=!0,t=e){try{if(!(0,n.existsSync)(e)){console.error(`No change, No replace src:${e}`);return}const i=(0,n.readFileSync)(e,{encoding:"utf8"}),c=String(i.replace(s,a));i!==c?(0,n.writeFileSync)(t,c):u&&console.log((0,k.styleText)("magentaBright",`replaceFile fail by same:${e}`))}catch(i){console.error(`replaceFile src:${e} ${i}`)}}function B(e,s,a=!0){return(0,n.existsSync)(e)||console.error(`chkUpdate err path1=${e}=`),(0,n.existsSync)(s)?(0,n.statSync)(e,{bigint:!0}).mtimeNs>(0,n.statSync)(s,{bigint:!0}).mtimeNs:a}const E=/\.(jpe?g|png)$/,O=/\.(htm|html)$/,R=/\w+\/\*WEBP\*\//g,v=/\.json$/,I=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,j='$1$2.webp","image_bkup":"$2.$3"',Q=/webp","image_bkup":".+(jpe?g|png)"/,Y='$1"',x=__filename+"on";let o={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const T=()=>{if(!(0,n.existsSync)(x))return;const e={...o};o=(0,n.readJsonSync)(x,{encoding:"utf8"}),e.sum={...o.sum};for(const s in o.hSize){const{fld_nm:a,ext:u,baseSize:t,webpSize:i}=o.hSize[s],c=a+"."+u;(0,n.existsSync)((0,r.resolve)(b,c))||(0,n.existsSync)((0,r.resolve)(l,c))?e.hSize[s]=o.hSize[s]:(e.sum.baseSize-=t,e.sum.webpSize-=i)}o=e},K=(e=-1)=>{const s=Object.entries(o.hSize);s.sort((a,u)=>{const t=a[0],i=u[0];return t<i?-1:t>i?1:0}),o.hSize=Object.fromEntries(s),(0,n.writeJsonSync)(x,o,{encoding:"utf8"}),e>-1&&process.exit(e)},S=new J.default({concurrency:50,autoStart:!1});let G=0;const w=async()=>{G=S.size,console.log((0,k.styleText)(["bgGreen","black"],`fn:cnv_mat_pic.ts start: ${G} tasks`)),S.start(),await S.onIdle(),K(0)};let z=()=>{const e=S.size;if(!(e%50>0)){if(e===0){z=()=>{};return}console.log((0,k.styleText)(["bgGreen","black"],`fn:cnv_mat_pic.ts ${e}/${G} tasks`))}};function h(e,s,a=!0){S.add(async()=>{a&&await(0,n.move)(e,s,{overwrite:!0});const{dir:u,name:t}=(0,r.parse)(e),{dir:i,ext:c}=(0,r.parse)(s),f=i+"/"+t+".webp",m=o.hSize[t]??={fld_nm:(0,r.basename)(u)+"/"+t,baseSize:0,webpSize:0,ext:""},_=await F(s).webp({quality:Number(m.webp_q??A)}).toFile(f);await(0,n.move)(f,u+"/"+t+".webp",{overwrite:!0});const d=(0,n.statSync)(s).size,y=_.size;o.hSize[t]={...m,baseSize:d,webpSize:y,ext:c.slice(1)},o.sum.baseSize+=d,o.sum.webpSize+=y,z()})}switch($){case"enable":(0,n.ensureDir)(l),p(b,()=>{},t=>{const i=(0,r.resolve)(l,t);(0,n.ensureDir)(i),p((0,r.resolve)(b,t),(c,f)=>{if(E.test(f)){h(c,(0,r.resolve)(i,f));return}if(O.test(f)){S.add(()=>{g(c,R,"true/*WEBP*/",!1),z()});return}v.test(f)&&S.add(()=>{g(c,I,j),z()})},()=>{})}),w();break;case"disable":p(l,()=>{},t=>{p((0,r.resolve)(l,t),(i,c)=>{if(!E.test(c))return;const f=(0,r.resolve)(b,t,c);S.add(async()=>{await(0,n.move)(i,f,{overwrite:!0}),z()});const{name:m}=(0,r.parse)(c),_=(0,r.resolve)(b,t,m+".webp");S.add(async()=>{await(0,n.remove)(_),z()})},()=>{})}),p(b,()=>{},t=>{p((0,r.resolve)(b,t),(i,c)=>{if(O.test(c)){R.lastIndex=0,S.add(()=>{g(i,R,"false/*WEBP*/",!1),z()});return}v.test(c)&&S.add(()=>{g(i,Q,Y),z()})},()=>{})}),w();break;case"reconv":T(),o.sum.baseSize=o.sum.webpSize=0;for(const{ext:t,fld_nm:i}of Object.values(o.hSize))h((0,r.resolve)(b,i+"."+t),(0,r.resolve)(l,i+"."+t),!1);w();break;case"prj_scan":T(),(0,n.ensureDir)(l),p(b,()=>{},t=>{const i=(0,r.resolve)(l,t);(0,n.ensureDir)(i),p((0,r.resolve)(b,t),(c,f)=>{if(E.test(f)){const m=(0,r.parse)(f).name;if(m in o.hSize){const{baseSize:_=0,webpSize:d=0}=o.hSize[m];o.sum.baseSize-=_,o.sum.webpSize-=d}h(c,(0,r.resolve)(i,f));return}if(O.test(f)){S.add(()=>{g(c,R,"true/*WEBP*/",!1),z()});return}v.test(f)&&S.add(()=>{g(c,I,j),z()})},()=>{})}),w();break;case"base_scan":T(),p(l,()=>{},t=>{const i=(0,r.resolve)(l,t);(0,n.ensureDir)(i);const c=(0,r.resolve)(b,t);p(i,(f,m)=>{if(!E.test(f))return;const _=(0,r.resolve)(c,m.replace(E,".webp"));if(!B(f,_))return;const d=(0,r.parse)(m).name;if(d in o.hSize){const{baseSize:y=0,webpSize:W=0}=o.hSize[d];o.sum.baseSize-=y,o.sum.webpSize-=W}h(_,f,!1)},()=>{})}),w();break;default:T();const{dir:e,name:s,ext:a}=(0,r.parse)($),u={...o.hSize[s],fld_nm:(0,r.basename)(e)+"/"+s,ext:a.slice(1)};o.sum.baseSize-=u.baseSize,o.sum.webpSize-=u.webpSize,h($,b,!!l),w();break}
