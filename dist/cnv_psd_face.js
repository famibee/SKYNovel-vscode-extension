const[,,h="",b]=process.argv;import E from"psd.js";import y from"sharp";y.cache(!1);import{mkdtempSync as F}from"node:fs";import{ensureFileSync as R,remove as x,outputFile as A}from"fs-extra/esm";import{basename as L,extname as T}from"node:path";import{styleText as u}from"node:util";import{fileURLToPath as v}from"node:url";const w=v(import.meta.url),k=import.meta.dirname,C=w.slice(k.length+1,-3),P=F(`/tmp/${C}-`);function G(c){return L(c,T(c))}function N(c,{name:d,left:e,top:o,width:i,height:n,layer:a},g,m,r,p){const t=c+"_"+d.replaceAll(O,"#"),s=`${b}face/${t}.png`,f=a.blendingMode(),l=`${g?";":""}	[add_face name=${t} dx=${e} dy=${o}${f==="normal"?"":` blendmode=${f}`}]
`;if(!g){const S=async()=>{console.log(u(["blueBright"],`fn:cnv_psd_face.ts f canvas(${r},${p}) layer(${String(e).padStart(4)}, ${String(o).padStart(4)}, ${String(i).padStart(4)}, ${String(n).padStart(4)}) name:${t}:`)),await a.image.saveAsPng(s)};return m.push(S()),l}const $=`${P}/${t}.png`,D=async()=>{console.log(u(["blueBright"],`fn:cnv_psd_face.ts b canvas(${r},${p}) layer(${String(e).padStart(4)}, ${String(o).padStart(4)}, ${String(i).padStart(4)}, ${String(n).padStart(4)}) name:${t}:`));try{await a.image.saveAsPng($),await y($).extend({left:e,right:r-e-i,top:o,bottom:p-o-n,background:{r:0,g:0,b:0,alpha:0}}).toFile(s)}catch(S){console.log(u(["bgRed","white"],"  [ERR] %o"),S)}};return m.push(D()),l}const O=/[\\\/:*?"<>|\.\s]/g,_=[];E.open(h).then(c=>{const d=c.tree(),{document:{width:e,height:o}}=d.export(),i=G(h);let n=`;#ED FACE
; *******************************************************
;#ED {"width":${e}, "height":${o}}
`;const a=d.descendants(),g=a.length;let m=g;for(;0<=--m;){const{type:t,parent:s}=a[m];if(t==="group"||s.isRoot())break}let r="";for(let t=0;t<g;++t){const s=a[t],{type:f,name:l,parent:$}=s;if(f==="group"){n+=`;#ED FACE_FOLDER ${l}
`,r="_"+l;continue}$.isRoot()&&(r!==""&&(n+=`;#ED FACE_FOLDER /
`),r=""),n+=N(i+r,s,m<=t,_,e,o)}n+=`
; *******************************************************

[return]
`;const p=b+`face/face${i}.sn`;R(p),_.push(A(p,n,"utf8")),Promise.allSettled(_).then(async()=>{await x(P),console.log(u(["bgGreen","black"],"fn:cnv_psd_face.ts ok.")),process.exit(0)})});
