exports.id = "node_modules_fluent-ffmpeg_lib_options_sync_recursive-node_modules_npm-check-updates_build_sy-5d0518";
exports.ids = ["node_modules_fluent-ffmpeg_lib_options_sync_recursive-node_modules_npm-check-updates_build_sy-5d0518"];
exports.modules = {

/***/ "./node_modules/fluent-ffmpeg/lib/options sync recursive":
/*!******************************************************!*\
  !*** ./node_modules/fluent-ffmpeg/lib/options/ sync ***!
  \******************************************************/
/***/ ((module) => {

function webpackEmptyContext(req) {
	var e = new Error("Cannot find module '" + req + "'");
	e.code = 'MODULE_NOT_FOUND';
	throw e;
}
webpackEmptyContext.keys = () => ([]);
webpackEmptyContext.resolve = webpackEmptyContext;
webpackEmptyContext.id = "./node_modules/fluent-ffmpeg/lib/options sync recursive";
module.exports = webpackEmptyContext;

/***/ }),

/***/ "./node_modules/npm-check-updates/build sync recursive":
/*!****************************************************!*\
  !*** ./node_modules/npm-check-updates/build/ sync ***!
  \****************************************************/
/***/ ((module) => {

function webpackEmptyContext(req) {
	var e = new Error("Cannot find module '" + req + "'");
	e.code = 'MODULE_NOT_FOUND';
	throw e;
}
webpackEmptyContext.keys = () => ([]);
webpackEmptyContext.resolve = webpackEmptyContext;
webpackEmptyContext.id = "./node_modules/npm-check-updates/build sync recursive";
module.exports = webpackEmptyContext;

/***/ }),

/***/ "./node_modules/vscode-languageserver-types/lib/umd sync recursive":
/*!****************************************************************!*\
  !*** ./node_modules/vscode-languageserver-types/lib/umd/ sync ***!
  \****************************************************************/
/***/ ((module) => {

function webpackEmptyContext(req) {
	var e = new Error("Cannot find module '" + req + "'");
	e.code = 'MODULE_NOT_FOUND';
	throw e;
}
webpackEmptyContext.keys = () => ([]);
webpackEmptyContext.resolve = webpackEmptyContext;
webpackEmptyContext.id = "./node_modules/vscode-languageserver-types/lib/umd sync recursive";
module.exports = webpackEmptyContext;

/***/ }),

/***/ "./src/AnalyzeTagArg.ts":
/*!******************************!*\
  !*** ./src/AnalyzeTagArg.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnalyzeTagArg: () => (/* binding */ AnalyzeTagArg),
/* harmony export */   idx2LnCol: () => (/* binding */ idx2LnCol)
/* harmony export */ });
function idx2LnCol(sSn, idx, lenNm = 0, ln = 0, ch = 0) {
    const sBefore = sSn.slice(0, idx);
    const a = sBefore.split('\n');
    const len = a.length;
    return {
        ln: ln + len - 1,
        ch: len < 2 ? ch + 1 + lenNm + idx : a.at(-1)?.length ?? 0,
    };
}
class AnalyzeTagArg {
    #REG_TAGARG = /;[^\n]*|(?<key>[^\s="'#|;]+)(?:\s|;[^\n]*\n)*=(?:\s|;[^\n]*\n)*(?:(?<val>[^\s"'#|;]+)|(["'#])(?<val2>.*?)\3)(?:\|(?:(?<def>[^\s"'#;]+)|(["'#])(?<def2>.*?)\6))?|(?<literal>[^\s;]+)/g;
    parse(args) {
        this.#hPrm = {};
        this.#isKomeParam = false;
        for (const { groups } of args.matchAll(this.#REG_TAGARG)) {
            const { key, val, val2, def, def2, literal } = groups;
            if (key)
                this.#hPrm[key] = {
                    val: val ?? val2 ?? '',
                    def: def ?? def2
                };
            else if (literal) {
                if (literal === '*')
                    this.#isKomeParam = true;
                else
                    this.#hPrm[literal] = { val: '1' };
            }
        }
    }
    parseinDetail(token, lenNm, ln, ch) {
        const hRng = {};
        const sSn = token.slice(1 + lenNm, -1);
        for (const { groups, index, 0: z } of sSn.matchAll(this.#REG_TAGARG)) {
            if (!index)
                continue;
            const { key, val, val2 = '', literal } = groups;
            if (literal) {
                if (literal.endsWith('=')) {
                    const lenVnm = literal.length - 1;
                    const { ch: k_ch } = idx2LnCol(sSn, index + lenVnm, lenNm, ln, ch);
                    hRng[literal.slice(0, -1)] = {
                        k_ln: ln,
                        k_ch: k_ch - lenVnm,
                        v_ln: ln,
                        v_ch: k_ch + 1,
                        v_len: 0,
                    };
                }
                continue;
            }
            if (!key)
                continue;
            const { ln: k_ln, ch: k_ch } = idx2LnCol(sSn, index, lenNm, ln, ch);
            const { ln: v_ln, ch: v_ch } = idx2LnCol(sSn, index + z.lastIndexOf(val ?? val2) - (val ? 0 : 1), lenNm, ln, ch);
            hRng[key] = { k_ln, k_ch, v_ln, v_ch, v_len: val ? val.length : val2.length + 2 };
        }
        return hRng;
    }
    #hPrm = {};
    get hPrm() { return this.#hPrm; }
    #isKomeParam = false;
    get isKomeParam() { return this.#isKomeParam; }
}


/***/ }),

/***/ "./src/Config.ts":
/*!***********************!*\
  !*** ./src/Config.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   Config: () => (/* binding */ Config),
/* harmony export */   SysExtension: () => (/* binding */ SysExtension)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _ConfigBase__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./ConfigBase */ "./src/ConfigBase.ts");
/* harmony import */ var image_size_fromFile__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! image-size/fromFile */ "./node_modules/image-size/dist/fromFile.mjs");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:fs/promises */ "node:fs/promises");
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_fs_promises__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_6__);







class SysExtension {
    arg;
    constructor(arg) {
        this.arg = arg;
    }
    async loadPath(hPathFn2Exts, _cfg) {
        const fn = this.arg.cur + 'path.json';
        const oJs = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.readJson)(fn, { encoding: 'utf8' });
        for (const [nm, v] of Object.entries(oJs)) {
            const h = hPathFn2Exts[nm] = v;
            for (const [ext, w] of Object.entries(h)) {
                if (ext !== ':cnt')
                    h[ext] = this.arg.cur + w;
            }
        }
    }
    dec = (_ext, d) => Promise.resolve(d);
    decAB = (ab) => Promise.resolve(ab);
    set crypto(v) { this.arg.crypto = v; }
    fetch = async (url) => new Response(await (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.readJson)(url, { encoding: 'utf8' }));
    hash;
    $path_downloads = '';
    get path_downloads() { return this.$path_downloads; }
    $path_userdata = '';
    get path_userdata() { return this.$path_userdata; }
}
class Config extends _ConfigBase__WEBPACK_IMPORTED_MODULE_1__.ConfigBase {
    sys;
    encry;
    constructor(sys, encry) {
        super(sys);
        this.sys = sys;
        this.encry = encry;
    }
    setCryptoMode(v) { this.sys.crypto = v; }
    async loadEx(encFile, haDiagFn) {
        const fpPrj = this.sys.arg.cur + 'prj.json';
        const fpPath = this.sys.arg.cur + 'path.json';
        try {
            const o = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.readJson)(fpPrj, { encoding: 'utf8' });
            const d = (0,_ConfigBase__WEBPACK_IMPORTED_MODULE_1__.creCfg)();
            await super.load({
                ...d,
                ...o,
                book: { ...d.book, ...o.book },
                window: { ...d.window, ...o.window },
                log: { ...d.log, ...o.log },
                init: { ...d.init, ...o.init },
                debug: { ...d.debug, ...o.debug },
                code: { ...d.code, ...o.code },
            });
            this.hPathFn2Exts = await this.#get_hPathFn2Exts(this.sys.arg.cur, haDiagFn);
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.outputJson)(fpPath, this.hPathFn2Exts);
            if (this.sys.crypto)
                await encFile(vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(fpPath));
        }
        catch (e) {
            console.error(`Project loadPrjJs ${e} fpPrj=${fpPrj}= fpPath=${fpPath}=`);
        }
    }
    #REG_NEEDHASH = /\.(js|css)$/;
    #REG_SPRSHEETIMG = /^(.+)\.(\d+)x(\d+)\.(png|jpe?g)$/;
    async #get_hPathFn2Exts($cur, haDiagFn) {
        const hFn2Path = {};
        const aDo = [];
        const { mes, sev } = _CmnLib__WEBPACK_IMPORTED_MODULE_0__.hDiagL2s.ファイル名合成文字;
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)($cur, () => { }, dir => {
            const wd = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)($cur, dir);
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)(wd, (fp, nm) => {
                const aD = [];
                this.#addPath(hFn2Path, dir, nm, aD);
                if (nm.normalize('NFC').length !== nm.normalize('NFD').length)
                    aD.push({ mes, sev });
                if (aD.length > 0)
                    haDiagFn[fp] = aD;
                const a2 = nm.match(this.#REG_NEEDHASH);
                if (a2) {
                    const snm = nm.slice(0, -a2[0].length);
                    const p = hFn2Path[snm];
                    if (p) {
                        aDo.push((async () => {
                            const s = await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_5__.readFile)(fp, { encoding: 'utf8' });
                            p[a2[1] + ':id'] = 'u5:' + this.encry.uuidv5(s);
                        })());
                    }
                }
                const a = nm.match(this.#REG_SPRSHEETIMG);
                if (!a)
                    return;
                const [, basename = '', axLen = '', ayLen = '',] = a;
                const fnJs = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(wd, basename + '.json');
                if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.existsSync)(fnJs))
                    return;
                aDo.push((async () => {
                    const { width, height } = await (0,image_size_fromFile__WEBPACK_IMPORTED_MODULE_2__.imageSizeFromFile)(fp);
                    const xLen = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(axLen);
                    const yLen = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(ayLen);
                    const w = width / xLen;
                    const h = height / yLen;
                    const ext = a[4];
                    const oJs = {
                        frames: {},
                        meta: {
                            app: 'skynovel',
                            version: '1.0',
                            image: a[0],
                            format: 'RGBA8888',
                            size: { w: width, h: height },
                            scale: 1,
                            animationSpeed: 1,
                        },
                    };
                    let cnt = 0;
                    for (let ix = 0; ix < xLen; ++ix) {
                        for (let iy = 0; iy < yLen; ++iy) {
                            oJs.frames[basename + String(++cnt).padStart(4, '0') + '.' + ext] = {
                                frame: { x: ix * w, y: iy * h, w, h },
                                rotated: false,
                                trimmed: false,
                                spriteSourceSize: { x: 0, y: 0, w: width, h: height },
                                sourceSize: { w, h },
                                pivot: { x: 0.5, y: 0.5 },
                            };
                        }
                    }
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.writeJson)(fnJs, oJs);
                    vscode__WEBPACK_IMPORTED_MODULE_3__.window.showInformationMessage(`[SKYNovel] ${nm} からスプライトシート用 ${basename}.json を自動生成しました`);
                    this.#addPath(hFn2Path, dir, `${basename}.json`, aD);
                    if (aD.length > 0)
                        haDiagFn[fp] = aD;
                })());
            }, () => { });
        });
        await Promise.allSettled(aDo);
        return hFn2Path;
    }
    #addPath(hFn2Path, dir, nm, aD) {
        const { name: fn, base, ext } = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.parse)(nm);
        const ext2 = ext.slice(1);
        let hExts = hFn2Path[fn];
        if (!hExts)
            hExts = hFn2Path[fn] = { ':cnt': 0 };
        else if (ext2 in hExts) {
            const { mes, sev } = _CmnLib__WEBPACK_IMPORTED_MODULE_0__.hDiagL2s.ファイル重複;
            aD.push({ mes: mes.replace('$', base), sev });
            return;
        }
        hExts[':cnt'] = ((0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(hExts[':cnt']) + 1);
        hExts[ext2] = dir + '/' + nm;
    }
}


/***/ }),

/***/ "./src/ConfigBase.ts":
/*!***************************!*\
  !*** ./src/ConfigBase.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ConfigBase: () => (/* binding */ ConfigBase),
/* harmony export */   SEARCH_PATH_ARG_EXT: () => (/* binding */ SEARCH_PATH_ARG_EXT),
/* harmony export */   creCfg: () => (/* binding */ creCfg)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");

var SEARCH_PATH_ARG_EXT;
(function (SEARCH_PATH_ARG_EXT) {
    SEARCH_PATH_ARG_EXT["DEFAULT"] = "";
    SEARCH_PATH_ARG_EXT["SP_GSM"] = "png|jpg|jpeg|json|svg|webp|mp4|webm";
    SEARCH_PATH_ARG_EXT["SCRIPT"] = "sn|ssn";
    SEARCH_PATH_ARG_EXT["FONT"] = "woff2|woff|otf|ttf";
    SEARCH_PATH_ARG_EXT["SOUND"] = "mp3|m4a|ogg|aac|flac|wav";
    SEARCH_PATH_ARG_EXT["HTML"] = "htm|html";
    SEARCH_PATH_ARG_EXT["CSS"] = "css";
    SEARCH_PATH_ARG_EXT["SN"] = "sn";
    SEARCH_PATH_ARG_EXT["TST_PNGPNG_"] = "png|png_";
    SEARCH_PATH_ARG_EXT["TST_HH"] = "hh";
    SEARCH_PATH_ARG_EXT["TST_EEE"] = "eee";
    SEARCH_PATH_ARG_EXT["TST_GGG"] = "ggg";
    SEARCH_PATH_ARG_EXT["TST_PNGXML"] = "png|xml";
})(SEARCH_PATH_ARG_EXT || (SEARCH_PATH_ARG_EXT = {}));
function creCfg() {
    return {
        save_ns: '',
        window: {
            width: 300,
            height: 300,
        },
        book: {
            title: '',
            creator: '',
            cre_url: '',
            publisher: '',
            pub_url: '',
            detail: '',
            version: '1.0',
        },
        log: { max_len: 64 },
        init: {
            bg_color: '#000000',
            tagch_msecwait: 10,
            auto_msecpagewait: 3500,
            escape: '',
        },
        debug: {
            devtool: false,
            dumpHtm: false,
            token: false,
            tag: false,
            putCh: false,
            debugLog: false,
            baseTx: false,
            masume: false,
            variable: false,
        },
        code: {},
        debuger_token: '',
    };
}
class ConfigBase {
    sys;
    oCfg = creCfg();
    userFnTail = '';
    hPathFn2Exts = {};
    constructor(sys) {
        this.sys = sys;
    }
    async load(oCfg) {
        this.oCfg.save_ns = oCfg.save_ns || this.oCfg.save_ns;
        this.oCfg.window.width = oCfg.window.width || this.oCfg.window.width;
        this.oCfg.window.height = oCfg.window.height || this.oCfg.window.height;
        this.oCfg.book = { ...this.oCfg.book, ...oCfg.book };
        this.oCfg.log.max_len = oCfg.log.max_len || this.oCfg.log.max_len;
        this.oCfg.init = { ...this.oCfg.init, ...oCfg.init };
        this.oCfg.debug = { ...this.oCfg.debug, ...oCfg.debug };
        this.oCfg.debuger_token = oCfg.debuger_token;
        await this.sys.loadPath(this.hPathFn2Exts, this);
        this.#existsBreakline = this.matchPath('^breakline$', SEARCH_PATH_ARG_EXT.SP_GSM).length > 0;
        this.#existsBreakpage = this.matchPath('^breakpage$', SEARCH_PATH_ARG_EXT.SP_GSM).length > 0;
        const hFn2Ext = {};
        if (!this.sys.arg.crypto) {
            for (const [fn0, hExts] of Object.entries(this.hPathFn2Exts)) {
                for (const ext of Object.keys(hExts)) {
                    if (ext.startsWith(':'))
                        continue;
                    hFn2Ext[fn0] = ext;
                }
            }
        }
        else
            for (const [fn0, hExts] of Object.entries(this.hPathFn2Exts)) {
                for (const [ext, pp] of Object.entries(hExts)) {
                    if (!ext.startsWith(':')) {
                        hFn2Ext[fn0] = ext;
                        continue;
                    }
                    if (!ext.endsWith(':id'))
                        continue;
                    const hp = pp.slice(pp.lastIndexOf('/') + 1);
                    const fn = hExts[ext.slice(0, -10)] ?? '';
                    const res = await this.sys.fetch(fn);
                    const src = await res.text();
                    const hf = this.sys.hash(src);
                    if (hp !== hf)
                        throw `ファイル改竄エラーです fn:${fn}`;
                }
            }
    }
    #existsBreakline = false;
    get existsBreakline() { return this.#existsBreakline; }
    #existsBreakpage = false;
    get existsBreakpage() { return this.#existsBreakpage; }
    getNs() { return `skynovel.${this.oCfg.save_ns} - `; }
    #REG_PATH = /([^/\s]+)\.([^\d]\w+)/;
    searchPath(fn, extptn = SEARCH_PATH_ARG_EXT.DEFAULT) {
        if (!fn)
            throw '[searchPath] fnが空です';
        if (fn.startsWith('http://'))
            return fn;
        const a = fn.match(this.#REG_PATH);
        let fn0 = a ? a[1] ?? '' : fn;
        const ext = a ? a[2] : '';
        if (this.userFnTail) {
            const utn = fn0 + '@@' + this.userFnTail;
            if (utn in this.hPathFn2Exts) {
                if (extptn === SEARCH_PATH_ARG_EXT.DEFAULT)
                    fn0 = utn;
                else
                    for (const e3 of Object.keys(this.hPathFn2Exts[utn] ?? {})) {
                        if (!`|${extptn}|`.includes(`|${e3}|`))
                            continue;
                        fn0 = utn;
                        break;
                    }
            }
        }
        const h_exts = this.hPathFn2Exts[fn0];
        if (!h_exts)
            throw `サーチパスに存在しないファイル【${fn}】です`;
        if (!ext) {
            const hcnt = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.int)(h_exts[':cnt']);
            if (extptn === SEARCH_PATH_ARG_EXT.DEFAULT) {
                if (hcnt > 1)
                    throw `指定ファイル【${fn}】が複数マッチします。サーチ対象拡張子群【${extptn}】で絞り込むか、ファイル名を個別にして下さい。`;
                return fn;
            }
            const search_exts = `|${extptn}|`;
            if (hcnt > 1) {
                let cnt = 0;
                for (const e2 of Object.keys(h_exts)) {
                    if (!search_exts.includes(`|${e2}|`))
                        continue;
                    if (++cnt > 1)
                        throw `指定ファイル【${fn}】が複数マッチします。サーチ対象拡張子群【${extptn}】で絞り込むか、ファイル名を個別にして下さい。`;
                }
            }
            for (const [ext, pp] of Object.entries(h_exts)) {
                if (search_exts.includes(`|${ext}|`))
                    return pp;
            }
            throw `サーチ対象拡張子群【${extptn}】にマッチするファイルがサーチパスに存在しません。探索ファイル名=【${fn}】`;
        }
        if (extptn !== SEARCH_PATH_ARG_EXT.DEFAULT && !`|${extptn}|`.includes(`|${ext}|`)) {
            throw `指定ファイルの拡張子【${ext}】は、サーチ対象拡張子群【${extptn}】にマッチしません。探索ファイル名=【${fn}】`;
        }
        const ret = h_exts[ext];
        if (!ret)
            throw `サーチパスに存在しない拡張子【${ext}】です。探索ファイル名=【${fn}】、サーチ対象拡張子群【${extptn}】`;
        return ret;
    }
    matchPath(fnptn, extptn = SEARCH_PATH_ARG_EXT.DEFAULT) {
        const aRet = [];
        const regPtn = new RegExp(fnptn);
        const regExt = new RegExp(extptn);
        for (const [fn, h_exts] of Object.entries(this.hPathFn2Exts)) {
            if (fn.search(regPtn) === -1)
                continue;
            if (extptn === SEARCH_PATH_ARG_EXT.DEFAULT) {
                aRet.push(h_exts);
                continue;
            }
            const o = {};
            let isa = false;
            for (const ext of Object.keys(h_exts)) {
                if (ext.search(regExt) === -1)
                    continue;
                o[ext] = fn;
                isa = true;
            }
            if (isa)
                aRet.push(o);
        }
        return aRet;
    }
    addPath(fn, h_exts) {
        const o = {};
        for (const [ext, v] of Object.entries(h_exts)) {
            o[ext] = (ext.startsWith(':') ? '' : this.sys.arg.cur) + String(v);
        }
        this.hPathFn2Exts[fn] = o;
    }
}


/***/ }),

/***/ "./src/CteScore.ts":
/*!*************************!*\
  !*** ./src/CteScore.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CteScore: () => (/* binding */ CteScore)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _AnalyzeTagArg__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./AnalyzeTagArg */ "./src/AnalyzeTagArg.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_4__);





class CteScore {
    curPrj;
    static #uriRes;
    static #htmBaseSrc = '';
    static init(ctx) {
        vscode__WEBPACK_IMPORTED_MODULE_3__.window.registerCustomEditorProvider('SKYNovel.score', {
            resolveCustomTextEditor(doc, webviewPanel, _token) {
                const path = doc.fileName;
                for (const [cur, v] of Object.entries(CteScore.#hCur2Me)) {
                    if (!path.startsWith(cur))
                        continue;
                    v.#resolveCustomTextEditor(doc, webviewPanel);
                    break;
                }
            }
        });
        const path_ext_htm = ctx.extensionPath + '/views/';
        CteScore.#uriRes = vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(path_ext_htm);
        CteScore.#htmBaseSrc =
            (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.readFileSync)(path_ext_htm + 'score.htm', { encoding: 'utf8' })
                .replace('<meta_autooff ', '<meta ')
                .replace(/\$\{nonce}/g, (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.getNonce)())
                .replace(/<tbody>[\s\S]+<\/tbody>/, '<tbody/>')
                .replace(/(<div class="card-group">)[\s\S]+(<\/div><!-- card-group -->)/, '$1 $2');
    }
    static #hCur2Me = {};
    constructor(curPrj) {
        this.curPrj = curPrj;
        CteScore.#hCur2Me[curPrj] = this;
    }
    #hPath2Tokens = {};
    updScore(path, curPrj, aToken) {
        const s = { line: 1 };
        this.#hPath2Tokens[path] = {
            uriPrj: vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.parse(curPrj),
            htm: CteScore.#htmBaseSrc.replace('<tbody/>', `<tbody>${aToken.map((token, i) => this.#token2html(s, token, i)).join('')}</tbody>`),
            skipupd: false,
        };
        const wv = this.#hPath2Wv[path];
        if (wv)
            wv.html = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.repWvUri)(this.#hPath2Tokens[path].htm, wv, CteScore.#uriRes);
    }
    add_lay(_o) {
    }
    isSkipUpd(path) {
        const t = this.#hPath2Tokens[path];
        if (t?.skipupd) {
            t.skipupd = false;
            return true;
        }
        return false;
    }
    separation(path) {
        this.#hPath2Wv[path]?.postMessage({ cmd: 'separation' });
    }
    combining(path) {
        this.#hPath2Wv[path]?.postMessage({ cmd: 'combining' });
    }
    updLine(doc, rng, txt, aToken) {
        const wv = this.#hPath2Wv[doc.fileName];
        if (!wv)
            return false;
        const sl = rng.start.line;
        const el = rng.end.line;
        if ((rng.start.character > 0 ||
            rng.end.character > 0) && sl !== el)
            return true;
        if (txt === '') {
            wv.postMessage({ cmd: 'del', ln: sl });
            return false;
        }
        wv.postMessage({
            cmd: sl === el && txt.at(-1) === '\n' ? 'ins' : 'rep',
            ln: sl,
            htm: (txt === '\n'
                ? this.#token2html({ line: sl + 1 }, '\n\n', -1)
                : (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.repWvUri)(aToken.map(t => t.charCodeAt(0) < 11
                    ? ''
                    : this.#token2html({ line: sl + 1 }, t, 0)).join(''), wv, CteScore.#uriRes))
                .replace(/<tr .+>|<\/tr>/g, ''),
        });
        return false;
    }
    #hPath2Wv = {};
    static analyzTagArg = (token) => CteScore.REG_TAG.exec(token);
    static REG_TAG = /\[(?<name>[^\s;\]]+)\s*(?<args>(?:[^"'#\]]+|(["'#]).*?\3)*?)]/;
    #resolveCustomTextEditor(doc, webviewPanel) {
        const path = doc.fileName;
        const t = this.#hPath2Tokens[path];
        if (!t)
            throw `resolveCustomTextEditor err path=${path}`;
        const wv = this.#hPath2Wv[path] = webviewPanel.webview;
        wv.options = {
            enableScripts: true,
            localResourceRoots: [CteScore.#uriRes, t.uriPrj],
        };
        wv.onDidReceiveMessage((o) => {
            switch (o.cmd) {
                case 'info':
                    vscode__WEBPACK_IMPORTED_MODULE_3__.window.showInformationMessage(o.text);
                    break;
                case 'warn':
                    vscode__WEBPACK_IMPORTED_MODULE_3__.window.showWarningMessage(o.text);
                    break;
                case 'err':
                    vscode__WEBPACK_IMPORTED_MODULE_3__.window.showErrorMessage(o.text);
                    break;
                case 'loaded':
                    this.#updWv_db(path);
                    this.combining(path);
                    break;
                case 'save_tbody':
                    t.htm = wv.html
                        .replace(/<tbody>[\s\S]+<\/tbody>/, `<tbody>${o.tbody}</tbody>`);
                    break;
                case 'move':
                    {
                        const { from, to } = o;
                        if (from === to)
                            break;
                        t.skipupd = true;
                        const ed = new vscode__WEBPACK_IMPORTED_MODULE_3__.WorkspaceEdit;
                        const rng_from = new vscode__WEBPACK_IMPORTED_MODULE_3__.Range(from, 0, from + 1, 0);
                        const ins = doc.getText(rng_from);
                        if (from > to) {
                            ed.delete(doc.uri, rng_from);
                            ed.insert(doc.uri, new vscode__WEBPACK_IMPORTED_MODULE_3__.Position(to, 0), ins);
                        }
                        else {
                            ed.insert(doc.uri, new vscode__WEBPACK_IMPORTED_MODULE_3__.Position(to + 1, 0), ins);
                            ed.delete(doc.uri, rng_from);
                        }
                        vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.applyEdit(ed);
                    }
                    break;
                case 'tool_put':
                    {
                        const scr = o.scr
                            .replace(/\$\{(.+)\}/g, (_, p1) => {
                            let ret = '';
                            for (const i of this.#hBufWords[p1]) {
                                ret = `#${i}#`;
                                break;
                            }
                            return ret;
                        });
                        console.log(`fn:CteScore.ts line:176 tool_put row:${o.row} to:${o.to} scr=${scr}=`);
                        wv.postMessage({
                            cmd: 'tool_res',
                            row: o.row,
                            htm: (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.repWvUri)(this.#token2html({ line: o.row }, scr, o.row), wv, CteScore.#uriRes),
                        });
                        t.skipupd = true;
                        const ed = new vscode__WEBPACK_IMPORTED_MODULE_3__.WorkspaceEdit;
                        ed.insert(doc.uri, new vscode__WEBPACK_IMPORTED_MODULE_3__.Position(o.to, 0), scr === '\n\n' ? '\n' : scr + '\n');
                        vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.applyEdit(ed);
                    }
                    break;
                case 'del':
                    {
                        t.skipupd = true;
                        const ed = new vscode__WEBPACK_IMPORTED_MODULE_3__.WorkspaceEdit;
                        ed.delete(doc.uri, new vscode__WEBPACK_IMPORTED_MODULE_3__.Range(o.lnum, 0, o.lnum + 1, 0));
                        vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.applyEdit(ed);
                    }
                    break;
                case 'input':
                    {
                        console.log(`fn:CteScore.ts line:184 input ln:${o.ln} nm=${o.nm}= val=${o.val}=`);
                        t.skipupd = true;
                        const ed = new vscode__WEBPACK_IMPORTED_MODULE_3__.WorkspaceEdit;
                        const rng = new vscode__WEBPACK_IMPORTED_MODULE_3__.Range(o.ln, 0, o.ln + 1, 0);
                        const base = o.nm.charCodeAt(0) < 60
                            ? o.nm + o.val + '\n'
                            : doc.getText(rng);
                        let txt = base.replace(new RegExp(`(${o.nm}=)([#"']).*\\2`), `$1$2${o.val}$2`).replace(new RegExp(`(${o.nm}=)[^\\] #"']+`), `$1${o.val}`);
                        if (base === txt)
                            txt = txt.replace(/(])/, ` ${o.nm}=#${o.val}#$1`);
                        ed.replace(doc.uri, rng, txt);
                        vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.applyEdit(ed);
                        const a_tag = CteScore.analyzTagArg(txt);
                        const g = a_tag?.groups;
                        if (!g)
                            break;
                        const t2t = this.#hTag2Tds[g.name];
                        if (!t2t)
                            break;
                        CteScore.#alzTagArg.parse(g.args);
                        const oTds = t2t(CteScore.#alzTagArg.hPrm);
                        wv.postMessage({ cmd: 'upd_btn_face', ln: o.ln, htm: `
<i class="fas ${oTds.icon}" aria-hidden="true"></i>
${oTds.btn_face}`, td: `<td class="p-0 ${oTds.td_style ?? ''}">`, nm: o.nm, val: o.val });
                    }
                    break;
                case 'req_wds':
                    wv.postMessage({ cmd: 'res_wds', key: o.key, aWd: [...this.#hBufWords[o.key].values()] });
                    break;
            }
        }, false);
        wv.html = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.repWvUri)(this.#hPath2Tokens[doc.uri.path].htm, wv, CteScore.#uriRes);
        if (doc.getText(new vscode__WEBPACK_IMPORTED_MODULE_3__.Range(0, 0, 1, 1)) === '') {
            const ed = new vscode__WEBPACK_IMPORTED_MODULE_3__.WorkspaceEdit;
            ed.insert(doc.uri, new vscode__WEBPACK_IMPORTED_MODULE_3__.Position(0, 0), '\n\n\n[return]\n');
            vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.applyEdit(ed);
        }
    }
    static #regFld = /\w+/;
    #updWv_db(path) {
        const hFld2 = {};
        const t = this.#hPath2Tokens[path];
        const hPath = this.#hPrj2hPath;
        for (const [fn, p] of Object.entries(hPath)) {
            for (const [ext, v] of Object.entries(p)) {
                if (ext === ':cnt')
                    continue;
                const path = String(v);
                const fld = String(path.match(CteScore.#regFld));
                hFld2[fld] ??= [];
                hFld2[fld].push({ ext, path, fn });
            }
        }
        const wv = this.#hPath2Wv[path];
        wv.postMessage({
            cmd: 'upd_db',
            pathPrj: String(wv.asWebviewUri(t.uriPrj)),
            hFld2url: hFld2,
            hPath,
        });
    }
    #hBufWords = {};
    updWords(key, Words) {
        this.#hBufWords[key] = Words;
        for (const v of Object.values(this.#hPath2Wv)) {
            v.postMessage({ cmd: 'del_wds', key });
        }
    }
    #hPrj2hPath = {};
    updPath(hPath) {
        this.#hPrj2hPath = hPath;
        for (const path_doc of Object.keys(this.#hPath2Tokens)) {
            if (path_doc in this.#hPath2Wv)
                this.#updWv_db(path_doc);
        }
    }
    #token2html(stt, token, idx) {
        let tds = '';
        switch (token.charCodeAt(0)) {
            case 9: return '';
            case 10: {
                const dl = idx === 0 && stt.line === 1 ? 1 : 0;
                const len = token.length + dl;
                stt.line += len - dl;
                if (len === 1)
                    return '';
                let str_r = '';
                for (let i = stt.line - len + 1; i < stt.line; ++i) {
                    str_r += this.#make_tr(i, this.#make_tds(0, i, 'btn-rounded', 'fa-expand', '（空行）'));
                }
                return str_r;
            }
            case 38:
                {
                    const is_dsp = token.endsWith('&');
                    tds = this.#make_tds(0, stt.line, 'btn-secondary dropdown-toggle" data-face="true" data-mdb-toggle="dropdown" aria-expanded="false', 'fa-calculator', is_dsp
                        ? '変数表示'
                        : `変数操作 ${token.slice(1, token.indexOf('=') + 2)}…`, is_dsp ? token.slice(1, -1) : token.slice(1), `
	<div class="form-outline col-12">
		<input type="text" data-nm="&" id="${String(idx)}txf" class="form-control" value="${token.slice(1)}"/>
		<label class="form-label" for="${String(idx)}txf">${is_dsp ? '変数表示' : '変数操作'}</label>
	</div>`);
                }
                break;
            case 59:
                tds = this.#make_tds(0, stt.line, 'btn-outline-light btn-rounded dropdown-toggle" data-face="true" data-mdb-toggle="dropdown" aria-expanded="false', 'fa-comment-dots', token.slice(1, 11) + '…', token.slice(1), `
	<div class="form-outline col-12">
		<input type="text" data-nm=";" id="${String(idx)}txf" class="form-control" value="${token.slice(1)}"/>
		<label class="form-label" for="${String(idx)}txf">コメント</label>
	</div>`);
                break;
            case 42:
                tds = this.#make_tds(0, stt.line, 'btn-outline-light dropdown-toggle" data-mdb-toggle="dropdown" aria-expanded="false" data-face="true', 'fa-tag', token.slice(1), token.slice(1), `
	<div class="form-outline col-12">
		<input type="text" data-nm="*" id="${String(idx)}txf" class="form-control" value="${token.slice(1)}"/>
		<label class="form-label" for="${String(idx)}txf">ラベル</label>
	</div>`);
                break;
            case 91:
                {
                    let lineTkn = 0;
                    let j = -1;
                    while ((j = token.indexOf('\n', j + 1)) >= 0)
                        ++lineTkn;
                    if (lineTkn > 0)
                        stt.line += lineTkn;
                    if (tds = this.#make_tds_tag(token, stt.line, idx))
                        break;
                }
                return '';
            default:
                tds = this.#make_tds(5, stt.line, 'btn-outline-primary text-white dropdown-toggle sn-ext_txt" data-face="true" data-mdb-toggle="dropdown" aria-expanded="false', 'fa-align-left', '', '', `
	<div class="form-outline col-12">
		<textarea class="form-control" placeholder="本文テキストを入力" cols="40" rows="2" data-nm="text" id="${String(idx)}ta">${token}</textarea>
		<label class="form-label" for="${String(idx)}ta">本文テキスト</label>
	</div>`);
        }
        return this.#make_tr(stt.line, tds);
    }
    #make_tr(line, tds) {
        return `
<tr data-row="${String(line)}">
	${tds}
	<td class="p-0"><div class="d-flex justify-content-center">
		<button type="button" class="btn btn-danger btn-sm btn-floating tglEdit d-none">
			<i class="fas fa-times"></i>
		</button>
	</div></td>
</tr>`;
    }
    #make_tds_tag(token, line, row) {
        const a_tag = CteScore.analyzTagArg(token);
        const g = a_tag?.groups;
        if (!g)
            return '';
        const t2t = this.#hTag2Tds[g.name];
        if (!t2t)
            return this.#make_tds(0, line, 'btn-light', 'fa-code', g.name, g.args);
        CteScore.#alzTagArg.parse(g.args);
        const oTds = t2t(CteScore.#alzTagArg.hPrm);
        const len = oTds.args ? oTds.args.length : 0;
        const frm_style = len === 1 ? 'col-12 col-sm-3 col-md-2'
            : len === 2 ? 'col-2'
                : '';
        return this.#make_tds(oTds.col ? this.#hCn2Col[oTds.col] : 0, line, (oTds.btn_style ?? 'btn-secondary')
            + (oTds.args ? ' dropdown-toggle" data-mdb-toggle="dropdown" aria-expanded="false' : ''), oTds.icon, oTds.btn_face, oTds.tooltip ?? g.args, oTds.args ? oTds.args.map((v, i) => {
            let ret = '';
            let fo = 'form-outline px-2';
            const id = `sn-${row}:${i}`;
            switch (v.type) {
                case 'bool':
                    fo = 'p-0';
                    ret = `
<div class="form-control ${frm_style}">
<div class="form-check">
	<input type="checkbox" id="${id}chk" class="form-check-input" data-nm="${v.name}" value="${v.val ?? ''}"${(0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.chkBoolean)(v.val) ? ' checked' : ''}/>
	<label class="form-check-label" for="${id}chk">${v.hint ?? v.name}</label>
</div>
</div>`;
                    break;
                case 'textarea':
                    ret = `
<textarea id="${id}ta" class="form-control" placeholder="${v.hint ?? v.name}を入力" cols="40" rows="2" data-nm="${v.name}">${v.val ?? ''}</textarea>
<label class="form-label" for="${id}ta">${v.hint ?? v.name}</label>`;
                    break;
                case 'select':
                    fo = 'p-0';
                    ret = `
<div class="form-control">
<label class="form-label select-label" for="${id}sel">${v.hint ?? v.name}</label>
<select class="select" id="${id}sel" data-nm="${v.name}" data-key="${v.key ?? ''}"${v.exts ? `data-exts="${v.exts}"` : ''}${v.filter ? `data-filter="${v.filter}"` : ''}>
	<option selected>${v.val ?? ''}</option>
	<option>...</option>
	<option>...</option>
</select>
</div>`;
                    break;
                case 'range':
                    fo = 'p-0';
                    ret = `
<div class="range form-control">
	<label class="form-label" for="${id}rng">${v.hint ?? v.name}（${v.min ?? ''} - ${v.max ?? ''}）</label>
	<input type="range" id="${id}rng" data-nm="${v.name}" class="form-range" min=${v.min ?? ''} max=${v.max ?? ''} step=${v.step ?? ''} value="${v.val ?? ''}"/>
</div>`;
                    break;
                default: ret = `
<input type="${v.type === 'num' ? 'number' : 'text'}" id="${id}txf" class="form-control ${frm_style}" data-nm="${v.name}" value="${v.val ?? ''}"/>
<label class="form-label" for="${id}txf">${v.hint ?? v.name}</label>`;
            }
            return `
<div class="${fo} col-12 ${len === 1 ? ''
                : len === 2 ? 'col-md-6'
                    : 'col-md-6 col-lg-4'} my-1${v.type === 'bool' ? ' pt-2' : ''}">${ret}</div>`;
        }).join('') : '', oTds.td_style ?? '', oTds.detail ?? '');
    }
    undefMacro(def_nm) { delete this.#hTag2Tds[def_nm]; }
    defMacro(def_nm, hPrm) {
        this.#hTag2Tds[def_nm] = () => ({ ...{
                icon: 'icon未指定',
                btn_face: 'btn_face未指定',
            }, ...hPrm });
    }
    static #alzTagArg = new _AnalyzeTagArg__WEBPACK_IMPORTED_MODULE_1__.AnalyzeTagArg;
    static #EXTS_PIC = 'jpg|jpeg|png';
    #hTag2Tds = {
        ch: hPrm => ({
            col: 'mes',
            btn_style: 'btn-outline-primary text-white dropdown-toggle sn-ext_txt" data-face="true" data-mdb-toggle="dropdown" aria-expanded="false',
            icon: 'fa-align-left',
            btn_face: '',
            tooltip: '',
            args: [
                { name: 'text', type: 'textarea', val: hPrm.text?.val ?? '', hint: '本文テキスト' },
            ],
            detail: `<form><textarea class="form-control bg-light" placeholder="本文テキストを入力" data-nm="text">${hPrm.text?.val ?? ''}</textarea></form>`,
        }),
        jump: hPrm => ({
            icon: 'fa-external-link-alt',
            btn_face: 'ジャンプ'
                + (hPrm.fn?.val ? ` ${hPrm.fn.val}` : '')
                + (hPrm.label?.val ? ` ${hPrm.label.val}` : ''),
        }),
        call: hPrm => ({
            icon: 'fa-exchange-alt',
            btn_face: 'コール'
                + (hPrm.fn?.val ? ` ${hPrm.fn.val}` : '')
                + (hPrm.label?.val ? ` ${hPrm.label.val}` : ''),
        }),
        return: _ => ({
            icon: 'fa-long-arrow-alt-left',
            btn_face: '戻る',
        }),
        add_lay: hPrm => {
            const is_grp = hPrm.class?.val === 'grp';
            return {
                col: hPrm.layer?.val ?? 'base',
                btn_style: `btn-${is_grp ? 'success' : 'primary text-white'}`,
                icon: is_grp ? 'fa-image' : 'fa-align-left',
                btn_face: (is_grp ? '画像' : '文字') + 'レイヤ追加 '
                    + (hPrm.layer?.val ?? ''),
            };
        },
        clear_lay: hPrm => ({
            col: hPrm.layer?.val ?? 'base',
            btn_style: 'btn-outline-primary text-white',
            icon: 'fa-ban',
            btn_face: 'レイヤ設定消去',
        }),
        lay: hPrm => ({
            col: hPrm.layer?.val ?? 'base',
            btn_style: 'btn-outline-primary text-white',
            icon: 'fa-cog',
            btn_face: 'レイヤ設定',
        }),
        img: hPrm => {
            const layer = hPrm.layer?.val ?? 'base';
            return {
                col: layer,
                btn_style: `btn${hPrm.fn?.val ? '' : '-outline'}-${layer !== 'mes'
                    ? 'success'
                    : 'secondary text-white'}`,
                icon: layer === 'base' ? 'fa-image' : 'fa-user',
                btn_face: hPrm.fn?.val ?? (layer === 'base' ? '(消去)' : '(退場)'),
                args: [
                    { name: 'fn', type: 'select', val: hPrm.fn?.val ?? '(消去)', hint: '画像名', key: '画像ファイル名' },
                ]
            };
        },
        scene_change: hPrm => ({
            col: 'base',
            td_style: 'sn-cmb-'
                + (hPrm.bg?.val ? `start" data-fn="${hPrm.bg.val}` : 'end'),
            btn_style: 'btn-success text-black',
            icon: 'fa-door-open',
            btn_face: '場面転換'
                + (hPrm.rule?.val ? ` ${hPrm.rule.val}ルールで` : '')
                + (hPrm.time?.val ? ` ${hPrm.time.val}msで` : '')
                + (hPrm.bg ? ` ${hPrm.bg.val}へ変更` : '(消去)'),
            args: [
                { name: 'bg', type: 'select', val: hPrm.bg?.val ?? '(消去)', hint: '背景の画像名', key: '画像ファイル名', exts: CteScore.#EXTS_PIC, filter: 'bg/' },
                { name: 'time', type: 'num', val: hPrm.time?.val ?? '1000', hint: 'かける時間' },
                { name: 'rule', type: 'select', val: hPrm.rule?.val ?? '', hint: 'ルール画像名', key: '画像ファイル名', exts: CteScore.#EXTS_PIC, filter: 'rule/' },
            ],
        }),
        scene_reserve: hPrm => ({
            col: hPrm.layer?.val ?? '0',
            td_style: 'sn-cmb-'
                + (hPrm.fn?.val ? `start" data-fn="${hPrm.fn.val}` : 'end'),
            btn_style: 'btn-success btn-rounded text-black',
            icon: 'fa-user-ninja',
            btn_face: `場面準備 ${hPrm.fn?.val ?? ''}`,
            args: [
                { name: 'layer', type: 'select', val: hPrm.layer?.val ?? '0', hint: '画像レイヤ', key: '画像レイヤ名' },
                { name: 'fn', type: 'select', val: hPrm.fn?.val ?? '(消去)', hint: '画像名', key: '画像ファイル名' },
                { name: 'face', type: 'str', val: hPrm.face?.val ?? '', hint: '差分' },
                { name: 'pos', type: 'str', val: hPrm.pos?.val ?? '', hint: '表示位置' },
                { name: 'alpha', type: 'range', val: hPrm.alpha?.val ?? '', hint: '不透明度', min: '0.0', max: '1.0', step: '0.1' },
            ],
        }),
        grp: hPrm => {
            return {
                col: 'base',
                td_style: 'sn-cmb-'
                    + (hPrm.bg?.val ? `start" data-fn="${hPrm.bg.val}` : 'end'),
                btn_style: 'btn-success',
                icon: 'fa-images',
                btn_face: (hPrm.bg?.val ?? '(消去)')
                    + (hPrm.rule?.val ? ` ${hPrm.rule.val}ルールで` : '')
                    + (hPrm.time?.val ? ` へ変更 ${hPrm.time.val}msで` : ''),
                args: [
                    { name: 'bg', type: 'select', val: hPrm.bg?.val ?? '(消去)', hint: '背景の画像名', key: '画像ファイル名', exts: CteScore.#EXTS_PIC, filter: 'bg/' },
                    { name: 'time', type: 'num', val: hPrm.time?.val ?? '1000', hint: 'かける時間' },
                    { name: 'rule', type: 'select', val: hPrm.rule?.val ?? '', hint: 'ルール画像名', key: '画像ファイル名', exts: CteScore.#EXTS_PIC, filter: 'rule/' },
                    { name: 'l0', type: 'select', val: hPrm.l0?.val ?? '(消去)', hint: 'レイヤ0の画像名', key: '画像ファイル名' },
                    { name: 'f0', type: 'str', val: hPrm.f0?.val ?? '', hint: 'レイヤ0のface属性' },
                    { name: 'pos0', type: 'str', val: hPrm.pos0?.val ?? '', hint: 'レイヤ0のpos位置' },
                    { name: 'o0', type: 'num', val: hPrm.o0?.val ?? '', hint: 'レイヤ0の不透明度' },
                    { name: 'l1', type: 'select', val: hPrm.l1?.val ?? '(消去)', hint: 'レイヤ1の画像名', key: '画像ファイル名' },
                    { name: 'f1', type: 'str', val: hPrm.f1?.val ?? '', hint: 'レイヤ1のface属性' },
                    { name: 'pos1', type: 'str', val: hPrm.pos1?.val ?? '', hint: 'レイヤ1のpos位置' },
                    { name: 'o1', type: 'num', val: hPrm.o1?.val ?? '', hint: 'レイヤ1の不透明度' },
                    { name: 'l2', type: 'select', val: hPrm.l2?.val ?? '(消去)', hint: 'レイヤ2の画像名', key: '画像ファイル名' },
                    { name: 'f2', type: 'str', val: hPrm.f2?.val ?? '', hint: 'レイヤ2のface属性' },
                    { name: 'pos2', type: 'str', val: hPrm.pos2?.val ?? '', hint: 'レイヤ2のpos位置' },
                    { name: 'o2', type: 'num', val: hPrm.o2?.val ?? '', hint: 'レイヤ2の不透明度' },
                    { name: 'se', type: 'str', val: hPrm.se?.val ?? '', hint: '効果音名' },
                ],
            };
        },
        fg: hPrm => ({
            col: hPrm.layer?.val ?? '命令',
            btn_style: 'btn-success',
            icon: 'fa-image',
            btn_face: hPrm.fn?.val ?? '',
        }),
        button: hPrm => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-sign-out-alt',
            btn_face: (hPrm.text?.val ? `文字ボタン「${hPrm.text.val}」` : '')
                + (hPrm.pic?.val ? `画像ボタン ${hPrm.pic.val}` : ''),
        }),
        enable_event: hPrm => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-check-square',
            btn_face: `イベント発生 ${hPrm.enabled?.val === 'true'
                ? 'させる' : 'させない'}`,
        }),
        event: hPrm => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-bolt',
            btn_face: 'イベント予約'
                + (hPrm.global?.val === 'true' ? '（毎回）' : '（一回だけ）')
                + (hPrm.del?.val === 'true' ? 'の削除 ' : '')
                + (hPrm.key?.val ?? ''),
        }),
        waitclick: _ => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-hourglass-start',
            btn_face: 'クリック待ち',
        }),
        r: _ => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-align-left',
            btn_face: '文字改行',
        }),
        l: _ => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-leaf',
            btn_face: '改行待ち',
        }),
        plc: hPrm => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-book-open',
            btn_face: '改ページ待ち'
                + (hPrm.visible?.val === 'false' ? '（マーク非表示）' : ''),
            args: [
                { name: 'visible', type: 'bool', val: hPrm.visible?.val ?? 'true', hint: 'マーク表示する' },
                { name: 'time', type: 'num', val: hPrm.time?.val ?? '500', hint: '再開時の効果音FO時間' },
                { name: 'buf', type: 'str', val: hPrm.buf?.val ?? '音声', hint: '再開時の再生停止' },
            ],
        }),
        let: hPrm => ({
            btn_style: 'btn-secondary',
            icon: 'fa-calculator',
            btn_face: `変数操作 ${hPrm.name?.val ?? ''}=…`,
        }),
        bgm: hPrm => ({
            col: 'BGM',
            td_style: 'sn-cmb-'
                + (hPrm.fn?.val ? `start" data-fn="${hPrm.fn.val}` : 'end'),
            btn_style: 'btn-info',
            icon: 'fa-play',
            btn_face: hPrm.fn?.val ?? '',
            tooltip: `fn=${hPrm.fn?.val ?? ''}`,
        }),
        stopbgm: _ => ({
            col: 'BGM',
            td_style: 'sn-cmb-end',
            btn_style: 'btn-outline-info',
            icon: 'fa-stop',
            btn_face: '再生停止',
        }),
        fadeoutbgm: hPrm => ({
            col: 'BGM',
            td_style: 'sn-cmb-end',
            btn_style: 'btn-outline-info',
            icon: 'fa-volume-down',
            btn_face: `フェードアウト ${hPrm.time?.val ?? ''}ms かけて`,
        }),
        wait: hPrm => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-hourglass-start',
            btn_face: `${hPrm.time?.val ?? '0'}ms`,
            tooltip: '待機'
                + (hPrm.time?.val ? ` time=${hPrm.time.val}ms` : '')
                + (hPrm.canskip?.val ? ` スキップできるか=${hPrm.canskip.val}` : ''),
        }),
        s: _ => ({
            col: 'mes',
            btn_style: 'btn-primary',
            icon: 'fa-stop',
            btn_face: '停止する',
        }),
        close: _ => ({
            icon: 'fa-window-close',
            btn_face: 'アプリの終了',
        }),
        macro: hPrm => {
            this.#macro_nm = hPrm.name?.val ?? '';
            return {
                btn_style: 'btn-outline-secondary text-white',
                icon: 'fa-box-open',
                btn_face: `マクロ定義の開始 ${this.#macro_nm}`,
                args: [
                    { name: 'name', type: 'str', val: this.#macro_nm, hint: 'マクロ名' },
                ],
            };
        },
        endmacro: _ => {
            const nm = this.#macro_nm;
            this.#macro_nm = '';
            return {
                btn_style: 'btn-outline-secondary text-white',
                icon: 'fa-box',
                btn_face: `マクロ定義の終了 ${nm}`,
            };
        },
        アルバム解放: hPrm => ({
            icon: 'fa-th',
            btn_face: 'アルバム解放 ' + (hPrm.name?.val ?? ''),
            args: [
                { name: 'name', type: 'str', val: hPrm.name?.val ?? '', hint: '素材識別名' },
            ],
        }),
    };
    #macro_nm = '';
    #MAX_COL = 7;
    #hCn2Col = {
        '命令': 0,
        'base': 1,
        '0': 2,
        '1': 3,
        '2': 4,
        'mes': 5,
        'BGM': 6,
        'SE': 7,
        '詳細': 8,
    };
    #make_tds(col, line, btn_style, icon, btn_face, tooltip = '', aft = '', td_style = '', detail = '') {
        return '<td></td>'.repeat(col) + `
	<td class="p-0 ${td_style}">
		<button type="button" class="btn btn-block btn-sm ${btn_style}" data-faceicon="${icon}" data-ripple-color="dark" id="${String(line)}btn" draggable="true"${tooltip
            ? ` data-mdb-toggle="tooltip" data-placement="right" title="${tooltip}"`
            : ''}>
			<i class="fas ${icon}" aria-hidden="true"></i>
		</button>
		${aft ? `<div class="dropdown-menu col-xxl-4 col-sm-6 col-12"><form class="p-1 d-flex flex-wrap">${aft}</form></div>` : ''}
	</td>`.replace(' dropdown-toggle', '') +
            '<td></td>'.repeat(this.#MAX_COL - col) + `
	<td class="p-0">${detail || `
		<button type="button" class="btn btn-block btn-sm px-2 text-start text-lowercase ${btn_style}" data-faceicon="${icon}" data-ripple-color="dark" id="${String(line)}detail" draggable="true"${tooltip
            ? ` data-mdb-toggle="tooltip" data-placement="right" title="${tooltip}"`
            : ''}>
			<i class="fas ${icon}" aria-hidden="true"></i>
			${btn_face}
		</button>`}	${aft ? `<div class="dropdown-menu col-xxl-4 col-sm-6 col-12"><form class="p-1 d-flex flex-wrap">${aft}</form></div>` : ''}
	</td>`;
    }
}


/***/ }),

/***/ "./src/DebugAdapter.ts":
/*!*****************************!*\
  !*** ./src/DebugAdapter.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   initDebug: () => (/* binding */ initDebug)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _Debugger__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Debugger */ "./src/Debugger.ts");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @vscode/debugadapter */ "./node_modules/@vscode/debugadapter/lib/main.js");





function initDebug(ctx, hookTag) {
    const lng = _CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel.language || '';
    vscode__WEBPACK_IMPORTED_MODULE_3__.debug.registerDebugConfigurationProvider(lng, {
        provideDebugConfigurations: _ => [
            {
                name: '10.ブラウザ版',
                request: 'launch',
                type: 'pwa-node',
                runtimeExecutable: 'npm',
                runtimeArgs: ['run-script', 'watch:wdsdbg'],
                skipFiles: ['<node_internals>/**'],
                console: 'internalConsole',
                internalConsoleOptions: 'openOnSessionStart'
            },
            {
                name: '1.アプリ版',
                request: 'launch',
                type: 'node',
                port: 3776,
                console: 'internalConsole',
                internalConsoleOptions: 'openOnSessionStart',
            },
            {
                name: '2.デバッガ',
                request: 'attach',
                type: 'skynovel',
                port: 3776,
                weburi: 'http://localhost:8080',
                stopOnEntry: false,
            },
        ]
    });
    ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_3__.debug.registerDebugConfigurationProvider('node', {
        resolveDebugConfiguration(_folder, cfg) {
            const ex = '${workspaceFolder}/node_modules/.bin/electron';
            return {
                program: '${workspaceFolder}/doc/app.js',
                runtimeExecutable: ex,
                windows: { runtimeExecutable: ex + '.cmd' },
                console: 'integratedTerminal',
                autoAttachChildProcesses: true,
                skipFiles: [
                    '<node_internals>/**/*.js'
                ],
                ...cfg,
                env: { SKYNOVEL_DBG: 'on', SKYNOVEL_PORT: cfg.port ?? 3776, ...cfg.env, },
            };
        }
    }));
    ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_3__.debug.registerDebugConfigurationProvider(lng, {
        resolveDebugConfiguration(_folder, cfg) {
            return { cwd: '${workspaceFolder}', port: 3776, weburi: 'http://localhost:8080', ...cfg, };
        }
    }));
    const dadf = {
        createDebugAdapterDescriptor: ds => {
            if (!ds.workspaceFolder)
                return undefined;
            daii ??= new vscode__WEBPACK_IMPORTED_MODULE_3__.DebugAdapterInlineImplementation(new DebugAdapter(ds.workspaceFolder, hookTag));
            return daii;
        },
    };
    ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_3__.debug.registerDebugAdapterDescriptorFactory(lng, dadf));
}
let daii = null;
class DebugAdapter extends _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.LoggingDebugSession {
    wsFld;
    static #THREAD_ID = 1;
    #dbg;
    constructor(wsFld, hookTag) {
        super('sn_debug.txt');
        this.wsFld = wsFld;
        this.setDebuggerLinesStartAt1(true);
        this.setDebuggerColumnsStartAt1(true);
        this.#dbg = new _Debugger__WEBPACK_IMPORTED_MODULE_1__.Debugger(wsFld, hookTag);
        this.#dbg.on('stopOnEntry', () => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StoppedEvent('entry', DebugAdapter.#THREAD_ID));
        });
        this.#dbg.on('stopOnStep', () => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StoppedEvent('step', DebugAdapter.#THREAD_ID));
        });
        this.#dbg.on('stopOnBreakpoint', () => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StoppedEvent('breakpoint', DebugAdapter.#THREAD_ID));
        });
        this.#dbg.on('stopOnDataBreakpoint', () => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StoppedEvent('data breakpoint', DebugAdapter.#THREAD_ID));
        });
        this.#dbg.on('stopOnException', () => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StoppedEvent('exception', DebugAdapter.#THREAD_ID));
        });
        this.#dbg.on('breakpointValidated', (bp) => {
            this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.BreakpointEvent('changed', bp));
        });
        this.#dbg.on('output', (text, filePath, line, column) => {
            const e = new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.OutputEvent(`${text}\n`);
            if (text === 'start' || text === 'startCollapsed' || text === 'end') {
                e.body.group = text;
                e.body.output = `group-${text}\n`;
            }
            e.body.source = this.#createSource(filePath);
            e.body.line = this.convertDebuggerLineToClient(line);
            e.body.column = this.convertDebuggerColumnToClient(column);
            this.sendEvent(e);
        });
        this.#dbg.on('end', () => this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.TerminatedEvent));
    }
    initializeRequest(res, _args) {
        res.body ??= {};
        res.body.supportsConfigurationDoneRequest = true;
        res.body.supportsFunctionBreakpoints = true;
        res.body.supportsConditionalBreakpoints = true;
        res.body.supportsHitConditionalBreakpoints = true;
        res.body.supportsEvaluateForHovers = true;
        res.body.supportsStepBack = false;
        res.body.supportsSetVariable = true;
        res.body.supportsCompletionsRequest = true;
        res.body.supportsRestartRequest = true;
        res.body.supportsDataBreakpoints = true;
        res.body.supportsCancelRequest = false;
        this.sendResponse(res);
        this.sendEvent(new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.InitializedEvent);
    }
    disconnectRequest(_res, _args, _req) { this.#dbg.end(); }
    configurationDoneRequest(_res, _args) { this.#cfgDone(); }
    #cfgDone = Promise.withResolvers().resolve;
    attachRequest(res, args) {
        _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.logger.setup(_vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Logger.LogLevel.Stop, false);
        this.#dbg.attach(args);
        this.sendResponse(res);
    }
    restartRequest(res, _args) {
        void this.#dbg.restart(res.request_seq);
        this.sendResponse(res);
    }
    setBreakPointsRequest(res, args) {
        const a = args.breakpoints ?? [];
        res.body = {
            breakpoints: this.#dbg.setBreakPoints(args.source.path, a.map(o => ({
                ...o,
                line: this.convertClientLineToDebugger(o.line),
            })))
                .map((o, i) => new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Breakpoint(o.verified, a[i].line, o.col))
        };
        this.sendResponse(res);
    }
    setFunctionBreakPointsRequest(res, args, _req) {
        const a = [];
        res.body = { breakpoints: [] };
        for (const dbp of args.breakpoints) {
            a.push(dbp);
            res.body.breakpoints.push({ verified: true, });
        }
        void this.#dbg.setFuncBreakpoint(res.request_seq, a);
        this.sendResponse(res);
    }
    restartFrameRequest(_res, _args, _req) {
    }
    pauseRequest(_res, _args) { this.#dbg.pause(); }
    threadsRequest(res) {
        res.body = { threads: [new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Thread(DebugAdapter.#THREAD_ID, 'thread 1')] };
        this.sendResponse(res);
    }
    stackTraceRequest(res, args) {
        const start = typeof args.startFrame === 'number' ? args.startFrame : 0;
        const maxLevels = typeof args.levels === 'number' ? args.levels : 1000;
        const end = start + maxLevels;
        void this.#dbg.stack(res.request_seq, start, end)
            .then(stk => {
            res.body = {
                stackFrames: stk.map((f, i) => new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.StackFrame(i, f.nm, this.#createSource(f.fn), this.convertDebuggerLineToClient(f.ln), this.convertDebuggerColumnToClient(f.col))),
                totalFrames: stk.length,
            };
            this.sendResponse(res);
        });
    }
    #hdlsVar = new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Handles;
    #hNm2HdlNm = {};
    scopesRequest(res, _args) {
        this.#hScope = {
            'tmp': {},
            'sys': {},
            'save': {},
            'mp': {},
        };
        res.body = {
            scopes: [
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('雑用変数 tmp:', this.#hdlsVar.create('tmp'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('雑用変数 tmp:（SKYNovel組み込み）', this.#hdlsVar.create('tmp:sn'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('マクロ変数 mp:', this.#hdlsVar.create('mp'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('マクロ変数 mp:（SKYNovel組み込み）', this.#hdlsVar.create('mp:sn'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('システム変数 sys:', this.#hdlsVar.create('sys'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('システム変数 sys:（SKYNovel組み込み）', this.#hdlsVar.create('sys:sn'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('セーブ変数 save:', this.#hdlsVar.create('save'), false),
                new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Scope('セーブ変数 save:（SKYNovel組み込み）', this.#hdlsVar.create('save:sn'), false),
            ]
        };
        this.sendResponse(res);
    }
    #mapCancelationTokens = new Map;
    #mapIsLongrunning = new Map;
    static #REG_SN_VAR = /^(?:const\.)?sn\./;
    #hScope = {
        'tmp': {},
        'sys': {},
        'save': {},
        'mp': {},
    };
    variablesRequest(res, args, req) {
        const aVar = [];
        if (this.#mapIsLongrunning.get(args.variablesReference)) {
            if (req)
                this.#mapCancelationTokens.set(req.seq, false);
            for (let i = 0; i < 100; ++i) {
                aVar.push({
                    name: `i_${i}`,
                    type: 'integer',
                    value: `${i}`,
                    variablesReference: 0,
                });
                if (req && this.#mapCancelationTokens.get(req.seq))
                    break;
            }
            if (req)
                this.#mapCancelationTokens.delete(req.seq);
        }
        else {
            let id = this.#hdlsVar.get(args.variablesReference);
            if (id) {
                let tst_sn = true;
                if (id.endsWith(':sn')) {
                    tst_sn = false;
                    id = id.slice(0, -3);
                }
                const fnc = id in this.#hScope
                    ? this.#dbg.var(res.request_seq, id)
                    : Promise.try(() => {
                        let h = {};
                        const a = `${id}:`.split(':', 2);
                        const h2 = this.#hScope[a[0]];
                        if (h2) {
                            const v2 = h2[a[1]];
                            if (v2)
                                h = JSON.parse(String(v2));
                        }
                        return h;
                    });
                void (() => fnc)().then(h => {
                    for (const [key, v2] of Object.entries(h)) {
                        if (DebugAdapter.#REG_SN_VAR.test(key) === tst_sn)
                            continue;
                        const v = String(v2);
                        const o = {
                            name: key,
                            type: this.#getType(v),
                            value: v,
                            presentationHint: {
                                kind: 'property',
                                visibility: 'public',
                            },
                            variablesReference: 0,
                        };
                        if (key.startsWith('const.'))
                            o.presentationHint.attributes = ['constant'];
                        if (v === '[object Object]')
                            o.value = JSON.stringify(v2);
                        else if (o.type === 'object' || o.type === 'array')
                            this.#hNm2HdlNm[`${id}:${key}`] = o.variablesReference
                                = this.#hdlsVar.create(`${id}:${key}`);
                        aVar.push(o);
                    }
                });
            }
        }
        res.body = { variables: aVar.sort((a, b) => {
                if (a.name < b.name)
                    return -1;
                if (a.name > b.name)
                    return 1;
                return 0;
            }) };
        this.sendResponse(res);
    }
    #getType(v) {
        let type = 'string';
        if (v === 'true' || v === 'false')
            type = 'boolean';
        else if (v === '[object Object]')
            type = 'object';
        else if (/^[+-]?[0-9]+([0-9]*)?$/.test(v))
            type = 'integer';
        else if (/^[+-]?[0-9]+(\.[0-9]*)?([eE][+-]?[0-9]+)?$/.test(v))
            type = 'float';
        else if (v) {
            const bc = v.at(0);
            if (bc === '{' || bc === '[')
                type = bc === '{' ? 'object' : 'array';
        }
        return type;
    }
    setVariableRequest(res, args, _req) {
        void this.#dbg.setVariable(res.request_seq, args.name, args.value);
        res.body = { value: args.value, };
        this.sendResponse(res);
    }
    continueRequest(res, _args) {
        this.#dbg.continue();
        this.sendResponse(res);
    }
    reverseContinueRequest(res, _args) {
        this.#dbg.continue(true);
        this.sendResponse(res);
    }
    nextRequest(res, _args) {
        this.#dbg.step();
        this.sendResponse(res);
    }
    stepInRequest(res, _args, _req) {
        this.#dbg.stepin();
        this.sendResponse(res);
    }
    stepOutRequest(res, _args, _req) {
        this.#dbg.stepout();
        this.sendResponse(res);
    }
    stepBackRequest(res, _args) {
        this.#dbg.step(true);
        this.sendResponse(res);
    }
    evaluateRequest(res, args) {
        switch (args.context) {
            case 'hover':
                {
                    const v = this.#getVar(args.expression);
                    if (!v.exist) {
                        res.body = {
                            result: `変数 ${v.fullnm ?? '?'} はありません`,
                            variablesReference: 0,
                        };
                        break;
                    }
                    const hdlnm = this.#hNm2HdlNm[v.fullnm ?? ''];
                    res.body = {
                        result: `変数（${v.fullnm ?? '?'}）の値${hdlnm ? '' : `【${String(v.ret)}】`}`,
                        presentationHint: {
                            kind: 'property', visibility: 'public',
                            attributes: v.const ? ['readOnly'] : undefined,
                        },
                        variablesReference: hdlnm ?? 0,
                    };
                }
                break;
            case 'watch':
                void this.#dbg.eval(res.request_seq, args.expression)
                    .then(v => {
                    if (v)
                        res.body = {
                            result: v,
                            presentationHint: { kind: 'formula', visibility: 'public', },
                            variablesReference: 0,
                        };
                    else
                        res.body = { result: '【null】', variablesReference: 0, };
                });
                break;
            case 'repl':
                void this.#dbg.eval(res.request_seq, args.expression)
                    .then(v => {
                    res.body = {
                        result: v ? `=${v}` : '【null】',
                        variablesReference: 0,
                    };
                });
                break;
        }
        this.sendResponse(res);
    }
    #getVar(txt) {
        const a = `${txt}:`.split(':', 2);
        const scope = a[1] === '' ? 'tmp' : a[0];
        const nm = a[1] === '' ? a[0] : a[1];
        switch (scope) {
            case 'tmp':
            case 'sys':
            case 'save':
            case 'mp': break;
            default: return { exist: false };
        }
        const h = this.#hScope[scope];
        return nm in h
            ? { exist: true, fullnm: `${scope}:${nm}`, ret: h[nm], const: nm.startsWith('const.') }
            : { exist: false, fullnm: `${scope}:${nm}` };
    }
    dataBreakpointInfoRequest(res, args) {
        if (args.variablesReference && args.name) {
            const v = this.#getVar(args.name);
            if (v.exist)
                res.body = {
                    dataId: v.fullnm,
                    description: `変数値変更：${v.fullnm}`,
                    accessTypes: ['write'],
                    canPersist: true,
                };
        }
        else
            res.body = {
                dataId: null,
                description: 'cannot break on data access',
            };
        this.sendResponse(res);
    }
    setDataBreakpointsRequest(res, args) {
        const a = [];
        res.body = { breakpoints: [] };
        for (const dbp of args.breakpoints) {
            a.push(dbp);
            res.body.breakpoints.push({ verified: true, });
        }
        void this.#dbg.setDataBreakpoint(res.request_seq, a);
        this.sendResponse(res);
    }
    completionsRequest(res, _args) {
        res.body = {
            targets: [
                {
                    label: 'item 10',
                    sortText: '10'
                },
                {
                    label: 'item 1',
                    sortText: '01'
                },
                {
                    label: 'item 2',
                    sortText: '02'
                },
                {
                    label: 'array[]',
                    selectionStart: 6,
                    sortText: '03'
                },
                {
                    label: 'func(arg)',
                    selectionStart: 5,
                    selectionLength: 3,
                    sortText: '04'
                }
            ]
        };
        this.sendResponse(res);
    }
    loadedSourcesRequest(res, _args, _req) {
        res.body.sources = [
            {
                name: 'main.sn とか?',
                path: 'doc/prj/script/main.sn',
                sourceReference: 0,
            }
        ];
        this.sendResponse(res);
    }
    cancelRequest(_res, args) {
        if (args.requestId)
            this.#mapCancelationTokens.set(args.requestId, true);
    }
    #createSource(filePath) {
        return new _vscode_debugadapter__WEBPACK_IMPORTED_MODULE_4__.Source((0,node_path__WEBPACK_IMPORTED_MODULE_2__.basename)(filePath), this.convertDebuggerPathToClient(filePath), undefined, undefined, 'mock-adapter-data');
    }
}


/***/ }),

/***/ "./src/Debugger.ts":
/*!*************************!*\
  !*** ./src/Debugger.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   Debugger: () => (/* binding */ Debugger)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjSetting__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./PrjSetting */ "./src/PrjSetting.ts");
/* harmony import */ var socket_io__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! socket.io */ "./node_modules/socket.io/wrapper.mjs");
/* harmony import */ var image_size_fromFile__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! image-size/fromFile */ "./node_modules/image-size/dist/fromFile.mjs");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_6__);
/* harmony import */ var events__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! events */ "events");
/* harmony import */ var events__WEBPACK_IMPORTED_MODULE_7___default = /*#__PURE__*/__webpack_require__.n(events__WEBPACK_IMPORTED_MODULE_7__);








class Debugger extends events__WEBPACK_IMPORTED_MODULE_7__.EventEmitter {
    wsFld;
    hookTag;
    #pathWs = '';
    constructor(wsFld, hookTag) {
        super();
        this.wsFld = wsFld;
        this.hookTag = hookTag;
        this.#pathWs = wsFld.uri.path;
        Debugger.#hcurPrj2Dbg[this.#pathWs + '/doc/prj/'] = this;
    }
    static #hcurPrj2Dbg = {};
    static send2SN(type, o = {}) {
        const pathWs = vscode__WEBPACK_IMPORTED_MODULE_4__.debug.activeDebugSession?.workspaceFolder?.uri.fsPath;
        if (!pathWs)
            return;
        const dbg = Debugger.#hcurPrj2Dbg[pathWs + '/doc/prj/'];
        dbg.send2SN(type, o);
    }
    attach(args) {
        this.#hProcSnRes.hi = () => {
            this.send2SN('auth', {
                t: _PrjSetting__WEBPACK_IMPORTED_MODULE_1__.PrjSetting.getDebugertoken(this.wsFld),
                hBreakpoint: {
                    hFn2hLineBP: this.#hFn2hLineBP,
                    aData: this.#aDataBreak,
                    aFunc: this.#aFuncBreak,
                },
                ...args,
            });
            this.hookTag({ タグ名: ':connect' });
            return false;
        };
        new socket_io__WEBPACK_IMPORTED_MODULE_2__.Server(args.port, { cors: { origin: args.weburi } })
            .on('connection', (sk) => {
            sk.on('data', (type, o) => {
                if (!this.#hProcSnRes[type](type, o))
                    return;
                this.#hProcSnRes[type] = () => false;
            });
            this.send2SN = (type, o = {}) => {
                sk.emit('data', type, o);
            };
            const fncEnd = this.end;
            this.end = () => {
                this.end = fncEnd;
                this.end();
                this.send2SN('disconnect', {});
                this.send2SN = () => { };
                sk.disconnect();
            };
        });
    }
    send2SN(_type, _o = {}) { }
    end() {
        delete Debugger.#hcurPrj2Dbg[this.#pathWs];
        this.hookTag({ タグ名: ':disconnect' });
    }
    #hProcSnRes = {
        stopOnEntry: type => { this.#sendEvent2Adpt(type); return false; },
        stopOnStep: type => { this.#sendEvent2Adpt(type); return false; },
        stopOnBreakpoint: type => { this.#sendEvent2Adpt(type); return false; },
        stopOnDataBreakpoint: type => { this.#sendEvent2Adpt(type); return false; },
        _recodeDesign: (_, o) => {
            const ln = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(o[':ln']) - 1;
            const col_s = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(o[':col_s']);
            const col_e = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uint)(o[':col_e']);
            this.#hDCId2DI[o[':id_tag']] = {
                ...o,
                uri: vscode__WEBPACK_IMPORTED_MODULE_4__.Uri.file(o[':path'].replace('${pathbase}', this.#pathWs + '/doc')),
                rng: new vscode__WEBPACK_IMPORTED_MODULE_4__.Range(ln, col_s, ln, col_e),
            };
            this.hookTag(o);
            return false;
        },
        _enterDesign: _ => {
            return false;
        },
        _changeCast: (_, o) => {
            const { ':id_tag': id_tag, ri, ...o2 } = o;
            const di = this.#hDCId2DI[id_tag];
            if (!di)
                return false;
            let token = di[':token'];
            for (const [k, v] of Object.entries(o2))
                token = token.replace(new RegExp(`(\\s${k}=)(['"#]*)(?:\\S+)\\2([\\s\\]])`), `$1${v}$3`);
            di[':token'] = token;
            const ed = new vscode__WEBPACK_IMPORTED_MODULE_4__.WorkspaceEdit;
            ed.replace(di.uri, di.rng, token);
            vscode__WEBPACK_IMPORTED_MODULE_4__.workspace.applyEdit(ed);
            return false;
        },
        _focusScript: (_, o) => {
            o[':path'] = o[':path'].replace('${pathbase}', this.#pathWs + '/doc');
            const ln = o[':ln'] - 1;
            vscode__WEBPACK_IMPORTED_MODULE_4__.window.showTextDocument(vscode__WEBPACK_IMPORTED_MODULE_4__.Uri.file(o[':path']), {
                selection: new vscode__WEBPACK_IMPORTED_MODULE_4__.Range(new vscode__WEBPACK_IMPORTED_MODULE_4__.Position(ln, o[':col_s']), new vscode__WEBPACK_IMPORTED_MODULE_4__.Position(ln, o[':col_e'])),
            });
            return false;
        },
        _dropFile: (_, o) => {
            const { ':id_tag': id_tag, fn, ext, url, buf, old_fn, old_url } = o;
            const di = this.#hDCId2DI[id_tag];
            if (!di)
                return false;
            let urlWrite = '';
            if (url) {
                urlWrite = url.replace('${pathbase}', this.#pathWs + '/doc');
                if (fn === old_fn) {
                    let eq = true;
                    const bufFromPrj = (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.readFileSync)(urlWrite);
                    const len = bufFromPrj.length;
                    if (len !== buf.length)
                        eq = false;
                    else
                        for (let i = 0; i < len; ++i) {
                            if (bufFromPrj[i] !== buf[i]) {
                                eq = false;
                                break;
                            }
                        }
                    if (eq)
                        return false;
                }
            }
            else {
                const parent = (0,node_path__WEBPACK_IMPORTED_MODULE_5__.basename)((0,node_path__WEBPACK_IMPORTED_MODULE_5__.dirname)(old_url));
                urlWrite = this.#pathWs + `/doc/prj/${parent}/${fn}.${ext}`;
                const oAP = { ':cnt': 1 };
                oAP[ext] = `${parent}/${fn}.${ext}`;
                this.send2SN('_addPath', { fn, o: oAP });
            }
            const fwPathJs = vscode__WEBPACK_IMPORTED_MODULE_4__.workspace.createFileSystemWatcher(new vscode__WEBPACK_IMPORTED_MODULE_4__.RelativePattern(this.wsFld, 'doc/prj/path.json'));
            fwPathJs.onDidChange(() => {
                fwPathJs.dispose();
                let token = di[':token'];
                const o2 = { fn, b_pic: fn, pic: fn };
                const fnc = () => {
                    for (const [k, v] of Object.entries(o2))
                        token = token.replace(new RegExp(`(\\s${k}=)(['"#]*)(?:\\S+)\\2([\\s\\]])`), `$1${v}$3`);
                    di[':token'] = token;
                    const ed = new vscode__WEBPACK_IMPORTED_MODULE_4__.WorkspaceEdit;
                    ed.replace(di.uri, di.rng, token);
                    vscode__WEBPACK_IMPORTED_MODULE_4__.workspace.applyEdit(ed);
                };
                (0,image_size_fromFile__WEBPACK_IMPORTED_MODULE_3__.imageSizeFromFile)(urlWrite)
                    .then(({ width, height }) => {
                    o2.width = String(width);
                    o2.height = String(height);
                    fnc();
                })
                    .catch(() => fnc());
            });
            (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.writeFileSync)(urlWrite, buf);
            return false;
        },
    };
    #hDCId2DI = {};
    static noticeChgDoc(curPrj, e) {
        const dbg = Debugger.#hcurPrj2Dbg[curPrj];
        if (!dbg)
            return;
        const hRepTkn = {};
        for (const c of e.contentChanges) {
            const sa = c.text.length - c.rangeLength;
            for (const [id_tag, di] of Object.entries(dbg.#hDCId2DI)) {
                if (!di.rng.contains(c.range))
                    continue;
                di[':col_e'] += sa;
                di.rng = di.rng.with(di.rng.start, di.rng.end.translate(0, sa));
                const n = e.document.getText(di.rng);
                di[':token'] = n;
                if (n.at(0) !== '[' || n.at(-1) !== ']')
                    continue;
                hRepTkn[id_tag] = { ...di, ':id_tag': id_tag, };
            }
        }
        for (const v of Object.values(hRepTkn))
            dbg.send2SN('_replaceToken', v);
    }
    restart = (ri) => new Promise(res => {
        this.send2SN('restart', { ri });
        this.#hProcSnRes[ri] = () => { res(); return true; };
    });
    continue = (reverse = false) => this.send2SN('continue', { reverse });
    step = (reverse = false) => this.send2SN('stepover', { reverse });
    stepin = () => this.send2SN('stepin');
    stepout = () => this.send2SN('stepout');
    pause = () => this.send2SN('pause');
    var = (ri, scope) => new Promise(res => {
        this.send2SN('var', { ri, scope });
        this.#hProcSnRes[ri] = (_, o) => { res(o.v); return true; };
    });
    stack = (ri, start, end) => new Promise(res => {
        this.send2SN('stack', { ri });
        this.#hProcSnRes[ri] = (_, o) => {
            if (!Array.isArray(o.a)) {
                res([]);
                return true;
            }
            res(o.a.slice(start, end)
                .filter(v => v.ma
                ? (JSON.parse(v.ma ?? '{}').stepin ?? 'true') === 'true'
                : true)
                .map(v => {
                v.fn = v.fn.replace('${pathbase}', this.#pathWs + '/doc');
                return v;
            }));
            return true;
        };
    });
    eval = (ri, txt) => new Promise(res => {
        this.send2SN('eval', { ri, txt });
        this.#hProcSnRes[ri] = (_, o) => { res(o.v); return true; };
    });
    #idBP = 0;
    #hFn2hLineBP = {};
    setBreakPoints(fn, a) {
        const aBp = a.map(o => ({
            id: ++this.#idBP,
            ln: o.line,
            col: o.column,
            verified: true,
            condition: o.condition,
            hitCondition: o.hitCondition,
        }));
        const o = {};
        this.#loadSource(fn);
        const sl = this.#hScriptLines[fn];
        const len_sl = sl.length;
        for (const v of aBp) {
            while (sl[v.ln - 1].replace(/;.*$/, '').trim() === '') {
                if (v.ln++ === len_sl) {
                    v.verified = false;
                    break;
                }
            }
            o[v.ln] = v;
            this.#sendEvent2Adpt('breakpointValidated', v);
        }
        this.send2SN('add_break', { fn, o });
        this.#hFn2hLineBP[fn] = o;
        return aBp;
    }
    #hScriptLines = {};
    #loadSource(fn) {
        if (fn in this.#hScriptLines)
            return;
        this.#hScriptLines[fn] = (0,fs_extra__WEBPACK_IMPORTED_MODULE_6__.readFileSync)(fn).toString().split('\n');
    }
    #aDataBreak = [];
    setDataBreakpoint = (ri, a) => new Promise(res => {
        this.#aDataBreak = a;
        this.send2SN('set_data_break', { ri, a });
        this.#hProcSnRes[ri] = (_, o) => { res(o.v); return true; };
    });
    #aFuncBreak = [];
    setFuncBreakpoint = (ri, a) => new Promise(res => {
        this.#aFuncBreak = a;
        this.send2SN('set_func_break', { ri, a });
        this.#hProcSnRes[ri] = (_, o) => { res(o.v); return true; };
    });
    setVariable = (ri, nm, val) => new Promise(res => {
        this.send2SN('set_var', { ri, nm, val });
        this.#hProcSnRes[ri] = (_, o) => { res(o.v); return true; };
    });
    #sendEvent2Adpt(type, ...args) {
        setImmediate(() => this.emit(type, ...args));
    }
}


/***/ }),

/***/ "./src/Encryptor.ts":
/*!**************************!*\
  !*** ./src/Encryptor.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   Encryptor: () => (/* binding */ Encryptor),
/* harmony export */   ab2hexStr: () => (/* binding */ ab2hexStr),
/* harmony export */   decBase64Ab: () => (/* binding */ decBase64Ab),
/* harmony export */   decBase64Str: () => (/* binding */ decBase64Str),
/* harmony export */   encAbBase64: () => (/* binding */ encAbBase64),
/* harmony export */   encStrBase64: () => (/* binding */ encStrBase64),
/* harmony export */   hexStr2ab: () => (/* binding */ hexStr2ab)
/* harmony export */ });
/* harmony import */ var uuid__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! uuid */ "./node_modules/uuid/dist-node/v5.js");

function hexStr2ab(i) {
    return new Uint8Array(i.match(/../g)?.map(h => parseInt(h, 16)) ?? []).buffer;
}
function ab2hexStr(ab) {
    return [...new Uint8Array(ab)]
        .map(x => x.toString(16).padStart(2, '0')).join('');
}
function encAbBase64(ab) {
    return btoa(new Uint8Array(ab)
        .reduce((binStr, uint8) => binStr + String.fromCharCode(uint8), ''));
}
function decBase64Ab(base64) {
    return Uint8Array.from(atob(base64), binCh => binCh.charCodeAt(0));
}
function encStrBase64(s) {
    return encAbBase64(new TextEncoder().encode(s).buffer);
}
function decBase64Str(base64) {
    return new TextDecoder().decode(decBase64Ab(base64));
}
class Encryptor {
    hPass;
    subtle;
    #strHPass;
    #acp;
    constructor(hPass, subtle) {
        this.hPass = hPass;
        this.subtle = subtle;
        this.#strHPass = JSON.stringify(hPass);
        this.#acp = { name: 'AES-GCM', iv: hexStr2ab(hPass.iv) };
    }
    get strHPass() { return this.#strHPass; }
    #digest(s) {
        return this.subtle.digest('SHA-512', new TextEncoder().encode(s));
    }
    uuidv5(d) { return (0,uuid__WEBPACK_IMPORTED_MODULE_0__["default"])(d, this.hPass.pass); }
    async init() {
        const keyMaterial = await this.subtle.importKey('raw', await this.#digest(this.hPass.pass), 'PBKDF2', false, ['deriveKey']);
        this.#key = await this.subtle.deriveKey({
            name: 'PBKDF2',
            hash: 'SHA-512',
            iterations: this.hPass.ite,
            salt: hexStr2ab(this.hPass.salt),
        }, keyMaterial, { name: this.#acp.name, length: 256 }, false, ['encrypt', 'decrypt']);
    }
    #key;
    encAb(ab) {
        return this.subtle.encrypt(this.#acp, this.#key, ab);
    }
    async enc(tx) {
        return encAbBase64(await this.encAb(new TextEncoder().encode(tx).buffer));
    }
    decAb(ab) {
        return this.subtle.decrypt(this.#acp, this.#key, ab);
    }
    async dec(encTx) {
        return new TextDecoder().decode(await this.decAb(decBase64Ab(encTx).buffer));
    }
}


/***/ }),

/***/ "./src/EncryptorTransform.ts":
/*!***********************************!*\
  !*** ./src/EncryptorTransform.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EncryptorTransform: () => (/* binding */ EncryptorTransform)
/* harmony export */ });
/* harmony import */ var node_stream__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! node:stream */ "node:stream");
/* harmony import */ var node_stream__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(node_stream__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var node_buffer__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! node:buffer */ "node:buffer");
/* harmony import */ var node_buffer__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(node_buffer__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_2__);



const LEN_CODE = 1024 * 10;
class EncryptorTransform extends node_stream__WEBPACK_IMPORTED_MODULE_0__.Transform {
    encry;
    short_path;
    #len_code = LEN_CODE;
    #ite = 2;
    #bh;
    #hExt2N = {
        'jpg': 1,
        'jpeg': 1,
        'png': 2,
        'svg': 3,
        'webp': 4,
        'mp3': 10,
        'm4a': 11,
        'ogg': 12,
        'aac': 13,
        'flac': 14,
        'wav': 15,
        'mp4': 20,
        'webm': 21,
        'ogv': 22,
    };
    constructor(encry, short_path) {
        super();
        this.encry = encry;
        this.short_path = short_path;
        this.#bh = node_buffer__WEBPACK_IMPORTED_MODULE_1__.Buffer.alloc(this.#ite + this.#len_code);
        this.#bh[0] = 0;
        this.#bh[1] = this.#hExt2N[(0,node_path__WEBPACK_IMPORTED_MODULE_2__.extname)(short_path).slice(1)] ?? 0;
    }
    _transform(chunk, _enc, cb) {
        const size = chunk.length;
        if (this.#len_code === 0) {
            this.push(chunk);
            cb();
            return;
        }
        if (size < this.#len_code) {
            this.#bh.set(chunk, this.#ite);
            this.#ite += size;
            this.#len_code -= size;
            cb();
            return;
        }
        this.#bh.set(chunk.slice(0, this.#len_code), this.#ite);
        this.#ite += this.#len_code;
        const code_size = this.#len_code;
        void this.#codeArea().then(() => {
            if (size > code_size) {
                this.push(chunk.slice(code_size));
            }
            cb();
        });
    }
    _final(cb) {
        void this.#codeArea().then(() => cb());
    }
    async #codeArea() {
        if (this.#len_code === 0)
            return;
        this.#len_code = 0;
        const e = await this.encry.encAb(this.#bh.buffer.slice(0, this.#ite));
        const bl = node_buffer__WEBPACK_IMPORTED_MODULE_1__.Buffer.alloc(4);
        bl.writeUInt32LE(e.byteLength, 0);
        this.push(bl);
        this.push(new Uint8Array(e));
    }
}


/***/ }),

/***/ "./src/HDiff.ts":
/*!**********************!*\
  !*** ./src/HDiff.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   HDiff: () => (/* binding */ HDiff)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _Project__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Project */ "./src/Project.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var crc_32__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! crc-32 */ "./node_modules/crc-32/crc32.js");
/* harmony import */ var crc_32__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(crc_32__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! fs-extra/esm */ "./node_modules/fs-extra/lib/esm.mjs");







class HDiff {
    PATH_DIFF;
    FLD_SRC;
    PATH_CRYPT;
    encry;
    #pp2hDiff = Object.create(null);
    constructor(PATH_DIFF, FLD_SRC, PATH_CRYPT, encry) {
        this.PATH_DIFF = PATH_DIFF;
        this.FLD_SRC = FLD_SRC;
        this.PATH_CRYPT = PATH_CRYPT;
        this.encry = encry;
        const REG_path2 = `\\/(doc\\/prj|${FLD_SRC}\\/${_PrjCmn__WEBPACK_IMPORTED_MODULE_2__.FLD_PRJ_BASE})\\/`;
        this.#REG_path2cn = new RegExp(REG_path2 + '.+$');
        this.#REG_fp2pp = new RegExp('^.+' + REG_path2);
    }
    async init() {
        if ((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)(this.PATH_DIFF))
            this.#pp2hDiff = await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.readJson)(this.PATH_DIFF);
        for (const [pp, { cn }] of Object.entries(this.#pp2hDiff)) {
            const fp = `${this.PATH_CRYPT}${cn}`;
            if (!(0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)(fp))
                delete this.#pp2hDiff[pp];
        }
    }
    clear() { this.#pp2hDiff = Object.create(null); }
    del(pp) { delete this.#pp2hDiff[pp]; }
    get(pp) { return this.#pp2hDiff[pp]; }
    get keysPP() { return Object.keys(this.#pp2hDiff); }
    path2cn(afp) {
        const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(afp).path);
        const pp = this.fp2pp(fp);
        const diff = this.#pp2hDiff[pp];
        return {
            pathCn: diff
                ? fp.replace(this.#REG_path2cn, `/${_Project__WEBPACK_IMPORTED_MODULE_1__.FLD_CRYPT_DOC}/prj/${diff.cn}`)
                : undefined,
            diff,
            pp,
        };
    }
    #REG_path2cn;
    #REG_fp2pp;
    fp2pp(fp) { return fp.replace(this.#REG_fp2pp, ''); }
    filter(regDiff) {
        return Promise.allSettled(Object.entries(this.#pp2hDiff)
            .filter(([pp,]) => regDiff.test(pp))
            .map(([, { cn }]) => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.remove)(`${this.PATH_CRYPT}${cn}`)));
    }
    save = () => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.PATH_DIFF, this.#pp2hDiff);
    isDiff({ path }) {
        const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(path);
        const { pathCn, diff, pp } = this.path2cn(fp);
        if (pathCn && !(0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)(pathCn))
            return true;
        let hash = 0;
        if (_Project__WEBPACK_IMPORTED_MODULE_1__.REG_FULLCRYPTO.test(fp)) {
            hash = crc_32__WEBPACK_IMPORTED_MODULE_4__.buf(Buffer.from((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.readFileSync)(fp, { encoding: 'utf8' }), 'binary'), 0);
        }
        else {
            this.#bufChkDiff.fill(0, 0, this.#LEN_CHKDIFF);
            const fd = (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.openSync)(fp, 'r');
            (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.readSync)(fd, this.#bufChkDiff, 0, this.#LEN_CHKDIFF, 0);
            (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.closeSync)(fd);
            hash = crc_32__WEBPACK_IMPORTED_MODULE_4__.buf(this.#bufChkDiff, 0);
        }
        if (diff?.hash === hash)
            return false;
        this.#pp2hDiff[pp] = {
            hash,
            cn: _Project__WEBPACK_IMPORTED_MODULE_1__.REG_NEEDCRYPTO.test(pp)
                ? pp
                    .replace(this.#REG_SPATH2HFN, `$1/${this.encry.uuidv5(pp)}$2`)
                    .replace(this.#REG_REPPATHJSON, '.bin')
                : pp,
        };
        return true;
    }
    #LEN_CHKDIFF = 1024 * 20;
    #REG_SPATH2HFN = /([^/]+)\/[^/]+(\.\w+)/;
    #bufChkDiff = new Uint8Array(this.#LEN_CHKDIFF);
    #REG_REPPATHJSON = /\.(jpe?g|png|svg|webp|mp3|m4a|ogg|aac|flac|wav|mp4|webm|ogv)/g;
}


/***/ }),

/***/ "./src/PrjCmn.ts":
/*!***********************!*\
  !*** ./src/PrjCmn.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FLD_PRJ_BASE: () => (/* binding */ FLD_PRJ_BASE),
/* harmony export */   PrjCmn: () => (/* binding */ PrjCmn)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _WorkSpaces__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./WorkSpaces */ "./src/WorkSpaces.ts");
/* harmony import */ var _PrjTreeItem__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./PrjTreeItem */ "./src/PrjTreeItem.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_4__);





const FLD_PRJ_BASE = 'prj_base';
const hTask2Inf = {
    cnv_mat_pic: {
        title: '画像ファイル最適化',
        aNeedLib: ['fs-extra', 'sharp'],
    },
    cnv_mat_snd: {
        title: '音声ファイル最適化',
        aNeedLib: [],
    },
    cnv_psd_face: {
        title: 'PSDファイル変換',
        aNeedLib: ['fs-extra', 'sharp'],
    },
    cut_round: {
        title: 'アイコン生成・加工中',
        aNeedLib: ['fs-extra', 'sharp', 'png2icons'],
    },
    subset_font: {
        title: 'フォントサイズ最適化',
        aNeedLib: [],
    },
};
class PrjCmn {
    ctx;
    wsFld;
    hOnEndTask;
    URI_WS;
    PATH_WS;
    LEN_PATH_WS;
    PATH_PRJ;
    LEN_PATH_PRJ;
    IS_NEW_TMP;
    FLD_SRC;
    PATH_PLG_PRE;
    PATH_PRJ_BASE;
    LEN_PATH_PRJ_BASE;
    wss;
    hTaskExe = new Map;
    constructor(ctx, wsFld, hOnEndTask) {
        this.ctx = ctx;
        this.wsFld = wsFld;
        this.hOnEndTask = hOnEndTask;
        this.URI_WS = wsFld.uri.toString();
        this.PATH_WS = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(wsFld.uri.path);
        this.LEN_PATH_WS = this.PATH_WS.length;
        this.PATH_PRJ = `${this.PATH_WS}/doc/prj/`;
        this.LEN_PATH_PRJ = this.PATH_PRJ.length;
        this.IS_NEW_TMP = (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.existsSync)(`${this.PATH_WS}/src/plugin/`);
        this.FLD_SRC = this.IS_NEW_TMP ? 'src' : 'core';
        this.PATH_PLG_PRE = `${this.PATH_WS}/${this.FLD_SRC}/plugin/snsys_pre/`;
        this.PATH_PRJ_BASE = `${this.PATH_WS}/${this.FLD_SRC}/${FLD_PRJ_BASE}/`;
        this.LEN_PATH_PRJ_BASE = this.PATH_PRJ_BASE.length;
        this.wss = ctx.workspaceState;
    }
    fp2pp(fp) { return fp.slice(this.LEN_PATH_PRJ); }
    fp2wp(fp) { return fp.slice(this.LEN_PATH_WS); }
    src2pp(fp) { return fp.slice(this.LEN_PATH_PRJ_BASE); }
    isBaseUrl(fp) { return fp.startsWith(this.PATH_PRJ_BASE); }
    init(updPathJson, encIfNeeded, diff, isCryptoMode, ps) {
        this.updPathJson = updPathJson;
        this.encIfNeeded = encIfNeeded;
        this.#diff = diff;
        this.isCryptoMode = isCryptoMode;
        this.ps = ps;
    }
    updPathJson;
    encIfNeeded;
    #diff;
    get diff() { return this.#diff; }
    ps;
    isCryptoMode;
    async exeBatch(nm, arg, fisish = (_exit_code) => { }) {
        const inf = hTask2Inf[nm];
        return vscode__WEBPACK_IMPORTED_MODULE_3__.window.withProgress({
            location: vscode__WEBPACK_IMPORTED_MODULE_3__.ProgressLocation.Notification,
            title: inf.title,
            cancellable: false,
        }, prg => new Promise(donePrg => {
            const oPkg = (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.readJsonSync)(this.PATH_WS + '/package.json', { encoding: 'utf8' });
            const sNeedInst = inf.aNeedLib
                .filter(nm => !(oPkg.devDependencies ??= {})[nm]).join(' ');
            const pathJs = this.PATH_WS + `/${this.FLD_SRC}/batch/${nm}.js`;
            (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.copySync)(this.ctx.extensionPath + `/dist/${nm}.js`, pathJs);
            try {
                vscode__WEBPACK_IMPORTED_MODULE_3__.tasks.executeTask(new vscode__WEBPACK_IMPORTED_MODULE_3__.Task({ type: _WorkSpaces__WEBPACK_IMPORTED_MODULE_1__.PRE_TASK_TYPE + 'Sys' }, this.wsFld, inf.title, 'SKYNovel', new vscode__WEBPACK_IMPORTED_MODULE_3__.ShellExecution(`cd "${this.PATH_WS}" ${_PrjTreeItem__WEBPACK_IMPORTED_MODULE_2__.statBreak} ${sNeedInst
                    ? `npm i -D ${sNeedInst} ${_PrjTreeItem__WEBPACK_IMPORTED_MODULE_2__.statBreak}`
                    : ''} node ./${this.FLD_SRC}/batch/${nm}.js ${arg}`)))
                    .then(r => this.hTaskExe.set('Batch', r));
            }
            catch (e) {
                console.error('Project exeTask() e:%o', e);
            }
            this.hOnEndTask.set('Sys', e => {
                prg.report({ message: '完了', increment: 100 });
                fisish(e.exitCode ?? 0);
                setTimeout(donePrg, 4000);
            });
        }));
    }
    addSeq(fnc, uniq) {
        if (!this.watchFile)
            return;
        if (this.#aQSeq.push({ uniq, fnc }) !== 1)
            return;
        if (this.#tiLasyQ)
            clearTimeout(this.#tiLasyQ);
        this.#tiLasyQ = setTimeout(() => { void this.doSeq(); }, 100);
    }
    #aQSeq = [];
    #tiLasyQ = undefined;
    watchFile = true;
    async doSeq() {
        this.watchFile = false;
        let q;
        while (q = this.#aQSeq.shift()) {
            const uniq = q.uniq;
            this.#aQSeq = this.#aQSeq.filter(v => v.uniq !== uniq);
            await q.fnc();
        }
        this.watchFile = true;
    }
}


/***/ }),

/***/ "./src/PrjSetting.ts":
/*!***************************!*\
  !*** ./src/PrjSetting.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PrjSetting: () => (/* binding */ PrjSetting)
/* harmony export */ });
/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./types */ "./src/types.ts");
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var _WorkSpaces__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./WorkSpaces */ "./src/WorkSpaces.ts");
/* harmony import */ var _WPFolder__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./WPFolder */ "./src/WPFolder.ts");
/* harmony import */ var _batch_WfbSettingSn__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./batch/WfbSettingSn */ "./src/batch/WfbSettingSn.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_6__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_7___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_7__);
/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! path */ "path");
/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_8___default = /*#__PURE__*/__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_8__);
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! crypto */ "crypto");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_9___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_9__);
/* harmony import */ var os__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! os */ "os");
/* harmony import */ var os__WEBPACK_IMPORTED_MODULE_10___default = /*#__PURE__*/__webpack_require__.n(os__WEBPACK_IMPORTED_MODULE_10__);











class PrjSetting {
    pc;
    cfg;
    setTitle;
    reqPrj2LSP;
    optPic;
    optSnd;
    optFont;
    #wss;
    #oWss = _types__WEBPACK_IMPORTED_MODULE_0__.DEF_WSS;
    get oWss() { return this.#oWss; }
    #PATH_PRJ_JSON;
    #PATH_APP_JS;
    #PATH_PKG_JSON;
    #PATH_INS_NSH;
    #PATH_ICON;
    #PATH_README4FREEM;
    #uriRes;
    #htmSrc = '';
    #pnlWVFolder;
    get pnlWVFolder() { return this.#pnlWVFolder; }
    #stgSn;
    #ds = [];
    #setEscape;
    constructor(pc, cfg, setTitle, reqPrj2LSP, optPic, optSnd, optFont) {
        this.pc = pc;
        this.cfg = cfg;
        this.setTitle = setTitle;
        this.reqPrj2LSP = reqPrj2LSP;
        this.optPic = optPic;
        this.optSnd = optSnd;
        this.optFont = optFont;
        this.#wss = this.pc.ctx.workspaceState;
        const oWss = _types__WEBPACK_IMPORTED_MODULE_0__.DEF_WSS;
        for (const [nm, v] of Object.entries(oWss)) {
            const d = this.#wss.get(nm);
            if (d)
                oWss[nm] = d;
            else
                void this.#wss.update(nm, v);
        }
        this.#oWss = oWss;
        this.#PATH_PRJ_JSON = this.pc.PATH_PRJ + 'prj.json';
        this.#PATH_APP_JS = this.pc.PATH_WS + '/doc/app.js';
        this.#PATH_PKG_JSON = this.pc.PATH_WS + '/package.json';
        this.#pnlWVFolder = new _WPFolder__WEBPACK_IMPORTED_MODULE_4__.WPFolder(this.pc);
        this.#stgSn = new _batch_WfbSettingSn__WEBPACK_IMPORTED_MODULE_5__.WfbSettingSn(this.pc, reqPrj2LSP);
        this.#PATH_README4FREEM = this.pc.PATH_WS + '/build/include/readme.txt';
        this.#PATH_INS_NSH = this.pc.PATH_WS + '/build/installer.nsh';
        this.#PATH_ICON = this.pc.PATH_WS + '/build/icon.png';
        this.#setEscape = () => reqPrj2LSP({ cmd: 'need_go' });
        const path_ext = this.pc.ctx.extensionPath;
        const path_vue_root = path_ext + '/dist/';
        this.#uriRes = vscode__WEBPACK_IMPORTED_MODULE_6__.Uri.file(path_vue_root);
        void Promise.allSettled([
            () => Promise.try(() => {
                setTitle(cfg.oCfg.book.title);
                PrjSetting.#hWsFld2token[this.pc.wsFld.uri.path] = () => cfg.oCfg.debuger_token;
            }),
            async () => {
                this.#htmSrc = (await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readFile)(path_vue_root + 'setting.html', { encoding: 'utf8' }))
                    .replace('<meta_autooff ', '<meta ')
                    .replaceAll('${nonce}', (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.getNonce)())
                    .replace('.ts"></script>', '.js"></script>');
                if (this.#setTmp_save_ns.has(cfg.oCfg.save_ns))
                    this.open();
            },
            () => this.#stgSn.init(),
            async () => {
                if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(this.#PATH_README4FREEM)) {
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.ensureFile)(this.#PATH_README4FREEM);
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.copyFile)(path_ext + '/res/readme.txt', this.#PATH_README4FREEM);
                }
                if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(this.#PATH_INS_NSH))
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.copyFile)(path_ext + '/res/installer.nsh', this.#PATH_INS_NSH);
                if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(this.#PATH_ICON))
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.copyFile)(path_ext + '/res/img/icon.png', this.#PATH_ICON);
                const fnLaunchJs = this.pc.PATH_WS + '/.vscode/launch.json';
                if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(fnLaunchJs))
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.copyFile)(path_ext + '/res/launch.json', fnLaunchJs);
            },
        ].map(p => p()));
    }
    #setTmp_save_ns = new Set([
        'tmp_esm_uc',
        'tmp_cjs_sample',
        'tmp_cjs_hatsune',
        'tmp_cjs_uc',
        'sn_sample',
        'hatsune',
        'uc',
    ]);
    dispose() { for (const d of this.#ds)
        d.dispose(); }
    getLocalSNVer() {
        const oPkg = (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readJsonSync)(this.#PATH_PKG_JSON, { encoding: 'utf8' });
        const fnCngLog = this.pc.PATH_WS + '/CHANGELOG.md';
        const lib_name = `@famibee/skynovel${this.pc.IS_NEW_TMP ? '_esm' : ''}`;
        return {
            verSN: oPkg.dependencies?.[lib_name]?.slice(1) ?? '',
            verTemp: (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(fnCngLog)
                ? /## v(.+)\s/.exec((0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readFileSync)(fnCngLog, { encoding: 'utf8' }))?.[1] ?? ''
                : '',
        };
    }
    static #hWsFld2token = {};
    static getDebugertoken(wsFld) {
        if (!wsFld)
            return '';
        return PrjSetting.#hWsFld2token[wsFld.uri.path]?.() ?? '';
    }
    async onCreDir({ path }) {
        this.cfg.oCfg.code[(0,path__WEBPACK_IMPORTED_MODULE_8__.basename)(path)] = false;
        await this.cmd2Vue({ cmd: 'update.oCfg', oCfg: this.cfg.oCfg });
    }
    async onDelDir({ path }) {
        delete this.cfg.oCfg.code[(0,path__WEBPACK_IMPORTED_MODULE_8__.basename)(path)];
        void this.#writePrjJs();
        await this.cmd2Vue({ cmd: 'update.oCfg', oCfg: this.cfg.oCfg });
        this.#pnlWVFolder.close();
    }
    #writePrjJs() {
        const o = { ...this.cfg.oCfg };
        o.code = {};
        for (const [nm, v] of Object.entries(this.cfg.oCfg.code)) {
            if (v)
                o.code[nm] = true;
        }
        return (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.writeFile)(this.#PATH_PRJ_JSON, JSON.stringify(o, null, '\t'));
    }
    #wp = undefined;
    #pathIcon;
    open() {
        if (!_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.ActivityBar.aReady[_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.eTreeEnv.NPM])
            return;
        const column = vscode__WEBPACK_IMPORTED_MODULE_6__.window.activeTextEditor?.viewColumn;
        if (this.#wp) {
            this.#wp.reveal(column);
            const wv = this.#wp.webview;
            wv.html = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.repWvUri)(this.#htmSrc, wv, this.#uriRes);
            return;
        }
        const p = this.#wp = vscode__WEBPACK_IMPORTED_MODULE_6__.window.createWebviewPanel('SKYNovel-setting', '設定', column ?? vscode__WEBPACK_IMPORTED_MODULE_6__.ViewColumn.One, {
            enableScripts: true,
            localResourceRoots: [
                this.#uriRes,
                vscode__WEBPACK_IMPORTED_MODULE_6__.Uri.file(this.pc.PATH_WS),
            ],
        });
        p.onDidDispose(() => {
            this.#wp = undefined;
            this.cmd2Vue = _ => Promise.resolve(false);
        }, undefined, this.pc.ctx.subscriptions);
        const wv = p.webview;
        this.#wvuWs = wv.asWebviewUri(vscode__WEBPACK_IMPORTED_MODULE_6__.Uri.file(this.pc.PATH_WS));
        this.#pathIcon = `${String(this.#wvuWs)}/build/icon.png`;
        this.cmd2Vue = async (mes) => wv.postMessage(mes);
        wv.onDidReceiveMessage((m) => this.#onDidReceiveMessage(m), undefined, this.pc.ctx.subscriptions);
        wv.html = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.repWvUri)(this.#htmSrc, wv, this.#uriRes);
    }
    cmd2Vue = _ => Promise.resolve(false);
    #wvuWs;
    get wvuWs() { return String(this.#wvuWs); }
    async #onDidReceiveMessage(m) {
        switch (m.cmd) {
            case '?':
                await Promise.allSettled([
                    (async () => {
                        await this.cmd2Vue({
                            cmd: '!',
                            oCfg: this.cfg.oCfg,
                            oWss: this.#oWss,
                            pathIcon: this.#pathIcon,
                            fld_src: this.pc.FLD_SRC,
                        });
                        this.#stgSn.chkMultiMatch();
                    })(),
                    this.optFont.disp(),
                    this.optPic.disp(),
                    this.optSnd.disp(),
                ]);
                break;
            case 'update.oCfg':
                {
                    const { oCfg } = m;
                    const escOld = this.cfg.oCfg.init.escape;
                    const oc = this.cfg.oCfg;
                    const save_ns = oCfg.save_ns ?? oc.save_ns;
                    const c = this.cfg.oCfg = {
                        ...oc,
                        book: { ...oc.book, ...oCfg.book },
                        save_ns,
                        window: { ...oc.window, ...oCfg.window },
                        log: { ...oc.log, ...oCfg.log },
                        init: { ...oc.init, ...oCfg.init },
                        debug: { ...oc.debug, ...oCfg.debug },
                        code: { ...oc.code, ...oCfg.code },
                        debuger_token: this.#setTmp_save_ns.has(save_ns)
                            ? ''
                            : (oCfg.debuger_token ?? oc.debuger_token) || (0,crypto__WEBPACK_IMPORTED_MODULE_9__.randomUUID)(),
                    };
                    if (c.init.escape !== escOld)
                        await this.#setEscape();
                    await this.#writePrjJs();
                    this.setTitle(c.book.title);
                    const CopyrightYear = new Date().getFullYear();
                    const p = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readJson)(this.#PATH_PKG_JSON, { encoding: 'utf8' });
                    p.name = c.save_ns;
                    p.appBundleId = p.appId = `com.fc2.blog.famibee.skynovel.${c.save_ns}`;
                    p.version = c.book.version;
                    p.productName = c.book.title;
                    p.author = c.book.creator;
                    p.appCopyright = `(c)${c.book.creator}`;
                    p.homepage = c.book.pub_url;
                    p.description = c.book.detail;
                    p.build.appId = p.appId;
                    p.build.productName = c.book.title.normalize('NFD');
                    p.build.artifactName = '${name}-${version}-${arch}.${ext}';
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.writeFile)(this.#PATH_PKG_JSON, JSON.stringify(p, null, '\t'));
                    if (this.pc.IS_NEW_TMP)
                        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceRegsFile)(this.pc.PATH_WS + '/src/main/main.ts', [
                            [
                                /(companyName\s*:\s*)(['"]).*\2/,
                                `$1"${c.book.publisher}"`
                            ],
                            [
                                /(pkg.appCopyright \+' )\d+/,
                                `$1${CopyrightYear}`
                            ],
                        ], false);
                    else
                        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceRegsFile)(this.#PATH_APP_JS, [
                            [
                                /(companyName\s*:\s*)(['"]).*\2/,
                                `$1"${c.book.publisher}"`
                            ],
                            [
                                /(pkg.appCopyright \+' )\d+/,
                                `$1${CopyrightYear}`
                            ],
                        ], false);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceRegsFile)(this.#PATH_README4FREEM, [
                        [/(【Version】)[^\n]+/g, `$1${c.book.version}`],
                        [/(【タイトル】)[^\n]+/g, `$1${c.book.title}`],
                        [/(【著 作 者】)[^\n]+/g, `$1${c.book.creator}`],
                        [/(【連 絡 先】メール： )[^\n]+/, `$1${c.book.cre_url}`],
                        [
                            /(Copyright \(C\) )\d+ "([^"]+)"/g,
                            `$1${CopyrightYear} "${c.book.publisher}"`
                        ],
                        [/(　　　　　　ＷＥＢ： )[^\n]+/g, `$1${c.book.pub_url}`],
                    ], false);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceRegsFile)(this.#PATH_INS_NSH, [
                        [/(!define PUBLISHER ").+"/, `$1${c.book.publisher}"`],
                    ], false);
                }
                break;
            case 'change.range.webp_q_def':
                await this.optPic.chgWebp_q_def(m);
                break;
            case 'change.range.webp_q':
                await this.optPic.chgWebp_q(m);
                break;
            case 'update.oWss':
                for (const [id, val] of Object.entries(m.oWss)) {
                    const old_val = this.#oWss[id];
                    if (old_val === val)
                        continue;
                    await this.#wss.update(id, val);
                    this.#oWss[id] = val;
                    switch (id) {
                        case 'cnv.font.subset': break;
                        case 'cnv.mat.pic': break;
                        case 'cnv.mat.snd': break;
                        case 'cnv.mat.snd.codec': break;
                        default: continue;
                    }
                    const o = { cmd: 'notice.Component', id, mode: 'wait' };
                    await this.cmd2Vue(o);
                    const go = await this.#onSettingEvt(id, String(val));
                    if (go)
                        o.mode = 'comp';
                    else {
                        await this.#wss.update(id, this.#oWss[id] = old_val);
                        o.mode = 'cancel';
                    }
                    await this.cmd2Vue(o);
                    break;
                }
                break;
            case 'update.aTemp':
                this.#stgSn.update(m);
                break;
            case 'info':
                vscode__WEBPACK_IMPORTED_MODULE_6__.window.showInformationMessage(m.mes);
                break;
            case 'warn':
                vscode__WEBPACK_IMPORTED_MODULE_6__.window.showWarningMessage(m.mes);
                break;
            case 'openURL':
                (0,_WorkSpaces__WEBPACK_IMPORTED_MODULE_3__.openURL)(vscode__WEBPACK_IMPORTED_MODULE_6__.Uri.parse(m.url), this.pc.PATH_WS);
                break;
            case 'copyTxt':
                {
                    if (m.id !== 'copy.folder_save_app')
                        break;
                    const { username } = (0,os__WEBPACK_IMPORTED_MODULE_10__.userInfo)();
                    switch (process.platform) {
                        case 'win32':
                            await vscode__WEBPACK_IMPORTED_MODULE_6__.env.clipboard.writeText(`C:\\Users\\${username}\\AppData\\Roaming\\${this.cfg.oCfg.save_ns}\\storage\\`);
                            break;
                        case 'darwin':
                            await vscode__WEBPACK_IMPORTED_MODULE_6__.env.clipboard.writeText(`/Users/${username}/Library/Application Support/${this.cfg.oCfg.save_ns}/storage/`);
                            break;
                        case 'linux':
                            await vscode__WEBPACK_IMPORTED_MODULE_6__.env.clipboard.writeText(`~/.config/${this.cfg.oCfg.save_ns}/storage/`);
                            break;
                    }
                    vscode__WEBPACK_IMPORTED_MODULE_6__.window.showInformationMessage('クリップボードに【アプリ版（通常実行）セーブデータ保存先パス】をコピーしました');
                }
                break;
            case 'selectFile':
                await this.optPic.cnvIconShape(m, this.#pathIcon);
                break;
        }
    }
    async #onSettingEvt(nm, val) {
        switch (nm) {
            case 'cnv.font.subset':
                if (await vscode__WEBPACK_IMPORTED_MODULE_6__.window.showInformationMessage('フォントサイズ最適化（する / しない）を切り替えますか？', { modal: true }, 'はい') !== 'はい')
                    return false;
                if (!_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.ActivityBar.aReady[_ActivityBar__WEBPACK_IMPORTED_MODULE_2__.eTreeEnv.PY_FONTTOOLS])
                    break;
                if ((0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.chkBoolean)(val))
                    await this.optFont.enable();
                else
                    await this.optFont.disable();
                break;
            case 'cnv.mat.pic':
                if (await vscode__WEBPACK_IMPORTED_MODULE_6__.window.showInformationMessage('画像ファイル最適化（する / しない）を切り替えますか？', { modal: true }, 'はい') !== 'はい')
                    return false;
                if ((0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.chkBoolean)(val))
                    await this.optPic.enable();
                else
                    await this.optPic.disable();
                break;
            case 'cnv.mat.snd':
                if (await vscode__WEBPACK_IMPORTED_MODULE_6__.window.showInformationMessage('音声ファイル最適化（する / しない）を切り替えますか？', { modal: true }, 'はい') !== 'はい')
                    return false;
                if ((0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.chkBoolean)(val))
                    await this.optSnd.enable();
                else
                    await this.optSnd.disable();
                break;
            case 'cnv.mat.snd.codec':
                await this.optSnd.reconv();
                break;
        }
        return true;
    }
}


/***/ }),

/***/ "./src/PrjTreeItem.ts":
/*!****************************!*\
  !*** ./src/PrjTreeItem.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PrjTreeItem: () => (/* binding */ PrjTreeItem),
/* harmony export */   eDevTreeView: () => (/* binding */ eDevTreeView),
/* harmony export */   statBreak: () => (/* binding */ statBreak),
/* harmony export */   updStatBreak: () => (/* binding */ updStatBreak)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_2__);



let statBreak = ';';
function updStatBreak(s) { statBreak = s; }
var eDevTreeView;
(function (eDevTreeView) {
    eDevTreeView[eDevTreeView["SnUpd"] = 0] = "SnUpd";
    eDevTreeView[eDevTreeView["ReBuild"] = 1] = "ReBuild";
    eDevTreeView[eDevTreeView["PrjSet"] = 2] = "PrjSet";
    eDevTreeView[eDevTreeView["Crypto"] = 3] = "Crypto";
    eDevTreeView[eDevTreeView["TaskWeb"] = 4] = "TaskWeb";
    eDevTreeView[eDevTreeView["TaskApp"] = 5] = "TaskApp";
    eDevTreeView[eDevTreeView["Pack"] = 6] = "Pack";
})(eDevTreeView || (eDevTreeView = {}));
class PrjTreeItem extends vscode__WEBPACK_IMPORTED_MODULE_2__.TreeItem {
    ctx;
    pathWs;
    cfg;
    static create(ctx, wsFld, onBtn, is_new_tmp) {
        const cfg = {
            cmd: '',
            icon: '',
            label: '',
            desc: wsFld.name,
            children: [
                { cmd: 'SnUpd', icon: 'skynovel', label: 'ベース更新',
                    task_type: 'Sys',
                    npm: `npm update${is_new_tmp
                        ? ''
                        : ` ${statBreak} npm run webpack:dev`}`,
                },
                { cmd: 'ReBuild', icon: 'refresh', label: 'リビルド',
                    task_type: 'Sys', npm: 'npm run rebuild' },
                { cmd: 'PrjSet', icon: 'gear', label: '設定', task_type: 'Sys', },
                { cmd: 'Crypto', icon: 'gear', label: '暗号化', task_type: 'Sys', npm: is_new_tmp
                        ? 'echo "Crypto"'
                        : 'npm run webpack:dev' },
                { cmd: 'TaskWeb', icon: 'browser', label: '起動：ブラウザ版',
                    task_type: 'Web', npm: 'npm run web', exe: true, },
                { cmd: 'TaskApp', icon: 'electron', label: '起動：アプリ版',
                    task_type: 'App',
                    npm: `npm run ${is_new_tmp ? 'app' : 'start'}`,
                    exe: true, },
                { cmd: '', icon: '', label: '生成', children: [
                        { cmd: 'PackWin', icon: 'windows', label: 'Windows exe x64',
                            npm: `npm run webpack:pro ${statBreak} electron-builder -w --x64` },
                        { cmd: 'PackWin32', icon: 'windows', label: 'Windows exe ia32',
                            npm: `npm run webpack:pro ${statBreak} electron-builder -w --ia32` },
                        { cmd: 'PackMac', icon: 'macosx', label: 'macOS dmg x64',
                            npm: `npm run webpack:pro ${statBreak} electron-builder -m --x64`,
                            forMac: true, },
                        { cmd: 'PackMacArm64', icon: 'macosx', label: 'macOS dmg arm64',
                            npm: `npm run webpack:pro ${statBreak} electron-builder -m --arm64`,
                            forMac: true, },
                        { cmd: 'PackLinux', icon: 'linux', label: 'Linux AppImage',
                            npm: `npm run webpack:pro ${statBreak} electron-builder -l` },
                        { cmd: 'PackFreem', icon: 'freem', label: 'ふりーむ！形式 zip',
                            npm: 'npm run webpack:pro' },
                    ] },
            ],
        };
        if (is_new_tmp) {
            const ePack = cfg.children[eDevTreeView.Pack];
            ePack.children = ePack.children.map(e => ({ ...e, npm: e.npm?.replace('webpack:pro', 'app_bld') }));
        }
        const pathWs = wsFld.uri.fsPath;
        const pti = new PrjTreeItem(ctx, pathWs, cfg);
        pti.collapsibleState = vscode__WEBPACK_IMPORTED_MODULE_2__.TreeItemCollapsibleState.Collapsed;
        PrjTreeItem.regCmds = () => { };
        PrjTreeItem.#hPathWs2onBtn[pathWs] = onBtn;
        return pti;
    }
    static #hPathWs2onBtn = {};
    #children = [];
    constructor(ctx, pathWs, cfg) {
        super(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_win && cfg.forMac ? '' : cfg.label);
        this.ctx = ctx;
        this.pathWs = pathWs;
        this.cfg = cfg;
        if (_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_win && cfg.forMac)
            this.description = '（Windowsでは使えません）';
        else {
            this.description = cfg.desc ?? '';
            if (cfg.cmd) {
                const cntVal = this.contextValue = 'skynovel.dev' + cfg.cmd;
                PrjTreeItem.regCmds(ctx, cntVal, cfg);
            }
        }
        if (cfg.children) {
            this.iconPath = vscode__WEBPACK_IMPORTED_MODULE_2__.ThemeIcon.Folder;
            this.collapsibleState = vscode__WEBPACK_IMPORTED_MODULE_2__.TreeItemCollapsibleState.Collapsed;
            this.#children = cfg.children.map(c => new PrjTreeItem(ctx, pathWs, c));
        }
        else {
            this.iconPath = (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_1__.oIcon)(cfg.icon);
            this.collapsibleState = vscode__WEBPACK_IMPORTED_MODULE_2__.TreeItemCollapsibleState.None;
        }
    }
    static regCmds(ctx, cntVal, cfg) {
        if (cfg.cmd === '')
            return;
        PrjTreeItem.#regCmd(ctx, cntVal, cfg.cmd, cfg);
        if (cfg.exe) {
            PrjTreeItem.#regCmd(ctx, cntVal + 'Dbg', (cfg.cmd + 'Dbg'), cfg);
            PrjTreeItem.#regCmd(ctx, cntVal + 'Stop', (cfg.cmd + 'Stop'), cfg);
        }
    }
    static #regCmd(ctx, cntVal, btn_nm2, cfg) {
        ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_2__.commands.registerCommand(cntVal, (ti) => PrjTreeItem.#hPathWs2onBtn[ti.pathWs]?.(ti, btn_nm2, cfg)));
    }
    get children() { return this.#children; }
}


/***/ }),

/***/ "./src/Project.ts":
/*!************************!*\
  !*** ./src/Project.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FLD_CRYPT_DOC: () => (/* binding */ FLD_CRYPT_DOC),
/* harmony export */   Project: () => (/* binding */ Project),
/* harmony export */   REG_FULLCRYPTO: () => (/* binding */ REG_FULLCRYPTO),
/* harmony export */   REG_NEEDCRYPTO: () => (/* binding */ REG_NEEDCRYPTO)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjSetting__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./PrjSetting */ "./src/PrjSetting.ts");
/* harmony import */ var _Encryptor__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./Encryptor */ "./src/Encryptor.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var _EncryptorTransform__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./EncryptorTransform */ "./src/EncryptorTransform.ts");
/* harmony import */ var _PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./PrjTreeItem */ "./src/PrjTreeItem.ts");
/* harmony import */ var _WorkSpaces__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./WorkSpaces */ "./src/WorkSpaces.ts");
/* harmony import */ var _Config__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./Config */ "./src/Config.ts");
/* harmony import */ var _ConfigBase__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./ConfigBase */ "./src/ConfigBase.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var _batch_WfbOptPic__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./batch/WfbOptPic */ "./src/batch/WfbOptPic.ts");
/* harmony import */ var _batch_WfbOptSnd__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./batch/WfbOptSnd */ "./src/batch/WfbOptSnd.ts");
/* harmony import */ var _batch_WfbOptFont__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./batch/WfbOptFont */ "./src/batch/WfbOptFont.ts");
/* harmony import */ var _HDiff__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./HDiff */ "./src/HDiff.ts");
/* harmony import */ var image_size_fromFile__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! image-size/fromFile */ "./node_modules/image-size/dist/fromFile.mjs");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! crypto */ "crypto");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_15___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_15__);
/* harmony import */ var archiver__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! archiver */ "./node_modules/archiver/index.js");
/* harmony import */ var archiver__WEBPACK_IMPORTED_MODULE_16___default = /*#__PURE__*/__webpack_require__.n(archiver__WEBPACK_IMPORTED_MODULE_16__);
/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! child_process */ "child_process");
/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_17___default = /*#__PURE__*/__webpack_require__.n(child_process__WEBPACK_IMPORTED_MODULE_17__);
/* harmony import */ var npm_check_updates__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! npm-check-updates */ "./node_modules/npm-check-updates/build/index.js");
/* harmony import */ var npm_check_updates__WEBPACK_IMPORTED_MODULE_18___default = /*#__PURE__*/__webpack_require__.n(npm_check_updates__WEBPACK_IMPORTED_MODULE_18__);
/* harmony import */ var str_async_replace__WEBPACK_IMPORTED_MODULE_19__ = __webpack_require__(/*! str-async-replace */ "./node_modules/str-async-replace/dist/index.js");
/* harmony import */ var str_async_replace__WEBPACK_IMPORTED_MODULE_19___default = /*#__PURE__*/__webpack_require__.n(str_async_replace__WEBPACK_IMPORTED_MODULE_19__);
/* harmony import */ var encoding_japanese__WEBPACK_IMPORTED_MODULE_20__ = __webpack_require__(/*! encoding-japanese */ "./node_modules/encoding-japanese/src/index.js");
/* harmony import */ var encoding_japanese__WEBPACK_IMPORTED_MODULE_20___default = /*#__PURE__*/__webpack_require__.n(encoding_japanese__WEBPACK_IMPORTED_MODULE_20__);
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_21__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_21___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_21__);
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_22__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_22___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_22__);
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_23__ = __webpack_require__(/*! node:fs/promises */ "node:fs/promises");
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_23___default = /*#__PURE__*/__webpack_require__.n(node_fs_promises__WEBPACK_IMPORTED_MODULE_23__);
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_24__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_24___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_24__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_25__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_25___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_25__);
















const { subtle } = crypto__WEBPACK_IMPORTED_MODULE_15__.webcrypto;










const FLD_CRYPT_DOC = 'doc_crypto';
const REG_NEEDCRYPTO = /\.(ss?n|json|html?|jpe?g|png|svg|webp|mp3|m4a|ogg|aac|flac|wav|mp4|webm|ogv|html?)$/;
const REG_FULLCRYPTO = /\.(ss?n|json|html?)$/;
const mExt2aFld = new Map([
    [_ConfigBase__WEBPACK_IMPORTED_MODULE_8__.SEARCH_PATH_ARG_EXT.SP_GSM, ['bg', 'image']],
    [_ConfigBase__WEBPACK_IMPORTED_MODULE_8__.SEARCH_PATH_ARG_EXT.SOUND, ['music', 'sound']],
    [_ConfigBase__WEBPACK_IMPORTED_MODULE_8__.SEARCH_PATH_ARG_EXT.FONT, ['script']],
    [_ConfigBase__WEBPACK_IMPORTED_MODULE_8__.SEARCH_PATH_ARG_EXT.SCRIPT, ['script']],
]);
class Project {
    ctx;
    actBar;
    wsFld;
    aTiRoot;
    emPrjTD;
    hOnEndTask;
    reqPrj2LSP;
    #pc;
    #PATH_CRYPT;
    #isCryptoMode = false;
    #encry;
    #diff;
    #ps;
    #ds = [];
    #dspCryptoMode;
    #aTiFlat = [];
    enableBtn(enabled) {
        if (enabled)
            for (const ti of this.#aTiFlat) {
                ti.contextValue = ti.contextValue?.trimEnd();
                this.emPrjTD.fire(ti);
            }
        else
            for (const ti of this.#aTiFlat) {
                ti.contextValue += ' ';
                this.emPrjTD.fire(ti);
            }
    }
    #haDiagFont = {};
    #haDiagChrCd = {};
    #cfg;
    #haDiagFn = {};
    #optPic;
    #optSnd;
    #optFont;
    constructor(ctx, actBar, wsFld, aTiRoot, emPrjTD, hOnEndTask, reqPrj2LSP) {
        this.ctx = ctx;
        this.actBar = actBar;
        this.wsFld = wsFld;
        this.aTiRoot = aTiRoot;
        this.emPrjTD = emPrjTD;
        this.hOnEndTask = hOnEndTask;
        this.reqPrj2LSP = reqPrj2LSP;
        this.#pc = new _PrjCmn__WEBPACK_IMPORTED_MODULE_9__.PrjCmn(ctx, wsFld, this.hOnEndTask);
        this.#PATH_CRYPT = `${this.#pc.PATH_WS}/${FLD_CRYPT_DOC}/prj/`;
        {
            const OLD_FLD_DOC_CRYPTO = `${this.#pc.PATH_WS}/doc/crypto_prj/`;
            if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(OLD_FLD_DOC_CRYPTO)) {
                (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.moveSync)(OLD_FLD_DOC_CRYPTO, this.#PATH_CRYPT);
            }
            const gi = `${this.#pc.PATH_WS}/.gitignore`;
            if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(gi))
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(gi, /\/doc\/crypto_prj\n/, `/${FLD_CRYPT_DOC}\n`, false);
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/package.json', /"doc\/crypto_prj\/",/, `"${FLD_CRYPT_DOC}/prj/",`, false);
        }
        this.#isCryptoMode = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(this.#PATH_CRYPT);
        const fnPass = this.#pc.PATH_WS + '/pass.json';
        const exists_pass = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(fnPass);
        this.#encry = new _Encryptor__WEBPACK_IMPORTED_MODULE_2__.Encryptor(exists_pass
            ? (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.readJsonSync)(fnPass, { throws: false })
            : {
                pass: (0,crypto__WEBPACK_IMPORTED_MODULE_15__.randomUUID)(),
                salt: (0,_Encryptor__WEBPACK_IMPORTED_MODULE_2__.ab2hexStr)((0,crypto__WEBPACK_IMPORTED_MODULE_15__.getRandomValues)(new Uint32Array(128 / 8)).buffer),
                iv: (0,_Encryptor__WEBPACK_IMPORTED_MODULE_2__.ab2hexStr)((0,crypto__WEBPACK_IMPORTED_MODULE_15__.getRandomValues)(new Uint32Array(128 / 8)).buffer),
                keySize: 512 / 32,
                ite: 500 + Math.floor((new Date).getTime() % 300),
                stk: (0,_Encryptor__WEBPACK_IMPORTED_MODULE_2__.ab2hexStr)((0,crypto__WEBPACK_IMPORTED_MODULE_15__.getRandomValues)(new Uint32Array(128 / 8)).buffer),
            }, subtle);
        const is_new_tmp = this.#pc.IS_NEW_TMP;
        if (!exists_pass)
            void (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.outputFile)(fnPass, this.#encry.strHPass);
        this.#aRepl = is_new_tmp
            ? [
                `${this.#pc.FLD_SRC}/web.ts`,
                `${this.#pc.FLD_SRC}/renderer/renderer.ts`,
            ]
            : [
                `${this.#pc.FLD_SRC}/app4webpack.js`,
                `${this.#pc.FLD_SRC}/web4webpack.js`,
            ];
        const sr = new _Config__WEBPACK_IMPORTED_MODULE_7__.SysExtension({ cur: this.#pc.PATH_PRJ, crypto: this.#isCryptoMode, dip: '' });
        this.#cfg = new _Config__WEBPACK_IMPORTED_MODULE_7__.Config(sr, this.#encry);
        const pti = _PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.PrjTreeItem.create(ctx, wsFld, (ti, btn_nm, cfg) => { void this.#onBtn(ti, btn_nm, cfg); }, is_new_tmp);
        aTiRoot.push(pti);
        this.#ds.push(this.#ps = new _PrjSetting__WEBPACK_IMPORTED_MODULE_1__.PrjSetting(this.#pc, this.#cfg, title => {
            pti.label = title;
            emPrjTD.fire(pti);
        }, this.reqPrj2LSP, this.#optPic = new _batch_WfbOptPic__WEBPACK_IMPORTED_MODULE_10__.WfbOptPic(this.#pc), this.#optSnd = new _batch_WfbOptSnd__WEBPACK_IMPORTED_MODULE_11__.WfbOptSnd(this.#pc), this.#optFont = new _batch_WfbOptFont__WEBPACK_IMPORTED_MODULE_12__.WfbOptFont(this.#pc)));
        this.#diff = new _HDiff__WEBPACK_IMPORTED_MODULE_13__.HDiff(`${this.#pc.PATH_WS}/${this.#pc.FLD_SRC}/diff.json`, this.#pc.FLD_SRC, this.#PATH_CRYPT, this.#encry);
        const updPathJson = async () => {
            this.#haDiagFn = {};
            await this.#cfg.loadEx(uri => this.#encFile(uri), this.#haDiagFn);
            for (const [spae, aFld] of mExt2aFld)
                this.#mExt2ToPath.set(spae, aFld.filter(fld_nm => (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(this.#pc.PATH_WS + `/doc/prj/${fld_nm}/`)));
            await this.reqPrj2LSP({ cmd: 'need_go' });
        };
        this.#pc.init(updPathJson, uri => this.#encIfNeeded(uri), this.#diff, () => this.#isCryptoMode, this.#ps);
        this.#optPic.initOnce(updPathJson, uri => this.#encIfNeeded(uri));
        const aTi = pti.children;
        const aC = aTi.at(-1).children;
        this.#aTiFlat = [...aTi.slice(0, -1), ...aC];
        const tiSnUpd = aTi[_PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.eDevTreeView.SnUpd];
        this.getLocalSNVer = () => {
            const o = this.#ps.getLocalSNVer();
            tiSnUpd.description = o.verSN
                ? o.verSN.startsWith('ile:') || o.verSN.startsWith('./')
                    ? '（相対パス参照中）'
                    : `-- ${o.verSN}${o.verTemp ? ` - ${o.verTemp}` : ''}`
                : '取得できません';
            emPrjTD.fire(tiSnUpd);
            return o;
        };
        const tiCrypto = aTi[_PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.eDevTreeView.Crypto];
        this.#dspCryptoMode = () => {
            tiCrypto.description = `-- ${this.#isCryptoMode ? 'する' : 'しない'}`;
            emPrjTD.fire(tiCrypto);
        };
        void this.#encry.init()
            .then(() => Promise.allSettled([
            async () => {
                await this.#initCrypto();
                this.#dspCryptoMode();
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)(this.#pc.PATH_PRJ, () => { }, nm => {
                    if (nm in this.#cfg.oCfg.code)
                        return;
                    this.#cfg.oCfg.code[nm] = false;
                });
            },
            async () => {
                if (!is_new_tmp) {
                    for await (const fn of (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_23__.glob)(this.#pc.PATH_WS + '/doc/{app/app,web}.vendors-node_modules_*.js'))
                        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.unlink)(fn);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/package.json', /github.com:famibee\/SKYNovel_/, 'github.com:famibee/tmp_cjs_', false);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/package.json', / && npm i && npm run webpack:dev/, ' && npm i",\n\t\t"postinstall": "npm run webpack:dev', false);
                }
                for await (const fn of (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_23__.glob)(this.#pc.PATH_WS + '/build/{cnv_*,cut_round,subset_font}.{js,json}')) {
                    const dest = fn.replace('/build/', `/${this.#pc.FLD_SRC}/batch/`);
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.move)(fn, dest);
                }
                const OLD_FLD_PRJ_BASE = `${this.#pc.PATH_WS}/doc/${_PrjCmn__WEBPACK_IMPORTED_MODULE_9__.FLD_PRJ_BASE}/`;
                if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(OLD_FLD_PRJ_BASE))
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.move)(OLD_FLD_PRJ_BASE, this.#pc.PATH_PRJ_BASE);
                const pathStgJS = this.#pc.PATH_WS + '/.vscode/settings.json';
                if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(pathStgJS)) {
                    const o = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.readJson)(pathStgJS, { encoding: 'utf8' });
                    if (!('terminal.integrated.env.windows' in o)) {
                        o['terminal.integrated.env.windows'] = {
                            'PATH': '${workspaceRoot}\\node_modules\\.bin;${env:PATH}'
                        };
                        o['terminal.integrated.env.osx'] = {
                            'PATH': '${workspaceRoot}/node_modules/.bin:${env:PATH}'
                        };
                        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.writeFile)(pathStgJS, JSON.stringify(o, null, '\t'));
                    }
                }
                else
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copyFile)(ctx.extensionPath + '/res/settings.json', pathStgJS);
            },
            async () => {
                const firstInit = !(0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(this.#pc.PATH_WS + '/node_modules');
                await this.#updPlugin(firstInit);
                if (firstInit) {
                    if (_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.ActivityBar.aReady[_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.eTreeEnv.NPM])
                        vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage('初期化中です。ターミナルの処理が終わって止まるまでしばらくお待ち下さい。', { modal: true });
                }
                else
                    await actBar.chkLastSNVer([this.getLocalSNVer()]);
            },
            () => this.#optPic.init(),
            () => this.#optSnd.init(),
            () => this.#optFont.init(async (fp) => {
                if (!/\.(ss?n|json)$/.test(fp))
                    return;
                this.#chkChrCd(fp);
                await this.reqPrj2LSP({ cmd: 'upd_diag', haDiag: this.#haDiag });
            }, async (fp) => {
                if (!/\.(ss?n|json)$/.test(fp))
                    return false;
                delete this.#haDiagChrCd[fp];
                await this.reqPrj2LSP({ cmd: 'upd_diag', haDiag: this.#haDiag });
                return true;
            }, () => this.reqPrj2LSP({ cmd: 'need_go' })),
            () => this.#diff.init(),
            () => Promise.try(() => this.#ds.push(vscode__WEBPACK_IMPORTED_MODULE_21__.workspace.createFileSystemWatcher(new vscode__WEBPACK_IMPORTED_MODULE_21__.RelativePattern(wsFld, 'doc/prj/prj.json')).onDidChange(uri => this.#encIfNeeded(uri)), vscode__WEBPACK_IMPORTED_MODULE_21__.debug.onDidTerminateDebugSession(_ => this.#onDidTermDbgSS()), vscode__WEBPACK_IMPORTED_MODULE_21__.debug.onDidStartDebugSession(ds => this.#aDbgSS.push(ds)), vscode__WEBPACK_IMPORTED_MODULE_21__.languages.registerEvaluatableExpressionProvider(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel, { provideEvaluatableExpression(doc, pos) {
                    const r = doc.getWordRangeAtPosition(pos, /;.+|[[*]?[\d\w.]+=?/);
                    if (!r)
                        throw new Error('No word here.');
                    const txt = doc.getText(r);
                    const hc = txt.at(0);
                    if (hc === '[' || hc === '*' || hc === ';'
                        || txt.endsWith('='))
                        throw new Error('No word here.');
                    return new vscode__WEBPACK_IMPORTED_MODULE_21__.EvaluatableExpression(r, txt);
                } }))),
        ].map(p => p()))).then(async () => {
            await this.#optPic.init2th();
            await this.reqPrj2LSP({ cmd: 'ready' });
        });
    }
    getLocalSNVer;
    #aDbgSS = [];
    #onDidTermDbgSS = () => { };
    dispose() {
        for (const d of this.#ds)
            d.dispose();
        void this.#termDbgSS();
        this.#pc.hTaskExe.forEach(v => v.terminate());
        this.#pc.hTaskExe.clear();
    }
    #termDbgSS() {
        this.#pc.hTaskExe.get('TaskWeb')?.terminate();
        this.#pc.hTaskExe.delete('TaskWeb');
        this.#pc.hTaskExe.get('TaskApp')?.terminate();
        this.#pc.hTaskExe.delete('TaskApp');
        const a = this.#aDbgSS.map(ds => vscode__WEBPACK_IMPORTED_MODULE_21__.debug.stopDebugging(ds));
        this.#aDbgSS = [];
        return Promise.allSettled(a);
    }
    onRequest(o) {
        switch (o.cmd) {
            case 'go':
                {
                    this.#haDiagFont = this.#optFont.updDiag(o.InfFont);
                    const pp2s = {};
                    this.#haDiagChrCd = {};
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.treeProc)(this.#pc.PATH_PRJ, fp => {
                        if (/\.(ss?n|json)$/.test(fp))
                            this.#chkChrCd(fp, pp2s);
                    });
                    void this.reqPrj2LSP({ cmd: 'go.res',
                        pp2s,
                        hDefPlg: this.#hDefPlg,
                        haDiag: this.#haDiag,
                    });
                }
                break;
            case 'analyze_inf':
                {
                    this.#aPickItems = [
                        ..._WorkSpaces__WEBPACK_IMPORTED_MODULE_6__.aPickItems,
                        { kind: vscode__WEBPACK_IMPORTED_MODULE_21__.QuickPickItemKind.Separator, label: '' },
                        ...o.aQuickPickMac
                            .map(({ label, description, uri }) => ({
                            label, description, uri: vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse(uri),
                        })),
                        { kind: vscode__WEBPACK_IMPORTED_MODULE_21__.QuickPickItemKind.Separator, label: '' },
                        ...o.aQuickPickPlg
                            .map(({ label, description, uri }) => ({
                            label, description, uri: vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse(uri),
                        })),
                    ];
                    this.#mExt2Snip = new Map(o.aExt2Snip);
                    this.#haDiagFont = this.#optFont.updDiag(o.InfFont);
                }
                break;
            case 'hover.res':
                this.#hFp2AHoverProc[o.fp]?.shift()?.(o);
                break;
        }
    }
    #chkChrCd(fp, pp2s) {
        const td = vscode__WEBPACK_IMPORTED_MODULE_21__.workspace.textDocuments.find(v => (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(v.uri.path) === fp);
        const pp = this.#pc.fp2pp(fp);
        const str = _CmnLib__WEBPACK_IMPORTED_MODULE_0__.REG_SCRIPT.test(fp) ? td?.getText() : undefined;
        let cc;
        if (str) {
            if (pp2s)
                pp2s[pp] = str;
            cc = td?.encoding ?? '';
        }
        else {
            const buf = (0,node_fs__WEBPACK_IMPORTED_MODULE_24__.readFileSync)(fp);
            if (pp2s)
                pp2s[pp] = buf.toString('utf-8');
            cc = encoding_japanese__WEBPACK_IMPORTED_MODULE_20___default().detect(buf);
        }
        if (/(UTF8|ASCII)$/i.test(cc)) {
            delete this.#haDiagChrCd[fp];
            return;
        }
        const { mes, sev } = _CmnLib__WEBPACK_IMPORTED_MODULE_0__.hDiagL2s.文字コード異常;
        this.#haDiagChrCd[fp] = [{ mes: mes.replace('$', cc), sev }];
    }
    get #haDiag() {
        return {
            ...this.#haDiagFn,
            ...this.#haDiagFont,
            ...this.#haDiagChrCd,
        };
    }
    #hFp2AHoverProc = {};
    provideHover(doc, pos) {
        const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(doc.uri.path);
        return new Promise(rs => {
            (this.#hFp2AHoverProc[fp] ??= []).push(({ value }) => {
                const a = value.split(/(?=\n---\n)/);
                if (a.length !== 3) {
                    const ms = new vscode__WEBPACK_IMPORTED_MODULE_21__.MarkdownString(value);
                    ms.isTrusted = true;
                    rs(new vscode__WEBPACK_IMPORTED_MODULE_21__.Hover(ms));
                    return;
                }
                const [args = '', ...detail] = a;
                new (str_async_replace__WEBPACK_IMPORTED_MODULE_19___default())(detail.join('')).replaceAll(/<!-- ({.+?}) -->/g, async (e1) => {
                    const { name, val } = JSON.parse(e1.slice(5, -4));
                    const ppImg = this.#cfg.searchPath(val, _ConfigBase__WEBPACK_IMPORTED_MODULE_8__.SEARCH_PATH_ARG_EXT.SP_GSM);
                    const vfpImg = `${this.#pc.URI_WS}/doc/prj/${ppImg}`;
                    const srcEx = `${vfpImg}|width=${String(this.#whThumbnail)}|height=${String(this.#whThumbnail)}`;
                    const { width, height } = await (0,image_size_fromFile__WEBPACK_IMPORTED_MODULE_14__.imageSizeFromFile)((0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.uri2path)(vfpImg));
                    const exImg = encodeURIComponent(JSON.stringify([vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file(vfpImg)]));
                    return `- ${name} = ${val} (${width}x${height}) [ファイルを見る](${vfpImg} "ファイルを見る") [サイドバーに表示](${String(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse(`command:revealInExplorer?${exImg}`))} "サイドバーに表示")
	[フォルダを開く](${String(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse(`command:revealFileInOS?${exImg}`))} "フォルダを開く")  \n`
                        + `![${val}](${srcEx} "${val}")`;
                })
                    .then(ar => {
                    const ms = new vscode__WEBPACK_IMPORTED_MODULE_21__.MarkdownString(args + ar.toString());
                    ms.isTrusted = true;
                    rs(new vscode__WEBPACK_IMPORTED_MODULE_21__.Hover(ms));
                })
                    .catch((e) => console.error(e));
            });
            void this.reqPrj2LSP({ cmd: 'hover', fp, pos });
        });
    }
    #whThumbnail = 200;
    #aPickItems = [];
    openReferencePallet() {
        vscode__WEBPACK_IMPORTED_MODULE_21__.window.showQuickPick(this.#aPickItems, {
            placeHolder: 'どのリファレンスを開きますか?',
            matchOnDescription: true,
        })
            .then(q => { if (q?.uri)
            (0,_WorkSpaces__WEBPACK_IMPORTED_MODULE_6__.openURL)(q.uri, this.#pc.PATH_WS); });
    }
    opView(uri) { this.#ps.pnlWVFolder.open(uri); }
    #hPush2BtnEnable = new Map([
        ['Crypto', ['', '', '', '', '', '', '', '', '', '', '', '']],
        ['TaskWeb', ['_off', '_off', '', '_off', 'Stop', '_off',
                '_off', '_off', '_off', '_off', '_off', '_off']],
        ['TaskWebDbg', ['_off', '_off', '', '_off', 'Stop', '_off',
                '_off', '_off', '_off', '_off', '_off', '_off']],
        ['TaskWebStop', ['', '', '', '', '', '', '', '', '', '', '', '']],
        ['TaskAppDbgStop', ['', '', '', '', '', '', '', '', '', '', '', '']],
    ]);
    async #onBtn(ti, btn_nm, cfg) {
        if (!_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.ActivityBar.aReady[_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.eTreeEnv.NPM])
            return;
        const aBtnEnable = this.#hPush2BtnEnable.get(btn_nm)
            ?? ['_off', '_off', '_off', '_off', '_off', '_off',
                '_off', '_off', '_off', '_off', '_off', '_off'];
        this.#aTiFlat.forEach((ti, i) => {
            ti.contextValue += aBtnEnable[i];
            this.emPrjTD.fire(ti);
        });
        if (btn_nm === 'TaskWebStop' || btn_nm === 'TaskAppStop') {
            await this.#onBtn_sub(ti, btn_nm, cfg, () => { });
            return;
        }
        await vscode__WEBPACK_IMPORTED_MODULE_21__.window.withProgress({
            location: vscode__WEBPACK_IMPORTED_MODULE_21__.ProgressLocation.Notification,
            title: typeof ti.label === 'string'
                ? ti.label : ti.label?.label,
            cancellable: false,
        }, prg => new Promise(done => {
            const iconPath = ti.iconPath;
            ti.iconPath = new vscode__WEBPACK_IMPORTED_MODULE_21__.ThemeIcon('sync~spin');
            void this.#onBtn_sub(ti, btn_nm, cfg, (timeout = 4000) => {
                ti.iconPath = iconPath;
                for (const ti of this.#aTiFlat) {
                    const tc = ti.contextValue;
                    if (tc && (tc.endsWith('_off') || tc.endsWith('Stop'))) {
                        ti.contextValue = tc.slice(0, -4);
                    }
                    this.emPrjTD.fire(ti);
                }
                prg.report({ message: '完了', increment: 100 });
                setTimeout(() => done(0), timeout);
            });
        }));
    }
    async #onBtn_sub(ti, btn_nm, cfg, done) {
        let cmd = `cd "${this.#pc.PATH_WS}" ${_PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.statBreak} `;
        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(this.#pc.PATH_WS + '/node_modules')) {
            cmd += `npm i ${_PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.statBreak} `;
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(this.#pc.PATH_WS + '/package-lock.json');
        }
        if (cfg.npm)
            cmd += cfg.npm;
        switch (btn_nm) {
            case 'SnUpd':
                try {
                    await this.#termDbgSS();
                    await this.actBar.updPrjFromTmp(this.#pc.PATH_WS);
                    await npm_check_updates__WEBPACK_IMPORTED_MODULE_18___default()({
                        packageFile: this.#pc.PATH_WS + '/package.json',
                        upgrade: true,
                        target: 'minor',
                    });
                    this.getLocalSNVer();
                    await this.#onBtn_sub(ti, 'SnUpd_waited', cfg, done);
                }
                catch (e) {
                    console.error('fn:Project.ts onBtn_sub SnUpd e:%o', e);
                    done(0);
                }
                return;
            case 'SnUpd_waited': break;
            case 'PrjSet':
                this.#ps.open();
                done(0);
                return;
            case 'Crypto':
                try {
                    const ans = await vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage('暗号化（する / しない）を切り替えますか？', { modal: true }, 'はい');
                    if (ans !== 'はい') {
                        done(0);
                        return;
                    }
                    await this.#termDbgSS();
                    await this.#tglCryptoMode();
                    await this.#onBtn_sub(ti, 'Crypto_waited', cfg, done);
                }
                catch (e) {
                    console.error('fn:Project.ts onBtn_sub Crypto e:%o', e);
                }
                return;
            case 'Crypto_waited': break;
            case 'TaskWebDbg':
            case 'TaskAppDbg':
                await this.#termDbgSS();
                this.#onDidTermDbgSS = () => {
                    this.#onDidTermDbgSS = () => { };
                    done(0);
                };
                await vscode__WEBPACK_IMPORTED_MODULE_21__.debug.startDebugging(this.wsFld, `${btn_nm === 'TaskWebDbg' ? 'web' : 'app'}デバッグ`);
                return;
            case 'TaskWebStop':
            case 'TaskAppStop':
                await this.#termDbgSS();
                done(0);
                return;
            case 'PackWin':
            case 'PackWin32':
            case 'PackMac':
            case 'PackMacArm64':
            case 'PackLinux':
                await this.#termDbgSS();
                break;
            case 'PackFreem':
                {
                    await this.#termDbgSS();
                    let find_ng = false;
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.treeProc)(this.#pc.PATH_PRJ, fp => {
                        if (find_ng || !fp.endsWith('.svg'))
                            return;
                        find_ng = true;
                        vscode__WEBPACK_IMPORTED_MODULE_21__.window.showErrorMessage('ふりーむ！では svg ファイル使用禁止です。png などに置き換えて下さい', 'フォルダを開く', 'Online Converter')
                            .then(async (ans) => {
                            switch (ans) {
                                case 'フォルダを開く':
                                    await vscode__WEBPACK_IMPORTED_MODULE_21__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file((0,node_path__WEBPACK_IMPORTED_MODULE_22__.dirname)(fp)));
                                    break;
                                case 'Online Converter':
                                    await vscode__WEBPACK_IMPORTED_MODULE_21__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse('https://cancerberosgx.github.io/demos/svg-png-converter/playground/'));
                                    break;
                            }
                        });
                    });
                    if (find_ng) {
                        done();
                        return;
                    }
                }
                break;
        }
        switch (btn_nm) {
            case 'PackWin':
            case 'PackWin32':
                if (!_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_win)
                    break;
                if (!/(Restricted|AllSigned)/.test((0,child_process__WEBPACK_IMPORTED_MODULE_17__.execSync)('PowerShell Get-ExecutionPolicy').toString()))
                    break;
                done();
                await vscode__WEBPACK_IMPORTED_MODULE_21__.window.showErrorMessage('管理者として開いたPowerShell で実行ポリシーを RemoteSigned などに変更して下さい。\n例）Set-ExecutionPolicy RemoteSigned', { modal: true }, '参考サイトを開く')
                    .then(async (a) => { if (a)
                    await vscode__WEBPACK_IMPORTED_MODULE_21__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse('https://qiita.com/Targityen/items/3d2e0b5b0b7b04963750')); });
                return;
        }
        const task_type = cfg.task_type ?? 'Pkg';
        const t = new vscode__WEBPACK_IMPORTED_MODULE_21__.Task({ type: _WorkSpaces__WEBPACK_IMPORTED_MODULE_6__.PRE_TASK_TYPE + task_type }, this.wsFld, cfg.label, 'SKYNovel', new vscode__WEBPACK_IMPORTED_MODULE_21__.ShellExecution(cmd));
        this.hOnEndTask.set(task_type, () => done());
        switch (btn_nm) {
            case 'SnUpd_waited':
                this.hOnEndTask.set(task_type, () => { this.getLocalSNVer(); done(); });
                break;
            case 'Crypto_waited':
                this.hOnEndTask.set(task_type, () => { this.#dspCryptoMode(); done(); });
                break;
            case 'PackWin':
            case 'PackWin32':
            case 'PackMac':
            case 'PackMacArm64':
            case 'PackLinux':
                this.hOnEndTask.set(task_type, () => {
                    Promise.resolve(async () => {
                        const oPkg = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.readJson)(this.#pc.PATH_WS + '/package.json', { encoding: 'utf8' });
                        const pathPkg = this.#pc.PATH_WS + '/build/package';
                        const pathUpd = pathPkg + '/update';
                        const fnUcJs = pathUpd + '/_index.json';
                        let oUc = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(fnUcJs)
                            ? await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.readJson)(fnUcJs, { encoding: 'utf8' })
                            : {};
                        const isMacBld = btn_nm.slice(4, 7) === 'Mac';
                        const isLinBld = btn_nm.slice(4, 7) === 'Lin';
                        const fnYml = pathPkg + `/latest${isMacBld ? '-mac' : isLinBld ? '-linux' : ''}.yml`;
                        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(fnYml))
                            throw '必要なファイルが生成されませんでした';
                        const sYml = await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_23__.readFile)(fnYml, { encoding: 'utf8' });
                        const mv = /version: (.+)/.exec(sYml);
                        if (!mv)
                            throw '[Pack...] .yml に version が見つかりません';
                        const ver = mv[1];
                        if (oUc.version !== ver || oUc.name !== oPkg.name) {
                            oUc = {};
                            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(pathUpd);
                            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.mkdirs)(pathUpd);
                        }
                        oUc.version = oPkg.version;
                        oUc.name = oPkg.name;
                        const mp = /path: (.+)/.exec(sYml);
                        if (!mp)
                            throw '[Pack...] .yml に path が見つかりません';
                        const path = mp[1];
                        const ms = /size: (.+)/.exec(sYml);
                        if (!ms)
                            throw '[Pack...] .yml に size が見つかりません';
                        const size = Number(ms[1] ?? NaN);
                        const mc = /sha512: (.+)/.exec(sYml);
                        if (!mc)
                            throw '[Pack...] .yml に sha512 が見つかりません';
                        const sha512 = mc[1] ?? '';
                        const cn = (0,_Encryptor__WEBPACK_IMPORTED_MODULE_2__.encStrBase64)(this.#encry.uuidv5(sha512));
                        const ma = /-(\w+)\.\D/.exec(path);
                        if (!ma)
                            throw 'path に arch が見つかりません';
                        const arch = ma[1];
                        const key = (isMacBld ? 'darwin' : isLinBld ? 'linux' : 'win32') + '_' + arch;
                        oUc[key] = { path, size, sha512, cn, };
                        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.outputJson)(fnUcJs, oUc, { spaces: '\t' });
                        const REG_OLD_SAMEKEY = new RegExp('^' + key + '-');
                        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)(pathUpd, (fp, nm) => {
                            if (REG_OLD_SAMEKEY.test(nm))
                                void (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(fp);
                        }, () => { });
                        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copy)(pathPkg + '/' + path, pathUpd + '/' + key + '-' + cn);
                        const a = await vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage(`${cfg.label} パッケージを生成しました`, '出力フォルダを開く');
                        if (a)
                            await vscode__WEBPACK_IMPORTED_MODULE_21__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file(pathPkg));
                    })
                        .catch((e) => {
                        void vscode__WEBPACK_IMPORTED_MODULE_21__.window.showErrorMessage(`${cfg.label} パッケージ生成に失敗しました…${e}`);
                    })
                        .finally(() => done());
                });
                break;
            case 'PackFreem':
                this.hOnEndTask.set(task_type, () => {
                    const cwd = `${this.#pc.PATH_WS}/${this.#isCryptoMode ? FLD_CRYPT_DOC : 'doc'}/`;
                    const arc = archiver__WEBPACK_IMPORTED_MODULE_16__.create('zip', { zlib: { level: 9 }, })
                        .append((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.createReadStream)(cwd + 'web.htm'), { name: 'index.html' })
                        .append((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.createReadStream)(this.#pc.PATH_WS + '/build/include/readme.txt'), { name: 'readme.txt' })
                        .glob('web.js', { cwd })
                        .glob('web.*.js', { cwd })
                        .glob('prj/**/*', { cwd })
                        .glob('favicon.ico', { cwd });
                    const fn_out = `${(0,node_path__WEBPACK_IMPORTED_MODULE_22__.basename)(this.#pc.PATH_WS)}_1.0freem.zip`;
                    const ws = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.createWriteStream)(`${this.#pc.PATH_WS}/build/package/${fn_out}`)
                        .on('close', () => {
                        done();
                        vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage(`ふりーむ！形式で出力（${fn_out}）しました`, '出力フォルダを開く').then(a => { if (a)
                            vscode__WEBPACK_IMPORTED_MODULE_21__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file(this.#pc.PATH_WS + '/build/package/')); });
                    });
                    arc.pipe(ws);
                    void arc.finalize();
                });
                break;
        }
        await vscode__WEBPACK_IMPORTED_MODULE_21__.tasks.executeTask(t)
            .then(re => this.#pc.hTaskExe.set(btn_nm, re), (e) => console.error(`fn:Project onBtn_sub() rj:${e}`));
    }
    async #initCrypto() {
        const fnc = this.#isCryptoMode
            ? fp => {
                const uri = vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file(fp);
                if (this.#diff.isDiff(uri))
                    void this.#encFile(uri);
            }
            : fp => {
                const uri = vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.file(fp);
                this.#diff.isDiff(uri);
            };
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.treeProc)(this.#pc.PATH_PRJ, fnc);
        await this.#diff.save();
    }
    async #encIfNeeded(uri) {
        if (this.#diff.isDiff(uri) && this.#isCryptoMode)
            await this.#encFile(uri);
        await this.#diff.save();
    }
    #aRepl;
    async #tglCryptoMode() {
        this.#isCryptoMode = !this.#isCryptoMode;
        this.#cfg.setCryptoMode(this.#isCryptoMode);
        if (!this.#isCryptoMode) {
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(`${this.#pc.PATH_WS}/${FLD_CRYPT_DOC}/`);
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(this.#pc.PATH_PLG_PRE);
            for (const url of this.#aRepl)
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/' + url, /\(hPlg, {.+?}\);/, '(hPlg);');
            if (this.#pc.IS_NEW_TMP) {
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/electron.vite.config.ts', new RegExp(`publicDir: '../../${FLD_CRYPT_DOC}/'`), 'publicDir: \'../../doc/\'');
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/vite.config.ts', new RegExp(`publicDir: '${FLD_CRYPT_DOC}'`), 'publicDir: \'doc\'');
            }
            else {
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/package.json', new RegExp(`${FLD_CRYPT_DOC}\\/`, 'g'), 'doc/');
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/core/wds.config.js', new RegExp(`\\/${FLD_CRYPT_DOC}'`, 'g'), '/doc\'');
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/core/webpack.config.js', new RegExp(`'\\/${FLD_CRYPT_DOC}`, 'g'), '\'/doc');
            }
            await this.#updPlugin();
            return;
        }
        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.mkdirs)(this.#PATH_CRYPT);
        for (const url of this.#aRepl)
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/' + url, /\(hPlg\);/, '(hPlg, {cur: \'prj/\', crypto: true});');
        if (this.#pc.IS_NEW_TMP) {
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/electron.vite.config.ts', /publicDir: '..\/..\/doc\/'/, `publicDir: '../../${FLD_CRYPT_DOC}/'`);
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/vite.config.ts', /publicDir: 'doc'/, `publicDir: '${FLD_CRYPT_DOC}'`);
        }
        else {
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/package.json', /doc\//g, `${FLD_CRYPT_DOC}/`);
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/core/wds.config.js', /\/doc'/g, `/${FLD_CRYPT_DOC}'`);
            (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/core/webpack.config.js', /'\/doc/g, `'/${FLD_CRYPT_DOC}`);
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copy)(this.#pc.PATH_WS + '/doc/web.htm', this.#pc.PATH_WS + `/${FLD_CRYPT_DOC}/web.htm`);
        }
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.ctx.extensionPath + '/dist/snsys_pre.js', /[^\s=]+\.tstDecryptInfo\(\)/, this.#encry.strHPass, true, this.#pc.PATH_PLG_PRE + `index.${this.#pc.IS_NEW_TMP ? 'ts' : 'js'}`);
        await this.#updPlugin();
        this.#diff.clear();
        await this.#initCrypto();
    }
    async #encFile({ path }) {
        const fsp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(path);
        const pp = this.#diff.fp2pp(fsp);
        try {
            const fsp_enc = this.#PATH_CRYPT + this.#diff.get(pp).cn;
            if (!REG_NEEDCRYPTO.test(pp)) {
                await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copy)(fsp, fsp_enc, { overwrite: true });
                return;
            }
            if (REG_FULLCRYPTO.test(pp)) {
                if (pp === 'path.json') {
                    await this.#encFile_pathjson(fsp, fsp_enc);
                    return;
                }
                const s = await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_23__.readFile)(fsp, { encoding: 'utf8' });
                await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.outputFile)(fsp_enc, await this.#encry.enc(s));
                return;
            }
            const dir = this.#REG_DIR.exec(pp);
            if (dir && this.#cfg.oCfg.code[dir[1]]) {
                await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copy)(fsp, fsp_enc, { overwrite: true });
                return;
            }
            const u2 = fsp_enc.replace(/\.[^.]+$/, '.bin');
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.ensureFile)(u2);
            const ws = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.createWriteStream)(u2)
                .on('error', e => { ws.destroy(); console.error('enc ws=%o', e); });
            const rs = (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.createReadStream)(fsp)
                .on('error', e => console.error('enc rs=%o', e));
            const tr = new _EncryptorTransform__WEBPACK_IMPORTED_MODULE_4__.EncryptorTransform(this.#encry, fsp);
            rs.pipe(tr).pipe(ws);
        }
        catch (e) {
            console.error(`enc other ${e instanceof Error ? e.message : ''} src:${fsp}`);
        }
    }
    async #encFile_pathjson(fsp, fsp_enc) {
        const hPath = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.readJson)(fsp, { encoding: 'utf8' });
        for (const hExt2N of Object.values(hPath)) {
            for (const [ext, pp] of Object.entries(hExt2N)) {
                if (ext === ':cnt')
                    continue;
                if (ext.endsWith(':id'))
                    continue;
                const dir = this.#REG_DIR.exec(pp);
                const d = this.#diff.get(pp);
                if (dir && this.#cfg.oCfg.code[dir[1]] || !d)
                    continue;
                hExt2N[ext] = d.cn;
            }
        }
        const s = JSON.stringify(hPath);
        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.outputFile)(fsp_enc, await this.#encry.enc(s));
    }
    #REG_DIR = /(^.+)\//;
    #REG_PLGADDTAG = /(?<=\.\s*addTag\s*\(\s*)(["'])(.+?)\1/g;
    #hDefPlg = {};
    async #updPlugin(build = true) {
        const pathPlg = `${this.#pc.PATH_WS}/${this.#pc.FLD_SRC}/plugin/`;
        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(pathPlg)) {
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.mkdirs)(pathPlg);
            this.#build();
            return;
        }
        const h4json = {};
        this.#hDefPlg = {};
        const aP = [];
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)(pathPlg, () => { }, nm => {
            h4json[nm] = 0;
            let path = `${pathPlg}${nm}/index.`;
            if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(path + 'js'))
                path += 'js';
            else if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(path + 'ts'))
                path += 'ts';
            else
                return;
            aP.push((async () => {
                const txt = await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_23__.readFile)(path, 'utf8');
                let a;
                while (a = this.#REG_PLGADDTAG.exec(txt)) {
                    const nm = a[2];
                    const len_nm = nm.length;
                    const idx_nm = this.#REG_PLGADDTAG.lastIndex - len_nm - 1;
                    let line = 0;
                    let j = idx_nm;
                    while ((j = txt.lastIndexOf('\n', j - 1)) >= 0)
                        ++line;
                    const col = idx_nm - txt.lastIndexOf('\n', idx_nm) - 1;
                    this.#hDefPlg[nm] = {
                        uri: path,
                        sl: line,
                        sc: col,
                        el: line,
                        ec: col + len_nm,
                    };
                }
            })());
        });
        await Promise.allSettled(aP);
        await this.reqPrj2LSP({ cmd: 'def_plg.upd', hDefPlugin: this.#hDefPlg });
        const sPlgIdx = pathPlg.slice(0, -1);
        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.outputJson)(sPlgIdx + '.json', h4json);
        if (build)
            try {
                this.#build();
            }
            catch (e) {
                console.error(`Project updPlugin ${e}`);
            }
        if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(sPlgIdx + '.js')) {
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.remove)(sPlgIdx + '.js');
            for (const url of this.#aRepl)
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.replaceFile)(this.#pc.PATH_WS + '/' + url, /'\.\/plugin\.js';/, '\'./plugin.json\';');
        }
    }
    #build = () => {
        if (!_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.ActivityBar.aReady[_ActivityBar__WEBPACK_IMPORTED_MODULE_3__.eTreeEnv.NPM])
            return;
        this.#build = () => { };
        let cmd = `cd "${this.#pc.PATH_WS}"`;
        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.existsSync)(this.#pc.PATH_WS + '/node_modules')) {
            cmd += ` ${_PrjTreeItem__WEBPACK_IMPORTED_MODULE_5__.statBreak} npm i`;
            (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.removeSync)(this.#pc.PATH_WS + '/package-lock.json');
        }
        const type = _WorkSpaces__WEBPACK_IMPORTED_MODULE_6__.PRE_TASK_TYPE + 'Sys';
        const name = '自動ビルド';
        const t = new vscode__WEBPACK_IMPORTED_MODULE_21__.Task({ type }, this.wsFld, name, 'SKYNovel', new vscode__WEBPACK_IMPORTED_MODULE_21__.ShellExecution(cmd));
        this.enableBtn(false);
        vscode__WEBPACK_IMPORTED_MODULE_21__.window.withProgress({
            location: vscode__WEBPACK_IMPORTED_MODULE_21__.ProgressLocation.Notification,
            title: name,
            cancellable: false
        }, _prg => new Promise(done => {
            let fnc = (e) => {
                if (e.execution.task.definition.type !== type)
                    return;
                fnc = () => { };
                this.enableBtn(true);
                done();
            };
            vscode__WEBPACK_IMPORTED_MODULE_21__.tasks.onDidEndTaskProcess(e => fnc(e));
            try {
                void vscode__WEBPACK_IMPORTED_MODULE_21__.tasks.executeTask(t);
            }
            catch (e) {
                console.error('Project build() e:%o', e);
            }
        }));
    };
    #mExt2ToPath = new Map;
    #getコピー先候補(ext) {
        let aコピー先候補 = [];
        for (const [spae, a] of this.#mExt2ToPath.entries()) {
            if (!new RegExp(spae).test(ext))
                continue;
            aコピー先候補 = a;
            break;
        }
        return aコピー先候補;
    }
    async drop(td, pos, aUri) {
        const aFpNew = [];
        for (const uri of aUri) {
            const { path, scheme } = uri;
            const ext = (0,node_path__WEBPACK_IMPORTED_MODULE_22__.extname)(path).slice(1);
            const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(path);
            let fpNew = fp;
            const fn_ext = '/' + (0,node_path__WEBPACK_IMPORTED_MODULE_22__.basename)(fp);
            const aコピー先候補 = this.#getコピー先候補(ext);
            switch (scheme) {
                case 'file':
                    if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.statSync)(path).isDirectory()) {
                        if (!fp.startsWith(this.#pc.PATH_PRJ))
                            return null;
                        if (fp === this.#pc.PATH_PRJ + 'prj.json')
                            this.#ps.open();
                        else
                            this.#ps.pnlWVFolder.open(uri);
                    }
                    if (!ext)
                        continue;
                    if (fp.startsWith(this.#pc.PATH_PRJ))
                        break;
                    switch (aコピー先候補.length) {
                        case 0:
                            {
                                const tp = td.uri.path;
                                fpNew = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(tp.slice(0, -(0,node_path__WEBPACK_IMPORTED_MODULE_22__.basename)(tp).length) + (0,node_path__WEBPACK_IMPORTED_MODULE_22__.basename)(fp));
                            }
                            break;
                        case 1:
                            fpNew = this.#pc.PATH_PRJ + aコピー先候補[0] + fn_ext;
                            break;
                        default:
                            {
                                aコピー先候補.push('キャンセル');
                                const ans = await vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage((0,node_path__WEBPACK_IMPORTED_MODULE_22__.basename)(fp) + ' のコピー先を選んでください', ...aコピー先候補);
                                if (!ans || ans === 'キャンセル')
                                    return null;
                                fpNew = this.#pc.PATH_PRJ + ans + fn_ext;
                            }
                            break;
                    }
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.copyFile)(fp, fpNew);
                    break;
                case 'http':
                case 'https':
                    {
                        if (!ext)
                            continue;
                        if (this.#ps.pnlWVFolder.isOpend(path))
                            break;
                        const uriDL = uri.toString();
                        const res = await fetch(uriDL);
                        if (!res.ok) {
                            vscode__WEBPACK_IMPORTED_MODULE_21__.window.showErrorMessage(`ダウンロードに失敗しました。手動でローカルにコピーして下さい uri=${uriDL}`);
                            return null;
                        }
                        let ppNew = '';
                        switch (aコピー先候補.length) {
                            case 0:
                                return null;
                            default:
                                ppNew = aコピー先候補[0] + fn_ext;
                                break;
                        }
                        fpNew = this.#pc.PATH_PRJ + ppNew;
                        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_25__.writeFile)(fpNew, new Uint8Array(await res.arrayBuffer()));
                        vscode__WEBPACK_IMPORTED_MODULE_21__.window.showInformationMessage(`素材をダウンロードしました。 path=${ppNew}`);
                        await vscode__WEBPACK_IMPORTED_MODULE_21__.commands.executeCommand('revealInExplorer', vscode__WEBPACK_IMPORTED_MODULE_21__.Uri.parse(`${this.#pc.URI_WS}/doc/prj/${ppNew}`));
                    }
                    break;
                default: return null;
            }
            aFpNew.push(fpNew);
        }
        if (aFpNew.length === 0)
            return null;
        const fp = aFpNew[0];
        const ext = (0,node_path__WEBPACK_IMPORTED_MODULE_22__.extname)(fp).slice(1);
        const fn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(fp);
        for (const [spae, snip] of this.#mExt2Snip.entries()) {
            if (!new RegExp(spae).test(ext))
                continue;
            const { range, nm } = this.#getWordRangeAtPosition(td, pos, this.#REG_FIELD);
            if (nm)
                return { insertText: '', additionalEdit: this.#createWsEd_repVal(td.uri, range, nm, fn) };
            const sni = snip.replace('...', fn)
                .replaceAll(/\${\d\|([^,]+)\|}/g, '$1');
            return { insertText: new vscode__WEBPACK_IMPORTED_MODULE_21__.SnippetString(sni) };
        }
        return null;
    }
    #mExt2Snip = new Map;
    #REG_FIELD = /(?<=\s)[^\s=[\]]+(?:=(?:[^"'#\s;\]]+|(["'#]).*?\1)?)?/g;
    #createWsEd_repVal(uri, range, nm, val) {
        const we = new vscode__WEBPACK_IMPORTED_MODULE_21__.WorkspaceEdit;
        const v2 = /[\s=]/.test(val)
            ? /['#]/.test(val) ? `"${val}"` : `'${val}'`
            : val;
        we.replace(uri, range, nm + '=' + v2);
        return we;
    }
    #getWordRangeAtPosition(td, { line, character }, reg) {
        const s = td.getText(new vscode__WEBPACK_IMPORTED_MODULE_21__.Range(line, 0, line, 9999));
        let e;
        reg.lastIndex = 0;
        while (e = reg.exec(s)) {
            const [hit] = e, b = reg.lastIndex - hit.length;
            const [nm = '', ...v] = hit.split('=');
            const val = v.join('=');
            if (b <= character && character <= reg.lastIndex)
                return {
                    hit,
                    range: new vscode__WEBPACK_IMPORTED_MODULE_21__.Range(line, b, line, reg.lastIndex),
                    nm, val,
                };
        }
        return { hit: '', range: new vscode__WEBPACK_IMPORTED_MODULE_21__.Range(0, 0, 0, 0), nm: '', val: '' };
    }
}


/***/ }),

/***/ "./src/WPFolder.ts":
/*!*************************!*\
  !*** ./src/WPFolder.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WPFolder: () => (/* binding */ WPFolder)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var _ConfigBase__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./ConfigBase */ "./src/ConfigBase.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_4__);





class WPFolder {
    pc;
    #wp = undefined;
    #uriOpen = null;
    #uriWvPrj = null;
    #uriRes;
    #htmSrc;
    constructor(pc) {
        this.pc = pc;
        const path_res = this.pc.ctx.extensionPath + '/views/';
        this.#uriRes = vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(path_res);
        void (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.readFile)(path_res + 'folder.htm', { encoding: 'utf8' })
            .then(t => {
            this.#htmSrc = t
                .replace('<meta_autooff ', '<meta ')
                .replaceAll('${nonce}', (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_1__.getNonce)())
                .replace('.ts"></script>', '.js"></script>');
        });
    }
    open(uri) {
        const column = vscode__WEBPACK_IMPORTED_MODULE_3__.window.activeTextEditor?.viewColumn;
        const wp = this.#wp;
        if (this.#uriOpen === uri && wp) {
            wp.reveal(column);
            return;
        }
        if (!wp) {
            const wp = this.#wp = vscode__WEBPACK_IMPORTED_MODULE_3__.window.createWebviewPanel('SKYNovel-folder', '', column ?? vscode__WEBPACK_IMPORTED_MODULE_3__.ViewColumn.One, {
                enableScripts: true,
                localResourceRoots: [
                    this.#uriRes,
                    vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(this.pc.PATH_WS),
                ],
            });
            const wv = wp.webview;
            this.pc.ctx.subscriptions.push(wp.onDidDispose(() => { this.#wp = undefined; }, undefined, this.pc.ctx.subscriptions), wv.onDidReceiveMessage(({ cmd, text }) => {
                switch (cmd) {
                    case 'info':
                        vscode__WEBPACK_IMPORTED_MODULE_3__.window.showInformationMessage(text);
                        break;
                    case 'warn':
                        vscode__WEBPACK_IMPORTED_MODULE_3__.window.showWarningMessage(text);
                        break;
                }
            }, false));
            wv.html = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.repWvUri)(this.#htmSrc, wv, this.#uriRes)
                .replace(/<!--SOL-->.+?<!--EOL-->/s, '');
        }
        this.#uriOpen = uri;
        this.#update(uri);
    }
    #update(uri) {
        const vfp = uri.path;
        const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(vfp);
        const pp = this.pc.diff.fp2pp(fp);
        this.#wp.title = pp + ' フォルダ';
        let htm = '';
        const wv = this.#wp.webview;
        this.#uriWvPrj = wv.asWebviewUri(vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(this.pc.PATH_PRJ));
        const pathWp = String(this.#uriWvPrj);
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.foldProc)(fp, (vfp2, nm) => {
            const fp2 = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(vscode__WEBPACK_IMPORTED_MODULE_3__.Uri.file(vfp2).path);
            const pp2 = this.pc.diff.fp2pp(fp2);
            if (this.#REG_MOV.test(fp2)) {
                htm +=
                    `<div class="col pe-0">
	<div class="card text-bg-secondary">
		<video controls controlsList="nodownload" playsinline preload="metadata" class="w-100" src="${pathWp}${pp2}" class="card-img-top"></video>
		<div class="card-body">
			<a href="${pathWp}${pp2}" title="エディタにドラッグできます" class="btn btn-primary" title="エディタにドラッグできます">${nm}</a>
		</div>
	</div>
</div>`;
                return;
            }
            if (this.#REG_GRP.test(pp2)) {
                htm +=
                    `<div class="col pe-0">
	<img loading="lazy" src="${pathWp}${pp2}" title="${nm}"/>
</div>`;
                return;
            }
            if (this.#REG_SND.test(pp2)) {
                htm +=
                    `<div class="col pe-0">
	<div class="card text-bg-secondary">
		<audio controls src="${pathWp}${pp2}" class="card-img-top"></audio>
		<div class="card-body">
			<a href="${pathWp}${pp2}" title="エディタにドラッグできます" class="btn btn-primary" title="エディタにドラッグできます">${nm}</a>
		</div>
	</div>
</div>`;
                return;
            }
        }, () => { });
        wv.postMessage({ cmd: 'refresh', o: { htm } });
    }
    #REG_MOV = /\.(mp4|webm)$/;
    #REG_GRP = new RegExp(`\\.${_ConfigBase__WEBPACK_IMPORTED_MODULE_2__.SEARCH_PATH_ARG_EXT.SP_GSM}$`);
    #REG_SND = new RegExp(`\\.${_ConfigBase__WEBPACK_IMPORTED_MODULE_2__.SEARCH_PATH_ARG_EXT.SOUND}$`);
    updateDelay({ path }) {
        const uri = this.#uriOpen;
        if (!this.#wp || !uri)
            return;
        const fp = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(path);
        const fpOF = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(uri.path);
        if (!fp.startsWith(fpOF))
            return;
        if (this.#tiDelay)
            clearTimeout(this.#tiDelay);
        this.#tiDelay = setTimeout(() => {
            this.#tiDelay = undefined;
            this.#update(uri);
        }, 500);
    }
    #tiDelay = undefined;
    isOpend(path) {
        return this.#uriWvPrj && path.startsWith(this.#uriWvPrj.path);
    }
    close() {
        this.#wp?.dispose();
        this.#wp = undefined;
        this.#uriOpen = null;
    }
}


/***/ }),

/***/ "./src/WorkSpaces.ts":
/*!***************************!*\
  !*** ./src/WorkSpaces.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PRE_TASK_TYPE: () => (/* binding */ PRE_TASK_TYPE),
/* harmony export */   WorkSpaces: () => (/* binding */ WorkSpaces),
/* harmony export */   aPickItems: () => (/* binding */ aPickItems),
/* harmony export */   openURL: () => (/* binding */ openURL)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _ActivityBar__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./ActivityBar */ "./src/ActivityBar.ts");
/* harmony import */ var _Project__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./Project */ "./src/Project.ts");
/* harmony import */ var _DebugAdapter__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./DebugAdapter */ "./src/DebugAdapter.ts");
/* harmony import */ var _Debugger__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./Debugger */ "./src/Debugger.ts");
/* harmony import */ var _CteScore__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./CteScore */ "./src/CteScore.ts");
/* harmony import */ var _PrjTreeItem__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./PrjTreeItem */ "./src/PrjTreeItem.ts");
/* harmony import */ var _md_json__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./md.json */ "./src/md.json");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_8___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_8__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_9___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_9__);
/* harmony import */ var vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! vscode-languageclient/node */ "./node_modules/vscode-languageclient/node.js");
/* harmony import */ var vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10___default = /*#__PURE__*/__webpack_require__.n(vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10__);











const aPickItems = [];
function openURL(url, pathWs) {
    switch (url.scheme) {
        case 'ws-file':
            vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.openTextDocument(pathWs + url.path)
                .then(doc => vscode__WEBPACK_IMPORTED_MODULE_8__.window.showTextDocument(doc));
            break;
        case 'ws-folder':
            vscode__WEBPACK_IMPORTED_MODULE_8__.env.openExternal(vscode__WEBPACK_IMPORTED_MODULE_8__.Uri.file(pathWs + url.path));
            break;
        default: vscode__WEBPACK_IMPORTED_MODULE_8__.env.openExternal(url);
    }
}
const PRE_TASK_TYPE = 'SKYNovel Task';
class WorkSpaces {
    ctx;
    actBar;
    #aTiRoot = [];
    #mPrj = new Map;
    #lsp;
    constructor(ctx, actBar) {
        this.ctx = ctx;
        this.actBar = actBar;
        const itmStt = this.#addStatusItem('init');
        itmStt.text = '初期化中...';
        itmStt.busy = true;
        itmStt.detail = 'refresh';
        const module = ctx.asAbsolutePath('dist/LangSrv.js');
        const so = {
            run: { module, transport: vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10__.TransportKind.ipc },
            debug: { module, transport: vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10__.TransportKind.ipc,
                options: { execArgv: ['--nolazy',
                        '--inspect=' + String(7000 + Math.round(Math.random() * 999))
                    ] }, }
        };
        const co = {
            documentSelector: [_CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel],
            synchronize: {
                fileEvents: [
                    vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.createFileSystemWatcher('**/doc/prj/path.json'),
                ],
            },
        };
        this.#lsp = new vscode_languageclient_node__WEBPACK_IMPORTED_MODULE_10__.LanguageClient('SKYNovelLangSrv', 'SKYNovel Language Server', so, co);
        ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_8__.languages.registerHoverProvider(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel, this), vscode__WEBPACK_IMPORTED_MODULE_8__.window.registerTreeDataProvider('skynovel-ws', this), { dispose: () => this.#lsp.stop() }, this.#lsp.onRequest(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.REQ_ID, (hd) => {
            switch (hd.cmd) {
                case 'log':
                case 'error':
                    console.error(hd.txt);
                    return;
            }
            this.onRequest(hd);
        }), vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.onDidChangeWorkspaceFolders(e => this.#refresh(e)));
        const LEN_PRE_TASK_TYPE = PRE_TASK_TYPE.length;
        vscode__WEBPACK_IMPORTED_MODULE_8__.tasks.onDidEndTaskProcess(e => this.#hOnEndTask.get((e.execution.task.definition.type.slice(LEN_PRE_TASK_TYPE)))?.(e));
        itmStt.detail = 'initDebug';
        const emDbgLayTd = new vscode__WEBPACK_IMPORTED_MODULE_8__.EventEmitter;
        (0,_DebugAdapter__WEBPACK_IMPORTED_MODULE_3__.initDebug)(ctx, (o) => {
            switch (o.タグ名) {
                case ':connect':
                    this.#tiLayers = [];
                    break;
                case ':disconnect':
                    this.#tiLayers = [];
                    emDbgLayTd.fire(undefined);
                    break;
                case 'add_lay':
                    {
                        const t = new vscode__WEBPACK_IMPORTED_MODULE_8__.TreeItem(o.layer ?? '');
                        if (o.class === 'txt') {
                            t.iconPath = (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_1__.oIcon)('comment');
                            t.tooltip = `文字レイヤ layer=${o.layer ?? ''}`;
                            t.collapsibleState = vscode__WEBPACK_IMPORTED_MODULE_8__.TreeItemCollapsibleState.Expanded;
                        }
                        else {
                            t.iconPath = (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_1__.oIcon)(o.layer === 'base' ? 'image' : 'user');
                            t.tooltip = `画像レイヤ layer=${o.layer ?? ''}`;
                        }
                        t.command = {
                            command: 'skynovel.tiLayers.selectNode',
                            title: 'Select Node',
                            arguments: [o.layer],
                        };
                        this.#tiLayers.push(t);
                        emDbgLayTd.fire(undefined);
                    }
                    break;
            }
        });
        ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_8__.commands.registerCommand('skynovel.tiLayers.selectNode', node => _Debugger__WEBPACK_IMPORTED_MODULE_4__.Debugger.send2SN('_selectNode', { node })));
        itmStt.detail = 'layers';
        ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_8__.window.registerTreeDataProvider('skynovel-layers', {
            getChildren: t => {
                if (!t)
                    return this.#tiLayers;
                const icon = t.iconPath;
                if (!icon)
                    return this.#tiLayers;
                const a = typeof icon === 'string'
                    || icon instanceof vscode__WEBPACK_IMPORTED_MODULE_8__.ThemeIcon
                    || icon instanceof vscode__WEBPACK_IMPORTED_MODULE_8__.Uri
                    || icon.dark.path.endsWith('comment.svg')
                    ? [
                        { label: 'ボタン', icon: 'hand-point-down' },
                    ]
                    : [];
                return a.map(v => Object.assign(new vscode__WEBPACK_IMPORTED_MODULE_8__.TreeItem(v.label), {
                    iconPath: (0,_ActivityBar__WEBPACK_IMPORTED_MODULE_1__.oIcon)(v.icon),
                    command: {
                        command: 'skynovel.tiLayers.selectNode',
                        title: 'Select Node',
                        arguments: [t.label + '/' + v.label],
                    },
                }));
            },
            getTreeItem: t => t,
            onDidChangeTreeData: emDbgLayTd.event,
        }));
        ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_8__.languages.registerDocumentDropEditProvider(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel, this));
        _CteScore__WEBPACK_IMPORTED_MODULE_5__.CteScore.init(ctx);
        this.#removeStatusItem('init');
        for (const [tag_nm, { sum }] of Object.entries(_md_json__WEBPACK_IMPORTED_MODULE_7__))
            aPickItems.push({
                label: tag_nm,
                description: sum,
                uri: vscode__WEBPACK_IMPORTED_MODULE_8__.Uri.parse('https://famibee.github.io/SKYNovel/tag.html#' + tag_nm),
            });
    }
    #tiLayers = [];
    async provideDocumentDropEdits(td, pos, dataTransfer, tkn) {
        const dti = dataTransfer.get('text/uri-list');
        if (!dti)
            return null;
        const urlList = await dti.asString();
        if (tkn.isCancellationRequested)
            return null;
        const aUri = [];
        for (const res of urlList.split('\n')) {
            try {
                aUri.push(vscode__WEBPACK_IMPORTED_MODULE_8__.Uri.parse(res));
            }
            catch { }
        }
        if (aUri.length === 0)
            return null;
        for (const [vfpWs, prj] of this.#mPrj.entries()) {
            if (!td.uri.path.startsWith(vfpWs + '/doc/prj/'))
                continue;
            return await prj.drop(td, pos, aUri) ?? { insertText: '' };
        }
        return null;
    }
    provideHover(doc, pos) {
        for (const [vfpWs, prj] of this.#mPrj.entries()) {
            if (!doc.uri.path.startsWith(vfpWs + '/doc/prj/'))
                continue;
            return prj.provideHover(doc, pos);
        }
        return null;
    }
    async start() {
        await this.#lsp.start();
        this.#req2LSP = (uriWs, o) => {
            return this.#lsp.sendRequest(_CmnLib__WEBPACK_IMPORTED_MODULE_0__.REQ_ID, { ...o, pathWs: (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.fullSchPath2fp)(uriWs.path) });
        };
        this.ctx.subscriptions.push(vscode__WEBPACK_IMPORTED_MODULE_8__.commands.registerCommand('skynovel.openReferencePallet', () => this.#openReferencePallet()), vscode__WEBPACK_IMPORTED_MODULE_8__.commands.registerCommand('skynovel.opView', (uri) => {
            const { path } = uri;
            for (const [vfpWs, prj] of this.#mPrj.entries()) {
                if (!path.startsWith(vfpWs))
                    continue;
                prj.opView(uri);
            }
        }));
        if (_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_mac)
            (0,_PrjTreeItem__WEBPACK_IMPORTED_MODULE_6__.updStatBreak)('&&');
        else if (_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_win) {
            const chkShell = String(vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.getConfiguration('terminal.integrated.shell').get('windows'));
            (0,_PrjTreeItem__WEBPACK_IMPORTED_MODULE_6__.updStatBreak)(chkShell.endsWith('cmd.exe') ? '&' : ';');
        }
        this.#refresh();
    }
    #req2LSP = async () => { };
    #openReferencePallet() {
        const aWsFld = vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.workspaceFolders;
        const at = vscode__WEBPACK_IMPORTED_MODULE_8__.window.activeTextEditor;
        if (!aWsFld || !at) {
            vscode__WEBPACK_IMPORTED_MODULE_8__.window.showQuickPick(aPickItems, {
                placeHolder: 'どのリファレンスを開きますか?',
                matchOnDescription: true,
            })
                .then(q => { if (q?.uri)
                openURL(q.uri, ''); });
            return;
        }
        const vfp = at.document.uri.path;
        for (const [vfpWs, prj] of this.#mPrj.entries()) {
            if (!vfp.startsWith(vfpWs))
                continue;
            prj.openReferencePallet();
        }
    }
    get aLocalSNVer() {
        return this.#mPrj.values().map(v => v.getLocalSNVer()).toArray();
    }
    #hItmLangStt = {};
    #addStatusItem(id) {
        const ret = this.#hItmLangStt[id] = vscode__WEBPACK_IMPORTED_MODULE_8__.languages.createLanguageStatusItem(id, _CmnLib__WEBPACK_IMPORTED_MODULE_0__.docsel);
        return ret;
    }
    #removeStatusItem(id) {
        this.#hItmLangStt[id]?.dispose();
        delete this.#hItmLangStt[id];
    }
    #refresh(e) {
        const aWsFld = vscode__WEBPACK_IMPORTED_MODULE_8__.workspace.workspaceFolders;
        if (!aWsFld)
            return;
        if (!e) {
            for (const wsFld of aWsFld)
                this.#makePrj(wsFld);
            if (this.#aTiRoot.length === 0)
                return;
            this.#aTiRoot[0].collapsibleState = vscode__WEBPACK_IMPORTED_MODULE_8__.TreeItemCollapsibleState.Expanded;
            this.#emPrjTD.fire(undefined);
            return;
        }
        if (e.added.length > 0)
            this.#makePrj(aWsFld.slice(-1)[0]);
        else {
            const removed = e.removed[0];
            const nm = removed.name;
            const del = this.#aTiRoot.findIndex(v => v.label === nm);
            this.#aTiRoot.splice(del, 1);
            this.#mPrj.get(removed.uri.path)?.dispose();
        }
        this.#emPrjTD.fire(undefined);
    }
    #emPrjTD = new vscode__WEBPACK_IMPORTED_MODULE_8__.EventEmitter;
    onDidChangeTreeData = this.#emPrjTD.event;
    onRequest(hd) {
        const prj = this.#mPrj.get((_CmnLib__WEBPACK_IMPORTED_MODULE_0__.is_win ? '/c:' : '') + hd.pathWs);
        if (!prj) {
            console.error(`fn:WorkSpaces.ts onRequest 'project ${hd.pathWs} does not exist'`);
            return;
        }
        prj.onRequest(hd);
    }
    enableBtn(enable) {
        for (const prj of this.#mPrj.values())
            prj.enableBtn(enable);
    }
    #makePrj(wsFld) {
        const vfpWs = wsFld.uri.path;
        const pathWs = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(vfpWs);
        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_9__.existsSync)(pathWs + '/package.json')
            || !(0,fs_extra__WEBPACK_IMPORTED_MODULE_9__.existsSync)(pathWs + '/doc/prj/prj.json'))
            return;
        this.#mPrj.set(vfpWs, new _Project__WEBPACK_IMPORTED_MODULE_2__.Project(this.ctx, this.actBar, wsFld, this.#aTiRoot, this.#emPrjTD, this.#hOnEndTask, (o) => this.#req2LSP(wsFld.uri, o)));
    }
    #hOnEndTask = new Map([]);
    getTreeItem = (t) => t;
    getChildren = (t) => t ? t.children : this.#aTiRoot;
    dispose() {
        for (const prj of this.#mPrj.values())
            prj.dispose();
        this.#mPrj.clear();
        for (const [itm, v] of Object.entries(this.#hItmLangStt)) {
            if (Object.prototype.hasOwnProperty.call(this.#hItmLangStt, itm)) {
                v.dispose();
            }
        }
    }
}


/***/ }),

/***/ "./src/batch/BatOptPic.ts":
/*!********************************!*\
  !*** ./src/batch/BatOptPic.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BatOptPic: () => (/* binding */ BatOptPic),
/* harmony export */   PROC_ID_PIC: () => (/* binding */ PROC_ID_PIC)
/* harmony export */ });
/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../types */ "./src/types.ts");
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! fs-extra/esm */ "./node_modules/fs-extra/lib/esm.mjs");







const PROC_ID_PIC = 'cnv.mat.pic';
const REG_EXT_ORG = /\.(jpe?g|png)$/;
const REG_EXT_HTML = /\.(htm|html)$/;
const REG_REP_WEBPFLAG = /\w+\/\*WEBP\*\//g;
const REG_REP_JSON_CNV = /("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/;
const DEST_REP_JSON_CNV = '$1$2.webp","image_bkup":"$2.$3"';
const REG_REP_JSON_RESTORE = /webp","image_bkup":".+(jpe?g|png)"/;
const DEST_REP_JSON_RESTORE = '$1"';
class BatOptPic {
    pc;
    oBJ;
    #PATH_BJ;
    constructor(pc) {
        this.pc = pc;
        this.#PATH_BJ = this.pc.PATH_WS + `/${this.pc.FLD_SRC}/batch/cnv_mat_pic.json`;
        (async () => {
            if ((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)(this.#PATH_BJ)) {
                this.oBJ = await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.readJson)(this.#PATH_BJ, { encoding: 'utf8' });
                if (this.oBJ.order)
                    return;
            }
            await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.#PATH_BJ, this.oBJ = (0,_types__WEBPACK_IMPORTED_MODULE_0__.creBJ_OPTPIC)());
        })();
    }
    async go(modeInp) {
        const o = { cmd: 'notice.Component', id: PROC_ID_PIC, mode: 'wait' };
        await this.pc.ps.cmd2Vue(o);
        const oWp = {
            location: vscode__WEBPACK_IMPORTED_MODULE_4__.ProgressLocation.Notification,
            title: '画像最適化処理',
            cancellable: true,
        };
        switch (modeInp) {
            case 'enable':
                oWp.title = '変換有効化';
                break;
            case 'disable':
                oWp.title = '変換無効化';
                break;
            case 'reconv':
                oWp.title = '再変換';
                break;
            case 'prj_scan':
                oWp.title = 'prjフォルダ走査';
                break;
            case 'base_scan':
                oWp.title = 'baseフォルダ走査';
                break;
        }
        await vscode__WEBPACK_IMPORTED_MODULE_4__.window.withProgress(oWp, (prg, tknCancel) => this.#proc(modeInp, prg, tknCancel));
        o.mode = 'comp';
        await this.pc.ps.cmd2Vue(o);
    }
    disp() {
        return this.pc.ps.cmd2Vue({
            cmd: 'update.optPic',
            oOptPic: { ...this.oBJ, sum: {
                    ...this.oBJ.sum,
                    pathPicOpt: this.pc.ps.wvuWs + '/doc/prj/',
                    pathPicBase: this.pc.ps.wvuWs + `/${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_2__.FLD_PRJ_BASE}/`,
                } },
        });
    }
    async chgBJ(fnc = async () => { }) {
        await fnc();
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.#PATH_BJ, this.oBJ);
        await this.disp();
    }
    async #proc(modeInp, prg, tknCancel) {
        this.oBJ = {
            ...(0,_types__WEBPACK_IMPORTED_MODULE_0__.creBJ_OPTPIC)(),
            order: {
                quality: this.pc.ps.oWss['cnv.mat.webp_quality'],
                FLD_PRJ_BASE: `${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_2__.FLD_PRJ_BASE}/`,
            },
        };
        prg.report({ message: '処理ファイル調査中' });
        const aP = [];
        switch (modeInp) {
            case 'enable':
                (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir), (url, nm) => {
                        if (REG_EXT_ORG.test(nm)) {
                            aP.push(() => this.#cnv(url, (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(wdBase, nm)));
                            return;
                        }
                        if (REG_EXT_HTML.test(nm)) {
                            aP.push(() => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_WEBPFLAG, 'true/*WEBP*/', false);
                            }));
                            return;
                        }
                        if (nm.endsWith('.json'))
                            aP.push(() => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_JSON_CNV, DEST_REP_JSON_CNV);
                            }));
                    }, () => { });
                });
                break;
            case 'disable':
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ_BASE, () => { }, dir => {
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ_BASE, dir), (url, nm) => {
                        if (!REG_EXT_ORG.test(nm))
                            return;
                        const urlPrj = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir, nm);
                        aP.push(() => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.move)(url, urlPrj, { overwrite: true }));
                        const { name } = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.parse)(nm);
                        const delDest = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir, name + '.webp');
                        aP.push(() => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.remove)(delDest));
                    }, () => { });
                });
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ, () => { }, dir => {
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir), (url, nm) => {
                        if (REG_EXT_HTML.test(nm)) {
                            REG_REP_WEBPFLAG.lastIndex = 0;
                            aP.push(() => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_WEBPFLAG, 'false/*WEBP*/', false);
                            }));
                            return;
                        }
                        if (nm.endsWith('.json'))
                            aP.push(() => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_JSON_RESTORE, DEST_REP_JSON_RESTORE);
                            }));
                    }, () => { });
                });
                break;
            case 'reconv':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                this.oBJ.sum.baseSize =
                    this.oBJ.sum.webpSize = 0;
                for (const { ext, fld_nm } of Object.values(this.oBJ.hSize)) {
                    aP.push(() => this.#cnv((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, fld_nm + '.' + ext), (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ_BASE, fld_nm + '.' + ext), false));
                }
                break;
            case 'prj_scan':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir), (url, nm) => {
                        if (REG_EXT_ORG.test(nm)) {
                            const { name } = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.parse)(nm);
                            const size = this.oBJ.hSize[name];
                            if (size) {
                                const { baseSize = 0, webpSize = 0 } = size;
                                this.oBJ.sum.baseSize -= baseSize;
                                this.oBJ.sum.webpSize -= webpSize;
                            }
                            aP.push(() => this.#cnv(url, (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(wdBase, nm)));
                            return;
                        }
                        if (REG_EXT_HTML.test(nm)) {
                            aP.push(async () => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_WEBPFLAG, 'true/*WEBP*/', false);
                            }));
                            return;
                        }
                        if (nm.endsWith('.json'))
                            aP.push(() => Promise.try(() => {
                                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceFile)(url, REG_REP_JSON_CNV, DEST_REP_JSON_CNV);
                            }));
                    }, () => { });
                });
                break;
            case 'base_scan':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ_BASE, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    const wdPrj = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(this.pc.PATH_PRJ, dir);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(wdBase, (url, nm) => {
                        if (!REG_EXT_ORG.test(url))
                            return;
                        const toPath = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(wdPrj, nm.replace(REG_EXT_ORG, '.webp'));
                        if (!(0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.chkUpdate)(url, toPath))
                            return;
                        const { name } = (0,node_path__WEBPACK_IMPORTED_MODULE_3__.parse)(nm);
                        const size = this.oBJ.hSize[name];
                        if (size) {
                            const { baseSize = 0, webpSize = 0 } = size;
                            this.oBJ.sum.baseSize -= baseSize;
                            this.oBJ.sum.webpSize -= webpSize;
                        }
                        aP.push(() => this.#cnv(toPath, url, false));
                    }, () => { });
                });
                break;
            default: console.error('fn:BatOptPic.ts line:288 ERR');
        }
        let start_cnt = 0;
        const cnt = () => prg.report({
            increment: ++start_cnt / aP.length * 100,
            message: `処理中 ${String(start_cnt)}/${String(aP.length)} tasks`,
        });
        await Promise.allSettled(aP.map(v => (async () => {
            if (tknCancel.isCancellationRequested)
                return;
            await v();
            cnt();
        })()))
            .catch((e) => console.log(`fn:BatOptPic.ts ${String(e)}`));
        await this.chgBJ(async () => {
            const oBJ = this.oBJ;
            oBJ.aOrder
                .sort((k1, k2) => {
                const n1 = k1.pathBase.toUpperCase();
                const n2 = k2.pathBase.toUpperCase();
                if (n1 < n2)
                    return -1;
                if (n1 > n2)
                    return 1;
                return 0;
            });
            const a = Object.entries(oBJ.hSize)
                .sort(([k1], [k2]) => {
                const n1 = k1.toUpperCase();
                const n2 = k2.toUpperCase();
                if (n1 < n2)
                    return -1;
                if (n1 > n2)
                    return 1;
                return 0;
            });
            oBJ.hSize = Object.fromEntries(a);
        });
        if (this.oBJ.aOrder.length > 0)
            await this.pc.exeBatch('cnv_mat_pic', '', exit_code => {
                if (exit_code)
                    return;
                this.oBJ = (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.readJsonSync)(this.#PATH_BJ, { encoding: 'utf8' });
                void this.disp();
                switch (modeInp) {
                    case 'enable':
                    case 'disable':
                    case 'reconv':
                        void this.pc.updPathJson();
                        break;
                }
            });
        prg.report({ message: '完了' });
    }
    async #cnv(pathPrj, pathBase, do_move = true) {
        if (do_move)
            await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.move)(pathPrj, pathBase, { overwrite: true });
        this.oBJ.aOrder.push({
            pathPrj: this.pc.fp2pp(pathPrj),
            pathBase: this.pc.src2pp(pathBase),
        });
    }
    #log_enter(curPrj, curPrjBase) {
        const o = this.oBJ;
        for (const [fn, of] of Object.entries(this.oBJ.hSize)) {
            const { fld_nm, ext, baseSize, webpSize } = of;
            const pp = fld_nm + '.' + ext;
            if ((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(curPrj, pp))
                || (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)((0,node_path__WEBPACK_IMPORTED_MODULE_3__.resolve)(curPrjBase, pp)))
                o.hSize[fn] = of;
            else {
                o.sum.baseSize -= baseSize;
                o.sum.webpSize -= webpSize;
            }
        }
        this.oBJ = o;
    }
    async delRes(path) {
        const fn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.getFn)(path);
        if (!(fn in this.oBJ.hSize))
            return;
        const s = this.oBJ.hSize[fn];
        if (!s)
            return;
        const { baseSize, webpSize } = s;
        this.oBJ.sum.baseSize -= baseSize;
        this.oBJ.sum.webpSize -= webpSize;
        delete this.oBJ.hSize[fn];
        await this.disp();
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.#PATH_BJ, this.oBJ, { encoding: 'utf8' });
    }
}


/***/ }),

/***/ "./src/batch/BatOptSnd.ts":
/*!********************************!*\
  !*** ./src/batch/BatOptSnd.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BatOptSnd: () => (/* binding */ BatOptSnd),
/* harmony export */   PROC_ID_SND: () => (/* binding */ PROC_ID_SND)
/* harmony export */ });
/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../types */ "./src/types.ts");
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var fluent_ffmpeg__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fluent-ffmpeg */ "./node_modules/fluent-ffmpeg/index.js");
/* harmony import */ var fluent_ffmpeg__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(fluent_ffmpeg__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! fs-extra/esm */ "./node_modules/fs-extra/lib/esm.mjs");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_7___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_7__);








const PROC_ID_SND = 'cnv.mat.snd';
const REG_EXT_ORG = /\.(mp3|wav)$/;
class BatOptSnd {
    pc;
    #oBJ;
    #PATH_BJ;
    constructor(pc) {
        this.pc = pc;
        this.#PATH_BJ = this.pc.PATH_WS + `/${this.pc.FLD_SRC}/batch/cnv_mat_snd.json`;
        (async () => {
            if ((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)(this.#PATH_BJ))
                this.#oBJ = await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.readJson)(this.#PATH_BJ, { encoding: 'utf8' });
            else
                await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.#PATH_BJ, this.#oBJ = (0,_types__WEBPACK_IMPORTED_MODULE_0__.creOPTSND)());
        })();
    }
    async go(modeInp) {
        const o = { cmd: 'notice.Component', id: PROC_ID_SND, mode: 'wait' };
        await this.pc.ps.cmd2Vue(o);
        const oWp = {
            location: vscode__WEBPACK_IMPORTED_MODULE_7__.ProgressLocation.Notification,
            title: '画像最適化処理',
            cancellable: true,
        };
        switch (modeInp) {
            case 'enable':
                oWp.title = '変換有効化';
                break;
            case 'disable':
                oWp.title = '変換無効化';
                break;
            case 'reconv':
                oWp.title = '再変換';
                break;
            case 'prj_scan':
                oWp.title = 'prjフォルダ走査';
                break;
            case 'base_scan':
                oWp.title = 'baseフォルダ走査';
                break;
        }
        await vscode__WEBPACK_IMPORTED_MODULE_7__.window.withProgress(oWp, (prg, tknCancel) => this.#proc(modeInp, prg, tknCancel));
        o.mode = 'comp';
        await this.pc.ps.cmd2Vue(o);
    }
    disp() {
        return this.pc.ps.cmd2Vue({
            cmd: 'update.optSnd',
            oOptSnd: { ...this.#oBJ, sum: {
                    ...this.#oBJ.sum,
                    pathSndOpt: this.pc.ps.wvuWs + '/doc/prj/',
                    pathSndBase: this.pc.ps.wvuWs + `/${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_2__.FLD_PRJ_BASE}/`,
                } },
        });
    }
    async #chgBJ(fnc = async () => { }) {
        await fnc();
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.writeJson)(this.#PATH_BJ, this.#oBJ);
        await this.disp();
    }
    async #proc(modeInp, prg, tknCancel) {
        const codec = this.pc.ps.oWss['cnv.mat.snd.codec'];
        const extCnv = '.' + codec;
        const extOut = '.' + (codec === 'opus' ? 'm4a' : codec);
        this.#oBJ = {
            sum: {
                baseSize: 0,
                optSize: 0,
                pathSndOpt: '',
                pathSndBase: '',
            },
            hSize: {},
        };
        prg.report({ message: '処理ファイル調査中' });
        const aP = [];
        switch (modeInp) {
            case 'enable':
                (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ, dir), (url, nm) => {
                        if (!REG_EXT_ORG.test(nm))
                            return;
                        aP.push(() => this.#cnv(extCnv, extOut, url, (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(wdBase, nm)));
                    }, () => { });
                });
                break;
            case 'disable':
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ_BASE, () => { }, dir => {
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ_BASE, dir), (url, nm) => {
                        if (!REG_EXT_ORG.test(nm))
                            return;
                        const urlPrj = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ, dir, nm);
                        aP.push(async () => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.move)(url, urlPrj, { overwrite: true }));
                        const delDest = urlPrj.slice(0, -3);
                        for (const ext of ['m4a', 'aac', 'ogg'])
                            aP.push(() => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.remove)(delDest + ext));
                    }, () => { });
                });
                break;
            case 'reconv':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                this.#oBJ.sum.baseSize =
                    this.#oBJ.sum.optSize = 0;
                for (const { ext, fld_nm } of Object.values(this.#oBJ.hSize)) {
                    aP.push(() => this.#cnv(extCnv, extOut, (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ, fld_nm + '.' + ext), (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ_BASE, fld_nm + '.' + ext), false));
                }
                break;
            case 'prj_scan':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)((0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ, dir), (url, nm) => {
                        if (REG_EXT_ORG.test(nm)) {
                            const { name } = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.parse)(nm);
                            const size = this.#oBJ.hSize[name];
                            if (size) {
                                const { baseSize = 0, optSize = 0 } = size;
                                this.#oBJ.sum.baseSize -= baseSize;
                                this.#oBJ.sum.optSize -= optSize;
                            }
                            aP.push(() => this.#cnv(extCnv, extOut, url, (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(wdBase, nm)));
                        }
                    }, () => { });
                });
                break;
            case 'base_scan':
                this.#log_enter(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
                (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ_BASE, () => { }, dir => {
                    const wdBase = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ_BASE, dir);
                    (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.mkdirsSync)(wdBase);
                    const wdPrj = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(this.pc.PATH_PRJ, dir);
                    (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(wdBase, (url, nm) => {
                        if (!REG_EXT_ORG.test(url))
                            return;
                        const toPath = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(wdPrj, nm.replace(REG_EXT_ORG, '.webp'));
                        if (!(0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.chkUpdate)(url, toPath))
                            return;
                        const { name } = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.parse)(nm);
                        const size = this.#oBJ.hSize[name];
                        if (size) {
                            const { baseSize = 0, optSize = 0 } = size;
                            this.#oBJ.sum.baseSize -= baseSize;
                            this.#oBJ.sum.optSize -= optSize;
                        }
                        aP.push(() => this.#cnv(extCnv, extOut, toPath, url, false));
                    }, () => { });
                });
                break;
            default: console.error('fn:BatOptSnd.ts line:216 ');
        }
        let start_cnt = 0;
        const cnt = () => prg.report({
            increment: ++start_cnt / aP.length * 100,
            message: `処理中 ${String(start_cnt)}/${String(aP.length)} tasks`,
        });
        await Promise.allSettled(aP.map(v => (async () => {
            if (tknCancel.isCancellationRequested)
                return;
            await v();
            cnt();
        })()))
            .catch((e) => console.log(`fn:BatOptSnd.ts ${String(e)}`));
        await this.#chgBJ(async () => {
            const a = Object.entries(this.#oBJ.hSize)
                .sort(([k1], [k2]) => {
                const n1 = k1.toUpperCase();
                const n2 = k2.toUpperCase();
                if (n1 < n2)
                    return -1;
                if (n1 > n2)
                    return 1;
                return 0;
            });
            this.#oBJ.hSize = Object.fromEntries(a);
        });
        switch (modeInp) {
            case 'enable':
            case 'disable':
            case 'reconv':
                void this.pc.updPathJson();
                break;
        }
        prg.report({ message: '完了' });
    }
    #log_enter(curPrj, curPrjBase) {
        const o = this.#oBJ;
        for (const [fn, of] of Object.entries(this.#oBJ.hSize)) {
            const { fld_nm, ext, baseSize, optSize } = of;
            const pp = fld_nm + '.' + ext;
            if ((0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)((0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(curPrj, pp))
                || (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.existsSync)((0,node_path__WEBPACK_IMPORTED_MODULE_4__.resolve)(curPrjBase, pp)))
                o.hSize[fn] = of;
            else {
                o.sum.baseSize -= baseSize;
                o.sum.optSize -= optSize;
            }
        }
        this.#oBJ = o;
    }
    async #cnv(extCnv, extOut, pathInp, pathBase, do_move = true) {
        const { dir, name } = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.parse)(pathInp);
        if (do_move)
            await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.move)(pathInp, pathBase, { overwrite: true });
        else
            await Promise.allSettled(['m4a', 'aac', 'ogg']
                .map(ext => (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.remove)(dir + '/' + name + '.' + ext)));
        const { dir: dirBase, ext } = (0,node_path__WEBPACK_IMPORTED_MODULE_4__.parse)(pathBase);
        const pathWk = dirBase + '/' + name + extCnv;
        const fi = this.#oBJ.hSize[name] ??= { fld_nm: (0,node_path__WEBPACK_IMPORTED_MODULE_4__.basename)(dir) + '/' + name, baseSize: 0, optSize: 0, ext: '', };
        await new Promise(re => fluent_ffmpeg__WEBPACK_IMPORTED_MODULE_3___default()(pathBase)
            .save(pathWk)
            .on('error', (e) => console.error(e))
            .on('end', (_stdout, _stderr) => {
            const baseSize = (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.statSync)(pathBase).size;
            const optSize = (0,node_fs__WEBPACK_IMPORTED_MODULE_5__.statSync)(pathWk).size;
            this.#oBJ.hSize[name] = { ...fi, baseSize, optSize, ext: ext.slice(1), };
            this.#oBJ.sum.baseSize += baseSize;
            this.#oBJ.sum.optSize += optSize;
            (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_6__.moveSync)(pathWk, dir + '/' + name + extOut, { overwrite: true });
            re();
        }));
    }
    async delRes(path) {
        const fn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.getFn)(path);
        if (!(fn in this.#oBJ.hSize))
            return;
        const s = this.#oBJ.hSize[fn];
        if (!s)
            return;
        const { baseSize, optSize } = s;
        this.#oBJ.sum.baseSize -= baseSize;
        this.#oBJ.sum.optSize -= optSize;
        delete this.#oBJ.hSize[fn];
        await this.#chgBJ();
    }
}


/***/ }),

/***/ "./src/batch/BatPsdFace.ts":
/*!*********************************!*\
  !*** ./src/batch/BatPsdFace.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BatPsdFace: () => (/* binding */ BatPsdFace)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var psd_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! psd.js */ "./node_modules/psd.js/dist/index.mjs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var fs_extra_esm__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fs-extra/esm */ "./node_modules/fs-extra/lib/esm.mjs");




class BatPsdFace {
    pc;
    #PATH_BJ;
    #PATH_TMP = (0,node_fs__WEBPACK_IMPORTED_MODULE_2__.mkdtempSync)('/tmp/SKYNovel_PsdFace-');
    constructor(pc) {
        this.pc = pc;
        this.#PATH_BJ = `${this.pc.PATH_WS}/${this.pc.FLD_SRC}/batch/cnv_psd_face.json`;
    }
    async go(src) {
        const oBJ = {
            aOrder: [],
            err: '',
        };
        const aP = [];
        const psd = await psd_js__WEBPACK_IMPORTED_MODULE_1__["default"].open(src);
        const t = psd.tree();
        const { document: { width, height } } = t.export();
        let out = `;#ED FACE
; *******************************************************
;#ED {"width":${String(width)}, "height":${String(height)}}
`;
        const a = t.descendants();
        const len = a.length;
        let idxLast = len;
        while (0 <= --idxLast) {
            const { type, parent } = a[idxLast];
            if (type === 'group' || parent.isRoot())
                break;
        }
        let nm = '';
        const hn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(src);
        a.forEach((nc, i) => {
            const { type, name, parent } = nc;
            if (type === 'group') {
                out += `;#ED FACE_FOLDER ${name}\n`;
                nm = '_' + name;
                return;
            }
            if (parent.isRoot()) {
                if (nm !== '')
                    out += ';#ED FACE_FOLDER /\n';
                nm = '';
            }
            out += this.#genPsd2Layer(hn + nm, nc, idxLast <= i, width, height, aP, oBJ);
        });
        out += `
; *******************************************************

[return]\n`;
        const fnOut = this.pc.PATH_PRJ + `face/face${hn}.sn`;
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_3__.ensureFile)(fnOut);
        aP.push((0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_3__.outputFile)(fnOut, out, 'utf8'));
        await Promise.allSettled(aP);
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_3__.writeJson)(this.#PATH_BJ, oBJ, { encoding: 'utf8' });
        await this.pc.exeBatch('cnv_psd_face', '');
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_3__.remove)(this.#PATH_TMP);
    }
    #genPsd2Layer(fld, { name, left, top, width, height, layer }, is_canvas_size, cvsW, cvsH, aP, oLog) {
        const fn = fld + '_' + name.replaceAll(this.#REG_NG_PSD_LAYNM, '#');
        const pp_out = `face/${fn}.png`;
        const path_out = this.pc.PATH_PRJ + pp_out;
        const bm = layer.blendingMode();
        const ret = `${is_canvas_size ? ';' : ''}\t[add_face name=${fn} dx=${left} dy=${top}${bm === 'normal' ? '' : ` blendmode=${bm}`}]\n`;
        if (!is_canvas_size) {
            aP.push((async () => {
                await layer.image.saveAsPng(path_out);
            })());
            return ret;
        }
        const fp_tmp = `${this.#PATH_TMP}/${fn}.png`;
        aP.push((async () => {
            try {
                await layer.image.saveAsPng(fp_tmp);
                oLog.aOrder.push({
                    fp_tmp,
                    extend: {
                        left,
                        right: cvsW - left - width,
                        top,
                        bottom: cvsH - top - height,
                        background: { r: 0, g: 0, b: 0, alpha: 0 },
                    },
                    pp_out,
                });
            }
            catch (e) {
                console.error('  PSD が異常です' + String(left < 0 || cvsW - left - width < 0 ||
                    top < 0 || cvsH - top - height < 0) ? '。レイヤがキャンバスからはみ出ています。レイヤを動かすかトリミングしてください' : 0);
                console.error(`  [ERR] ${String(e)}`);
            }
        })());
        return ret;
    }
    #REG_NG_PSD_LAYNM = /[\\/:*?"<>|.\s]/g;
}


/***/ }),

/***/ "./src/batch/WatchFile.ts":
/*!********************************!*\
  !*** ./src/batch/WatchFile.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WatchFile: () => (/* binding */ WatchFile)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var minimatch__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! minimatch */ "./node_modules/minimatch/dist/esm/index.js");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_3__);




class WatchFile {
    pc;
    constructor(pc) {
        this.pc = pc;
    }
    initOnce(updPathJson, encIfNeeded) {
        WatchFile.#updPathJson = updPathJson;
        WatchFile.encIfNeeded = encIfNeeded;
        vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.onDidRenameFiles(e => this.#onDidRenameFiles(e));
        const ptnFld = 'doc/prj/*';
        const fwFld = vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.createFileSystemWatcher(new vscode__WEBPACK_IMPORTED_MODULE_2__.RelativePattern(this.pc.wsFld, ptnFld));
        fwFld.onDidCreate(newUri => this.pc.addSeq(() => this.#seqDidCreate(newUri), `CRE ${ptnFld}`));
        fwFld.onDidDelete(oldUri => this.pc.addSeq(() => this.#seqDidDelete(oldUri), `DEL ${ptnFld}`));
    }
    static #updPathJson;
    static encIfNeeded;
    async #onDidRenameFiles({ files }) {
        const PATH_WS_LEN = this.pc.PATH_WS.length;
        for (const { oldUri, newUri } of files) {
            const ppOld = oldUri.path.slice(PATH_WS_LEN + 1);
            const isOldRnInPrj = ppOld.startsWith('doc/');
            const ppNew = newUri.path.slice(PATH_WS_LEN + 1);
            const isNewRnInPrj = ppNew.startsWith('doc/');
            for (const w of this.#aWatchRp2CreDelProc) {
                const { pat } = w;
                if (isOldRnInPrj && w.del && (0,minimatch__WEBPACK_IMPORTED_MODULE_1__.minimatch)(ppOld, pat))
                    await w.del(oldUri);
                if (isNewRnInPrj && w.crechg && (0,minimatch__WEBPACK_IMPORTED_MODULE_1__.minimatch)(ppNew, pat))
                    await w.crechg(newUri, true);
            }
        }
    }
    #aWatchRp2CreDelProc = [];
    async #seqDidCreate(newUri) {
        if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_3__.statSync)(newUri.path).isDirectory())
            return;
        await this.pc.ps.onCreDir(newUri);
        const nm = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(newUri.path) + '/';
        const aPp2 = (await vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.fs.readDirectory(newUri))
            .filter(([, ty]) => ty === vscode__WEBPACK_IMPORTED_MODULE_2__.FileType.File)
            .map(([fp2pp,]) => 'doc/prj/' + nm + fp2pp);
        for (const w of this.#aWatchRp2CreDelProc) {
            const { pat } = w;
            if (!w.crechg || !pat.startsWith('doc/prj/'))
                continue;
            for (const pp2 of aPp2) {
                const match = (0,minimatch__WEBPACK_IMPORTED_MODULE_1__.minimatch)(pp2, pat);
                if (match)
                    await w.crechg(vscode__WEBPACK_IMPORTED_MODULE_2__.Uri.file(this.pc.PATH_WS + '/' + pp2), true);
            }
        }
    }
    async #seqDidDelete(oldUri) {
        await this.pc.ps.onDelDir(oldUri);
        const nm = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(oldUri.path) + '/';
        const aPP2 = this.pc.diff.keysPP
            .filter(pp => pp.startsWith(nm))
            .map(pp => 'doc/prj/' + pp);
        for (const w of this.#aWatchRp2CreDelProc) {
            const { pat } = w;
            if (!w.del || !pat.startsWith('doc/prj/'))
                continue;
            for (const pp2 of aPP2) {
                const match = (0,minimatch__WEBPACK_IMPORTED_MODULE_1__.minimatch)(pp2, pat);
                if (match)
                    await w.del(vscode__WEBPACK_IMPORTED_MODULE_2__.Uri.file(this.pc.PATH_WS + '/' + pp2));
            }
        }
    }
    async init2th() { await WatchFile.#updPathJson(); }
    lasyPathJson() {
        if (this.#tiLasyPathJson)
            clearTimeout(this.#tiLasyPathJson);
        this.#tiLasyPathJson = setTimeout(() => { void WatchFile.#updPathJson(); }, 500);
    }
    #tiLasyPathJson = undefined;
    async watchFld(pat, pathDest, init, crechg, del, updPathJson = false) {
        this.#aWatchRp2CreDelProc.push({ pat, crechg, del });
        const encIfNeeded = pat.startsWith('doc/prj/*/')
            ? async (uri) => {
                if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_3__.existsSync)(uri.path))
                    await WatchFile.encIfNeeded(uri);
            }
            : async () => { };
        if (init)
            await Promise.allSettled((await vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.findFiles(pat))
                .map(async (uri) => {
                await init(uri);
                return encIfNeeded(uri);
            }));
        const fw = vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.createFileSystemWatcher(new vscode__WEBPACK_IMPORTED_MODULE_2__.RelativePattern(this.pc.wsFld, pat), !crechg, !crechg, !del);
        if (crechg)
            this.pc.ctx.subscriptions.push(fw.onDidCreate(uri => {
                this.pc.addSeq(async () => {
                    await crechg(uri, true);
                    await encIfNeeded(uri);
                    this.pc.ps.pnlWVFolder.updateDelay(uri);
                    if (updPathJson)
                        this.lasyPathJson();
                }, `CRE ${pat}`);
            }), fw.onDidChange(uri => {
                this.pc.addSeq(async () => {
                    await this.#delDest(pathDest, uri);
                    await crechg(uri, false);
                    await encIfNeeded(uri);
                    this.pc.ps.pnlWVFolder.updateDelay(uri);
                }, `CHG ${pat}`);
            }));
        if (del)
            this.pc.ctx.subscriptions.push(fw.onDidDelete(uri => {
                this.pc.addSeq(async () => {
                    await this.#delDest(pathDest, uri);
                    if (await del(uri)) {
                        const { pathCn, pp } = this.pc.diff.path2cn(uri.path);
                        if (pathCn)
                            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_3__.remove)(pathCn);
                        this.pc.diff.del(pp);
                        await this.pc.diff.save();
                    }
                    this.pc.ps.pnlWVFolder.updateDelay(uri);
                    if (updPathJson)
                        this.lasyPathJson();
                }, `DEL ${pat}`);
            }));
    }
    chkUpdateByDiff(pathSrc, pathDest) {
        if (this.pc.isCryptoMode()) {
            const { pathCn } = this.pc.diff.path2cn(pathDest);
            if (!pathCn)
                return true;
            return (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.chkUpdate)(pathSrc, pathCn);
        }
        return (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.chkUpdate)(pathSrc, pathDest);
    }
    async #delDest(ptDest, { path }) {
        if (ptDest === '')
            return;
        const hn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(path);
        const aUri = await vscode__WEBPACK_IMPORTED_MODULE_2__.workspace.findFiles(ptDest.replaceAll('[FN]', hn));
        await Promise.allSettled(aUri.map(async ({ path }) => {
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_3__.remove)(path);
            const { pathCn, pp } = this.pc.diff.path2cn(path);
            if (pathCn)
                await (0,fs_extra__WEBPACK_IMPORTED_MODULE_3__.remove)(pathCn);
            this.pc.diff.del(pp);
        }));
        await this.pc.diff.save();
    }
    async delOldDiff(reg) {
        if (!this.pc.isCryptoMode())
            return;
        await this.pc.diff.filter(reg);
    }
}


/***/ }),

/***/ "./src/batch/WfbOptFont.ts":
/*!*********************************!*\
  !*** ./src/batch/WfbOptFont.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WfbOptFont: () => (/* binding */ WfbOptFont)
/* harmony export */ });
/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../types */ "./src/types.ts");
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _WatchFile__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./WatchFile */ "./src/batch/WatchFile.ts");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! node:path */ "node:path");
/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var node_os__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! node:os */ "node:os");
/* harmony import */ var node_os__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(node_os__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node:fs/promises */ "node:fs/promises");
/* harmony import */ var node_fs_promises__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_fs_promises__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var node_child_process__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! node:child_process */ "node:child_process");
/* harmony import */ var node_child_process__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(node_child_process__WEBPACK_IMPORTED_MODULE_6__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_7___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_7__);
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_8___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_8__);









const PROC_ID = 'cnv.font.subset';
class WfbOptFont extends _WatchFile__WEBPACK_IMPORTED_MODULE_2__.WatchFile {
    #PATH_FONT_JSON;
    #A_DIR_FONT = [];
    #A_REP_MASKP2FP = [];
    #A_REP_FP2MASKP = [];
    #PATH_BATOUT_JSON;
    #getHead2Mes;
    constructor(pc) {
        super(pc);
        const PATH_FONT = `${pc.PATH_WS}/${pc.FLD_SRC}/font`;
        this.#PATH_FONT_JSON = `${PATH_FONT}/font.json`;
        this.#PATH_BATOUT_JSON = `${PATH_FONT}/subset_font.json`;
        const { username } = (0,node_os__WEBPACK_IMPORTED_MODULE_4__.userInfo)();
        const aMat = [
            { mask_path: '::PATH_PRJ_FONTS::', fp: PATH_FONT },
            { mask_path: '::PATH_USER_FONTS::', fp: _CmnLib__WEBPACK_IMPORTED_MODULE_1__.is_win
                    ? `C:/Users/${username}/AppData/Local/Microsoft/Windows/Fonts`
                    : `/Users/${username}/Library/Fonts` },
            { mask_path: '::PATH_OS_FONTS::', fp: _CmnLib__WEBPACK_IMPORTED_MODULE_1__.is_win
                    ? 'C:/Windows/Fonts'
                    : '/Library/Fonts' },
            { mask_path: '::PATH_WS::', fp: pc.PATH_WS },
        ];
        for (const o of aMat) {
            this.#A_DIR_FONT.push(o.fp);
            this.#A_REP_MASKP2FP.push(p => p.replace(o.mask_path, o.fp));
            this.#A_REP_FP2MASKP.push(p => p.replace(o.fp, o.mask_path));
        }
        const H_HEAD2MES = {
            '::PATH_PRJ_': `${pc.FLD_SRC}/font/ 下`,
            '::PATH_USER': 'OS（ユーザー別）へのインストール済みフォント',
            '::PATH_OS_F': 'OS（ユーザー共通）へのインストール済みフォント',
        };
        this.#getHead2Mes = inp => H_HEAD2MES[inp.slice(0, 11)] ?? inp;
    }
    async init(noticeChgTxt, noticeDelTxt, sendNeedGo) {
        return this.watchFld('doc/prj/*/*.{sn,json,woff2,woff,otf,ttf,htm,html,css,js}', '', async () => { }, async ({ path }, cre) => {
            if (cre && /\.ss?n$/.test(path))
                await sendNeedGo();
            return noticeChgTxt(path);
        }, async ({ path }) => {
            if (/\.ss?n$/.test(path))
                await sendNeedGo();
            return noticeDelTxt(path);
        }, true);
    }
    enable() { return this.#procOnOff(true); }
    disable() { return this.#procOnOff(false); }
    async #procOnOff(minify) {
        this.pc.watchFile = false;
        const o = { cmd: 'notice.Component', id: PROC_ID, mode: 'wait' };
        await this.pc.ps.cmd2Vue(o);
        (0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.foldProc)(this.pc.PATH_PRJ + 'script/', (fp, nm) => { if (this.#REG_EXT_FONT.test(nm))
            (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.removeSync)(fp); }, () => { });
        if (!minify) {
            await this.#proc(false);
            o.mode = 'comp';
            await this.pc.ps.cmd2Vue(o);
            this.pc.watchFile = true;
            return;
        }
        const hFont = {};
        hFont[_types__WEBPACK_IMPORTED_MODULE_0__.H_FONTJSON_nm_DEF_FONT] = { inp: '', txt: '' };
        for (const f2s of Object.values(this.#InfFont.hSn2Font2Str)) {
            for (const [font_nm, str] of Object.entries(f2s)) {
                this.#ensureFont2Str(font_nm, hFont);
                hFont[font_nm].txt += str;
            }
        }
        this.#ensureFont2Str(this.#InfFont.defaultFontName, hFont);
        hFont[this.#InfFont.defaultFontName].txt += hFont[_types__WEBPACK_IMPORTED_MODULE_0__.H_FONTJSON_nm_DEF_FONT].txt;
        delete hFont[_types__WEBPACK_IMPORTED_MODULE_0__.H_FONTJSON_nm_DEF_FONT];
        for (const fj of Object.values(hFont)) {
            const s = new Set(Array.from(fj.txt));
            fj.txt = [...s].sort().join('');
        }
        await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.outputJson)(this.#PATH_FONT_JSON, hFont);
        await this.#proc(true, hFont);
        o.mode = 'comp';
        await this.pc.ps.cmd2Vue(o);
        this.pc.watchFile = true;
    }
    #REG_EXT_FONT = /\.(woff2?|otf|ttf)$/i;
    #InfFont = {
        defaultFontName: '',
        hSn2Font2Str: {},
        hFp2FontErr: {},
    };
    #ensureFont2Str = (font_nm, hFont) => {
        hFont[font_nm] ??= {
            inp: this.#getFontNm2path(font_nm)
                .replace(new RegExp(`^.+/${this.pc.FLD_SRC}/font`), '::PATH_PRJ_FONTS::')
                .replace(_CmnLib__WEBPACK_IMPORTED_MODULE_1__.is_win
                ? /C:\/Users\/[^/]+\/AppData\/Local\/Microsoft\/Windows\/Fonts/
                : /\/Users\/[^/]+\/Library\/Fonts/, '::PATH_USER_FONTS::')
                .replace(_CmnLib__WEBPACK_IMPORTED_MODULE_1__.is_win ? 'C:/Windows/Fonts' : '/Library/Fonts', '::PATH_OS_FONTS::'),
            txt: '',
        };
    };
    async #proc(minify, hFont) {
        const oFont = hFont ?? await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readJson)(this.#PATH_FONT_JSON, { encoding: 'utf8' });
        const aP = [];
        let start_cnt = 0;
        const cnv = minify
            ? async (ssf, nm, str, prg, tknCancel) => {
                try {
                    if (tknCancel.isCancellationRequested)
                        return;
                    const fnTmp = this.#PATH_BATOUT_JSON.slice(0, -5) + `_${nm}.txt`;
                    await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.outputFile)(fnTmp, str, { encoding: 'utf8' });
                    await new Promise((re, rj) => (0,node_child_process__WEBPACK_IMPORTED_MODULE_6__.exec)(`pyftsubset "${ssf.inp}" --text-file="${fnTmp}" --layout-features='*' --flavor=woff2 --output-file="${ssf.out}" --verbose`, (e, _stdout, stderr) => {
                        if (e) {
                            const m = `${nm} 出力エラー：` + e.message.replace(/--text-file=[^\n]+/, '...');
                            console.error(m);
                            ssf.err += m + '\n';
                            rj(new Error(m));
                            return;
                        }
                        const err = stderr.replaceAll(this.pc.PATH_WS, '::PATH_WS::');
                        (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.outputFileSync)(fnTmp, err, { encoding: 'utf8' });
                        prg.report({
                            increment: ++start_cnt / aP.length * 100,
                            message: `処理中 ${String(start_cnt)}/${String(aP.length)} tasks`,
                        });
                        const a = /Missing glyphs for requested Unicodes: (\[[^\]]+])/.exec(err);
                        if (a) {
                            const aCode = JSON.parse(a[1]?.replaceAll('\'', '"') ?? '[]');
                            rj(new Error(`${nm} 出力警告：フォントファイルに含まれない文字【${aCode.map(c => String.fromCharCode(parseInt(c.slice(2), 16))).join()}】がありました。[Open]ボタンからログを確認（Missing glyphs ...）できます。`));
                            return;
                        }
                        re();
                    }));
                }
                catch (e) {
                    if (e instanceof Error)
                        ssf.err += e.message.replace(/--text-file=[^\n]+/, '...') + '\n';
                    else
                        ssf.err += `err pyftsubset "${ssf.inp}"`;
                }
            }
            : ssf => (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.copy)(ssf.inp, ssf.out);
        const oBJ = {};
        await vscode__WEBPACK_IMPORTED_MODULE_8__.window.withProgress({
            location: vscode__WEBPACK_IMPORTED_MODULE_8__.ProgressLocation.Notification,
            title: 'フォント最適化処理',
            cancellable: true,
        }, async (prg, tknCancel) => {
            for (const [nm, { inp, txt }] of Object.entries(oFont)) {
                let inp2 = inp;
                for (const fnc of this.#A_REP_MASKP2FP)
                    inp2 = fnc(inp2);
                const ssf = oBJ[nm] = {
                    inp: inp2,
                    out: `${this.pc.PATH_WS}/doc/prj/script/${nm}${minify ? '.woff2' : (0,node_path__WEBPACK_IMPORTED_MODULE_3__.extname)(inp)}`,
                    iSize: 1, oSize: 1, err: '',
                };
                if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(inp2)) {
                    ssf.err = `変換失敗です。入力ファイル ${(0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.getFn)(inp) + (0,node_path__WEBPACK_IMPORTED_MODULE_3__.extname)(inp)} が存在するか確認してください`;
                    continue;
                }
                aP.push(cnv(ssf, nm, txt, prg, tknCancel));
            }
            await Promise.allSettled(aP);
        });
        for (const [nm, ssf] of Object.entries(oBJ)) {
            if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(ssf.out)) {
                ssf.err += `変換失敗です。出力ファイル ${ssf.out} が存在しません`;
                continue;
            }
            ssf.iSize = (await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_5__.stat)(ssf.inp)).size;
            ssf.oSize = (await (0,node_fs_promises__WEBPACK_IMPORTED_MODULE_5__.stat)(ssf.out)).size;
            ssf.inp = oFont[nm].inp;
        }
        await this.disp(oBJ);
    }
    updDiag(InfFont) {
        this.#InfFont = InfFont;
        const haDiag = {};
        for (const [fp, a] of Object.entries(InfFont.hFp2FontErr)) {
            const aD = [];
            for (const { err, nm } of a) {
                if (this.#getFontNm2path(nm))
                    continue;
                aD.push({ mes: err, sev: 'E' });
            }
            if (aD.length > 0)
                haDiag[fp] = aD;
        }
        return haDiag;
    }
    #getFontNm2path(font_nm) {
        for (const base of this.#A_DIR_FONT) {
            for (const ext of ['woff2', 'otf', 'ttf', 'WOFF2', 'OTF', 'TTF']) {
                const path = `${base}/${font_nm}.${ext}`;
                if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(path))
                    return path;
            }
        }
        return '';
    }
    async disp(oBJ) {
        if (oBJ) {
            for (const ssf of Object.values(oBJ)) {
                let i = ssf.out;
                for (const fnc of this.#A_REP_FP2MASKP)
                    i = fnc(i);
                ssf.out = i;
            }
            await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.outputJson)(this.#PATH_BATOUT_JSON, oBJ);
        }
        else {
            if (!(0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.existsSync)(this.#PATH_BATOUT_JSON)) {
                await this.pc.ps.cmd2Vue({ cmd: 'update.cnvFont', aCnvFont: [] });
                return;
            }
            oBJ = await (0,fs_extra__WEBPACK_IMPORTED_MODULE_7__.readJson)(this.#PATH_BATOUT_JSON);
        }
        const o = {
            cmd: 'update.cnvFont',
            aCnvFont: Object.entries(oBJ).map(([nm, ssf]) => ({
                nm,
                mes: this.#getHead2Mes(ssf.inp),
                iSize: ssf.iSize,
                oSize: ssf.oSize,
                err: ssf.err,
            })).sort(),
        };
        await this.pc.ps.cmd2Vue(o);
    }
}


/***/ }),

/***/ "./src/batch/WfbOptPic.ts":
/*!********************************!*\
  !*** ./src/batch/WfbOptPic.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WfbOptPic: () => (/* binding */ WfbOptPic)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var _WatchFile__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./WatchFile */ "./src/batch/WatchFile.ts");
/* harmony import */ var _BatOptPic__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./BatOptPic */ "./src/batch/BatOptPic.ts");
/* harmony import */ var _BatPsdFace__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./BatPsdFace */ "./src/batch/BatPsdFace.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! node:fs */ "node:fs");
/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_6__);
/* harmony import */ var fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! fs-extra/esm */ "./node_modules/fs-extra/lib/esm.mjs");








const ptnSrcBaseInPrj = 'doc/prj/*/*.{jpg,jpeg,png}';
const ptnSrcOptInPrj = 'doc/prj/*/*.webp';
class WfbOptPic extends _WatchFile__WEBPACK_IMPORTED_MODULE_2__.WatchFile {
    #bat;
    #batPsdFace;
    #PATH_BJ_cut_round = this.pc.PATH_WS + `/${this.pc.FLD_SRC}/batch/cut_round.json`;
    async init() {
        await Promise.allSettled([
            this.watchFld(ptnSrcBaseInPrj, 'doc/prj/*/[FN].webp', async () => { }, (uri, cre) => this.#onCreChg(uri, cre), uri => this.#onDel(uri), true),
            this.watchFld(`${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_1__.FLD_PRJ_BASE}/*/*.{jpg,jpeg,png}`, '', undefined, (uri, cre) => this.#onCreChg(uri, cre), uri => this.#onDel(uri), true),
            (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__.mkdirs)(this.pc.PATH_WS + `/${this.pc.FLD_SRC}/resource/`),
            this.watchFld(`${this.pc.FLD_SRC}/resource/*.psd`, `{doc/prj,${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_1__.FLD_PRJ_BASE}}/face/{[FN]_*.png,[FN]_*.webp,face[FN].sn}`, uri => this.#onInitFacePsd(uri), (uri, cre) => this.#onCreChgFacePsd(uri, cre), () => Promise.resolve(true), true),
        ]);
        this.#bat = new _BatOptPic__WEBPACK_IMPORTED_MODULE_3__.BatOptPic(this.pc);
        this.#batPsdFace = new _BatPsdFace__WEBPACK_IMPORTED_MODULE_4__.BatPsdFace(this.pc);
    }
    async #onCreChg(uri, _cre = false) {
        if (!this.pc.ps.oWss[_BatOptPic__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_PIC])
            return;
        const path = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(uri.path);
        const isBase = this.pc.isBaseUrl(path);
        await this.#bat.go(isBase ? 'base_scan' : 'prj_scan');
        const pathEncOpt = this.#prjBase2Prj(path);
        await this.pc.encIfNeeded(vscode__WEBPACK_IMPORTED_MODULE_5__.Uri.file(pathEncOpt));
    }
    #prjBase2Prj(path) {
        return path
            .replace(this.pc.PATH_PRJ_BASE, this.pc.PATH_PRJ)
            .replace(this.#REG_SRC_EXT, '.webp');
    }
    #REG_SRC_EXT = /\.(jpeg|jpg|png)$/;
    async #onDel(uri) {
        if (!this.pc.ps.oWss[_BatOptPic__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_PIC])
            return true;
        const path = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(uri.path);
        const isBase = this.pc.isBaseUrl(path);
        if (!isBase) {
            await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__.remove)(this.wpOpt2Base(path));
            return true;
        }
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__.remove)(this.#prjBase2Prj(path));
        await this.#bat.delRes(path);
        return true;
    }
    wpOpt2Base(wp) {
        if (!wp.endsWith('.webp'))
            return wp;
        const ret = wp
            .replace(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE)
            .slice(0, -4);
        const ext = ['jpeg', 'jpg', 'png'].find(ext => (0,node_fs__WEBPACK_IMPORTED_MODULE_6__.existsSync)(ret + ext));
        return ext ? ret + ext : wp;
    }
    disp() { return this.#bat.disp(); }
    enable() { return this.#procOnOff('enable', ptnSrcOptInPrj); }
    disable() { return this.#procOnOff('disable', ptnSrcBaseInPrj); }
    async #procOnOff(proc, ptn) {
        this.pc.watchFile = false;
        await this.delOldDiff(/\.(jpe?g|png|svg|webp)$/);
        await this.#bat.go(proc);
        await Promise.allSettled((await vscode__WEBPACK_IMPORTED_MODULE_5__.workspace.findFiles(ptn))
            .map(uri => this.pc.encIfNeeded(uri)));
        this.pc.watchFile = true;
    }
    async cnvIconShape({ title, openlabel, path }, pathIcon) {
        const fileUri = await vscode__WEBPACK_IMPORTED_MODULE_5__.window.showOpenDialog({
            title: `${title}を選択して下さい`,
            openLabel: openlabel || 'ファイルを選択',
            canSelectMany: false,
            canSelectFiles: false,
            canSelectFolders: false,
        });
        const src = fileUri?.[0]?.fsPath;
        if (!src)
            return;
        const cmd2Vue = (err_mes) => {
            void this.pc.ps.cmd2Vue({
                cmd: 'updpic',
                pathIcon,
                err_mes,
            });
        };
        const is_src_pp = src.startsWith(this.pc.PATH_PRJ_BASE);
        const oBJ = {
            order: {
                wp_src: is_src_pp ? this.pc.src2pp(src) : src,
                is_src_pp,
                shape: this.pc.ps.oWss['cnv.icon.shape'],
                wp_dest: path,
                is_new_tmp: this.pc.IS_NEW_TMP,
            },
            err: '',
        };
        await (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__.writeJson)(this.#PATH_BJ_cut_round, oBJ, { encoding: 'utf8' });
        await this.pc.exeBatch('cut_round', '', exit_code => {
            if (exit_code) {
                cmd2Vue('');
                return;
            }
            const oBJRes = (0,fs_extra_esm__WEBPACK_IMPORTED_MODULE_7__.readJsonSync)(this.#PATH_BJ_cut_round, { encoding: 'utf8' });
            cmd2Vue(oBJRes.err);
        });
    }
    async #onInitFacePsd(uri) {
        const { fsPath } = uri;
        const hn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(fsPath);
        if (this.chkUpdateByDiff(fsPath, `${this.pc.PATH_PRJ}face/face${hn}.sn`))
            await this.#onCreChgFacePsd(uri, false);
    }
    async #onCreChgFacePsd(uri, _cre = false) {
        const { fsPath } = uri;
        await this.#batPsdFace.go(fsPath);
        if (this.pc.ps.oWss[_BatOptPic__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_PIC])
            await this.#bat.go('prj_scan');
        const hn = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.getFn)(fsPath);
        const aUri = await vscode__WEBPACK_IMPORTED_MODULE_5__.workspace.findFiles('doc/prj/*/[FN]_*.{jpg,jpeg,png,webp}'.replaceAll('[FN]', hn));
        const pathSn = aUri.at(0)?.path.replace(/[^/]+\.\w+$/, `face${hn}.sn`);
        if (pathSn && (0,node_fs__WEBPACK_IMPORTED_MODULE_6__.existsSync)(pathSn))
            aUri.push(vscode__WEBPACK_IMPORTED_MODULE_5__.Uri.file(pathSn));
        await Promise.allSettled(aUri.map(u => this.pc.encIfNeeded(u)));
    }
    async chgWebp_q_def(e) {
        if (!this.pc.ps.oWss[_BatOptPic__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_PIC])
            return;
        this.pc.watchFile = false;
        await this.pc.wss.update('cnv.mat.webp_quality', this.pc.ps.oWss['cnv.mat.webp_quality'] = e.webp_q);
        await this.#bat.go('reconv');
        this.pc.watchFile = true;
    }
    async chgWebp_q(o) {
        if (!this.pc.ps.oWss[_BatOptPic__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_PIC])
            return;
        this.pc.watchFile = false;
        await this.#bat.chgBJ(async () => {
            const { oBJ } = this.#bat;
            const fi = oBJ.hSize[o.nm];
            if (o.no_def)
                fi.webp_q = o.webp_q;
            else
                delete fi.webp_q;
            await this.#onCreChg(vscode__WEBPACK_IMPORTED_MODULE_5__.Uri.file(this.pc.PATH_PRJ_BASE + fi.fld_nm + '.' + fi.ext));
        });
        this.pc.watchFile = true;
    }
}


/***/ }),

/***/ "./src/batch/WfbOptSnd.ts":
/*!********************************!*\
  !*** ./src/batch/WfbOptSnd.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WfbOptSnd: () => (/* binding */ WfbOptSnd)
/* harmony export */ });
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _PrjCmn__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../PrjCmn */ "./src/PrjCmn.ts");
/* harmony import */ var _WatchFile__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./WatchFile */ "./src/batch/WatchFile.ts");
/* harmony import */ var _BatOptSnd__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./BatOptSnd */ "./src/batch/BatOptSnd.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_5__);






const ptnSrcBaseInPrj = 'doc/prj/*/*.{mp3,wav}';
const ptnSrcOptInPrj = 'doc/prj/*/*.{m4a,aac,ogg}';
class WfbOptSnd extends _WatchFile__WEBPACK_IMPORTED_MODULE_2__.WatchFile {
    #bat;
    async init() {
        await Promise.allSettled([
            this.watchFld(ptnSrcBaseInPrj, 'doc/prj/*/[FN].{m4a,aac,ogg}', async () => { }, (uri, cre) => this.#onCreChg(uri, cre), uri => this.#onDel(uri), true),
            this.watchFld(`${this.pc.FLD_SRC}/${_PrjCmn__WEBPACK_IMPORTED_MODULE_1__.FLD_PRJ_BASE}/*/*.{mp3,wav}`, '', undefined, (uri, cre) => this.#onCreChg(uri, cre), uri => this.#onDel(uri), true),
        ]);
        this.#bat = new _BatOptSnd__WEBPACK_IMPORTED_MODULE_3__.BatOptSnd(this.pc);
    }
    async #onCreChg(uri, _cre = false) {
        if (!this.pc.ps.oWss[_BatOptSnd__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_SND])
            return;
        const path = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(uri.path);
        const isBase = this.pc.isBaseUrl(path);
        await this.#bat.go(isBase ? 'base_scan' : 'prj_scan');
        await this.pc.encIfNeeded(vscode__WEBPACK_IMPORTED_MODULE_4__.Uri.file(this.#prjBase2Prj(path)));
    }
    #prjBase2Prj(path) {
        const pathRet = path
            .replace(this.pc.PATH_PRJ_BASE, this.pc.PATH_PRJ);
        for (const ext of ['m4a', 'aac', 'ogg']) {
            const pathDest = pathRet
                .replace(this.#REG_SRC_EXT, '.' + ext);
            if ((0,fs_extra__WEBPACK_IMPORTED_MODULE_5__.existsSync)(pathDest))
                return pathDest;
        }
        return pathRet;
    }
    #REG_SRC_EXT = /\.(mp3|wav)$/;
    async #onDel(uri) {
        if (!this.pc.ps.oWss[_BatOptSnd__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_SND])
            return true;
        const path = (0,_CmnLib__WEBPACK_IMPORTED_MODULE_0__.vsc2fp)(uri.path);
        const isBase = this.pc.isBaseUrl(path);
        if (!isBase) {
            const path2 = path.replace(this.pc.PATH_PRJ, this.pc.PATH_PRJ_BASE);
            await Promise.allSettled(['mp3', 'wav']
                .map(ext => (0,fs_extra__WEBPACK_IMPORTED_MODULE_5__.remove)(path2.replace(/(m4a|aac|ogg)$/, ext))));
            return true;
        }
        await Promise.allSettled(['m4a', 'aac', 'ogg']
            .map(ext => (0,fs_extra__WEBPACK_IMPORTED_MODULE_5__.remove)(path
            .replace(this.pc.PATH_PRJ_BASE, this.pc.PATH_PRJ)
            .replace(this.#REG_SRC_EXT, '.' + ext))));
        await this.#bat.delRes(path);
        return true;
    }
    disp() { return this.#bat.disp(); }
    enable() { return this.#procOnOff('enable', ptnSrcOptInPrj); }
    disable() { return this.#procOnOff('disable', ptnSrcBaseInPrj); }
    async #procOnOff(proc, ptn) {
        this.pc.watchFile = false;
        await this.delOldDiff(this.#REG_DiffExtSnd);
        await this.#bat.go(proc);
        await Promise.allSettled((await vscode__WEBPACK_IMPORTED_MODULE_4__.workspace.findFiles(ptn))
            .map(uri => this.pc.encIfNeeded(uri)));
        this.pc.watchFile = true;
    }
    #REG_DiffExtSnd = /\.(mp3|m4a|ogg|aac|flac|wav)$/;
    async reconv() {
        if (!this.pc.ps.oWss[_BatOptSnd__WEBPACK_IMPORTED_MODULE_3__.PROC_ID_SND])
            return;
        this.pc.watchFile = false;
        await this.delOldDiff(this.#REG_DiffExtSnd);
        await this.#bat.go('reconv');
        this.pc.watchFile = true;
    }
}


/***/ }),

/***/ "./src/batch/WfbSettingSn.ts":
/*!***********************************!*\
  !*** ./src/batch/WfbSettingSn.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WfbSettingSn: () => (/* binding */ WfbSettingSn)
/* harmony export */ });
/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../types */ "./src/types.ts");
/* harmony import */ var _CmnLib__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../CmnLib */ "./src/CmnLib.ts");
/* harmony import */ var _WatchFile__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./WatchFile */ "./src/batch/WatchFile.ts");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! vscode */ "vscode");
/* harmony import */ var vscode__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(vscode__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! fs-extra */ "./node_modules/fs-extra/lib/index.js");
/* harmony import */ var fs_extra__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(fs_extra__WEBPACK_IMPORTED_MODULE_4__);





class WfbSettingSn extends _WatchFile__WEBPACK_IMPORTED_MODULE_2__.WatchFile {
    reqPrj2LSP;
    constructor(pc, reqPrj2LSP) {
        super(pc);
        this.reqPrj2LSP = reqPrj2LSP;
    }
    async init() {
        await this.watchFld('doc/prj/*/setting.sn', '', async ({ path }) => Promise.try(() => {
            this.#fnSetting = path;
            this.chkMultiMatch = () => this.#chkMultiMatch_proc();
            this.chkMultiMatch();
            this.update = e => this.#update_proc(e);
        }), async (_uri, cre) => Promise.try(() => {
            if (cre)
                this.chkMultiMatch();
        }), async () => Promise.resolve(true));
        vscode__WEBPACK_IMPORTED_MODULE_3__.workspace.onDidSaveTextDocument(e => {
            if (e.fileName.endsWith('/setting.sn'))
                this.chkMultiMatch();
        }, null, this.pc.ctx.subscriptions);
    }
    #preventUpdHowl = true;
    chkMultiMatch = () => { };
    #chkMultiMatch_proc() {
        this.#preventUpdHowl = true;
        const aTemp = [];
        const src = (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.readFileSync)(this.#fnSetting, { encoding: 'utf8' });
        for (const [full, nm1, nm2, val = '', sep = '', lbl_json = ''] of src.matchAll(_types__WEBPACK_IMPORTED_MODULE_0__.REG_SN2TEMP)) {
            if (full.at(0) === ';')
                continue;
            const lbl = lbl_json.trim();
            if (lbl === '' || lbl.startsWith('(HIDE GUI)'))
                continue;
            const nm = nm1 ?? nm2 ?? '';
            let o = {
                id: '/setting.sn:' + nm,
                nm,
                lbl,
                type: 'txt',
                val: sep ? val.slice(1, -1) : val,
            };
            if (lbl.at(0) === '{')
                o = { ...o, ...JSON.parse(lbl) };
            switch (o.type) {
                case 'rng': break;
                default:
                    if (val === 'true' || val === 'false')
                        o.type = 'chk';
            }
            aTemp.push(o);
        }
        void this.pc.ps.cmd2Vue({
            cmd: 'update.aTemp',
            err: '',
            aTemp,
        });
    }
    #fnSetting = '';
    update = (_e) => { };
    #update_proc(e) {
        if (this.#preventUpdHowl) {
            this.#preventUpdHowl = false;
            return;
        }
        if (this.#tiDelay)
            clearTimeout(this.#tiDelay);
        this.#tiDelay = setTimeout(() => {
            const a = [];
            for (const { nm, val } of e.aRes)
                a.push([
                    new RegExp(`(&${nm}\\s*=\\s*)((["'#]).+?\\3|[^;\\s]+)`),
                    `$1$3${val}$3`,
                ]);
            if ((0,_CmnLib__WEBPACK_IMPORTED_MODULE_1__.replaceRegsFile)(this.#fnSetting, a, false)) {
                const fp = this.#fnSetting;
                const pp = this.pc.diff.fp2pp(fp);
                const pp2s = {};
                pp2s[pp] = (0,fs_extra__WEBPACK_IMPORTED_MODULE_4__.readFileSync)(fp, { encoding: 'utf8' });
                void this.reqPrj2LSP({ cmd: 'onchg_scr', pp2s });
            }
        }, 500);
    }
    #tiDelay = undefined;
}


/***/ }),

/***/ "./src/md.json":
/*!*********************!*\
  !*** ./src/md.json ***!
  \*********************/
/***/ ((module) => {

"use strict";
module.exports = /*#__PURE__*/JSON.parse('{"frame":{"sum":"フレームに設定  \\nフレームそのものの属性を設定する","param":[{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"[[add_fram]](https://famibee.github.io/SKYNovel/tag.html#add_fram)で定義したフレーム名"},{"name":"alpha","required":"","def":"1.0","rangetype":"0.0〜1.0；透過度","comment":"0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"rotate","required":"","def":"0","rangetype":"-360〜360；回転角度","comment":"正の値は時計回り"},{"name":"visible","required":"","def":"true","rangetype":"true、false","comment":"trueで行末クリック待ち記号を表示、falseで非表示"},{"name":"disabled","required":"","def":"false","rangetype":"true、false","comment":"trueでスライダーなど操作不可・[[event]](https://famibee.github.io/SKYNovel/tag.html#event)の【dom=系】イベント無効、falseで可能"},{"name":"b_color","required":"","def":"透過","rangetype":"色指定。0x000000など","comment":"背後の矩形色。初期値は 透過（htmlで画像を表示すれば表示）"},{"name":"x","required":"","def":"0","rangetype":"実数；横座標","comment":"画面左上を原点とする画面内におけるフレームの横位置を指定"},{"name":"y","required":"","def":"0","rangetype":"実数；縦座標","comment":"画面左上を原点とする画面内におけるフレームの縦位置を指定"},{"name":"width","required":"","def":"フレームの横サイズ","rangetype":"1〜；横幅","comment":"表示するフレームの横ドットサイズ。元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"フレームの縦サイズ","rangetype":"1〜；縦幅","comment":"保存するフレームの縦ドットサイズ。元のサイズと異なる場合は拡大・縮小される"}],"snippet":[{"nm":"frame","txt":"frame id=${1{{フレーム名}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[HTMLフレーム](https://famibee.github.io/SKYNovel_gallery/?cur=frame)"},"stop_allse":{"sum":"全効果音再生の停止  \\n全てのサウンドを停止する。ぴたっと止める。","param":[],"snippet":[{"nm":"stop_allse","txt":"stop_allse"}],"detail":""},"stop_tsy":{"sum":"トゥイーン中断  \\nレイヤーやフレームのトゥイーンアニメを中断、終了する","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"処理対象のフレーム"}],"snippet":[{"nm":"stop_tsy","txt":"stop_tsy layer=${1{{レイヤ名}}}"}],"detail":"「layer（とpage）」を指定した場合はレイヤーの操作、  \\n「id」を指定した場合はフレームの操作を行なう\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=tag_tsy)"},"wv":{"sum":"動画再生終了待ち  \\n[lay]で開始したムービー再生の終了を待つ","param":[{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"クリックなど（→詳細は[[waitclick]](https://famibee.github.io/SKYNovel/tag.html#waitclick)）でウエイトをキャンセルできるか"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"},{"name":"stop","required":"","def":"true","rangetype":"true、false","comment":"trueで「クリックキャンセル時の再生停止」、falseなら行なわない"}],"snippet":[{"nm":"wv","txt":"wv canskip=${1|true,false|}"}],"detail":"何かしらの画像レイヤで再生している動画の終了を待つ"},"clear_lay":{"sum":"レイヤ設定の消去  \\n画像や文字などレイヤ状態をクリアする","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）"},{"name":"page","required":"","def":"fore","rangetype":"fore、back、both","comment":"ページの裏表（both指定で両面）"},{"name":"clear_filter","required":"","def":"false","rangetype":"true、false","comment":"true：フィルタもクリア"}],"snippet":[{"nm":"clear_lay","txt":"clear_lay layer=${1{{レイヤ名}}} page=${2|fore,back,both|}"}],"detail":"alpha、blendMode、rotation、scaleX、scaleYを初期値にする\\n※背景や背景画像はクリアしません（b_color、b_alpha） 　クリアしたい場合は、[lay back_clear=true]"},"add_face":{"sum":"差分名称の定義  \\n差分名称を定義する","param":[{"name":"name","required":"y","def":"","rangetype":"差分名称","comment":"[[lay]](https://famibee.github.io/SKYNovel/tag.html#lay)タグface属性で指定する差分名称"},{"name":"fn","required":"","def":"属性nameの値","rangetype":"画像ファイル名","comment":"表示する画像、アニメpng"},{"name":"dx","required":"","def":"0","rangetype":"実数；横座標","comment":"基本画像左上を原点とする差分画像の表示横位置"},{"name":"dy","required":"","def":"0","rangetype":"実数；縦座標","comment":"基本画像左上を原点とする差分画像の表示縦位置"},{"name":"blendmode","required":"","def":"なにもしない","rangetype":"ブレンドモード名","comment":"このレイヤと下のレイヤとの重なりにおいて、ドット単位で色のブレンド演算を行なう"}],"snippet":[{"nm":"add_face","txt":"add_face name=${1{{画像ファイル名}}}"}],"detail":"本タグだけでは差分画像を表示しない。画像レイヤの[[lay]](https://famibee.github.io/SKYNovel/tag.html#lay)タグface属性で指定する差分名称を登録するのみ。\\n\\n例えば同じ画像で差分表示位置やブレンドモードが違う登録をしたい場合、\\n### コード例\\n~~~skynovel\\n[add_face name=a_normal fn=画像 dx=0 dy=0]\\n[add_face name=a_10_10 fn=画像 dx=10 dy=10]\\n[add_face name=a_screen fn=画像 dx=0 dy=0 blendmode=screen]\\n~~~\\nとnameを変えることで登録できます。\\n\\n\\n機能ギャラリーにサンプルがあります。$(play)[画像も動画も表情差分](https://famibee.github.io/SKYNovel_gallery/?cur=tag_lay_face)"},"pop_stack":{"sum":"コールスタック破棄  \\nコールスタックを一つ破棄する\\n極力使用しないコーディングを推奨します","param":[{"name":"clear","required":"","def":"false","rangetype":"true、false","comment":"true：全て破棄する。空でもエラーを出さない  \\nfalse：スタックを一つ破棄する。空の場合はエラーメッセージ＆アプリ停止"}],"snippet":[{"nm":"pop_stack","txt":"pop_stack clear=${1|false,true|}"}],"detail":""},"set_focus":{"sum":"フォーカス移動  \\n[button][link]などのフォーカスを移動する","param":[{"name":"to","required":"y","def":"","rangetype":"prev、next、null","comment":"prev……追加順で前に移動  \\nnext……追加順で次に移動  \\nnull……どの[[button]](https://famibee.github.io/SKYNovel/tag.html#button)[[link]](https://famibee.github.io/SKYNovel/tag.html#link)にもフォーカスがない状態にする"},{"name":"add","required":"y","def":"","rangetype":"（querySelectorAll()引数なセレクタ指定）","comment":"[event key=\'dom=（略）\']指定していないフレーム内HTML要素にフォーカス移動対象に加えられる。  \\n【例】[set_focus add=\'dom=archive:.card-image,.btn_delete\']"},{"name":"del","required":"y","def":"","rangetype":"（querySelectorAll()引数なセレクタ指定）","comment":"フォーカス移動対象から外す。  \\n【例】[set_focus del=\'dom=archive:.card-image,.btn_delete\']"},{"name":"need_err","required":"","def":"true","rangetype":"true、false","comment":"HTML内にセレクタ（add・del属性）に対応する要素が見つからない場合にエラーを出すか"}],"snippet":[{"nm":"set_focus","txt":"set_focus to=${1|prev,next,null|}"}],"detail":"[[button]](https://famibee.github.io/SKYNovel/tag.html#button)[[link]](https://famibee.github.io/SKYNovel/tag.html#link)が文字レイヤに追加された順番、あるいは逆順に「マウスオーバー」表示を移動し、選択する。Enter(Return)キーでボタンクリックと同じ動作をする。\\nフレーム内HTML要素も[event key=\'dom=（略）\']で自動的にフォーカス移動対象に加えられる。\\nキーボードやゲームパッド、スイッチコントロールなどの操作を補助する。"},"else":{"sum":"その他ifブロック開始  \\nプログラム言語における、条件分岐のelse文。\\n詳細は【開発者向け情報：式の評価と条件分岐】をご覧下さい","param":[],"snippet":[{"nm":"else","txt":"else"}],"detail":""},"trans":{"sum":"ページ裏表を交換  \\n裏ページを表ページとクロスフェードする","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）","comment":"クロスフェードするレイヤ。指定以外のレイヤは変化させない"},{"name":"time","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化にかける時間"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化する前に待機する遅延時間"},{"name":"rule","required":"","def":"","rangetype":"画像ファイル名","comment":"指定した場合はルール画像として、ピクセル単位でクロスフェードするタイミングをずらす。ルール画像の黒いピクセル（と同じ位置にあるピクセル）が先に処理され、白が最後になる。  \\n省略時は画面全体ピクセルで同時にクロスフェードする"},{"name":"vague","required":"","def":"0.04","rangetype":"0.0〜1.0","comment":"トランジション期間全体を1とした値。表レイヤと裏レイヤの境界を曖昧にぼかす度合い"},{"name":"ease","required":"","def":"Linear.None","rangetype":"イージング名","comment":"揺れのイージング（値の変化の仕方）を指定する。  \\n[イージングの変化はこちらの図](https://createjs.com/demos/tweenjs/tween_sparktable)（または[こちら](https://sole.github.io/tween.js/examples/03_graphs.html)）が分かりやすい。  \\n- [tween.js/README.md at master · tweenjs/tween.js](https://github.com/tweenjs/tween.js/blob/master/README.md)  \\n- [CreateJS でのトゥイーンの作成方法 - ICS MEDIA](https://ics.media/tutorial-createjs/tween/)"},{"name":"glsl","required":"","def":"","rangetype":"シェーダー記述言語GLSL","comment":"機能ギャラリーに[フラグメントシェーダの動作サンプル](https://famibee.github.io/SKYNovel_gallery/?cur=glsl_slide)がありますので、詳細はそちらで。  \\nざっくり説明すると、  \\n【vTextureCoord】がピクセルの位置、  \\n【uSampler】が一ピクセル単位の画像データ、  \\n【tick】が時間経過、です"}],"snippet":[{"nm":"trans","txt":"trans layer=${1{{レイヤ名}}} time=${2:500} rule=${3{{画像ファイル名}}}][wt"}],"detail":"クロスフェードを開始すると、終了を待たずに次のタグへと処理を進める。\\n終了を待ちたい場合は[[wt]](https://famibee.github.io/SKYNovel/tag.html#wt)を使用する。\\n\\nクロスフェード終了後は元・裏ページから元・表ページに内容をコピーし、同じ内容になる。\\n\\nルール画像は白黒かグレースケールを推奨。（見た目と動きが一致する）\\n\\n$(warning)また[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)～[[wt]](https://famibee.github.io/SKYNovel/tag.html#wt)間で文字表示や[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)は動作未定義、非推奨。\\n[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)終了を待たず何かをするのは避けた方がよいでしょう。"},"ws":{"sum":"効果音再生の終了待ち  \\n効果音再生の終了を待つ  \\nloop=trueなら待たない。 利用時は【音声再生[playse]がjoin=true(ちなみにデフォルト)であること】を必須条件とします","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"canskip","required":"","def":"false","rangetype":"true、false","comment":"trueでクリックキャンセル可能にする"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"},{"name":"stop","required":"","def":"true","rangetype":"true、false","comment":"trueで「クリックキャンセル時の再生停止」、falseなら行なわない。"}],"snippet":[{"nm":"ws","txt":"ws buf=${1{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"er":{"sum":"ページ両面の文字消去  \\nデフォルト文字レイヤの裏と表の両方に対して[clear_lay]を行う","param":[{"name":"rec_page_break","required":"","def":"true","rangetype":"true、false","comment":"履歴を改ページするか"},{"name":"clear_filter","required":"","def":"false","rangetype":"true、false","comment":"true：フィルタもクリア"}],"snippet":[{"nm":"er","txt":"er"}],"detail":""},"volume":{"sum":"BGMや効果音の音量を指定  \\nBGMや効果音を指定した音量にする","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"volume","required":"","def":"1.0","rangetype":"0.0〜1.0","comment":"再生音量。ただし音量を示すシステム変数（sys:const.an.sound.BGM.volume）は変更しない"}],"snippet":[{"nm":"volume","txt":"volume buf=${1{{サウンドバッファ}}} volume=${2:1.0}"}],"detail":""},"reload_script":{"sum":"スクリプト再読込  \\n現在処理中のスクリプトをリロードする。実行位置は[record_place]によるセーブポイントまで戻って再開する。  \\n※スクリプトを大幅に変えた後だと、正常に再開できない場合があります。","param":[],"snippet":[{"nm":"reload_script","txt":"reload_script"}],"detail":""},"let":{"sum":"変数代入・演算  \\n変数に値を代入する","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"セットする値"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。  \\nnum……数値（実数）。「01」は数値の1となる。  \\nint……数値（符合付き整数）  \\nuint……数値（符合なし整数）  \\nbool……true、false  \\nstr……文字列。「01」は「01」のまま"},{"name":"val2font","required":"","def":"現在値","rangetype":"true、false","comment":"これ以降（〜スクリプト終端）での変数代入文字列をフォント生成対象とする／しない切り替え"},{"name":"val2fontNm","required":"","def":"現在値","rangetype":"フォント名","comment":"これ以降フォント生成対象とする際のフォント名"}],"snippet":[{"nm":"let","txt":"let name=${1{{代入変数名}}} text=${2:セットする値}"}],"detail":"### コード例\\n~~~skynovel\\n[let name=a text=\'てんぐ👺🌈𩸽🌕\']\\n[trace text=&a] ; -> \'てんぐ👺🌈𩸽🌕\'\\n&a=\'abcde\'\\n[trace text=&a] ; -> \'abcde\'\\n\\n\\n[let_substr name=a text=&a pos=2 len=3]\\n[trace text=&a] ; -> \'cde\'\\n[let_substr name=a text=&a pos=1 len=all]\\n[trace text=&a] ; -> \'de\'\\n~~~"},"let_char_at":{"sum":"文字列から一字取りだし  \\n文字列中の一文字を取り出す。結果を変数に代入する","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"元になる文字列"},{"name":"pos","required":"","def":"0","rangetype":"0〜","comment":"何番目の文字を取り出すか。0（先頭）"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_char_at","txt":"let_char_at name=${1{{代入変数名}}} text=${2:元になる文字列} pos=${3:取り出す位置}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcde\'\\n[let_char_at name=a text=&a pos=1]\\n[trace text=&a] ; -> \'b\'\\n~~~"},"rec_r":{"sum":"履歴改行  \\n履歴に改行を出力する","param":[],"snippet":[{"nm":"rec_r","txt":"rec_r"}],"detail":""},"button":{"sum":"ボタンを表示  \\n文字レイヤにボタンを配置する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"ボタンを配置する文字レイヤ"},{"name":"page","required":"","def":"back","rangetype":"fore、back","comment":"ページの裏表"},{"name":"pic","required":"y","def":"","rangetype":"画像ファイル名","comment":"画像ボタンとして配置する画像を指定する。  \\nただし画像は縦に三等分し、左から「通常時」「クリック押下時」「マウスカーソルを載せた時」の画像として表示する"},{"name":"text","required":"...","def":"","rangetype":"ボタンにする文字列","comment":"文字ボタンとして配置する文字列を指定する。  \\npicかtextのどちらかの指定を必須とする"},{"name":"b_pic","required":"","def":"","rangetype":"画像ファイル名","comment":"文字ボタンの背景画像が指定できる。画像の大きさにかかわらず、文字ボタンのちょうど真ん中に来るよう配置される"},{"name":"width","required":"","def":"100","rangetype":"1〜；横幅","comment":"文字ボタンの横幅を指定する。画像ボタンの場合はこの指定を無視し、画像横幅の1/3にする"},{"name":"height","required":"","def":"30","rangetype":"1〜；縦幅","comment":"文字ボタンの縦幅を指定する。画像ボタンの場合はこの指定を無視し、画像横幅の1/3にする。  \\nまた、文字は必ず横一列になるため、この設定値はフォントサイズと兼用になる"},{"name":"style","required":"","def":"","rangetype":"PIXI TextStyleのJSON文字列（一部）","comment":"文字ボタン上にマウスカーソルが乗っていない状態の文字スタイル"},{"name":"style_hover","required":"","def":"","rangetype":"PIXI TextStyleのJSON文字列（一部）","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしていない）の文字スタイル。  \\n設定できる値はstyleと同様"},{"name":"style_clicked","required":"","def":"","rangetype":"PIXI TextStyleのJSON文字列（一部）","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしている）の文字スタイル。  \\n設定できる値はstyleと同様"},{"name":"alpha","required":"","def":"1.0","rangetype":"0.0〜1.0；透過度","comment":"0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"left","required":"","def":"0","rangetype":"実数","comment":""},{"name":"top","required":"","def":"0","rangetype":"実数","comment":"詳細は[[lay]](https://famibee.github.io/SKYNovel/tag.html#lay)を参照"},{"name":"rotation","required":"","def":"0","rangetype":"-180〜180；回転角度","comment":"時計回りは0～180、反時計回りは0～-180を指定。 左上を中心に回る"},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"pivot_x","required":"","def":"0.0","rangetype":"実数","comment":"左上を基準として、回転や移動時の基準を指定"},{"name":"pivot_y","required":"","def":"0.0","rangetype":"実数","comment":"左上を基準として、回転や移動時の基準を指定"},{"name":"enabled","required":"","def":"true","rangetype":"true、false","comment":"falseだと押せないボタンとなり、クリックイベントが発生しない。  \\nこれにより文字レイヤの任意の位置に画像表示できる機能を提供する。  \\n画像は三等分しない。イベントや効果音指定は無効だが、ヒント機能は有効"},{"name":"call","required":"","def":"false","rangetype":"true、false","comment":"trueの場合は[[call]](https://famibee.github.io/SKYNovel/tag.html#call)、falseは[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)。  \\nただしcall=trueによりサブルーチンコールした場合、[[return]](https://famibee.github.io/SKYNovel/tag.html#return)によって「コールする前のイベント予約状態＆待ち状態」に戻る"},{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"クリック時にジャンプする先"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"コール先のスクリプトにあるラベル","":"クリック時ジャンプ先で「&sn.eventLabel」にて値を受け取れる"},{"name":"url","required":"y","def":"fn・label によるスクリプトジャンプ","rangetype":"ブラウザで開けるURL","comment":"クリック時にURLを開く。指定時は fn・label を無視する"},{"name":"global","required":"","def":"false","rangetype":"true、false","comment":"詳細は[[event]](https://famibee.github.io/SKYNovel/tag.html#event)と同様。  \\nボタンを[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)する場合はtrueにしておく"},{"name":"arg","required":"","def":"","rangetype":"ジャンプ先に渡したい値","comment":"指定した場合、クリック時ジャンプ先で「&sn.eventArg」にて値を受け取れる"},{"name":"onenter","required":"","def":"なにもしない","rangetype":"ラベル名","comment":"マウス重なり（フォーカス取得）時、指定したラベルをコールする。 必ず[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で戻ること"},{"name":"onleave","required":"","def":"なにもしない","rangetype":"ラベル名","comment":"マウス重なり外れ（フォーカス外れ）時、指定したラベルをコールする。 必ず[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で戻ること"},{"name":"clickse","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、クリック時に効果音を再生する"},{"name":"enterse","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、ボタン上にマウスカーソルが載った時に効果音を再生する"},{"name":"leavese","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、ボタン上からマウスカーソルが外れた時に効果音を再生する"},{"name":"clicksebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"クリック時効果音を再生するサウンドバッファを指定する"},{"name":"entersebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"マウスオン時効果音を再生するサウンドバッファを指定する"},{"name":"leavesebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"マウスアウト時効果音を再生するサウンドバッファを指定する"},{"name":"blendmode","required":"","def":"なにもしない","rangetype":"ブレンドモード名","comment":"このレイヤと下のレイヤとの重なりにおいて、ドット単位で色のブレンド演算を行なう"},{"name":"hint","required":"","def":"表示しない","rangetype":"ヒント文字列","comment":"指定した場合のみ、マウスカーソルを載せるとツールチップス表示する"},{"name":"hint_style","required":"","def":"","rangetype":"CSS style","comment":"hintの CSSを指定できる"},{"name":"hint_opt","required":"","def":"","rangetype":"文字列","comment":"@popperjs/coreの動作を指定"}],"snippet":[{"nm":"button","txt":"button text=${1:ボタンにする文字列} left=${2:0} top=${3:0} ${4{{ジャンプ先}}}"}],"detail":"選択肢として使用する場合、ジャンプ先のラベル直後には必ず[[record_place]](https://famibee.github.io/SKYNovel/tag.html#record_place)を記述して、ジャンプ直後でセーブしても正しくセーブされるようにして下さい\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=ch_button)"},"let_search":{"sum":"正規表現で検索  \\n文字列内を正規表現で検索し、最初に val が見つかった位置を返す","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"検索対象の文字列"},{"name":"reg","required":"y","def":"","rangetype":"文字列","comment":"正規表現"},{"name":"flags","required":"","def":"（なし）","rangetype":"文字列","comment":"正規表現のフラグ"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_search","txt":"let_search name=${1{{代入変数名}}} text=${2:検索対象の文字列} reg=${3:正規表現}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcde\'\\n[let_search name=a text=&a reg=\'cd\']\\n[trace text=&a] ; -> 2。a(=0),b(=1),c(=2)の2\\n~~~"},"clearvar":{"sum":"ゲーム変数の全消去   \\nsave:変数を全消去。削除すると言うより、初期化する","param":[],"snippet":[{"nm":"clearvar","txt":"clearvar"}],"detail":""},"toggle_full_screen":{"sum":"全画面状態切替  \\n呼び出す度にアプリの全画面／ウインドウモードを切り替える","param":[{"name":"key","required":"","def":"イベント登録せずモード切替","rangetype":"イベントのキー名","comment":"イベントを発生させるトリガーイベントを予約する。key属性の値は[[event]](https://famibee.github.io/SKYNovel/tag.html#event)を参照"}],"snippet":[{"nm":"toggle_full_screen","txt":"toggle_full_screen key=${1{{イベント名}}}"}],"detail":"現在の状態は文字列変数「tmp:const.sn.displayState」で分かる。trueならフルスクリーン"},"set_frame":{"sum":"フレーム変数に設定  \\nフレーム内の変数に、値を設定する","param":[{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"[[add_fram]](https://famibee.github.io/SKYNovel/tag.html#add_fram)で定義したフレーム名"},{"name":"var_name","required":"y","def":"","rangetype":"文字列","comment":"フレーム内の変数名"},{"name":"text","required":"y","def":"セットする値","rangetype":"文字列","comment":"フレーム内の変数にセットする値"}],"snippet":[{"nm":"set_frame","txt":"set_frame id=${1{{フレーム名}}} var_name=${2:フレーム内の変数名} text=${3:セットする値}"}],"detail":"### コード例\\n~~~skynovel\\n[add_frame id=config src=_config visible=false]\\n[event key=\'dom=config:#close\' label=*exit global=true]\\n\\n[let_frame id=config var_name=val_sldBackAlpha]\\n&sys:TextLayer.Back.Alpha = const.sn.frm.config.val_sldBackAlpha/100\\n[return]\\n\\n*val2ctrl\\n[set_frame id=config var_name=val_sldBackAlpha text=&sys:TextLayer.Back.Alpha*100]\\n[let_frame id=config var_name=val2ctrl function=true]\\n[return]\\n~~~\\n\\n機能ギャラリーにサンプルがあります。$(play)[HTMLフレーム](https://famibee.github.io/SKYNovel_gallery/?cur=frame)"},"macro":{"sum":"マクロ定義の開始  \\n[macro]と[endmacro]に囲まれた部分をマクロとして定義する。定義したマクロは既存のタグと同様に使用できる。渡した属性は、マクロ側で「mp:」スコープにより参照できる","param":[{"name":"name","required":"y","def":"","rangetype":"未定義のマクロ名","comment":"既存のタグやマクロと重複しないマクロ名"},{"name":"nowarn_unused","required":"","def":"false","rangetype":"true、false","comment":"true：未使用警告を止める"},{"name":"sum","required":"","def":"概要説明","rangetype":"文字列","comment":"拡張機能で表示する概要説明"},{"name":"detail","required":"","def":"詳細説明","rangetype":"文字列","comment":"拡張機能で表示する詳細説明"},{"name":"%(属性名)","required":"","def":"属性の詳細説明","rangetype":"型名|省略値|概要","comment":"属性名末尾に「?」を書くと【省略可能な属性】であると示す"},{"name":"design_unit","required":"","def":"false","rangetype":"true、false","comment":"true：デバッグモード時、マクロの引数変更とする（マクロの内部をサーチさせない）"},{"name":"stepin","required":"","def":"true","rangetype":"true、false","comment":"false：デバッグモード時、ステップインしない（マクロ内で停止させない）"},{"name":"snippet_ext","required":"","def":"詳細説明","rangetype":"SP_GSM、SOUND、FONT、SCRIPT","comment":"指定するとスニペット候補に追加できる"}],"snippet":[{"nm":"macro","txt":"macro name=${1:マクロ名}\\n\\tsum=\'概要説明\'\\n\\t%aaa=\'型|省略値|引数説明\'\\n]\\n\\t; ここにマクロの処理内容を\\n[endmacro"}],"detail":""},"add_frame":{"sum":"フレーム追加  \\nHTMLファイルをベースとする「フレーム」を追加する","param":[{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"他のタグなどで操作・参照する歳の名前となる"},{"name":"src","required":"y","def":"","rangetype":"HTMLファイル名","comment":"フレームとして読み込むhtmlファイルのファイル名（画像や音声などのfn属性と同じように）"},{"name":"alpha","required":"","def":"1.0","rangetype":"0.0〜1.0；透過度","comment":"0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"rotate","required":"","def":"0","rangetype":"-360〜360；回転角度","comment":"正の値は時計回り"},{"name":"visible","required":"","def":"true","rangetype":"true、false","comment":"trueで行末クリック待ち記号を表示、falseで非表示"},{"name":"b_color","required":"","def":"透過","rangetype":"色指定。0x000000など","comment":"背後の矩形色。初期値は 透過（htmlで画像を表示すれば表示）"},{"name":"x","required":"","def":"0","rangetype":"実数；横座標","comment":"画面左上を原点とする画面内におけるフレームの横位置を指定"},{"name":"y","required":"","def":"0","rangetype":"実数；縦座標","comment":"画面左上を原点とする画面内におけるフレームの縦位置を指定"},{"name":"width","required":"","def":"フレームの横サイズ","rangetype":"1〜；横幅","comment":"表示するフレームの横ドットサイズ。元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"フレームの縦サイズ","rangetype":"1〜；縦幅","comment":"保存するフレームの縦ドットサイズ。元のサイズと異なる場合は拡大・縮小される"}],"snippet":[{"nm":"add_frame","txt":"add_frame id=${1{{フレーム名}}} src=${2{{HTMLファイル名}}} visible=${3|true,false|}"}],"detail":"$(warning)注：これは HTML要素の iframe（インラインフレーム要素）で、フレームは全てのレイヤの手前に表示され、互い違いに重ねられない。   \\nconst.sn.frm.（フレーム名）系の値もセットする。\\n\\n### コード例\\n~~~skynovel\\n[add_frame id=config src=_config visible=false]\\n[event key=\'dom=config:#close\' label=*exit global=true]\\n\\n[let_frame id=config var_name=val_sldBackAlpha]\\n&sys:TextLayer.Back.Alpha = const.sn.frm.config.val_sldBackAlpha/100\\n[return]\\n\\n*val2ctrl\\n[set_frame id=config var_name=val_sldBackAlpha text=&sys:TextLayer.Back.Alpha*100]\\n[let_frame id=config var_name=val2ctrl function=true]\\n[return]\\n~~~\\n\\n機能ギャラリーにサンプルがあります。$(play)[HTMLフレーム](https://famibee.github.io/SKYNovel_gallery/?cur=frame)"},"let_index_of":{"sum":"文字列で検索  \\n文字列内を検索し、文字列内の start 以降で、最初に val が見つかった位置を返す","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数。-1の場合は見つからなかった"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"元になる文字列"},{"name":"val","required":"y","def":"","rangetype":"文字列","comment":"探す文字列"},{"name":"start","required":"","def":"0","rangetype":"0〜","comment":"検索を開始する位置。0（先頭）"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_index_of","txt":"let_index_of name=${1{{代入変数名}}} text=${2:元になる文字列} val=${3:探す文字列}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcdeFGHIabcde\'\\n[let_index_of name=a text=&a val=cd start=5]\\n[trace text=&a] ; -> 11\\n[let_index_of name=a text=&a val=GG]\\n[trace text=&a] ; -> -1\\n~~~"},"wait_tsy":{"sum":"トゥイーン終了待ち  \\nレイヤーやフレームの終了を待ち、再開する","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"処理対象のフレーム"},{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"クリックなどでウエイトをキャンセルできるか"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"wait_tsy","txt":"wait_tsy layer=${1{{レイヤ名}}} canskip=${2|true,false|}"}],"detail":"[[event]](https://famibee.github.io/SKYNovel/tag.html#event)などでイベントが登録されていても、イベント発生待ちを行わない。 繰返し回数が0（無限ループ）の場合、何もせず終了する。  \\n「layer（とpage）」を指定した場合はレイヤーの操作、  \\n「id」を指定した場合はフレームの操作を行なう\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=tag_tsy)"},"return":{"sum":"サブルーチンから戻る  \\nコールスタックに積まれているジャンプ先に戻るようなジャンプをする。\\n最後に積んだスタックを一つ破棄する。\\nマクロ内で実行した場合はマクロを脱出する\\nfn・label属性で戻り先を上書き指定できる。（マクロ内からジャンプしたいときなど）","param":[{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"戻り先のスクリプト"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"戻り先のスクリプトにあるラベル"}],"snippet":[{"nm":"return","txt":"return ${1{{ジャンプ先}}}"}],"detail":""},"endmacro":{"sum":"マクロ定義の終了  \\n[macro]と[endmacro]に囲まれた部分をマクロとして定義する","param":[],"snippet":[{"nm":"endmacro","txt":"endmacro"}],"detail":""},"span":{"sum":"インラインスタイル設定  \\nこの指定以降の文字のレイアウト（フォントや文字色など）を指定する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグ以降のルビ表示に適用される"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグ以降のルビ表示に適用される"},{"name":"ch_in_style","required":"","def":"なにもしない","rangetype":"文字出現演出名","comment":"[[ch_in_style]](https://famibee.github.io/SKYNovel/tag.html#ch_in_style)で定義した文字出現演出名"},{"name":"ch_out_style","required":"","def":"なにもしない","rangetype":"文字消去演出名","comment":"[[ch_out_style]](https://famibee.github.io/SKYNovel/tag.html#ch_out_style)で定義した文字消去演出名"},{"name":"r_align","required":"","def":"現在値","rangetype":"left、center、right、justify、121、even、1ruby","comment":"ルビ揃えを指定する。  \\n> left ……（肩付き）先頭親文字から、ルビ間は密着  \\n> center ……（中付き）センター合わせ、〃  \\n> right ……（右／下揃え）末尾親文字から、〃  \\n> justify ……（両端揃え）先頭から末尾親文字間に、ルビ間は均等にあける  \\n> 121 ……（1-2-1(JIS)）ルビの前後を比率1、ルビ間を比率2であける  \\n> even ……（均等アキ）ルビの前後、ルビ間も均等にあける  \\n> 1ruby ……（1ルビ文字アキ）ルビの前後をルビ一文字空け、ルビ間は均等にあける  \\n  \\n初期値は center。  \\n  \\n※親文字よりルビの方が長い場合は、親文字に対する「中付き」表示になる  \\n→参考（[機能ギャラリー・直感的なルビ文法](https://famibee.github.io/SKYNovel_gallery/index.html?cur=built_in_ruby)）"}],"snippet":[{"nm":"span","txt":"span style=${1:CSSstyle}"}],"detail":"一時的に文字レイヤのlayout属性への指定を上書きするイメージ。 文字レイヤをクリア（[[clear_text]](https://famibee.github.io/SKYNovel/tag.html#clear_text)、[[clear_lay]](https://famibee.github.io/SKYNovel/tag.html#clear_lay)）するとリセット、以降は元通り文字レイヤのlayout属性に従う"},"fadese":{"sum":"効果音のフェード  \\n効果音を指定した音量に、段階的に変化させる","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"volume","required":"y","def":"","rangetype":"0.0〜1.0","comment":"音量"},{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"フェード時間"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化する前に待機する遅延時"}],"snippet":[{"nm":"fadese","txt":"fadese buf=${1{{サウンドバッファ}}} volume=${2:0.0} time=${3:1000}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"p":{"sum":"改ページクリック待ち  \\nシナリオファイルの順次処理を停止し、クリックやキー押下（→詳細は[waitclick]）を待つ","param":[{"name":"visible","required":"","def":"true","rangetype":"true、false","comment":"trueで改ページ記号を表示、falseで非表示"},{"name":"er","required":"","def":"なにもしない","rangetype":"true、false","comment":"trueで改ページ待ち後に[[er]](https://famibee.github.io/SKYNovel/tag.html#er)処理を行なう"},{"name":"x","required":"","def":"0","rangetype":"実数；横座標","comment":"文字表示位置左上を原点とする横座標"},{"name":"y","required":"","def":"0","rangetype":"実数；縦座標","comment":"文字表示位置左上を原点とする縦座標"},{"name":"width","required":"","def":"画像の横サイズ","rangetype":"1〜；横幅","comment":"表示する画像の横ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"画像の縦サイズ","rangetype":"1〜；縦幅","comment":"保存する画像の縦ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"p","txt":"p visible=${1|true,false|}"}],"detail":"「breakpage」という画像やアニメpngファイルが用意されていれば、改ページクリック待ちマークとして表示する。\\nクリックやキー押下が発生した場合、処理を再開する。\\n[[event]](https://famibee.github.io/SKYNovel/tag.html#event)などでイベントが登録されていれば、イベント発生待ちを行う。"},"endlet_ml":{"sum":"インラインテキスト代入の終端  \\n[let_ml]〜[endlet_ml]で囲んだ複数行テキストを代入する","param":[],"snippet":[{"nm":"endlet_ml","txt":"endlet_ml"}],"detail":""},"if":{"sum":"ifブロックの開始  \\nプログラム言語における、条件分岐のif文","param":[{"name":"exp","required":"y","def":"","rangetype":"条件式","comment":"trueの場合処理は直後にうつる。  \\nfalseなら次の[[elsif]](https://famibee.github.io/SKYNovel/tag.html#elsif)や[[else]](https://famibee.github.io/SKYNovel/tag.html#else)の評価を行なう"}],"snippet":[{"nm":"if","txt":"if exp=${1:Boolean式}][endif"}],"detail":"詳細は【[開発者向け情報：式の評価と条件分岐](https://famibee.github.io/SKYNovel/dev.html#cond)】をご覧下さい。\\n\\n機能ギャラリーにサンプルがあります。$(play)[直感的なルビ文法](https://famibee.github.io/SKYNovel_gallery/?cur=ruby)"},"l":{"sum":"行末クリック待ち  \\nシナリオファイルの順次処理を停止し、クリックやキー押下（→詳細は[waitclick]）を待つ","param":[{"name":"visible","required":"","def":"true","rangetype":"true、false","comment":"trueで行末クリック待ち記号を表示、falseで非表示"},{"name":"x","required":"","def":"0","rangetype":"実数；横座標","comment":"文字表示位置左上を原点とする横座標"},{"name":"y","required":"","def":"0","rangetype":"実数；縦座標","comment":"文字表示位置左上を原点とする縦座標"},{"name":"width","required":"","def":"画像の横サイズ","rangetype":"1〜；横幅","comment":"表示する画像の横ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"画像の縦サイズ","rangetype":"1〜；縦幅","comment":"保存する画像の縦ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"l","txt":"l visible=${1|true,false|}"}],"detail":"「breakline」という画像やアニメpngファイルが用意されていれば、行末クリック待ちマークとして表示する。\\nクリックやキー押下が発生した場合、処理を再開する。\\n[[event]](https://famibee.github.io/SKYNovel/tag.html#event)などでイベントが登録されていれば、イベント発生待ちを行う"},"title":{"sum":"タイトル指定  \\nアプリウインドウのタイトル文字列を設定する","param":[{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"タイトル文字列"}],"snippet":[{"nm":"title","txt":"title text=${1:タイトル文字列}"}],"detail":""},"playse":{"sum":"効果音の再生  \\n効果音を再生する","param":[{"name":"fn","required":"y","def":"","rangetype":"音声ファイル名","comment":"再生する音声ファイル名"},{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"loop","required":"","def":"false","rangetype":"true、false","comment":"trueでBGMのようにループ再生する"},{"name":"volume","required":"","def":"1.0","rangetype":"0.0〜1.0","comment":"再生音量。ただし音量を示すシステム変数（sys:const.an.sound.BGM.volume）は変更しない"},{"name":"speed","required":"","def":"1.0","rangetype":"0.0〜1.0","comment":"再生速度（0:遅い、1.0:元のまま）"},{"name":"pan","required":"0.0","def":"-1.0〜1.0","rangetype":"音を出す左右位置（-1.0=左端、0.0=中央(省略値)、1.0=右端）"},{"name":"join","required":"","def":"true","rangetype":"true、false","comment":"trueで読み込みを待って次のタグへ進む"},{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"trueでキー押下Skip中なら再生をしない"},{"name":"start_ms","required":"","def":"0（冒頭）","rangetype":"0〜；ミリ秒","comment":"再生の開始位置を指定する。0は冒頭"},{"name":"end_ms","required":"","def":"末端","rangetype":"0〜；ミリ秒","comment":"再生の終了位置を指定する。省略時は末端。  \\n正の値は「冒頭から何ms目を終端とするか」  \\n負の値は「末尾から何ms手前を終端とするか」の指定"},{"name":"ret_ms","required":"","def":"0（冒頭）","rangetype":"0〜；ミリ秒","comment":"ループ戻り位置を指定する。0は冒頭。  \\nループ再生中にend_ms指定位置（省略時は末尾）に到達した場合、この指定位置に戻る。 ループ再生しない（loop=false）際は無視される。"}],"snippet":[{"nm":"playse","txt":"playse fn=${1{{音声ファイル名}}} buf=${2{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"snapshot":{"sum":"スナップショット  \\nアプリ表示部分全体を画像として保存する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）","comment":"スナップショットに含むレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"fn","required":"","def":"snapshot","rangetype":"保存するファイル名","comment":"省略時はデスクトップに保存  \\n保存する画像フォーマット（png、jpg）は拡張子で指定"},{"name":"width","required":"","def":"アプリ表示部分の横サイズ","rangetype":"1〜；横幅","comment":"保存する画像の横ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"アプリ表示部分の縦サイズ","rangetype":"1〜；縦幅","comment":"保存する画像の縦ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"smoothing","required":"","def":"false","rangetype":"true、false","comment":"拡大・縮小保存される場合、スムージングするか"},{"name":"b_color","required":"","def":"config.anprjで指定した背景色","rangetype":"透過つき色指定。0xFF000000（黒）など  \\n16進数では透過2桁＋赤2桁＋緑2桁＋青2桁で指定","comment":"テキスト背後の矩形色。pngで 0x0 にすると透過する。  \\n透過しない黒は 0xFF000000"}],"snippet":[{"nm":"snapshot","txt":"snapshot layer=${1:レイヤ名}"}],"detail":"画面スナップショットをダウンロードフォルダに保存する。\\nファイル名にはプロジェクト名と日時どが追加される。\\n\\n※文字の表示とスナップショットは、厳密には同じではないので注意。"},"navigate_to":{"sum":"ＵＲＬを開く  \\nWebページを開く","param":[{"name":"url","required":"y","def":"","rangetype":"ブラウザで開けるURL","comment":"開くURL"}],"snippet":[{"nm":"navigate_to","txt":"navigate_to url=${1:WebページURL}"}],"detail":""},"stopse":{"sum":"効果音再生の停止  \\n効果音再生を停止する","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"}],"snippet":[{"nm":"stopse","txt":"stopse buf=${1{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"stopfadese":{"sum":"音声フェードの停止  \\n音声フェードを停止する","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"}],"snippet":[{"nm":"stopfadese","txt":"stopfadese buf=${1{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"resume_tsy":{"sum":"一時停止再開  \\nレイヤーやフレームのトゥイーンアニメ一時停止を再開させる","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"処理対象のフレーム"}],"snippet":[{"nm":"resume_tsy","txt":"resume_tsy layer=${1{{レイヤ名}}}"}],"detail":"「layer（とpage）」を指定した場合はレイヤーの操作、  \\n「id」を指定した場合はフレームの操作を行なう\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=tag_tsy)"},"erasebookmark":{"sum":"しおりの消去  \\nしおりデータを削除する","param":[{"name":"place","required":"y","def":"","rangetype":"0〜","comment":"処理対象のしおり番号"}],"snippet":[{"nm":"erasebookmark","txt":"erasebookmark place=${1:処理対象のしおり番号}"}],"detail":""},"fadebgm":{"sum":"BGMのフェード  \\nBGMを指定した音量に、段階的に変化させる","param":[{"name":"volume","required":"y","def":"","rangetype":"0.0〜1.0","comment":"音量"},{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"フェード時間"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化する前に待機する遅延時"}],"snippet":[{"nm":"fadebgm","txt":"fadebgm volume=${1:0.0} time=${2:1000}"}],"detail":""},"reset_rec":{"sum":"履歴リセット  \\n履歴をクリアする。応用として、履歴に加工した文字列を設定し、履歴画面に機能を追加する事も","param":[{"name":"text","required":"","def":"全てクリア","rangetype":"文字列","comment":"履歴に設定したい文字列"}],"snippet":[{"nm":"reset_rec","txt":"reset_rec"}],"detail":""},"xchgbuf":{"sum":"サウンドバッファの交換  \\n二つのバッファを交換する。未再生でも再生中でも良いが、フェード中は避けること","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"サウンドバッファ"},{"name":"buf2","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"もう一つのサウンドバッファ"}],"snippet":[{"nm":"xchgbuf","txt":"xchgbuf buf=${1{{サウンドバッファ}}} buf2=${2{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"call":{"sum":"サブルーチンコール  \\nスクリプト処理の現在位置をコールスタックに積み、ジャンプする","param":[{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"コール先のスクリプトファイル[call fn=ext_*]のようにワイルドカードをサポート。マッチするスクリプトを順不同にコールする。（ワイルドカードは後方のみ）"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"コール先のスクリプトファイルにあるラベル","":"クリック時ジャンプ先で「&sn.eventLabel」にて値を受け取れる"},{"name":"count","required":"","def":"false","rangetype":"true、false","comment":"タグ位置を既読とするか"},{"name":"clear_local_event","required":"","def":"なにもしない","rangetype":"true、false","comment":"trueの場合は[[clear_event]](https://famibee.github.io/SKYNovel/tag.html#clear_event)を行なってからコールする"}],"snippet":[{"nm":"call","txt":"call ${1{{ジャンプ先}}}"}],"detail":"ジャンプ先での[[return]](https://famibee.github.io/SKYNovel/tag.html#return)により本タグの次の位置に戻る事が出来る。\\n\\n$(info)マニアックな話ですが、あらゆるタグの中で唯一「通常、既読としない」タグです。"},"stopbgm":{"sum":"BGM 演奏の停止  \\nBGM 演奏を停止する。ぴたっと止める。","param":[],"snippet":[{"nm":"stopbgm","txt":"stopbgm"}],"detail":""},"elsif":{"sum":"別条件のifブロック開始  \\nプログラム言語における、条件分岐のelsif文。\\n詳細は【開発者向け情報：式の評価と条件分岐】をご覧下さい","param":[{"name":"exp","required":"y","def":"","rangetype":"条件式","comment":"trueの場合処理は直後にうつる。  \\nfalseなら次の[[elsif]](https://famibee.github.io/SKYNovel/tag.html#elsif)や[[else]](https://famibee.github.io/SKYNovel/tag.html#else)の評価を行なう"}],"snippet":[{"nm":"elsif","txt":"elsif exp=${1:Boolean式}"}],"detail":""},"load":{"sum":"しおりの読込  \\nしおりデータを読み込み、スクリプト処理を再開する","param":[{"name":"place","required":"y","def":"","rangetype":"0〜","comment":"処理対象のしおり番号"},{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"ロード後最初にしたい共通処理をコールする（処理は[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で終わらせる）。指定方法は[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)と同様。ただし指定する際、fnとlabelは両方指定しなければならない"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"コール先のスクリプトにあるラベル"}],"snippet":[{"nm":"load","txt":"load place=${1:処理対象のしおり番号} ${2{{ジャンプ先}}}"}],"detail":""},"clear_text":{"sum":"文字消去  \\n文字のみをクリアする","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"}],"snippet":[{"nm":"clear_text","txt":"clear_text layer=${1{{文字レイヤ名}}} page=${2|fore,back|}"}],"detail":""},"wb":{"sum":"BGM フェードの終了待ち  \\nBGM フェードの終了を待つ","param":[{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"trueでクリックキャンセル可能にする"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"wb","txt":"wb canskip=${1|false,true|}"}],"detail":""},"close":{"sum":"アプリの終了  \\nアプリケーションを終了する","param":[],"snippet":[{"nm":"close","txt":"close"}],"detail":""},"dump_script":{"sum":"スクリプトのダンプ  \\n内部API","param":[{"name":"set_fnc","required":"y","def":"","rangetype":"GlobalThis要素名","comment":"...（内部APIにつき説明省略）"},{"name":"need_err","required":"","def":"true","rangetype":"true、false","comment":"HTML内にセレクタ（set_fnc属性）に対応する要素が見つからない場合にエラーを出すか"}],"snippet":[{"nm":"dump_script","txt":"dump_script"}],"detail":""},"let_ml":{"sum":"インラインテキスト代入  \\n[let_ml]〜[endlet_ml]で囲んだ複数行テキストを代入する","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"}],"snippet":[{"nm":"let_ml","txt":"let_ml name=${1{{代入変数名}}}]\\n\\tここに自由な複数行テキストを\\n[endlet_ml"}],"detail":"【JSON文字列を「.」表記で取り出せる書式】との組み合わせで、以下のようなことができます。\\n\\n### コード例\\n~~~skynovel\\n[let_ml name=a]\\n\\t{\\n\\t\\t\\"b\\": 3,\\n\\t\\t\\"c\\": 5\\n\\t}\\n[endlet_ml]\\n[trace text=&a] ; -> {\\"b\\": 3, \\"c\\": 5}\\n[trace text=&a.b] ; -> 3\\n[trace text=&a.c] ; -> 5\\n~~~\\n\\n機能ギャラリー【[フラグメントシェーダで[trans ]](https://famibee.github.io/SKYNovel_gallery/?cur=glsl_slide)】では、GLSLというシェーダー記述言語を扱うのに使用しています。\\n\\n### コード例\\n~~~skynovel\\n[let_ml name=ml]\\n\\tprecision mediump float;\\n\\tvarying vec2 vTextureCoord;\\n\\tuniform sampler2D uSampler;\\n\\tuniform float tick;\\n\\n\\tvoid main(void) {\\n\\t\\tvec2 pos = vTextureCoord;\\n\\t\\tpos.x = pos.x + tick;\\n\\t\\tif (pos.x > 1.0) gl_FragColor = vec4(0);\\n\\t\\telse gl_FragColor = texture2D(uSampler, pos);\\n\\t}\\n[endlet_ml]\\n~~~"},"let_abs":{"sum":"絶対値  \\n絶対値を求める。結果を変数に代入する","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"実数","comment":"絶対値を求める数"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_abs","txt":"let_abs name=${1{{代入変数名}}} text=${2:絶対値を求める数}"}],"detail":"### コード例\\n~~~skynovel\\n[let_abs name=a text=-3.56]\\n[trace text=&a] ; -> 3.56\\n~~~"},"tcy":{"sum":"縦中横を表示する  \\n縦中横文字を追加する。ルビは同時に設定する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"t","required":"y","def":"","rangetype":"縦中横文字列","comment":"通常半角文字を指定する"},{"name":"r","required":"","def":"ルビ無し","rangetype":"ルビ文字列","comment":"ルビ文字列"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時。"}],"snippet":[{"nm":"tcy","txt":"tcy t=${1:縦中横文字列}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[トップページの「451」](https://famibee.github.io/SKYNovel_gallery/)"},"tsy_frame":{"sum":"フレームをトゥイーン開始  \\nフレームのトゥイーンアニメを行なう","param":[{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"[[add_fram]](https://famibee.github.io/SKYNovel/tag.html#add_fram)で定義したフレーム名"},{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"トゥイーンにかける時間"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"トゥイーンを始める前の、何もしない待ち時間"},{"name":"repeat","required":"","def":"1","rangetype":"0〜；繰返し回数","comment":"0か負の値 で無限ループ。1を設定すると「繰り返しなし」、2を設定すると「二回同じ動き」を行なう"},{"name":"ease","required":"","def":"Linear.None","rangetype":"イージング名","comment":"揺れのイージング（値の変化の仕方）を指定する。[イージングの変化はこちらの図](https://createjs.com/demos/tweenjs/tween_sparktable)（または[こちら](https://sole.github.io/tween.js/examples/03_graphs.html)）が分かりやすい。指定できる値は[[tsy]](https://famibee.github.io/SKYNovel/tag.html#tsy)を参照"},{"name":"yoyo","required":"","def":"false","rangetype":"true、false","comment":"（暫定）ヨーヨーのように逆方向に戻って繰り返す"},{"name":"chain","required":"","def":"なにもしない","rangetype":"レイヤ名","comment":"指定したレイヤのトゥイーンアニメが終了してから、このトゥイーンを続けて開始する"},{"name":"alpha","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"レイヤの透過度。0（完全透明）〜0.5（半透明）〜1（不透明）  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"width","required":"","def":"なにもしない","rangetype":"相対値か絶対値","comment":"横幅  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"height","required":"","def":"なにもしない","rangetype":"相対値か絶対値","comment":"縦幅  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"rotation","required":"","def":"0","rangetype":"相対値か絶対値","comment":"時計回りは0～180、反時計回りは0～-180を指定。左上を中心に回る  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"scale_x","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"scale_y","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"x","required":"","def":"0","rangetype":"相対値か絶対値","comment":"leftの変化目標値  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"y","required":"","def":"0","rangetype":"相対値か絶対値","comment":"topの変化目標値  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"path","required":"","def":"なにもしない","rangetype":"※コメントで解説","comment":"指定すると複数のポイントを連続してトゥイーンアニメする。  \\nポイントは半角丸括弧()【吉里吉里拡張】や{}【JSON形式】が連続する文字列。  \\n"}],"snippet":[{"nm":"tsy_frame","txt":"tsy_frame id=${1{{フレーム名}}} time=${2:トゥイーンにかける時間}"}],"detail":"「目標値」を設定する時、相対値あるいは絶対値を指定できる\\n\\n| 指定\\t\\t\\t | 説明\\t|\\n--|--\\n| x=500\\t\\t\\t| X位置を500に |\\n| x=\'=500\'\\t\\t| 現在のX位置に+500加算した位置 |\\n| x=\'=-500\'\\t\\t| 現在のX位置に-500加算した位置 |\\n| x=\'250,500\'\\t| +250から＋500までの間でランダムな位置 |\\n| x=\'=250,500\'\\t| +250から＋500までの間でランダムな値を現在のX位置に加算した位置 |"},"wf":{"sum":"効果音フェードの終了待ち  \\n効果音 フェードの終了を待つ","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"canskip","required":"","def":"false","rangetype":"true、false","comment":"trueでクリックキャンセル可能にする"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"wf","txt":"wf buf=${1{{サウンドバッファ}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"log":{"sum":"ログ出力  \\nダウンロードフォルダにテキスト出力する（追記ではなく上書き。追記する。出力日時・分・スクリプト名や行番号やプロジェクト名も出力","param":[{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"ログ出力する値"}],"snippet":[{"nm":"log","txt":"log text=&${1{{代入変数名}}}"}],"detail":"### コード例\\n~~~skynovel\\n[log text=\'てんぐ👺🌈𩸽🌕\']\\n~~~"},"endlink":{"sum":"ハイパーリンクの終了  \\n[link]（ハイパーリンク）で開始したリンク区間を終了する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"}],"snippet":[{"nm":"endlink","txt":"endlink layer=${1{{文字レイヤ名}}} page=${2|fore,back|}"}],"detail":""},"update_check":{"sum":"更新チェック機能  \\nネットにアプリの更新を確認し、ダウンロードもサポートする","param":[{"name":"url","required":"y","def":"","rangetype":"URL文字列","comment":"latest(-mac).ymlや、dmg(exe)を置いたWebサーバーのフォルダURLを指定する。終端は「/」をつけること"}],"snippet":[{"nm":"update_check","txt":"update_check url=${1:WebページURL}"}],"detail":"アプリの最新バージョンをネットで確認する。（アプリ版でのみ動作）\\n処理は非同期に行われ、更新があった時のみ更新確認ウインドウが表示される。\\nダウンロードフォルダにアプリパッケージの dmg（インストーラー exe）をダウンロードする"},"ruby2":{"sum":"文字列と複数ルビの追加  \\n親文字列とルビ文字列のセットで文字を追加する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"t","required":"y","def":"","rangetype":"文字列","comment":"親文字列"},{"name":"r","required":"y","def":"","rangetype":"文字列","comment":"ルビ文字列"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"}],"snippet":[{"nm":"ruby2","txt":"ruby2 t=${1:親文字列} r=${2:ルビ文字列}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[直感的なルビ文法](https://famibee.github.io/SKYNovel_gallery/?cur=ruby)"},"r":{"sum":"改行  \\n指定した文字レイヤの表ページに、改行を出力する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"record","required":"","def":"true","rangetype":"true、false","comment":"履歴に保存するか"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"}],"snippet":[{"nm":"r","txt":"r"}],"detail":""},"window":{"sum":"アプリウインドウ設定  \\nゲームアプリのウインドウサイズや位置などを変更する","param":[{"name":"width","required":"","def":"現在値","rangetype":"1〜；横幅","comment":"アプリウインドウの横幅を指定"},{"name":"height","required":"","def":"現在値","rangetype":"1〜；縦幅","comment":"アプリウインドウの高さを指定"},{"name":"framerate","required":"","def":"現在値","rangetype":"1〜","comment":"アプリ全体のフレームレートを変更"},{"name":"centering","required":"","def":"なにもしない","rangetype":"true、false","comment":"trueを指定すると、アプリウインドウをデスクトップの中央に移動する"},{"name":"x","required":"","def":"なにもしない","rangetype":"実数；横座標","comment":"デスクトップにおけるアプリウインドウの横位置を指定"},{"name":"y","required":"","def":"なにもしない","rangetype":"実数；縦座標","comment":"デスクトップにおけるアプリウインドウの縦位置を指定"}],"snippet":[{"nm":"window","txt":"window"}],"detail":""},"enable_event":{"sum":"イベント有無の切替  \\n文字レイヤごとのイベント発生有効無効を設定する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"イベント有効無効を設定するレイヤ"},{"name":"enabled","required":"","def":"true","rangetype":"true、false","comment":"イベントを有効にするか"}],"snippet":[{"nm":"enable_event","txt":"enable_event global=${1|false,true|}"}],"detail":"無効にするとマウスイベントが無効になり、[[s]](https://famibee.github.io/SKYNovel/tag.html#s)待ちなどでイベントが発生しなくなるが、イベント予約は別の話であり、削除などされない。 有効にすればマウスイベントが発生するようになり、再びイベント待ちされるようになる"},"tsy":{"sum":"トゥイーン開始  \\nレイヤーにトゥイーンアニメ（変形・移動・回転アニメーション）を加える","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"name","required":"y","def":"layerの値","rangetype":"文字列","comment":"トゥイーン名"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"トゥイーンにかける時間"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"トゥイーンを始める前の、何もしない待ち時間- "},{"name":"repeat","required":"","def":"1","rangetype":"0〜；繰返し回数","comment":"0か負の値 で無限ループ。1を設定すると「繰り返しなし」、2を設定すると「二回同じ動き」を行なう"},{"name":"arrive","required":"","def":"false","rangetype":"true、false","comment":"trueならクリックキャンセルでアニメ終端までSkip。falseならその場で停止"},{"name":"backlay","required":"","def":"false","rangetype":"true、false","comment":"trueならトゥイーン終了時、fore→backへ属性をコピーする。  \\nコピーする属性はalpha, height, rotation, scale_x, scale_y, width, left, top"},{"name":"ease","required":"","def":"Linear.None","rangetype":"イージング名","comment":"揺れのイージング（値の変化の仕方）を指定する。[イージングの変化はこちらの図](https://createjs.com/demos/tweenjs/tween_sparktable)（または[こちら](https://sole.github.io/tween.js/examples/03_graphs.html)）が分かりやすい。指定できる値は[[tsy]](https://famibee.github.io/SKYNovel/tag.html#tsy)を参照"},{"name":"yoyo","required":"","def":"false","rangetype":"true、false","comment":"（暫定）ヨーヨーのように逆方向に戻って繰り返す"},{"name":"chain","required":"","def":"なにもしない","rangetype":"レイヤ名","comment":"指定したレイヤのトゥイーンアニメが終了してから、このトゥイーンを続けて開始する"},{"name":"alpha","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"レイヤの透過度。0（完全透明）〜0.5（半透明）〜1（不透明）  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"width","required":"","def":"なにもしない","rangetype":"相対値か絶対値","comment":"横幅  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"height","required":"","def":"なにもしない","rangetype":"相対値か絶対値","comment":"縦幅  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"rotation","required":"","def":"0","rangetype":"相対値か絶対値","comment":"時計回りは0～180、反時計回りは0～-180を指定。左上を中心に回る  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"scale_x","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"scale_y","required":"","def":"1.0","rangetype":"相対値か絶対値","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"x","required":"","def":"0","rangetype":"相対値か絶対値","comment":"leftの変化目標値  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"y","required":"","def":"0","rangetype":"相対値か絶対値","comment":"topの変化目標値  \\n> **相対値あるいは絶対値を指定できる**  \\n> x=500 .......... 500  \\n> x=\'=500\' ....... 現在のxに+500加算した値  \\n> x=\'=-500\' ...... 現在のxに-500加算した値  \\n> x=\'250,500\' .... +250から＋500までの間でランダムな値  \\n> x=\'=250,500\' ... +250から＋500までの間でランダムな値を現在のxに加算した値"},{"name":"path","required":"","def":"なにもしない","rangetype":"※コメントで解説","comment":"指定すると複数のポイントを連続してトゥイーンアニメする。  \\nポイントは半角丸括弧()【吉里吉里拡張】や{}【JSON形式】が連続する文字列。  \\n"},{"name":"render","required":"","def":"false","rangetype":"true、false","comment":"trueを指定すると[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)のように絵を合成してから不透明度を適用するように（半透明時に差分境界が見えなくなる）"},{"name":"filter","required":"","def":"blur","rangetype":"フィルター名","comment":"レイヤに指定するフィルター名。その他必要な属性は適宜指定する。詳細は[[add_filter]](https://famibee.github.io/SKYNovel/tag.html#add_filter)参照。ただし[[add_filter]](https://famibee.github.io/SKYNovel/tag.html#add_filter)のような追加ではなく上書き"},{"name":"enable_filter","required":"true","def":"true、false","rangetype":"フィルターを有効にするか"}],"snippet":[{"nm":"tsy","txt":"tsy layer=${1{{レイヤ名}}} time=${2:トゥイーンにかける時間}"}],"detail":"「目標値」を設定する時、相対値あるいは絶対値を指定できる\\n\\n| 指定\\t\\t\\t | 説明\\t|\\n--|--\\n| x=500\\t\\t\\t| X位置を500に |\\n| x=\'=500\'\\t\\t| 現在のX位置に+500加算した位置 |\\n| x=\'=-500\'\\t\\t| 現在のX位置に-500加算した位置 |\\n| x=\'250,500\'\\t| +250から＋500までの間でランダムな位置 |\\n| x=\'=250,500\'\\t| +250から＋500までの間でランダムな値を現在のX位置に加算した位置 |\\n\\n\\n機能ギャラリーにサンプルがあります。$(play)[トゥイーンアニメを行なう](https://famibee.github.io/SKYNovel_gallery/?cur=tag_tsy)"},"endif":{"sum":"ifブロックの終端  \\nプログラム言語における、条件分岐のendif文。\\n詳細は【開発者向け情報：式の評価と条件分岐】をご覧下さい","param":[],"snippet":[{"nm":"endif","txt":"endif"}],"detail":""},"import":{"sum":"プレイデータをインポート  \\nプレイデータファイルをインポートする\\n\\n読み込みダイアログが表示され、選択したプレイデータファイルをインポートする。\\nプレイデータ拡張子、ウェブ版は.swpd、アプリ版は.spdで互換性はない。\\n\\nタグはダイアログを表示次第すぐ次の処理に移り、ユーザーの選択を待たない。\\nインポート完了時には【sn:imported】というイベントを発火する。\\n【[event key=\'sn:imported\' 〜]】という記述でジャンプできる。\\n\\n機能ギャラリーにサンプルがあります。$(play)[プレイデータ](https://famibee.github.io/SKYNovel_gallery/?cur=import)","param":[],"snippet":[{"nm":"import","txt":"import"}],"detail":""},"let_replace":{"sum":"正規表現で置換  \\n文字列を正規表現で検索し、マッチする箇所を文字列で置き換える","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"置換対象の文字列"},{"name":"reg","required":"y","def":"","rangetype":"文字列","comment":"正規表現"},{"name":"flags","required":"","def":"（なし）","rangetype":"文字列","comment":"正規表現のフラグ"},{"name":"val","required":"y","def":"","rangetype":"文字列","comment":"置き換える文字列"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_replace","txt":"let_replace name=${1{{代入変数名}}} text=${2:置換対象の文字列} reg=${3:正規表現} val=${4:置き換える文字列}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcde\'\\n[let_replace name=a text=&a reg=\'cd\' val=GG]\\n[trace text=&a] ; -> abGGe\\n~~~"},"fadeoutbgm":{"sum":"BGMのフェードアウト  \\nBGMを無音に、段階的に変化させる","param":[{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"フェード時間"},{"name":"stop","required":"","def":"true","rangetype":"true、false","comment":"trueで「フェード終了時の再生停止」、falseなら行なわない"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化する前に待機する遅延時"}],"snippet":[{"nm":"fadeoutbgm","txt":"fadeoutbgm time=${1:1000}"}],"detail":""},"dump_val":{"sum":"変数のダンプ  \\n変数の内容をデバッグ表示する","param":[],"snippet":[{"nm":"dump_val","txt":"dump_val"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[デバッグ機能](https://famibee.github.io/SKYNovel_gallery/?cur=debug)"},"save":{"sum":"しおりの保存  \\nしおりデータを保存する","param":[{"name":"place","required":"y","def":"","rangetype":"0〜","comment":"処理対象のしおり番号"}],"snippet":[{"nm":"save","txt":"save place=${1:処理対象のしおり番号}"}],"detail":"しおりデータを保存する。  \\n読み込み時に再開するスクリプトの位置は最後に[[record_place]](https://famibee.github.io/SKYNovel/tag.html#record_place)をコールした位置。  \\n\\n[[record_place]](https://famibee.github.io/SKYNovel/tag.html#record_place)がゲーム状態（レイヤ状態など）をバッファに退避し、  \\n[[save]](https://famibee.github.io/SKYNovel/tag.html#save)は指定しおりに書き出す機能。"},"link":{"sum":"ハイパーリンク  \\n指定した文字レイヤの表ページに、ハイパーリンクを作成する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ名"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"style","required":"","def":"\'background-color: rgba(255,0,0,0.5);\'","rangetype":"CSS style","comment":"リンク上にマウスカーソルが乗っていない状態のCSS スタイル"},{"name":"style_hover","required":"","def":"\'background-color: rgba(255,0,0,0.9);\'","rangetype":"CSS style","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしていない）のCSS スタイル"},{"name":"style_clicked","required":"","def":"styleの値","rangetype":"CSS style","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしている）のCSS スタイル"},{"name":"style_disable","required":"","def":"\'color: gray;\'","rangetype":"CSS style","comment":"enabled=false 状態のCSS スタイル"},{"name":"r_style","required":"","def":"styleの値","rangetype":"CSS style","comment":"リンク上にマウスカーソルが乗っていない状態のルビのCSS スタイル"},{"name":"r_style_hover","required":"","def":"style_hoverの値","rangetype":"CSS style","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしていない）のルビのCSS スタイル"},{"name":"r_style_clicked","required":"","def":"r_styleの値","rangetype":"CSS style","comment":"文字ボタン上にマウスカーソルが乗っている状態（クリックしている）のルビのCSS スタイル"},{"name":"r_style_disable","required":"","def":"\'color: gray;\'","rangetype":"CSS style","comment":"enabled=false 状態のルビのCSS スタイル"},{"name":"ch_in_style","required":"","def":"なにもしない","rangetype":"文字出現演出名","comment":"[[ch_in_style]](https://famibee.github.io/SKYNovel/tag.html#ch_in_style)で定義した文字出現演出名"},{"name":"ch_out_style","required":"","def":"なにもしない","rangetype":"文字消去演出名","comment":"[[ch_out_style]](https://famibee.github.io/SKYNovel/tag.html#ch_out_style)で定義した文字消去演出名"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"enabled","required":"","def":"true","rangetype":"true、false","comment":"falseだと押せないボタンとなり、クリックイベントが発生しない。  \\nこれにより文字レイヤの任意の位置に画像表示できる機能を提供する。  \\n画像は三等分しない。イベントや効果音指定は無効だが、ヒント機能は有効"},{"name":"call","required":"","def":"false","rangetype":"true、false","comment":"trueの場合は[[call]](https://famibee.github.io/SKYNovel/tag.html#call)、falseは[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)。  \\nただしcall=trueによりサブルーチンコールした場合、[[return]](https://famibee.github.io/SKYNovel/tag.html#return)によって「コールする前のイベント予約状態＆待ち状態」に戻る"},{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"クリック時にジャンプする先"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"コール先のスクリプトにあるラベル","":"クリック時ジャンプ先で「&sn.eventLabel」にて値を受け取れる"},{"name":"url","required":"y","def":"fn・label によるスクリプトジャンプ","rangetype":"ブラウザで開けるURL","comment":"クリック時にURLを開く。指定時は fn・label を無視する"},{"name":"global","required":"","def":"false","rangetype":"true、false","comment":"詳細は[[event]](https://famibee.github.io/SKYNovel/tag.html#event)と同様。  \\n※ボタンを[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)する場合はtrueにしておく"},{"name":"arg","required":"","def":"","rangetype":"ジャンプ先に渡したい値","comment":"指定した場合、クリック時ジャンプ先で「&sn.eventArg」にて値を受け取れる"},{"name":"onenter","required":"","def":"なにもしない","rangetype":"ラベル名","comment":"マウス重なり（フォーカス取得）時、指定したラベルをコールする。 必ず[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で戻ること"},{"name":"onleave","required":"","def":"なにもしない","rangetype":"ラベル名","comment":"マウス重なり外れ（フォーカス外れ）時、指定したラベルをコールする。 必ず[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で戻ること"},{"name":"clickse","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、クリック時に効果音を再生する"},{"name":"enterse","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、ボタン上にマウスカーソルが載った時に効果音を再生する"},{"name":"leavese","required":"","def":"省略時は無音","rangetype":"音声ファイル名","comment":"指定すると、ボタン上からマウスカーソルが外れた時に効果音を再生する"},{"name":"clicksebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"クリック時効果音を再生するサウンドバッファを指定する"},{"name":"entersebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"マウスオン時効果音を再生するサウンドバッファを指定する"},{"name":"leavesebuf","required":"","def":"SYS","rangetype":"サウンドバッファ名","comment":"マウスアウト時効果音を再生するサウンドバッファを指定する"},{"name":"hint","required":"","def":"表示しない","rangetype":"ヒント文字列","comment":"指定した場合のみ、マウスカーソルを載せるとツールチップス表示する"},{"name":"hint_style","required":"","def":"","rangetype":"CSS style","comment":"hintの CSSを指定できる"},{"name":"hint_opt","required":"","def":"","rangetype":"文字列","comment":"@popperjs/coreの動作を指定"}],"snippet":[{"nm":"link","txt":"link ${1{{ジャンプ先}}}][endlink"}],"detail":"[[link]](https://famibee.github.io/SKYNovel/tag.html#link)から[[endlink]](https://famibee.github.io/SKYNovel/tag.html#endlink)（ハイパーリンクの終了）までで囲った範囲をリンク区間と呼び、\\nその区間の文字や縦中横がハイパーリンクになる。（リンク区間は入れ子に出来ません）\\n※選択肢として使用する場合、ジャンプ先のラベル直後には必ず[[record_place]](https://famibee.github.io/SKYNovel/tag.html#record_place)を記述して、ジャンプ直後でセーブしても正しくセーブされるようにして下さい\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=ch_button)"},"s":{"sum":"停止する  \\nシナリオファイルの順次処理を停止する\\n[event]などでイベントが登録されていれば、イベント発生待ちを行う","param":[{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"s","txt":"s"}],"detail":""},"char2macro":{"sum":"一文字マクロの定義  \\n属性無しのマクロやタグを、半角文字の記述で代用できるよう定義する","param":[{"name":"char","required":"y","def":"","rangetype":"一文字","comment":"マクロにする半角文字。  \\nマクロに出来るのは英文字、空白、;、[、]、、=、&、｜、《、》以外のみ。  \\n正規表現で言えば　/[\\\\w\\\\s;[]=&｜《》]/　以外。  \\n括弧文字や定義済みの一文字マクロは使用できない"},{"name":"name","required":"y","def":"","rangetype":"定義済みのマクロ名","comment":"半角文字に割り当てるマクロ名を指定。  \\n組み込みタグか、[[macro]](https://famibee.github.io/SKYNovel/tag.html#macro)による定義済みマクロ名で無ければならない"}],"snippet":[{"nm":"char2macro","txt":"char2macro char=${1:マクロにする半角文字} name=${2{{マクロ名}}}"}],"detail":"本タグより前にロードされたスクリプトファイルには適用されません。\\nまたスクリプトファイルに本タグが記述された場合、本タグより前に出現した半角文字にも適用されません\\n\\n機能ギャラリーにサンプルがあります。$(play)[メッセージウインドウ](https://famibee.github.io/SKYNovel_gallery/?cur=txt_back)"},"clear_filter":{"sum":"フィルター全削除  \\nレイヤのフィルターを全削除する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）"},{"name":"page","required":"","def":"fore","rangetype":"fore、back、both","comment":"ページの裏表（both指定で両面）"}],"snippet":[{"nm":"clear_filter","txt":"clear_filter layer=${1{{レイヤ名}}} page=${2|fore,back,both|}"}],"detail":""},"finish_trans":{"sum":"トランス強制終了  \\n[trans]で開始したトランスをすぐ終了させる","param":[],"snippet":[{"nm":"finish_trans","txt":"finish_trans"}],"detail":""},"playbgm":{"sum":"BGM の演奏  \\nBGMを再生する。[playse]とは違い、キー押下Skip中でも必ず再生を行なう。（canskip = false）","param":[{"name":"fn","required":"y","def":"","rangetype":"音声ファイル名","comment":"再生する音声ファイル名"},{"name":"loop","required":"","def":"true","rangetype":"true、false","comment":"trueでBGMのようにループ再生する"},{"name":"volume","required":"","def":"1.0","rangetype":"0.0〜1.0","comment":"再生音量。ただし音量を示すシステム変数（sys:const.an.sound.BGM.volume）は変更しない"},{"name":"speed","required":"","def":"1.0","rangetype":"0.0〜1.0","comment":"再生速度（0:遅い、1.0:元のまま）"},{"name":"pan","required":"0.0","def":"-1.0〜1.0","rangetype":"音を出す左右位置（-1.0=左端、0.0=中央(省略値)、1.0=右端）"},{"name":"join","required":"","def":"true","rangetype":"true、false","comment":"trueで読み込みを待って次のタグへ進む"},{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"trueでキー押下Skip中なら再生をしない"},{"name":"start_ms","required":"","def":"0（冒頭）","rangetype":"0〜；ミリ秒","comment":"再生の開始位置を指定する。0は冒頭"},{"name":"end_ms","required":"","def":"末端","rangetype":"0〜；ミリ秒","comment":"再生の終了位置を指定する。省略時は末端。  \\n正の値は「冒頭から何ms目を終端とするか」  \\n負の値は「末尾から何ms手前を終端とするか」の指定"},{"name":"ret_ms","required":"","def":"0（冒頭）","rangetype":"0〜；ミリ秒","comment":"ループ戻り位置を指定する。0は冒頭。  \\nループ再生中にend_ms指定位置（省略時は末尾）に到達した場合、この指定位置に戻る。 ループ再生しない（loop=false）際は無視される。"}],"snippet":[{"nm":"playbgm","txt":"playbgm fn=${1{{音声ファイル名}}}"}],"detail":""},"lay":{"sum":"レイヤ設定  \\nレイヤに各種設定を行う","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"visible","required":"","def":"現在値","rangetype":"true、false","comment":"true：表示、false：非表示"},{"name":"alpha","required":"","def":"1.0","rangetype":"0.0〜1.0；透過度","comment":"レイヤの透過度。0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"blendmode","required":"","def":"なにもしない","rangetype":"ブレンドモード名","comment":"このレイヤと下のレイヤとの重なりにおいて、ドット単位で色のブレンド演算を行なう"},{"name":"pos","required":"","def":"c","rangetype":"c・l・r・横座標","comment":"主に立ち絵に使う。横と縦座標を同時に設定する。横座標は指定した値（文字cの場合は画面中央、lは左寄り、rは右寄り）に設定し、画像下端を画面下端に接するように自動計算する"},{"name":"left","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン左端の画面左端からの距離"},{"name":"center","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン中央の画面左端からの距離"},{"name":"right","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン右端の画面左端からの距離"},{"name":"s_right","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン右端の画面右端からの距離"},{"name":"top","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン上端の画面上端からの距離"},{"name":"middle","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン中央の画面上端からの距離"},{"name":"bottom","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン下端の画面上端からの距離"},{"name":"s_bottom","required":"","def":"0","rangetype":"実数","comment":"レイヤやボタン下端の画面下端からの距離"},{"name":"rotation","required":"","def":"0","rangetype":"-180〜180；回転角度","comment":"時計回りは0～180、反時計回りは0～-180を指定。左上を中心に回る"},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"float","required":"","def":"なにもしない","rangetype":"true、false","comment":"true：レイヤを最前面に移動する"},{"name":"index","required":"","def":"なにもしない","rangetype":"0〜","comment":"レイヤをindexで指定したインデックスに移動する。  \\n0がもっとも背後。レイヤを重ねるたびに1加算したindexになる"},{"name":"dive","required":"","def":"なにもしない","rangetype":"レイヤ名","comment":"レイヤをdiveで指定したレイヤのすぐ後ろに潜り込ませる。  \\n「plg:プラグイン名」と記述する事でプラグインも指定できる"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\n[[span]](https://famibee.github.io/SKYNovel/tag.html#span)[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)などで style を指定しない際のデフォルト値。  \\n「color: red;」「color: blue;」と個別指定時は、過去値を上書きする。  \\n空白文字を指定時は全てクリアする"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\n「color: red;」「color: blue;」と個別指定時は、過去値を上書きする。  \\n空白文字を指定時は全てクリアする"},{"name":"r_align","required":"","def":"現在値","rangetype":"left、center、right、justify、121、even、1ruby","comment":"ルビ揃えを指定する。  \\n> left ……（肩付き）先頭親文字から、ルビ間は密着  \\n> center ……（中付き）センター合わせ、〃  \\n> right ……（右／下揃え）末尾親文字から、〃  \\n> justify ……（両端揃え）先頭から末尾親文字間に、ルビ間は均等にあける  \\n> 121 ……（1-2-1(JIS)）ルビの前後を比率1、ルビ間を比率2であける  \\n> even ……（均等アキ）ルビの前後、ルビ間も均等にあける  \\n> 1ruby ……（1ルビ文字アキ）ルビの前後をルビ一文字空け、ルビ間は均等にあける  \\n  \\n初期値は center。  \\n  \\n※親文字よりルビの方が長い場合は、親文字に対する「中付き」表示になる  \\n→参考（[機能ギャラリー・直感的なルビ文法](https://famibee.github.io/SKYNovel_gallery/index.html?cur=built_in_ruby)）"},{"name":"ch_in_style","required":"","def":"なにもしない","rangetype":"文字出現演出名","comment":"[[ch_in_style]](https://famibee.github.io/SKYNovel/tag.html#ch_in_style)で定義した文字出現演出名"},{"name":"ch_out_style","required":"","def":"なにもしない","rangetype":"文字消去演出名","comment":"[[ch_out_style]](https://famibee.github.io/SKYNovel/tag.html#ch_out_style)で定義した文字消去演出名"},{"name":"fn","required":"y","def":"なにもしない","rangetype":"差分名称（カンマ区切りで複数可）","comment":"基本画像ファイルを指定する。複数指定時はこの属性一つで基本画像（先頭）と差分名称（二つめ以降）を指定できる"},{"name":"face","required":"","def":"なにもしない","rangetype":"差分名称（カンマ区切りで複数可）","comment":"差分名称または画像ファイル名を指定する。[fg fn=\\"a\\" face=\\"b,c,d\\"]なら「基本a」の上に「差分b」を重ね、「差分c」を重ね、「差分d」を重ねる"},{"name":"width","required":"","def":"なにもしない","rangetype":"1〜；横幅","comment":"style設定に上書きできる"},{"name":"height","required":"","def":"なにもしない","rangetype":"1〜；縦幅","comment":"style設定に上書きできる"},{"name":"pl","required":"","def":"なにもしない","rangetype":"実数","comment":"style設定（paddingLeft）に上書きできる"},{"name":"pr","required":"","def":"なにもしない","rangetype":"実数","comment":"style設定（paddingRight）に上書きできる"},{"name":"pt","required":"","def":"なにもしない","rangetype":"実数","comment":"style設定（paddingTop）に上書きできる"},{"name":"pb","required":"","def":"なにもしない","rangetype":"実数","comment":"style設定（paddingBottom）に上書きできる"},{"name":"noffs","required":"","def":"現在値","rangetype":"文字列","comment":"font-feature-settingsの対象としない文字を指定できる。複数指定可能。  \\nデフォルト値は指定なし。（ただしインライン画像やクリック待ち記号表示のため、全角空白は必ず指定に含まれる）"},{"name":"kinsoku_sol","required":"","def":"なにもしない","rangetype":"文字列","comment":"行頭禁則の禁則処理文字を変更できる。対象文字を列挙した文字列を指定。  \\nデフォルト値は以下の通り。  \\n、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々"},{"name":"kinsoku_eol","required":"","def":"なにもしない","rangetype":"文字列","comment":"行末禁則の禁則処理文字を変更できる。対象文字を列挙した文字列を指定。  \\nデフォルト値は以下の通り。  \\n［（｛〈「『【〔“〝"},{"name":"kinsoku_dns","required":"","def":"なにもしない","rangetype":"文字列","comment":"分割禁止の禁則処理文字を変更できる。対象文字を列挙した文字列を指定。  \\nデフォルト値は以下の通り。  \\n─‥…"},{"name":"filter","required":"","def":"blur","rangetype":"フィルター名","comment":"レイヤに指定するフィルター名。その他必要な属性は適宜指定する。詳細は[[add_filter]](https://famibee.github.io/SKYNovel/tag.html#add_filter)参照。ただし[[add_filter]](https://famibee.github.io/SKYNovel/tag.html#add_filter)のような追加ではなく上書き"},{"name":"enable_filter","required":"true","def":"true、false","rangetype":"フィルターを有効にするか"}],"snippet":[{"nm":"lay","txt":"lay layer=${1{{レイヤ名}}} page=${2|fore,back|}"},{"nm":"lay（文字レイヤ）","txt":"lay layer=${1{{文字レイヤ名}}}"},{"nm":"lay（画像レイヤ）","txt":"lay layer=${1{{画像レイヤ名}}} fn=${2{{画像ファイル名}}} face=${3{{差分名称}}}"}],"detail":""},"stop_quake":{"sum":"画面揺らし中断  \\n画面揺らしを中断する","param":[],"snippet":[{"nm":"stop_quake","txt":"stop_quake"}],"detail":""},"event":{"sum":"イベントを予約  \\n次の[s]などのイベント待ちに向けてイベント処理を予約する","param":[{"name":"key","required":"y","def":"","rangetype":"イベント名","comment":"イベントを発生させるトリガーイベント  \\n修飾キーの同時押し（あるいは修飾キーを押しといて通常キー）を任意に組み合わせられます。「半角プラスで」「ABC順に」「イベントのキー名の前に」繋げて下さい。  \\n（例1）key=alt+enter  \\n（例2）key=alt+ctrl+shift+enter"},{"name":"call","required":"","def":"false","rangetype":"true、false","comment":"trueの場合は[[call]](https://famibee.github.io/SKYNovel/tag.html#call)、falseは[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)。  \\nただしcall=trueによりサブルーチンコールした場合、[[return]](https://famibee.github.io/SKYNovel/tag.html#return)によって「コールする前のイベント予約状態＆待ち状態」に戻る"},{"name":"fn","required":"y","def":"","rangetype":"ジャンプ先","comment":"イベント発生時にジャンプする先。指定方法は[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)と同様。  \\ncallの場合、ジャンプ先から[[return]](https://famibee.github.io/SKYNovel/tag.html#return)で戻ると、再度[[s]](https://famibee.github.io/SKYNovel/tag.html#s)などのイベント待ち状態に戻る"},{"name":"label","required":"y","def":"","rangetype":"ラベル名","comment":"イベント発生時にジャンプする先。指定方法は[[jump]](https://famibee.github.io/SKYNovel/tag.html#jump)と同様。  \\nクリック時ジャンプ先で「&sn.eventLabel」にて値を受け取れる"},{"name":"url","required":"y","def":"fn・label によるスクリプトジャンプ","rangetype":"URL","comment":"クリック時にURLを開く。指定時は fn・label を無視する"},{"name":"global","required":"","def":"false","rangetype":"true、false","comment":"trueを指定すると大域的なイベント扱いとなり、イベント発生時にイベント予約が削除されない"},{"name":"arg","required":"","def":"","rangetype":"ジャンプ先に渡したい値","comment":"指定した場合、クリック時ジャンプ先で「&sn.eventArg」にて値を受け取れる"},{"name":"del","required":"","def":"false","rangetype":"true、false","comment":"trueを指定すると予約済みイベントを削除する。  \\nfn/label/callとdelは同時指定できません"},{"name":"need_err","required":"","def":"true","rangetype":"true、false","comment":"HTML内にセレクタ（key属性）に対応する要素が見つからない場合にエラーを出すか"}],"snippet":[{"nm":"event","txt":"event key=${1{{イベント名}}} ${2{{ジャンプ先}}} global=${3|true,false|}"}],"detail":"あるイベントが発生した際、global=falseのイベント予約は全て削除される"},"trace":{"sum":"デバッグ表示へ出力  \\n属性をデバッグ表示する","param":[{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"デバッグ表示する値"}],"snippet":[{"nm":"trace","txt":"trace text=&${1{{代入変数名}}}"}],"detail":""},"clearsysvar":{"sum":"システム変数の全消去  \\nsys:変数を全消去。削除すると言うより、初期化する","param":[],"snippet":[{"nm":"clearsysvar","txt":"clearsysvar"}],"detail":""},"current":{"sum":"デフォルト文字レイヤ設定  \\nデフォルト文字レイヤを設定する","param":[{"name":"layer","required":"y","def":"","rangetype":"文字レイヤ名","comment":"デフォルトとするレイヤ"}],"snippet":[{"nm":"current","txt":"current layer=${1{{文字レイヤ名}}}"}],"detail":""},"ch_in_style":{"sum":"文字出現演出定義  \\n文字出現演出アニメを定義する","param":[{"name":"name","required":"y","def":"","rangetype":"文字出現演出名","comment":"文字出現演出を特定する名前"},{"name":"wait","required":"","def":"500","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"alpha","required":"","def":"0.0","rangetype":"0.0〜1.0；透過度","comment":"0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"x","required":"","def":"\'=0\'","rangetype":"実数か相対位置指定","comment":"変化の初期値。以下のような相対位置指定が出来る  \\n500 ──　X位置を500に  \\n\'=500\' ──　文字表示位置を基準に+500加算した位置  \\n\'=-500\' ──　文字表示位置を基準に-500加算した位置"},{"name":"y","required":"","def":"\'=0\'","rangetype":"実数か相対位置指定","comment":""},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"rotate","required":"","def":"0","rangetype":"-360〜360；回転角度","comment":"正の値は時計回り"},{"name":"join","required":"","def":"true","rangetype":"true、false","comment":"文字を順番に出すか（true）同時か（false）"},{"name":"ease","required":"","def":"\'ease-out\'","rangetype":"animation-timing-function","comment":"[CSSのanimation-timing-function プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/animation-timing-function)"}],"snippet":[{"nm":"ch_in_style","txt":"ch_in_style name=${1:文字出現演出名} wait=${2:500}"}],"detail":"[[lay]](https://famibee.github.io/SKYNovel/tag.html#lay)[[span]](https://famibee.github.io/SKYNovel/tag.html#span)などの ch_in_style属性で指定すると、定義どおりの文字出現演出アニメを行なう。\\n参考）[CSSのanimation-timing-function プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/animation-timing-function)\\n\\n機能ギャラリーにサンプルがあります。$(play)[文字出現演出](https://famibee.github.io/SKYNovel_gallery/?cur=ch_in_out)"},"let_length":{"sum":"文字列の長さ  \\n文字列の長さを求める","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"長さを求める文字列"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_length","txt":"let_length name=${1{{代入変数名}}} text=${2:長さを求める文字列}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcde\'\\n[let_length name=a text=&a]\\n[trace text=&a] ; -> 5\\n~~~"},"dump_stack":{"sum":"スタックのダンプ  \\n[call]等によるコールスタックの内容をデバッグ表示する","param":[],"snippet":[{"nm":"dump_stack","txt":"dump_stack"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[デバッグ機能](https://famibee.github.io/SKYNovel_gallery/?cur=debug)"},"page":{"sum":"ページ移動  \\nページ移動状態に入り、[p]停止位置を一つ移動する","param":[{"name":"clear","required":"いずれかを指定","def":"なにもしない","rangetype":"true、false","comment":"trueでページ状態記録をクリアする"},{"name":"to","required":"いずれかを指定","def":"なにもしない","rangetype":"oldest、prev、next、newest、exit、load","comment":"oldest：最古のページに移動  \\nprev：ひとつ前のページに戻る  \\nnext：ひとつ次のページに進める  \\nnewest：最新のページに移動  \\nexit：ページ移動状態から抜ける  \\nload：ページ移動状態で表示中ページからロードする"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ページ移動中の既読文字に適用する CSS スタイル。初期値は貴文字と黒縁取りCSS"},{"name":"key","required":"","def":"なにもしない","rangetype":"イベント名（カンマ区切りで複数可）","comment":"ページ移動状態中に有効にするグローバルイベントを限定できる。空白時は全て有効。"}],"snippet":[{"nm":"page","txt":"page to=${1|oldest,prev,next,newest,exit,load|}"}],"detail":"[[l]](https://famibee.github.io/SKYNovel/tag.html#l)[[p]](https://famibee.github.io/SKYNovel/tag.html#p)[[s]](https://famibee.github.io/SKYNovel/tag.html#s)などの停止位置を「ページ」とみなし、既読ページを戻ったり進んだりできる。\\nページを進めても一度読んだ位置を再現できる。\\nsave:sn.doRecLog が true の状態で[[l]](https://famibee.github.io/SKYNovel/tag.html#l)[[p]](https://famibee.github.io/SKYNovel/tag.html#p)[[s]](https://famibee.github.io/SKYNovel/tag.html#s)など。（[[wait]](https://famibee.github.io/SKYNovel/tag.html#wait)は対象外）で停止した際にそのページ状態の記録を行う。"},"jump":{"sum":"シナリオジャンプ  \\n指定位置のスクリプトにジャンプする","param":[{"name":"fn","required":"","def":"処理中のスクリプト","rangetype":"スクリプトファイル名","comment":"ジャンプ先のスクリプト"},{"name":"label","required":"","def":"スクリプトの先頭","rangetype":"ラベル名","comment":"ジャンプ先のスクリプトにあるラベル"},{"name":"count","required":"","def":"false","rangetype":"true、false","comment":"タグ位置を既読とするか"}],"snippet":[{"nm":"jump","txt":"jump ${1{{ジャンプ先}}}"}],"detail":"ラベルは例えば以下のように使います。\\n\\n### コード例\\n~~~skynovel\\n*aaa\\n無限ループ\\n[jump label=*aaa]\\n~~~\\n\\nさらにラベル名を考えるのが面倒なとき、「無名ラベル」ともいうべき機能が使えます。  \\n「**after」は「そのタグ以降で最初に見つかった**ラベルに」  \\n「**before」は「そのタグ以前で最初に見つかった**ラベルに」  \\nジャンプ・コールする、という指定です。次のように書きます。\\n\\n### コード例\\n~~~skynovel\\n[jump label=****after]\\n*** ; 最後のbeforeはここに戻る\\n**\\nも\\n[jump label=**after]\\n;**\\nっ\\n**\\n[l]\\nぷ\\n[jump label=**before]\\n**\\n＠[s]\\n**\\n****    ; 最初のafterはここへ\\nす\\n[jump label=***before]\\n~~~\\nこの例では「すもぷぷぷ……」と文字が表示されます。\\n「**」とか「***」とかアスタリスクは二個以上の任意の数が使え、同じ数同士が対応するラベルとなります。\\nが、上記例で見るとおりあんまり複雑に使うと可読性が下がってしまう気がしますので、局所的な用途に限ったほうが良さげです"},"enable_filter":{"sum":"フィルター個別切替  \\n個別にフィルター有効・無効を変更する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）"},{"name":"page","required":"","def":"fore","rangetype":"fore、back、both","comment":"ページの裏表（both指定で両面）"},{"name":"index","required":"","def":"0","rangetype":"0〜","comment":"追加したフィルターの中で、有効・無効を変更するフィルターの番号。  \\n0が最初のフィルター。フィルターを重ねるたびに1加算したindexになる"},{"name":"enabled","required":"true","def":"true、false","rangetype":"フィルターを有効にするか"}],"snippet":[{"nm":"enable_filter","txt":"enable_filter layer=${1{{レイヤ名}}} page=${2|fore,back,both|} index=${3:フィルターの番号} enabled=${4|true,false|}"}],"detail":""},"copybookmark":{"sum":"しおりの複写  \\nしおりデータを複写する","param":[{"name":"from","required":"y","def":"","rangetype":"0〜","comment":"複写元のしおり番号"},{"name":"to","required":"y","def":"","rangetype":"0〜","comment":"複写先のしおり番号"}],"snippet":[{"nm":"copybookmark","txt":"copybookmark from=${1:複写元のしおり番号} to=${2:複写先のしおり番号}"}],"detail":""},"add_lay":{"sum":"レイヤを追加する  \\nレイヤはページの裏表があり、文字レイヤや画像レイヤなどの種類があります","param":[{"name":"layer","required":"y","def":"","rangetype":"未使用のレイヤ名","comment":"レイヤ名を指定する。未使用のレイヤ名でなければエラー＆アプリ停止"},{"name":"class","required":"y","def":"","rangetype":"grp、txt","comment":"レイヤの種類。grp（画像レイヤ）、txt（文字レイヤ）のレイヤ種別"}],"snippet":[{"nm":"add_lay","txt":"add_lay layer=${1:レイヤ名} class=${2|grp,txt|}"}],"detail":"### コード例\\n~~~skynovel\\n[add_lay layer=base class=grp]\\n[add_lay layer=0 class=grp]\\n[add_lay layer=mes class=txt]\\n~~~"},"ch_out_style":{"sum":"文字消去演出定義  \\n文字消去演出アニメを定義する","param":[{"name":"name","required":"y","def":"","rangetype":"文字消去演出名","comment":"文字消去演出を特定する名前"},{"name":"wait","required":"","def":"500","rangetype":"0〜；ミリ秒","comment":"一時的な文字消去速度。0で瞬時"},{"name":"alpha","required":"","def":"0.0","rangetype":"0.0〜1.0；透過度","comment":"0（完全透明）〜0.5（半透明）〜1（不透明）"},{"name":"x","required":"","def":"\'=0\'","rangetype":"実数か相対位置指定","comment":"変化の目標値。以下のような相対位置指定が出来る  \\n500 ──　X位置を500に  \\n\'=500\' ──　文字位置を基準に+500加算した位置  \\n\'=-500\' ──　文字位置を基準に-500加算した位置"},{"name":"y","required":"","def":"\'=0\'","rangetype":"実数か相対位置指定","comment":""},{"name":"scale_x","required":"","def":"1.0","rangetype":"実数","comment":"横方向を何倍に拡大／縮小するか。負の値ならレイヤを左右反転"},{"name":"scale_y","required":"","def":"1.0","rangetype":"実数","comment":"縦方向を何倍に拡大／縮小するか。負の値ならレイヤを上下反転"},{"name":"rotate","required":"","def":"0","rangetype":"-360〜360；回転角度","comment":"正の値は時計回り"},{"name":"join","required":"","def":"false","rangetype":"true、false","comment":"文字を順番に出すか（true）同時か（false）"},{"name":"ease","required":"","def":"\'ease-out\'","rangetype":"animation-timing-function","comment":"[CSSのanimation-timing-function プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/animation-timing-function)"}],"snippet":[{"nm":"ch_out_style","txt":"ch_out_style name=${1:文字消去演出名} wait=${2:500}"}],"detail":"[[lay]](https://famibee.github.io/SKYNovel/tag.html#lay)[[span]](https://famibee.github.io/SKYNovel/tag.html#span)などの ch_out_style属性で指定すると、定義どおりの文字消去演出アニメを行なう。  \\n文字消去演出は、次ページの文字出現演出と同時に行なわれる。文字消去演出を待ちたい場合は、[[wait]](https://famibee.github.io/SKYNovel/tag.html#wait)などで待つ。\\n参考）[CSSのanimation-timing-function プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/animation-timing-function)\\n\\n機能ギャラリーにサンプルがあります。$(play)[文字出現演出](https://famibee.github.io/SKYNovel_gallery/?cur=ch_in_out)"},"pause_tsy":{"sum":"一時停止  \\nレイヤーやフレームのトゥイーンアニメを一時停止させる","param":[{"name":"layer","required":"y","def":"","rangetype":"レイヤ名","comment":"処理対象のレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"処理対象のフレーム"}],"snippet":[{"nm":"pause_tsy","txt":"pause_tsy layer=${1{{レイヤ名}}}"}],"detail":"「layer（とpage）」を指定した場合はレイヤーの操作、  \\n「id」を指定した場合はフレームの操作を行なう\\n\\n機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=tag_tsy)"},"fadeoutse":{"sum":"効果音のフェードアウト  \\n効果音を無音に、段階的に変化させる","param":[{"name":"buf","required":"","def":"SE","rangetype":"サウンドバッファ名","comment":"効果音を識別する名前。サウンドバッファ名を変えれば同時に複数の音を操作することが出来ます"},{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"フェード時間"},{"name":"stop","required":"","def":"true","rangetype":"true、false","comment":"trueで「フェード終了時の再生停止」、falseなら行なわない"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"変化する前に待機する遅延時"}],"snippet":[{"nm":"fadeoutse","txt":"fadeoutse buf=${1{{サウンドバッファ}}} time=${2:1000}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[効果音とBGM](https://famibee.github.io/SKYNovel_gallery/?cur=sound)"},"wl":{"sum":"BGM 再生の終了待ち  \\nBGM 再生の終了を待つ。\\nloop=true（[playbgm]のデフォルト値）なら待たない。\\n利用時は【音声再生[playbgm]がjoin=true(ちなみにデフォルト)であること】を必須条件とします","param":[{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"wl","txt":"wl"}],"detail":""},"ch":{"sum":"文字を追加する  \\n文字レイヤに文字を出力する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"text","required":"y","def":"","rangetype":"表示したい文字列","comment":"ルビ文法（《》）も解析する。改行も [[r]](https://famibee.github.io/SKYNovel/tag.html#r) で出来る"},{"name":"record","required":"","def":"true","rangetype":"true、false","comment":"履歴に保存するか"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る  \\n※[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)でのみ、背景styleなどを一塊とする。【[span style=\'\']文字[[span]](https://famibee.github.io/SKYNovel/tag.html#span)】と動作が異なる"},{"name":"ch_in_style","required":"","def":"なにもしない","rangetype":"文字出現演出名","comment":"[[ch_in_style]](https://famibee.github.io/SKYNovel/tag.html#ch_in_style)で定義した文字出現演出名"},{"name":"ch_out_style","required":"","def":"なにもしない","rangetype":"文字消去演出名","comment":"[[ch_out_style]](https://famibee.github.io/SKYNovel/tag.html#ch_out_style)で定義した文字消去演出名"}],"snippet":[{"nm":"ch","txt":"ch layer=${1{{文字レイヤ名}}} page=${2|fore,back|} text=${3:表示したい文字列} ch_in_style=${4{{文字出現演出名}}} ch_out_style=${5{{文字消去演出名}}}"}],"detail":"[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)を使わない、より簡潔な記述文法があります。\\n以下の記述は、\\n[ch text=&test]\\n[ch text=test]\\n[ch text=\\"&a + b\\"]\\n\\n以下のようにも書けます。&から&までを[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)文と解釈します。\\n&test&\\n&\'test\'&\\n&a + b&\\n\\nでは「&（半角）」を表示するには？（これらの文法のせいで普通に書けない）\\n[ch text=\\"&\'&\'\\"]として下さい。\\n\\nまた、[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)でのみ、背景styleなどを一塊とする。\\n\\n例）以下は表示が異なる\\n[span style=\'background-image: linear-gradient(70deg, tomato 0%, lightskyblue 100%); border-radius: 8px;\']SPAN[[span]](https://famibee.github.io/SKYNovel/tag.html#span)\\n[ch text=\'CH\' style=\'background-image: linear-gradient(70deg, tomato 0%, lightskyblue 100%); border-radius: 8px;\']"},"let_round":{"sum":"四捨五入  \\n四捨五入する","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"実数","comment":"四捨五入する数"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_round","txt":"let_round name=${1{{代入変数名}}} text=${2:四捨五入する数}"}],"detail":"### コード例\\n~~~skynovel\\n[let_round name=a text=3.45]\\n[trace text=&a] ; <- 3\\n~~~"},"clear_event":{"sum":"イベントを全消去  \\nイベント予約を全て削除する","param":[{"name":"global","required":"","def":"false","rangetype":"true、false","comment":"trueを指定すると全ての大域イベントを削除する。  \\nfalseの場合は大域以外の全てのイベントを削除する"}],"snippet":[{"nm":"clear_event","txt":"clear_event global=${1|false,true|}"}],"detail":""},"export":{"sum":"プレイデータをエクスポート  \\nプレイデータをファイルとしてエクスポートする\\n\\n保存ダイアログが表示され、選択したフォルダにプレイデータファイルが保存される。\\nプレイデータ拡張子、ウェブ版は.swpd、アプリ版は.spdで互換性はない。\\n暗号化するプロジェクトの場合、出力するプレイデータファイルも暗号化される。\\nブラウザならファイルをダウンロードする。\\n\\nエクスポート完了時には【sn:exported】というイベントを発火する。\\n【[event key=\'sn:exported\' 〜]】という記述でジャンプできる。\\n\\n機能ギャラリーにサンプルがあります。$(play)[プレイデータ](https://famibee.github.io/SKYNovel_gallery/?cur=import)","param":[],"snippet":[{"nm":"export","txt":"export"}],"detail":""},"wt":{"sum":"トランス終了待ち  \\n[trans]で開始したトランスの終了を待つ","param":[{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"trueでクリックキャンセル可能にする"},{"name":"global","required":"","def":"true","rangetype":"true、false","comment":"グローバルイベント待ちを有効にするか"}],"snippet":[{"nm":"wt","txt":"wt canskip=${1|true,false|}"}],"detail":"終了次第、スクリプト処理を次へ進める。\\n\\n$(warning)また[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)～[[wt]](https://famibee.github.io/SKYNovel/tag.html#wt)間で文字表示や[[ch]](https://famibee.github.io/SKYNovel/tag.html#ch)は動作未定義、非推奨。\\n[[trans]](https://famibee.github.io/SKYNovel/tag.html#trans)終了を待たず何かをするのは避けた方がよいでしょう。"},"record_place":{"sum":"セーブポイント指定  \\n本タグの位置を、スクリプト読み込み時に再開する位置として設定する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）","comment":"保存対象レイヤ名。しおりに状態を保存するレイヤ。Save/Load画面レイヤや設定画面レイヤなど、保存すべきでないレイヤを除いて指定すべき"},{"name":"reset_sound","required":"","def":"true","rangetype":"true、false","comment":"全てのサウンドを停止・再度再生開始するか"}],"snippet":[{"nm":"record_place","txt":"record_place"}],"detail":""},"waitclick":{"sum":"クリックを待つ  \\nシナリオファイルの順次処理を停止し、クリックやキー押下を待つ","param":[],"snippet":[{"nm":"waitclick","txt":"waitclick"}],"detail":""},"let_frame":{"sum":"フレーム変数を取得  \\nフレーム内の変数から、値を取得する","param":[{"name":"id","required":"y","def":"","rangetype":"フレーム名","comment":"[[add_fram]](https://famibee.github.io/SKYNovel/tag.html#add_fram)で定義したフレーム名"},{"name":"var_name","required":"y","def":"","rangetype":"文字列","comment":"フレーム内の変数/関数名"}],"snippet":[{"nm":"let_frame","txt":"let_frame id=${1{{フレーム名}}} var_name=${2:フレーム内の変数/関数名}"}],"detail":"関数名を指定した場合は関数を実行し、その戻り値を取得する。  \\n【const.sn.frm.（id名）.（var_name名）】に値がセットされる。\\n\\n### コード例\\n~~~skynovel\\n[add_frame id=config src=_config visible=false]\\n[event key=\'dom=config:#close\' label=*exit global=true]\\n\\n[let_frame id=config var_name=val_sldBackAlpha]\\n&sys:TextLayer.Back.Alpha = const.sn.frm.config.val_sldBackAlpha/100\\n[return]\\n\\n*val2ctrl\\n[set_frame id=config var_name=val_sldBackAlpha text=&sys:TextLayer.Back.Alpha*100]\\n[let_frame id=config var_name=val2ctrl function=true]\\n[return]\\n~~~\\n\\n機能ギャラリーにサンプルがあります。$(play)[HTMLフレーム](https://famibee.github.io/SKYNovel_gallery/?cur=frame)"},"add_filter":{"sum":"フィルター追加  \\nレイヤにフィルターを追加する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）"},{"name":"page","required":"","def":"fore","rangetype":"fore、back、both","comment":"ページの裏表（both指定で両面）"},{"name":"filter","required":"y","def":"","rangetype":"フィルター名","comment":"レイヤに指定するフィルタ。その他必要な属性は適宜指定する"},{"name":"enabled","required":"","def":"true","rangetype":"true、false","comment":"イベントを有効にするか"}],"snippet":[{"nm":"add_filter","txt":"add_filter layer=${1{{レイヤ名}}} page=${2|fore,back,both|} filter=${3{{フィルター名}}}"}],"detail":""},"autowc":{"sum":"文字ごとのウェイト  \\n特定の文字の直後に自動的にウェイトを入れる。\\ntextに指定した文字に対し、timeに指定した数値が対応する。\\n通常の文字表示速度にtimeの数値を掛け算する","param":[{"name":"enabled","required":"","def":"現在値","rangetype":"true、false","comment":"自動ウェイトを有効にするか。初期値false"},{"name":"text","required":"両方同時に指定、或いは省略","def":"現在値","rangetype":"一文字（カンマ区切りで複数可）","comment":"ウェイトを指定する文字の集まり"},{"name":"time","required":"両方同時に指定、或いは省略","def":"現在値","rangetype":"0〜（カンマ区切りで複数可）","comment":"文字表示ウェイト倍数"}],"snippet":[{"nm":"autowc","txt":"autowc enabled=${1|true,false|} text=${2:\'、。\'} time=${3:\'50,100\'}"}],"detail":"以下のように指定する。\\n\\n### コード例\\n~~~skynovel\\n[autowc enabled=true text=\\"４５６\\" time=\\"50,100,150\\"]\\n[autowc enabled=true text=\\"４５６\\" time=\\"100,100,100\\"]\\n[autowc enabled=false]\\n~~~\\n\\n　以下はエラーとなる。\\n### コード例\\n~~~skynovel\\n;x [autowc enabled=true text=\\"４５６\\" time=\\"100,100\\"]\\n;x [autowc enabled=true text=\\"４５６\\" time=\\"100,100,100,100\\"]\\n;x [autowc enabled=true text=\\"４５６\\"]\\n;x [autowc enabled=true time=\\"100,100,100\\"]\\n;x [autowc enabled=true]\\n;x [autowc enabled=true text=\\"\\" time=\\"\\"]\\n;x [autowc text=\\"\\" time=\\"\\"]\\n~~~"},"wait":{"sum":"ウェイトを入れる  \\n指定時間スクリプト処理を待ち、再開する\\n[event]などでイベントが登録されていても、イベント発生待ちを行わない","param":[{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"処理を待つ時間"},{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"クリックなど（→詳細は[[waitclick]](https://famibee.github.io/SKYNovel/tag.html#waitclick)）でウエイトをキャンセルできるか"}],"snippet":[{"nm":"wait","txt":"wait time=${1:処理を待つ時間}"}],"detail":""},"let_substr":{"sum":"文字列から抜きだし  \\n文字列の一部を取り出す","param":[{"name":"name","required":"y","def":"","rangetype":"代入変数名","comment":"代入する変数"},{"name":"text","required":"y","def":"","rangetype":"文字列","comment":"元になる文字列"},{"name":"pos","required":"","def":"0","rangetype":"整数","comment":"何番目の文字から取り出すか。負の値なら「後ろから何個目か」。0（先頭）が先頭、-1が最後の文字。【pos=-3 len=all】とすると、後ろから３文字を取り出す"},{"name":"len","required":"","def":"1","rangetype":"文字数またはall","comment":"何文字取り出すか。all でpos以降の全て"},{"name":"cast","required":"","def":"出来るだけ数値変換","rangetype":"num、int、uint、bool、str","comment":"値をセットする際の型。（詳細は[[let]](https://famibee.github.io/SKYNovel/tag.html#let)を参照）"}],"snippet":[{"nm":"let_substr","txt":"let_substr name=${1{{代入変数名}}} text=${2:元になる文字列} pos=${3:取り出す位置} len=${4:文字数またはall}"}],"detail":"### コード例\\n~~~skynovel\\n&a=\'abcde\'\\n[let_substr name=a text=&a pos=2 len=3]\\n[trace text=&a] ; -> \'cde\'\\n[let_substr name=a text=&a pos=1 len=all]\\n[trace text=&a] ; -> \'de\'\\n~~~"},"quake":{"sum":"画面を揺らす  \\n画面全体を揺らす","param":[{"name":"time","required":"y","def":"","rangetype":"0〜；ミリ秒","comment":"揺らす時間"},{"name":"hmax","required":"","def":"10","rangetype":"0〜","comment":"横方向の最大揺らし幅。幅はランダム値を取る"},{"name":"vmax","required":"","def":"10","rangetype":"0〜","comment":"縦方向の最大揺らし幅。幅はランダム値を取る"},{"name":"delay","required":"","def":"0","rangetype":"0〜；ミリ秒","comment":"トゥイーンを始める前の、何もしない待ち時間- "},{"name":"repeat","required":"","def":"1","rangetype":"0〜；繰返し回数","comment":"0か負の値 で無限ループ。1を設定すると「繰り返しなし」、2を設定すると「二回同じ動き」を行なう"},{"name":"ease","required":"","def":"Linear.None","rangetype":"イージング名","comment":"揺れのイージング（値の変化の仕方）を指定する。[イージングの変化はこちらの図](https://createjs.com/demos/tweenjs/tween_sparktable)（または[こちら](https://sole.github.io/tween.js/examples/03_graphs.html)）が分かりやすい。指定できる値は[[tsy]](https://famibee.github.io/SKYNovel/tag.html#tsy)を参照"},{"name":"yoyo","required":"","def":"false","rangetype":"true、false","comment":"（暫定）ヨーヨーのように逆方向に戻って繰り返す"}],"snippet":[{"nm":"quake","txt":"quake time=${1:500} hmax=${2:10} vmax=${3:10}][wq"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[文字出現演出](https://famibee.github.io/SKYNovel_gallery/?cur=tag_quake)"},"loadplugin":{"sum":"プラグインの読み込み  \\nプラグインとして読み込む","param":[{"name":"fn","required":"y","def":"","rangetype":"CSSファイルURL","comment":"読み込むプラグインのファイル名（拡張子はcssのみ、Webフォント用）"},{"name":"join","required":"","def":"true","rangetype":"true、false","comment":"trueで読み込みを待って次のタグへ進む"}],"snippet":[{"nm":"loadplugin","txt":"loadplugin fn=${1:WebフォントのCSSファイルURL} join=${2|true,false|}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[フォント利用](https://famibee.github.io/SKYNovel_gallery/?cur=font)"},"graph":{"sum":"インライン画像表示  \\n文字レイヤに画像を文字として表示する。ルビは同時に設定する","param":[{"name":"layer","required":"","def":"デフォルト文字レイヤ","rangetype":"文字レイヤ名","comment":"文字を表示するレイヤ"},{"name":"page","required":"","def":"fore","rangetype":"fore、back","comment":"ページの裏表"},{"name":"pic","required":"y","def":"","rangetype":"画像ファイル名","comment":"表示する画像やアニメpng"},{"name":"r","required":"","def":"ルビ無し","rangetype":"ルビ文字列","comment":"ただしあまりに他の文字サイズと大きく異なる場合は正しい位置に表示されない"},{"name":"width","required":"","def":"画像の横サイズ（※）","rangetype":"1〜；横幅","comment":"表示する画像の横ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"height","required":"","def":"画像の縦サイズ（※）","rangetype":"1〜；縦幅","comment":"保存する画像の縦ドットサイズ。  \\n元のサイズと異なる場合は拡大・縮小される"},{"name":"wait","required":"","def":"現在の文字表示速度","rangetype":"0〜；ミリ秒","comment":"一時的な文字表示速度。0で瞬時"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグによる表示のみに適用、以降は元に戻る"}],"snippet":[{"nm":"graph","txt":"graph pic=${1{{画像ファイル名}}}"}],"detail":"フォントにない外字やアニメpng画像表示に使える。\\n※省略時は画像サイズになるが、ロード完了直後に文字配置を決めるのでちらつく。それを嫌う際に指定する\\n※特にモバイルなどでゲーム画面が自動で拡大縮小される場合、省略したらその時の本文文字サイズとして扱われる。なるべくサイズ指定を推奨。"},"wq":{"sum":"画面揺らし終了待ち  \\n画面揺らしの終了を待ち、再開する。\\n[event]などでイベントが登録されていても、イベント発生待ちを行わない","param":[{"name":"canskip","required":"","def":"true","rangetype":"true、false","comment":"trueでクリックキャンセル可能にする"}],"snippet":[{"nm":"wq","txt":"wq canskip=${1|true,false|}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[文字出現演出](https://famibee.github.io/SKYNovel_gallery/?cur=tag_quake)"},"bracket2macro":{"sum":"括弧マクロの定義  \\n属性textを持つマクロやタグを、任意の二つの文字を括弧とし、括弧で囲った記述で代用できるよう","param":[{"name":"text","required":"y","def":"","rangetype":"括弧にする始点終点の二文字","comment":"マクロに出来るのは英文字、空白、;、[、]、、=、&、｜、《、》以外のみ。  \\n正規表現で言えば　/[\\\\w\\\\s;[]=&｜《》]/　以外。  \\n一文字マクロや定義済みの括弧文字は使用できない"},{"name":"name","required":"y","def":"","rangetype":"マクロ名","comment":"半角文字に割り当てるマクロ名を指定。  \\n組み込みタグか、[[macro]](https://famibee.github.io/SKYNovel/tag.html#macro)による定義済みマクロ名で無ければならない。  \\n組み込みタグやマクロは属性textだけを指定しても問題なく動作し、 それを処理すること。渡される属性textは空文字の場合もある"}],"snippet":[{"nm":"bracket2macro","txt":"bracket2macro text=${1:【】} name=${2{{マクロ名}}}"}],"detail":"※適用範囲について\\n本タグより前にロードされたスクリプトファイルには適用されません。\\nまたスクリプトファイルに本タグが記述された場合、本タグより前に出現した半角文字にも適用されません\\n\\n機能ギャラリーにサンプルがあります。$(play)[履歴と機能追加](https://famibee.github.io/SKYNovel_gallery/?cur=log_and_play)"},"rec_ch":{"sum":"履歴書き込み  \\n履歴に文字や付加情報を出力する","param":[{"name":"text","required":"","def":"現在値","rangetype":"表示したい文字列","comment":"ルビ文法（《》）も使用可能、[[r]](https://famibee.github.io/SKYNovel/tag.html#r)で改行"},{"name":"style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"文字の CSS Style を指定する。  \\nこのタグによる履歴表示のみに適用、以降は元に戻る"},{"name":"r_style","required":"","def":"なにもしない","rangetype":"CSS style","comment":"ルビの CSS Style を指定する。  \\nこのタグによる履歴表示のみに適用、以降は元に戻る  \\n※背景styleなどを一塊とする。"}],"snippet":[{"nm":"rec_ch","txt":"rec_ch text=${1:表示したい文字列}"}],"detail":"「現在のページ」のテキストに文字を追加する。\\n「現在のページ」に対する、任意の属性も自由に追加できる。その属性はconst.sn.log.jsonにも含まれ、フレームに渡しJavaScriptなどで（JSON.parse()して）利用できる。\\n文字列内では[[r]](https://famibee.github.io/SKYNovel/tag.html#r)で改行できる"},"dump_lay":{"sum":"レイヤのダンプ  \\nレイヤの内容をデバッグ表示する","param":[{"name":"layer","required":"","def":"全てのレイヤ","rangetype":"レイヤ名（カンマ区切りで複数可）","comment":"デバッグ表示するレイヤ名"}],"snippet":[{"nm":"dump_lay","txt":"dump_lay layer=${1{{レイヤ名}}}"}],"detail":"機能ギャラリーにサンプルがあります。$(play)[デバッグ機能](https://famibee.github.io/SKYNovel_gallery/?cur=debug)"}}');

/***/ }),

/***/ "./src/types.ts":
/*!**********************!*\
  !*** ./src/types.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DEF_CFG: () => (/* binding */ DEF_CFG),
/* harmony export */   DEF_CFG4TST: () => (/* binding */ DEF_CFG4TST),
/* harmony export */   DEF_TEMP: () => (/* binding */ DEF_TEMP),
/* harmony export */   DEF_TEMP4TST: () => (/* binding */ DEF_TEMP4TST),
/* harmony export */   DEF_WSS: () => (/* binding */ DEF_WSS),
/* harmony export */   H_FONTJSON_nm_DEF_FONT: () => (/* binding */ H_FONTJSON_nm_DEF_FONT),
/* harmony export */   REG_SN2TEMP: () => (/* binding */ REG_SN2TEMP),
/* harmony export */   creBJ_OPTPIC: () => (/* binding */ creBJ_OPTPIC),
/* harmony export */   creBJ_OPTPIC4TST: () => (/* binding */ creBJ_OPTPIC4TST),
/* harmony export */   creOPTSND: () => (/* binding */ creOPTSND),
/* harmony export */   creOPTSND4TST: () => (/* binding */ creOPTSND4TST)
/* harmony export */ });
const DEF_WSS = {
    'cnv.font.subset': false,
    'cnv.icon.shape': 0,
    'cnv.mat.pic': false,
    'cnv.mat.webp_quality': 90,
    'cnv.mat.snd': false,
    'cnv.mat.snd.codec': 'opus',
};
const DEF_CFG = {
    book: {
        title: '',
        creator: '',
        cre_url: '',
        publisher: '',
        pub_url: '',
        detail: '',
        version: '1.0',
    },
    save_ns: '',
    window: {
        width: 300,
        height: 300,
    },
    log: { max_len: 1024 },
    init: {
        bg_color: '#000000',
        tagch_msecwait: 10,
        auto_msecpagewait: 3500,
        escape: '',
    },
    debug: {
        devtool: false,
        dumpHtm: false,
        token: false,
        tag: false,
        putCh: false,
        debugLog: false,
        baseTx: false,
        masume: false,
        variable: false,
    },
    code: {},
    debuger_token: '',
};
const DEF_CFG4TST = {
    book: {
        title: '(作品タイトル)',
        creator: '(著作者)',
        cre_url: 'ugainovel@gmail.com',
        publisher: '(出版者)',
        pub_url: 'https://ugainovel.blog.fc2.com/',
        detail: '(内容紹介)',
        version: '1.2.3',
    },
    save_ns: 'tst_save_ns',
    window: {
        width: 800,
        height: 600,
    },
    log: { max_len: 1024 },
    init: {
        bg_color: '#008800',
        tagch_msecwait: 10,
        auto_msecpagewait: 3500,
        escape: '\\',
    },
    debug: {
        devtool: false,
        dumpHtm: false,
        token: false,
        tag: false,
        putCh: false,
        debugLog: false,
        baseTx: false,
        masume: false,
        variable: false,
    },
    code: { script: true, dummy: false },
    debuger_token: '',
};
const H_FONTJSON_nm_DEF_FONT = ':DEF_FONT:';
function creBJ_OPTPIC() {
    return {
        order: {
            quality: 0,
            FLD_PRJ_BASE: '',
        },
        aOrder: [],
        sum: {
            baseSize: 0,
            webpSize: 0,
            pathPicCmpWebP: '',
            pathPicCmpBase: '',
        },
        hSize: {},
    };
}
function creBJ_OPTPIC4TST() {
    return {
        order: {
            quality: 0,
            FLD_PRJ_BASE: '',
        },
        aOrder: [],
        sum: {
            baseSize: 4510000,
            webpSize: 1550000,
            pathPicCmpWebP: '../',
            pathPicCmpBase: '../',
        },
        hSize: {
            'title_base': { baseSize: 6000, webpSize: 1000, fld_nm: 'test/title_base', ext: 'jpg' },
            'breakpage_b': { baseSize: 6002, webpSize: 3000, fld_nm: 'test/breakpage_b', ext: 'png', webp_q: 45, },
            'breakline.5x20': { baseSize: 6001, webpSize: 2000, fld_nm: 'test/breakline.5x20', ext: 'png' },
        },
    };
}
function creOPTSND() {
    return {
        sum: {
            baseSize: 0,
            optSize: 0,
            pathSndOpt: '',
            pathSndBase: '',
        },
        hSize: {},
    };
}
function creOPTSND4TST() {
    return {
        sum: {
            baseSize: 4510001,
            optSize: 1550001,
            pathSndOpt: '../',
            pathSndBase: '../',
        },
        hSize: {
            'free0509': { baseSize: 4000, optSize: 1010, fld_nm: 'test/free0509', ext: 'wav' },
            'bow': { baseSize: 4002, optSize: 3010, fld_nm: 'test/bow', ext: 'mp4', },
            'wood04': { baseSize: 4001, optSize: 2010, fld_nm: 'test/wood04', ext: 'wav' },
        },
    };
}
const REG_SN2TEMP = /;[^\n]*|(?:&(\S+)|\[let\s+name\s*=\s*(\S+)\s+text)\s*=\s*((["'#]).+?\4|[^;\s]+)(?:[^;\n]*;(.*))?/g;
const DEF_TEMP = [];
const DEF_TEMP4TST = [
    { id: '/setting.sn:sys:TextLayer.Back.Alpha', nm: 'sys:TextLayer.Back.Alpha', lbl: 'メッセージ背景不透明度', type: 'rng', val: '0.7', num: 0.7, max: 1, min: 0, step: 0.05, },
    { id: '/setting.sn:sysse_ok1', nm: 'sysse_ok1', lbl: '軽い決定音', type: 'txt', val: 'BurstB_11' },
    { id: '/setting.sn:sysse_ok2', nm: 'sysse_ok2', lbl: '重い決定音', type: 'txt', val: 'BellA_16' },
    { id: '/setting.sn:sysse_ok2_long', nm: 'sysse_ok2_long', lbl: 'もっと重い決定音', type: 'txt', val: 'BellB_11' },
    { id: '/setting.sn:sysse_cancel', nm: 'sysse_cancel', lbl: 'キャンセル音', type: 'txt', val: 'bell05' },
    { id: '/setting.sn:sysse_choice', nm: 'sysse_choice', lbl: 'マウスオーバー・選択音', type: 'txt', val: 'wood04' },
    { id: '/setting.sn:useSysMenu', nm: 'useSysMenu', lbl: 'メッセージにシステムボタンを配置するか', type: 'chk', val: 'false', bol: false },
    { id: '/setting.sn:def_fonts', nm: 'def_fonts', lbl: 'デフォルトフォント', type: 'txt', val: 'ipamjm, QuiMi_mincho' },
    { id: '/setting.sn:autoResume', nm: 'autoResume', lbl: '（開発用ブラウザ版で）自動レジュームするか', type: 'chk', val: 'true', bol: true },
];


/***/ })

};
;