const[,,O="",W,l="",m=""]=process.argv;import j from"sharp";j.cache(!1);import{resolve as c,parse as z,basename as B}from"node:path";import{styleText as T}from"node:util";import{existsSync as _,statSync as v,readdirSync as C,readFileSync as q,writeFileSync as D}from"node:fs";import{ensureDir as h,move as x,readJsonSync as U,remove as X,writeJsonSync as V}from"fs-extra/esm";import{fileURLToPath as A}from"node:url";const H=A(import.meta.url),Q=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function p(t,o,f){for(const a of C(t,{withFileTypes:!0})){const e=String(a.name).normalize("NFC");if(Q.test(e))continue;if(a.isDirectory()){f(e);continue}const s=c(t,e);o(s,e)}}function w(t,o,f,a=!0,e=t){try{if(!_(t)){console.error(`No change, No replace src:${t}`);return}const s=q(t,{encoding:"utf8"}),i=String(s.replace(o,f));s!==i?D(e,i):a&&console.log(T("magentaBright",`replaceFile fail by same:${t}`))}catch(s){console.error(`replaceFile src:${t} ${s}`)}}function Y(t,o,f=!0){if(_(t)||console.error(`chkUpdate err path1=${t}=`),!_(o))return f;const a=v(t,{bigint:!0}),e=v(o,{bigint:!0});return a.mtimeMs>e.mtimeMs}const y=/\.(jpe?g|png)$/,G=/\.(htm|html)$/,k=/\w+\/\*WEBP\*\//g,F=/\.json$/,J=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,L='$1$2.webp","image_bkup":"$2.$3"',K=/webp","image_bkup":".+(jpe?g|png)"/,Z='$1"',I=H+"on";let n={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const $=()=>{if(!_(I))return;const t={...n};n=U(I,{encoding:"utf8"}),t.sum={...n.sum};for(const o in n.hSize){const{fld_nm:f,ext:a,baseSize:e,webpSize:s}=n.hSize[o],i=f+"."+a;_(c(l,i))||_(c(m,i))?t.hSize[o]=n.hSize[o]:(t.sum.baseSize-=e,t.sum.webpSize-=s)}n=t},ee=(t=-1)=>{const o=Object.entries(n.hSize);o.sort((f,a)=>{const e=f[0],s=a[0];return e<s?-1:e>s?1:0}),n.hSize=Object.fromEntries(o),V(I,n,{encoding:"utf8"}),t>-1&&process.exit(t)};import te from"p-queue";const u=new te({concurrency:50,autoStart:!1});let N=0;const E=async()=>{N=u.size,console.log(T(["bgGreen","black"],`fn:cnv_mat_pic.ts start: ${N} tasks`)),u.start(),await u.onIdle(),ee(0)};let g=()=>{const t=u.size;if(!(t%50>0)){if(t===0){g=()=>{};return}console.log(T(["bgGreen","black"],`fn:cnv_mat_pic.ts ${t}/${N} tasks`))}};function P(t,o,f=!0){u.add(async()=>{f&&await x(t,o,{overwrite:!0});const{dir:a,name:e}=z(t),{dir:s,ext:i}=z(o),r=s+"/"+e+".webp",b=n.hSize[e]??={fld_nm:B(a)+"/"+e,baseSize:0,webpSize:0,ext:""};try{const S=await j(o).webp({quality:Number(b.webp_q??W)}).toFile(r);await x(r,a+"/"+e+".webp",{overwrite:!0});const d=v(o).size,R=S.size;n.hSize[e]={...b,baseSize:d,webpSize:R,ext:i.slice(1)},n.sum.baseSize+=d,n.sum.webpSize+=R,g()}catch(S){console.log(T(["bgRed","white"],"  [ERR] %o"),S)}})}switch(O){case"enable":h(m),p(l,()=>{},e=>{const s=c(m,e);h(s),p(c(l,e),(i,r)=>{if(y.test(r)){P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,k,"true/*WEBP*/",!1),g()});return}F.test(r)&&u.add(()=>{w(i,J,L),g()})},()=>{})}),E();break;case"disable":p(m,()=>{},e=>{p(c(m,e),(s,i)=>{if(!y.test(i))return;const r=c(l,e,i);u.add(async()=>{await x(s,r,{overwrite:!0}),g()});const{name:b}=z(i),S=c(l,e,b+".webp");u.add(async()=>{await X(S),g()})},()=>{})}),p(l,()=>{},e=>{p(c(l,e),(s,i)=>{if(G.test(i)){k.lastIndex=0,u.add(()=>{w(s,k,"false/*WEBP*/",!1),g()});return}F.test(i)&&u.add(()=>{w(s,K,Z),g()})},()=>{})}),E();break;case"reconv":$(),n.sum.baseSize=n.sum.webpSize=0;for(const{ext:e,fld_nm:s}of Object.values(n.hSize))P(c(l,s+"."+e),c(m,s+"."+e),!1);E();break;case"prj_scan":$(),h(m),p(l,()=>{},e=>{const s=c(m,e);h(s),p(c(l,e),(i,r)=>{if(y.test(r)){const b=z(r).name;if(b in n.hSize){const{baseSize:S=0,webpSize:d=0}=n.hSize[b];n.sum.baseSize-=S,n.sum.webpSize-=d}P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,k,"true/*WEBP*/",!1),g()});return}F.test(r)&&u.add(()=>{w(i,J,L),g()})},()=>{})}),E();break;case"base_scan":$(),p(m,()=>{},e=>{const s=c(m,e);h(s);const i=c(l,e);p(s,(r,b)=>{if(!y.test(r))return;const S=c(i,b.replace(y,".webp"));if(!Y(r,S))return;const d=z(b).name;if(d in n.hSize){const{baseSize:R=0,webpSize:M=0}=n.hSize[d];n.sum.baseSize-=R,n.sum.webpSize-=M}P(S,r,!1)},()=>{})}),E();break;default:$();const{dir:t,name:o,ext:f}=z(O),a={...n.hSize[o],fld_nm:B(t)+"/"+o,ext:f.slice(1)};n.sum.baseSize-=a.baseSize,n.sum.webpSize-=a.webpSize,P(O,l,!!m),E();break}export{Y as chkUpdate};
