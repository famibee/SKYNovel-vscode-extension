const[,,$="",W,m="",S=""]=process.argv;import j from"sharp";j.cache(!1);import{resolve as c,parse as d,basename as B}from"node:path";import{styleText as O}from"node:util";import{existsSync as g,statSync as v,readdirSync as C,readFileSync as q,writeFileSync as D}from"fs";import{ensureDir as h,move as x,readJsonSync as U,remove as X,writeJsonSync as V}from"fs-extra/esm";import{fileURLToPath as A}from"node:url";const H=A(import.meta.url),Q=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function l(t,o,f){for(const a of C(t,{withFileTypes:!0})){const e=String(a.name).normalize("NFC");if(Q.test(e))continue;if(a.isDirectory()){f(e);continue}const s=c(t,e);o(s,e)}}function w(t,o,f,a=!0,e=t){try{if(!g(t)){console.error(`No change, No replace src:${t}`);return}const s=q(t,{encoding:"utf8"}),i=String(s.replace(o,f));s!==i?D(e,i):a&&console.log(O("magentaBright",`replaceFile fail by same:${t}`))}catch(s){console.error(`replaceFile src:${t} ${s}`)}}function Y(t,o,f=!0){if(g(t)||console.error(`chkUpdate err path1=${t}=`),!g(o))return f;const a=v(t,{bigint:!0}),e=v(o,{bigint:!0});return a.mtimeMs>e.mtimeMs}const y=/\.(jpe?g|png)$/,G=/\.(htm|html)$/,T=/\w+\/\*WEBP\*\//g,F=/\.json$/,J=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,L='$1$2.webp","image_bkup":"$2.$3"',K=/webp","image_bkup":".+(jpe?g|png)"/,Z='$1"',I=H+"on";let n={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const k=()=>{if(!g(I))return;const t={...n};n=U(I,{encoding:"utf8"}),t.sum={...n.sum};for(const o in n.hSize){const{fld_nm:f,ext:a,baseSize:e,webpSize:s}=n.hSize[o],i=f+"."+a;g(c(m,i))||g(c(S,i))?t.hSize[o]=n.hSize[o]:(t.sum.baseSize-=e,t.sum.webpSize-=s)}n=t},ee=(t=-1)=>{const o=Object.entries(n.hSize);o.sort((f,a)=>{const e=f[0],s=a[0];return e<s?-1:e>s?1:0}),n.hSize=Object.fromEntries(o),V(I,n,{encoding:"utf8"}),t>-1&&process.exit(t)};import te from"p-queue";const u=new te({concurrency:50,autoStart:!1});let N=0;const E=async()=>{N=u.size,console.log(O(["bgGreen","black"],`fn:cnv_mat_pic.ts start: ${N} tasks`)),u.start(),await u.onIdle(),ee(0)};let p=()=>{const t=u.size;if(!(t%50>0)){if(t===0){p=()=>{};return}console.log(O(["bgGreen","black"],`fn:cnv_mat_pic.ts ${t}/${N} tasks`))}};function P(t,o,f=!0){u.add(async()=>{f&&await x(t,o,{overwrite:!0});const{dir:a,name:e}=d(t),{dir:s,ext:i}=d(o),r=s+"/"+e+".webp",b=n.hSize[e]??={fld_nm:B(a)+"/"+e,baseSize:0,webpSize:0,ext:""},z=await j(o).webp({quality:Number(b.webp_q??W)}).toFile(r);await x(r,a+"/"+e+".webp",{overwrite:!0});const _=v(o).size,R=z.size;n.hSize[e]={...b,baseSize:_,webpSize:R,ext:i.slice(1)},n.sum.baseSize+=_,n.sum.webpSize+=R,p()})}switch($){case"enable":h(S),l(m,()=>{},e=>{const s=c(S,e);h(s),l(c(m,e),(i,r)=>{if(y.test(r)){P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,T,"true/*WEBP*/",!1),p()});return}F.test(r)&&u.add(()=>{w(i,J,L),p()})},()=>{})}),E();break;case"disable":l(S,()=>{},e=>{l(c(S,e),(s,i)=>{if(!y.test(i))return;const r=c(m,e,i);u.add(async()=>{await x(s,r,{overwrite:!0}),p()});const{name:b}=d(i),z=c(m,e,b+".webp");u.add(async()=>{await X(z),p()})},()=>{})}),l(m,()=>{},e=>{l(c(m,e),(s,i)=>{if(G.test(i)){T.lastIndex=0,u.add(()=>{w(s,T,"false/*WEBP*/",!1),p()});return}F.test(i)&&u.add(()=>{w(s,K,Z),p()})},()=>{})}),E();break;case"reconv":k(),n.sum.baseSize=n.sum.webpSize=0;for(const{ext:e,fld_nm:s}of Object.values(n.hSize))P(c(m,s+"."+e),c(S,s+"."+e),!1);E();break;case"prj_scan":k(),h(S),l(m,()=>{},e=>{const s=c(S,e);h(s),l(c(m,e),(i,r)=>{if(y.test(r)){const b=d(r).name;if(b in n.hSize){const{baseSize:z=0,webpSize:_=0}=n.hSize[b];n.sum.baseSize-=z,n.sum.webpSize-=_}P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,T,"true/*WEBP*/",!1),p()});return}F.test(r)&&u.add(()=>{w(i,J,L),p()})},()=>{})}),E();break;case"base_scan":k(),l(S,()=>{},e=>{const s=c(S,e);h(s);const i=c(m,e);l(s,(r,b)=>{if(!y.test(r))return;const z=c(i,b.replace(y,".webp"));if(!Y(r,z))return;const _=d(b).name;if(_ in n.hSize){const{baseSize:R=0,webpSize:M=0}=n.hSize[_];n.sum.baseSize-=R,n.sum.webpSize-=M}P(z,r,!1)},()=>{})}),E();break;default:k();const{dir:t,name:o,ext:f}=d($),a={...n.hSize[o],fld_nm:B(t)+"/"+o,ext:f.slice(1)};n.sum.baseSize-=a.baseSize,n.sum.webpSize-=a.webpSize,P($,m,!!S),E();break}export{Y as chkUpdate};
