var s=require("path"),t=require("fs-extra");const[,,g,T,p,m=""]=process.argv,F=require("sharp"),N=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function u(e,n,i){for(const o of(0,t.readdirSync)(e,{withFileTypes:!0})){const r=String(o.name).normalize("NFC");if(N.test(r))continue;if(o.isDirectory()){i(r);continue}const l=(0,s.resolve)(e,r);n(l,r)}}function _(e,n,i,o=!0,r=e){try{if(!(0,t.existsSync)(e)){console.error(`replaceFile no exists src:${e}`);return}const l=(0,t.readFileSync)(e,{encoding:"utf8"}),S=String(l.replace(n,i));l!==S?(0,t.writeFileSync)(r,S):o&&console.error(`replaceFile fail by same:${e}`)}catch(l){console.error(`replaceFile src:${e} ${l}`)}}const d=/\.(jpe?g|png)$/,R=/\.(htm|html)$/,E=/\w+\/\*WEBP\*\//g,v=/\.json$/,O=/("image":")([^.]+\.\d+x\d+).*\.(jpe?g|png)"/,$='$1$2.webp","image_bkup":"$2.$3"',G=/webp","image_bkup":".+(jpe?g|png)"/,I='$1"',f=__filename+"on";let c={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const b=(e=-1)=>{(0,t.writeJsonSync)(f,c,{encoding:"utf8"}),e>-1&&process.exit(e)},a=[];function w(e,n,i=""){a.push(async()=>{i!=="no_move"&&await(0,t.move)(e,n,{overwrite:!0});const{dir:o,name:r,ext:l}=(0,s.parse)(e),{dir:S}=(0,s.parse)(n),P=S+"/"+r+".webp",h=c.hSize[r]??={fld_nm:(0,s.basename)(o)+"/"+r,baseSize:0,webpSize:0,ext:""},x=await F(n).webp({quality:Number(h.webp_q??T)}).toFile(P);await(0,t.move)(P,o+"/"+r+".webp",{overwrite:!0});const z=(0,t.statSync)(n).size,y=x.size;c.hSize[r]={...h,baseSize:z,webpSize:y,ext:l.slice(1)},c.sum.baseSize+=z,c.sum.webpSize+=y})}switch(g){case"restore":u(m,()=>{},e=>{u((0,s.resolve)(m,e),(n,i)=>{if(!d.test(i))return;const o=(0,s.resolve)(p,e,i);a.push(()=>(0,t.move)(n,o,{overwrite:!0}));const{name:r}=(0,s.parse)(i),l=(0,s.resolve)(p,e,r+".webp");a.push(()=>(0,t.remove)(l))},()=>{})}),u(p,()=>{},e=>{u((0,s.resolve)(p,e),(n,i)=>{if(R.test(i)){E.lastIndex=0,a.push(async()=>_(n,E,"false/*WEBP*/"));return}v.test(i)&&a.push(async()=>_(n,G,I))},()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>b(0));break;case"all_no_move":(0,t.existsSync)(f)&&(c=(0,t.readJsonSync)(f,{encoding:"utf8"}),c.sum.baseSize=c.sum.webpSize=0);for(const e of Object.values(c.hSize)){const n="."+e.ext;!d.test(n)||w((0,s.resolve)(p,e.fld_nm+n),(0,s.resolve)(m,e.fld_nm+n),"no_move")}Promise.allSettled(a.map(e=>e())).then(()=>b(0));break;case"all":(0,t.ensureDir)(m),u(p,()=>{},e=>{const n=(0,s.resolve)(m,e);(0,t.ensureDir)(n),u((0,s.resolve)(p,e),(i,o)=>{if(d.test(o)){w(i,(0,s.resolve)(n,o));return}R.test(o)&&a.push(async()=>_(i,E,"true/*WEBP*/")),v.test(o)&&a.push(async()=>_(i,O,$))},()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>b(0));break;default:{(0,t.existsSync)(f)&&(c=(0,t.readJsonSync)(f,{encoding:"utf8"}));const{dir:e,name:n,ext:i}=(0,s.parse)(g),o={...c.hSize[n],fld_nm:(0,s.basename)(e)+"/"+n,ext:i.slice(1)};c.sum.baseSize-=o.baseSize,c.sum.webpSize-=o.webpSize,w(g,p,m),Promise.allSettled(a.map(r=>r())).then(()=>b(0))}break}
