import w from"sharp";w.cache(!1);import{fileURLToPath as z}from"node:url";import{parse as b,basename as x}from"node:path";import{styleText as S}from"node:util";import{statSync as I}from"node:fs";import{move as O,readJson as R,writeJsonSync as C}from"fs-extra/esm";const E=z(import.meta.url),_=E+"on",d=process.cwd();function c(e,i=0){console.log(i===0?S(["bgGreen","black"],"  [OK] %o"):S(["bgRed","white"],"  [ERR] %o"),e),process.exit(i)}R(_,{encoding:"utf8"}).then(async e=>{try{let o=function(n,s=0){C(_,e,{encoding:"utf8"}),c(n,s)};var i=o;const{quality:P,FLD_PRJ_BASE:u}=e.order;await Promise.allSettled(e.aOrder.map(async({pathPrj:n,pathBase:s})=>{const T=d+"/doc/prj/"+n,r=d+"/"+u+s,{dir:a,name:t}=b(T),{dir:g,ext:h}=b(r),m=g+"/"+t+".webp",p=e.hSize[t]??={fld_nm:x(a)+"/"+t,baseSize:0,webpSize:0,ext:""},y=await w(r).webp({quality:p.webp_q??P}).toFile(m),f=I(r).size,l=y.size;e.hSize[t]={...p,baseSize:f,webpSize:l,ext:h.slice(1)},e.sum.baseSize+=f,e.sum.webpSize+=l,await O(m,a+"/"+t+".webp",{overwrite:!0})})),o("\u7D42\u4E86\u3057\u307E\u3057\u305F")}catch(o){c(String(o),20)}}).catch(e=>{c(String(e),10)});
