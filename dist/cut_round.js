import g from"sharp";g.cache(!1);import{BICUBIC2 as _,BILINEAR as y,createICNS as $,createICO as I}from"png2icons";import{fileURLToPath as S}from"node:url";import{styleText as w}from"node:util";import{existsSync as k}from"node:fs";import{readFile as x,writeFile as u}from"node:fs/promises";import{copy as B,mkdirs as R,readJson as v,writeJsonSync as C}from"fs-extra/esm";const P=S(import.meta.url),b=P+"on",n=process.cwd()+"/";function m(i,s=0){console.log(s===0?w(["bgGreen","black"],"  [OK] %o"):w(["bgRed","white"],"  [ERR] %o"),i),process.exit(s)}v(b,{encoding:"utf8"}).then(async i=>{try{let r=function(c,o=0){C(b,i,{encoding:"utf8"}),m(c,o)};var s=r;const{order:e}=i,d=g((e.is_src_pp?n:"")+e.wp_src),{width:a,height:f}=await d.metadata();if(!a||!f)throw"\u753B\u50CF\u306E\u30B5\u30A4\u30BA\u304C\u4E0D\u660E\u3067\u3059";const t=1024;if(a<t||f<t)throw`\u5143\u753B\u50CF\u306E\u30B5\u30A4\u30BA\u306F ${t} x ${t} \u4EE5\u4E0A\u306B\u3057\u3066\u4E0B\u3055\u3044\u3002\uFF08width:${a} height:${f}\uFF09`;const p=d.png().resize({width:t,height:t,fit:"cover",background:{r:0,g:0,b:0,alpha:0}});switch(Number(e.shape)){case 1:p.composite([{input:Buffer.from(`<svg><circle cx="${t/2}" cy="${t/2}" r="${t/2}"/></svg>`),blend:"dest-in"}]);break;case 2:p.composite([{input:Buffer.from(`<svg><rect width="${t}" height="${t}" rx="${t/4.5}" ry="${t/4.5}"/></svg>`),blend:"dest-in"}]);break}await p.toFile(n+e.wp_dest);const h=n+"build/icon.png";if(!k(h))throw"\u751F\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F";const l=await x(h);await R(n+"build/icon/"),await Promise.allSettled([(async()=>{const c=n+"build/icon/icon.icns",o=$(l,y,0);o&&await u(c,o)})(),(async()=>{const c=n+"build/icon/icon.ico",o=I(l,_,0,!1,!0);o&&await u(c,o)})(),B(h,n+`doc/${e.is_new_tmp?"":"app/"}icon.png`)]),r("\u7D42\u4E86\u3057\u307E\u3057\u305F")}catch(r){m(i.err=String(r),20)}}).catch(i=>{m(String(i),10)});
