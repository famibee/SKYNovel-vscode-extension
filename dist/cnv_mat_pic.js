var N=Object.create;var O=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var C=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of k(t))!j.call(e,i)&&i!==n&&O(e,i,{get:()=>t[i],enumerable:!(r=G(t,i))||r.enumerable});return e};var J=(e,t,n)=>(n=e!=null?N(I(e)):{},C(t||!e||!e.__esModule?O(n,"default",{value:e,enumerable:!0}):n,e));var o=require("path"),s=require("fs-extra"),T=J(require("p-queue"));const[,,g,W,u,_=""]=process.argv,B=require("sharp"),L=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function p(e,t,n){for(const r of(0,s.readdirSync)(e,{withFileTypes:!0})){const i=String(r.name).normalize("NFC");if(L.test(i))continue;if(r.isDirectory()){n(i);continue}const a=(0,o.resolve)(e,i);t(a,i)}}function d(e,t,n,r=!0,i=e){try{if(!(0,s.existsSync)(e)){console.error(`replaceFile no exists src:${e}`);return}const a=(0,s.readFileSync)(e,{encoding:"utf8"}),S=String(a.replace(t,n));a!==S?(0,s.writeFileSync)(i,S):r&&console.error(`replaceFile fail by same:${e}`)}catch(a){console.error(`replaceFile src:${e} ${a}`)}}const w=/\.(jpe?g|png)$/,h=/\.(htm|html)$/,E=/\w+\/\*WEBP\*\//g,x=/\.json$/,q=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,M='$1$2.webp","image_bkup":"$2.$3"',V=/webp","image_bkup":".+(jpe?g|png)"/,D='$1"',m=__filename+"on";let c={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const A=(e=-1)=>{const t=Object.entries(c.hSize);t.sort((n,r)=>{const i=n[0],a=r[0];return i<a?-1:i>a?1:0}),c.hSize=Object.fromEntries(t),(0,s.writeJsonSync)(m,c,{encoding:"utf8"}),e>-1&&process.exit(e)},f=new T.default({concurrency:50,autoStart:!1});let z=0;const b=async()=>{z=f.size,console.error(`fn:cnv_mat_pic.ts start: ${z} tasks`),f.start(),await f.onIdle(),A(0)};let l=()=>{const e=f.size;if(!(e%50>0)){if(e===0){l=()=>{};return}console.error(`fn:cnv_mat_pic.ts ${e}/${z} tasks`)}};function y(e,t,n=""){f.add(async()=>{n!=="no_move"&&await(0,s.move)(e,t,{overwrite:!0});const{dir:r,name:i,ext:a}=(0,o.parse)(e),{dir:S}=(0,o.parse)(t),P=S+"/"+i+".webp",v=c.hSize[i]??={fld_nm:(0,o.basename)(r)+"/"+i,baseSize:0,webpSize:0,ext:""},F=await B(t).webp({quality:Number(v.webp_q??W)}).toFile(P);await(0,s.move)(P,r+"/"+i+".webp",{overwrite:!0});const R=(0,s.statSync)(t).size,$=F.size;c.hSize[i]={...v,baseSize:R,webpSize:$,ext:a.slice(1)},c.sum.baseSize+=R,c.sum.webpSize+=$,l()})}switch(g){case"restore":p(_,()=>{},e=>{p((0,o.resolve)(_,e),(t,n)=>{if(!w.test(n))return;const r=(0,o.resolve)(u,e,n);f.add(async()=>{await(0,s.move)(t,r,{overwrite:!0}),l()});const{name:i}=(0,o.parse)(n),a=(0,o.resolve)(u,e,i+".webp");f.add(async()=>{await(0,s.remove)(a),l()})},()=>{})}),p(u,()=>{},e=>{p((0,o.resolve)(u,e),(t,n)=>{if(h.test(n)){E.lastIndex=0,f.add(()=>{d(t,E,"false/*WEBP*/",!1),l()});return}x.test(n)&&f.add(()=>{d(t,V,D),l()})},()=>{})}),b();break;case"all_no_move":(0,s.existsSync)(m)&&(c=(0,s.readJsonSync)(m,{encoding:"utf8"}),c.sum.baseSize=c.sum.webpSize=0);for(const e of Object.values(c.hSize)){const t="."+e.ext;!w.test(t)||y((0,o.resolve)(u,e.fld_nm+t),(0,o.resolve)(_,e.fld_nm+t),"no_move")}b();break;case"all":(0,s.ensureDir)(_),p(u,()=>{},e=>{const t=(0,o.resolve)(_,e);(0,s.ensureDir)(t),p((0,o.resolve)(u,e),(n,r)=>{if(w.test(r)){y(n,(0,o.resolve)(t,r));return}if(h.test(r)){f.add(()=>{d(n,E,"true/*WEBP*/",!1),l()});return}x.test(r)&&f.add(()=>{d(n,q,M),l()})},()=>{})}),b();break;default:{(0,s.existsSync)(m)&&(c=(0,s.readJsonSync)(m,{encoding:"utf8"}));const{dir:e,name:t,ext:n}=(0,o.parse)(g),r={...c.hSize[t],fld_nm:(0,o.basename)(e)+"/"+t,ext:n.slice(1)};c.sum.baseSize-=r.baseSize,c.sum.webpSize-=r.webpSize,y(g,u,_),b()}break}
