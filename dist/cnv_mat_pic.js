const[,,$="",L,S="",b=""]=process.argv;import j from"sharp";j.cache(!1);import{resolve as c,parse as d,basename as B}from"node:path";import{styleText as O}from"node:util";import{ensureDir as h,existsSync as g,move as v,readdirSync as C,readFileSync as q,readJsonSync as D,remove as X,statSync as x,writeFileSync as U,writeJsonSync as V}from"fs-extra";const A=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function m(t,o,f){for(const a of C(t,{withFileTypes:!0})){const e=String(a.name).normalize("NFC");if(A.test(e))continue;if(a.isDirectory()){f(e);continue}const s=c(t,e);o(s,e)}}function w(t,o,f,a=!0,e=t){try{if(!g(t)){console.error(`No change, No replace src:${t}`);return}const s=q(t,{encoding:"utf8"}),i=String(s.replace(o,f));s!==i?U(e,i):a&&console.log(O("magentaBright",`replaceFile fail by same:${t}`))}catch(s){console.error(`replaceFile src:${t} ${s}`)}}function H(t,o,f=!0){if(g(t)||console.error(`chkUpdate err path1=${t}=`),!g(o))return f;const a=x(t,{bigint:!0}),e=x(o,{bigint:!0});return a.mtimeMs>e.mtimeMs}const y=/\.(jpe?g|png)$/,G=/\.(htm|html)$/,T=/\w+\/\*WEBP\*\//g,F=/\.json$/,J=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,M='$1$2.webp","image_bkup":"$2.$3"',Q=/webp","image_bkup":".+(jpe?g|png)"/,Y='$1"',I=__filename+"on";let n={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const k=()=>{if(!g(I))return;const t={...n};n=D(I,{encoding:"utf8"}),t.sum={...n.sum};for(const o in n.hSize){const{fld_nm:f,ext:a,baseSize:e,webpSize:s}=n.hSize[o],i=f+"."+a;g(c(S,i))||g(c(b,i))?t.hSize[o]=n.hSize[o]:(t.sum.baseSize-=e,t.sum.webpSize-=s)}n=t},K=(t=-1)=>{const o=Object.entries(n.hSize);o.sort((f,a)=>{const e=f[0],s=a[0];return e<s?-1:e>s?1:0}),n.hSize=Object.fromEntries(o),V(I,n,{encoding:"utf8"}),t>-1&&process.exit(t)};import Z from"p-queue";const u=new Z({concurrency:50,autoStart:!1});let N=0;const E=async()=>{N=u.size,console.log(O(["bgGreen","black"],`fn:cnv_mat_pic.ts start: ${N} tasks`)),u.start(),await u.onIdle(),K(0)};let p=()=>{const t=u.size;if(!(t%50>0)){if(t===0){p=()=>{};return}console.log(O(["bgGreen","black"],`fn:cnv_mat_pic.ts ${t}/${N} tasks`))}};function P(t,o,f=!0){u.add(async()=>{f&&await v(t,o,{overwrite:!0});const{dir:a,name:e}=d(t),{dir:s,ext:i}=d(o),r=s+"/"+e+".webp",l=n.hSize[e]??={fld_nm:B(a)+"/"+e,baseSize:0,webpSize:0,ext:""},z=await j(o).webp({quality:Number(l.webp_q??L)}).toFile(r);await v(r,a+"/"+e+".webp",{overwrite:!0});const _=x(o).size,R=z.size;n.hSize[e]={...l,baseSize:_,webpSize:R,ext:i.slice(1)},n.sum.baseSize+=_,n.sum.webpSize+=R,p()})}switch($){case"enable":h(b),m(S,()=>{},e=>{const s=c(b,e);h(s),m(c(S,e),(i,r)=>{if(y.test(r)){P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,T,"true/*WEBP*/",!1),p()});return}F.test(r)&&u.add(()=>{w(i,J,M),p()})},()=>{})}),E();break;case"disable":m(b,()=>{},e=>{m(c(b,e),(s,i)=>{if(!y.test(i))return;const r=c(S,e,i);u.add(async()=>{await v(s,r,{overwrite:!0}),p()});const{name:l}=d(i),z=c(S,e,l+".webp");u.add(async()=>{await X(z),p()})},()=>{})}),m(S,()=>{},e=>{m(c(S,e),(s,i)=>{if(G.test(i)){T.lastIndex=0,u.add(()=>{w(s,T,"false/*WEBP*/",!1),p()});return}F.test(i)&&u.add(()=>{w(s,Q,Y),p()})},()=>{})}),E();break;case"reconv":k(),n.sum.baseSize=n.sum.webpSize=0;for(const{ext:e,fld_nm:s}of Object.values(n.hSize))P(c(S,s+"."+e),c(b,s+"."+e),!1);E();break;case"prj_scan":k(),h(b),m(S,()=>{},e=>{const s=c(b,e);h(s),m(c(S,e),(i,r)=>{if(y.test(r)){const l=d(r).name;if(l in n.hSize){const{baseSize:z=0,webpSize:_=0}=n.hSize[l];n.sum.baseSize-=z,n.sum.webpSize-=_}P(i,c(s,r));return}if(G.test(r)){u.add(()=>{w(i,T,"true/*WEBP*/",!1),p()});return}F.test(r)&&u.add(()=>{w(i,J,M),p()})},()=>{})}),E();break;case"base_scan":k(),m(b,()=>{},e=>{const s=c(b,e);h(s);const i=c(S,e);m(s,(r,l)=>{if(!y.test(r))return;const z=c(i,l.replace(y,".webp"));if(!H(r,z))return;const _=d(l).name;if(_ in n.hSize){const{baseSize:R=0,webpSize:W=0}=n.hSize[_];n.sum.baseSize-=R,n.sum.webpSize-=W}P(z,r,!1)},()=>{})}),E();break;default:k();const{dir:t,name:o,ext:f}=d($),a={...n.hSize[o],fld_nm:B(t)+"/"+o,ext:f.slice(1)};n.sum.baseSize-=a.baseSize,n.sum.webpSize-=a.webpSize,P($,S,!!b),E();break}export{H as chkUpdate};
