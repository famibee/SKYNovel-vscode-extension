const[,,P="",L,m="",c=""]=process.argv,{codec:x}=JSON.parse(L);import J from"@ffmpeg-installer/ffmpeg";import F from"fluent-ffmpeg";F.setFfmpegPath(J.path);import{resolve as i,parse as _,basename as $}from"node:path";import{styleText as G}from"node:util";import{ensureDir as d,existsSync as p,move as O,readdirSync as R,readJsonSync as C,remove as B,statSync as y,writeJsonSync as M}from"fs-extra";const U=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function f(e,t,r){for(const s of R(e,{withFileTypes:!0})){const o=String(s.name).normalize("NFC");if(U.test(o))continue;if(s.isDirectory()){r(o);continue}const a=i(e,o);t(a,o)}}function q(e,t,r=!0){if(p(e)||console.error(`chkUpdate err path1=${e}=`),!p(t))return r;const s=y(e,{bigint:!0}),o=y(t,{bigint:!0});return s.mtimeMs>o.mtimeMs}const b=/\.(mp3|wav)$/,T=__filename+"on";let n={sum:{baseSize:0,optSize:0,pathSndOpt:"",pathSndBase:""},hSize:{}};const v=()=>{if(!p(T))return;const e={...n};n=C(T,{encoding:"utf8"}),e.sum={...n.sum};for(const t in n.hSize){const{fld_nm:r,ext:s,baseSize:o,optSize:a}=n.hSize[t],u=r+"."+s;p(i(m,u))||p(i(c,u))?e.hSize[t]=n.hSize[t]:(e.sum.baseSize-=o,e.sum.optSize-=a)}n=e},Q=(e=-1)=>{const t=Object.entries(n.hSize);t.sort((r,s)=>{const o=r[0],a=s[0];return o<a?-1:o>a?1:0}),n.hSize=Object.fromEntries(t),M(T,n,{encoding:"utf8"}),e>-1&&process.exit(e)};import W from"p-queue";const S=new W({concurrency:20,autoStart:!1});let j=0;const l=async()=>{j=S.size,console.log(G(["bgGreen","black"],`fn:cnv_mat_snd.ts start: ${j} tasks`)),S.start(),await S.onIdle(),Q(0)};let w=()=>{const e=S.size;if(!(e%20>0)){if(e===0){w=()=>{};return}console.log(G(["bgGreen","black"],`fn:cnv_mat_snd.ts ${e}/${j} tasks`))}};const X="."+x,I="."+(x==="opus"?"m4a":x);function g(e,t,r=!0){S.add(async()=>{const{dir:s,name:o}=_(e);r?await O(e,t,{overwrite:!0}):await Promise.allSettled(["m4a","aac","ogg"].map(k=>B(s+"/"+o+"."+k)));const{dir:a,ext:u}=_(t),z=a+"/"+o+X,h=n.hSize[o]??={fld_nm:$(s)+"/"+o,baseSize:0,optSize:0,ext:""};await new Promise(k=>F(t).save(z).on("error",E=>console.error(E)).on("end",async(E,Y)=>{const N=y(t).size,D=y(z).size;n.hSize[o]={...h,baseSize:N,optSize:D,ext:u.slice(1)},n.sum.baseSize+=N,n.sum.optSize+=D,await O(z,s+"/"+o+I,{overwrite:!0}),w(),k()}))})}switch(P){case"enable":d(c),f(m,()=>{},e=>{const t=i(c,e);d(t),f(i(m,e),(r,s)=>{if(b.test(s)){g(r,i(t,s));return}},()=>{})}),l();break;case"disable":f(c,()=>{},e=>{f(i(c,e),(t,r)=>{if(!b.test(r))return;const s=i(m,e,r);S.add(async()=>{await O(t,s,{overwrite:!0}),w()});const o=s.slice(0,-3);["m4a","aac","ogg"].forEach(a=>S.add(async()=>{await B(o+a),w()}))},()=>{})}),l();break;case"reconv":v(),n.sum.baseSize=n.sum.optSize=0;for(const{ext:e,fld_nm:t}of Object.values(n.hSize))g(i(m,t+"."+e),i(c,t+"."+e),!1);l();break;case"prj_scan":v(),d(c),f(m,()=>{},e=>{const t=i(c,e);d(t),f(i(m,e),(r,s)=>{if(b.test(s)){g(r,i(t,s));return}},()=>{})}),l();break;case"base_scan":v(),f(c,()=>{},e=>{const t=i(c,e);d(t);const r=i(m,e);f(t,(s,o)=>{if(!b.test(s))return;const a=i(r,o.replace(b,I));if(!q(s,a))return;const u=_(a).name;if(u in n.hSize){const{baseSize:z=0,optSize:h=0}=n.hSize[u];n.sum.baseSize-=z,n.sum.optSize-=h}g(a,s,!1)},()=>{})}),l();break;default:{v();const{dir:e,name:t,ext:r}=_(P),s={...n.hSize[t],fld_nm:$(e)+"/"+t,ext:r.slice(1)};n.sum.baseSize-=s.baseSize,n.sum.optSize-=s.optSize,g(P,m,!!c),l()}break}export{q as chkUpdate};
