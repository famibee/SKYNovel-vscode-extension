var B=Object.create;var g=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var R=(e,t)=>{for(var n in t)g(e,n,{get:t[n],enumerable:!0})},E=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of L(t))!J.call(e,r)&&r!==n&&g(e,r,{get:()=>t[r],enumerable:!(o=I(t,r))||o.enumerable});return e};var C=(e,t,n)=>(n=e!=null?B(q(e)):{},E(t||!e||!e.__esModule?g(n,"default",{value:e,enumerable:!0}):n,e)),U=e=>E(g({},"__esModule",{value:!0}),e);var H={};R(H,{chkUpdate:()=>$});module.exports=U(H);var i=require("node:path"),O=require("node:util"),s=require("fs-extra"),G=C(require("p-queue"));const[,,h,Q,m,u=""]=process.argv,{codec:k}=JSON.parse(Q),W=require("@ffmpeg-installer/ffmpeg"),D=require("fluent-ffmpeg");D.setFfmpegPath(W.path);const X=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function f(e,t,n){for(const o of(0,s.readdirSync)(e,{withFileTypes:!0})){const r=String(o.name).normalize("NFC");if(X.test(r))continue;if(o.isDirectory()){n(r);continue}const c=(0,i.resolve)(e,r);t(c,r)}}function $(e,t,n=!0){return(0,s.existsSync)(e)||console.error(`chkUpdate err path1=${e}=`),(0,s.existsSync)(t)?(0,s.statSync)(e,{bigint:!0}).mtimeNs>(0,s.statSync)(t,{bigint:!0}).mtimeNs:n}const p=/\.(mp3|wav)$/,P=__filename+"on";let a={sum:{baseSize:0,optSize:0,pathSndOpt:"",pathSndBase:""},hSize:{}};const _=()=>{if(!(0,s.existsSync)(P))return;const e={...a};a=(0,s.readJsonSync)(P,{encoding:"utf8"}),e.sum={...a.sum};for(const t in a.hSize){const{fld_nm:n,ext:o,baseSize:r,optSize:c}=a.hSize[t],S=n+"."+o;(0,s.existsSync)((0,i.resolve)(m,S))||(0,s.existsSync)((0,i.resolve)(u,S))?e.hSize[t]=a.hSize[t]:(e.sum.baseSize-=r,e.sum.optSize-=c)}a=e},Y=(e=-1)=>{const t=Object.entries(a.hSize);t.sort((n,o)=>{const r=n[0],c=o[0];return r<c?-1:r>c?1:0}),a.hSize=Object.fromEntries(t),(0,s.writeJsonSync)(P,a,{encoding:"utf8"}),e>-1&&process.exit(e)},l=new G.default({concurrency:20,autoStart:!1});let x=0;const z=async()=>{x=l.size,console.log((0,O.styleText)(["bgGreen","black"],`fn:cnv_mat_snd.ts start: ${x} tasks`)),l.start(),await l.onIdle(),Y(0)};let y=()=>{const e=l.size;if(!(e%20>0)){if(e===0){y=()=>{};return}console.log((0,O.styleText)(["bgGreen","black"],`fn:cnv_mat_snd.ts ${e}/${x} tasks`))}};const A="."+k,F="."+(k==="opus"?"m4a":k);function b(e,t,n=!0){l.add(async()=>{const{dir:o,name:r}=(0,i.parse)(e);n?await(0,s.move)(e,t,{overwrite:!0}):await Promise.allSettled(["m4a","aac","ogg"].map(w=>(0,s.remove)(o+"/"+r+"."+w)));const{dir:c,ext:S}=(0,i.parse)(t),d=c+"/"+r+A,v=a.hSize[r]??={fld_nm:(0,i.basename)(o)+"/"+r,baseSize:0,optSize:0,ext:""};await new Promise(w=>D(t).save(d).on("error",T=>console.error(T)).on("end",async(T,K)=>{const N=(0,s.statSync)(t).size,j=(0,s.statSync)(d).size;a.hSize[r]={...v,baseSize:N,optSize:j,ext:S.slice(1)},a.sum.baseSize+=N,a.sum.optSize+=j,await(0,s.move)(d,o+"/"+r+F,{overwrite:!0}),y(),w()}))})}switch(h){case"enable":(0,s.ensureDir)(u),f(m,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,s.ensureDir)(t),f((0,i.resolve)(m,e),(n,o)=>{if(p.test(o)){b(n,(0,i.resolve)(t,o));return}},()=>{})}),z();break;case"disable":f(u,()=>{},e=>{f((0,i.resolve)(u,e),(t,n)=>{if(!p.test(n))return;const o=(0,i.resolve)(m,e,n);l.add(async()=>{await(0,s.move)(t,o,{overwrite:!0}),y()});const r=o.slice(0,-3);["m4a","aac","ogg"].forEach(c=>l.add(async()=>{await(0,s.remove)(r+c),y()}))},()=>{})}),z();break;case"reconv":_(),a.sum.baseSize=a.sum.optSize=0;for(const{ext:e,fld_nm:t}of Object.values(a.hSize))b((0,i.resolve)(m,t+"."+e),(0,i.resolve)(u,t+"."+e),!1);z();break;case"prj_scan":_(),(0,s.ensureDir)(u),f(m,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,s.ensureDir)(t),f((0,i.resolve)(m,e),(n,o)=>{if(p.test(o)){b(n,(0,i.resolve)(t,o));return}},()=>{})}),z();break;case"base_scan":_(),f(u,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,s.ensureDir)(t);const n=(0,i.resolve)(m,e);f(t,(o,r)=>{if(!p.test(o))return;const c=(0,i.resolve)(n,r.replace(p,F));if(!$(o,c))return;const S=(0,i.parse)(c).name;if(S in a.hSize){const{baseSize:d=0,optSize:v=0}=a.hSize[S];a.sum.baseSize-=d,a.sum.optSize-=v}b(c,o,!1)},()=>{})}),z();break;default:{_();const{dir:e,name:t,ext:n}=(0,i.parse)(h),o={...a.hSize[t],fld_nm:(0,i.basename)(e)+"/"+t,ext:n.slice(1)};a.sum.baseSize-=o.baseSize,a.sum.optSize-=o.optSize,b(h,m,!!u),z()}break}
