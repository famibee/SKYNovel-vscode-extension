import l from"sharp";l.cache(!1);import{BICUBIC2 as b,BILINEAR as _,createICNS as y,createICO as $}from"png2icons";import{fileURLToPath as I}from"node:url";import{styleText as w}from"node:util";import{existsSync as k}from"node:fs";import{readFile as x,writeFile as u}from"node:fs/promises";import{copy as B,mkdirs as R,readJson as v,writeJsonSync as C}from"fs-extra/esm";const P=I(import.meta.url),S=P+"on",o=process.cwd()+"/";function h(i,s=0){console.log(s===0?w(["bgGreen","black"],"  [OK] %o"):w(["bgRed","white"],"  [ERR] %o"),i),process.exit(s)}v(S,{encoding:"utf8"}).then(async i=>{try{let c=function(e,n=0){C(S,i,{encoding:"utf8"}),h(e,n)};var s=c;const{order:r}=i,m=l((r.is_src_pp?o:"")+r.wp_src),{width:a,height:g}=await m.metadata();if(!a||!g)throw"\u753B\u50CF\u306E\u30B5\u30A4\u30BA\u304C\u4E0D\u660E\u3067\u3059";const t=1024;if(a<t||g<t)throw`\u5143\u753B\u50CF\u306E\u30B5\u30A4\u30BA\u306F ${String(t)} x ${String(t)} \u4EE5\u4E0A\u306B\u3057\u3066\u4E0B\u3055\u3044\u3002\uFF08width:${String(a)} height:${String(g)}\uFF09`;const f=m.png().resize({width:t,height:t,fit:"cover",background:{r:0,g:0,b:0,alpha:0}});switch(Number(r.shape)){case 1:f.composite([{input:Buffer.from(`<svg><circle cx="${String(t/2)}" cy="${String(t/2)}" r="${String(t/2)}"/></svg>`),blend:"dest-in"}]);break;case 2:f.composite([{input:Buffer.from(`<svg><rect width="${String(t)}" height="${String(t)}" rx="${String(t/4.5)}" ry="${String(t/4.5)}"/></svg>`),blend:"dest-in"}]);break}await f.toFile(o+r.wp_dest);const p=o+"build/icon.png";if(!k(p))throw"\u751F\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F";const d=await x(p);await R(o+"build/icon/"),await Promise.allSettled([(async()=>{const e=o+"build/icon/icon.icns",n=y(d,_,0);n&&await u(e,n)})(),(async()=>{const e=o+"build/icon/icon.ico",n=$(d,b,0,!1,!0);n&&await u(e,n)})(),B(p,o+`doc/${r.is_new_tmp?"":"app/"}icon.png`)]),c("\u7D42\u4E86\u3057\u307E\u3057\u305F")}catch(c){h(i.err=String(c),20)}}).catch(i=>{h(String(i),10)});
