"use strict";var B=Object.create;var g=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var R=(e,t)=>{for(var o in t)g(e,o,{get:t[o],enumerable:!0})},N=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of L(t))!J.call(e,r)&&r!==o&&g(e,r,{get:()=>t[r],enumerable:!(s=I(t,r))||s.enumerable});return e};var C=(e,t,o)=>(o=e!=null?B(q(e)):{},N(t||!e||!e.__esModule?g(o,"default",{value:e,enumerable:!0}):o,e)),M=e=>N(g({},"__esModule",{value:!0}),e);var A={};R(A,{chkUpdate:()=>$});module.exports=M(A);var i=require("node:path"),O=require("node:util"),n=require("fs-extra"),G=C(require("p-queue"));const[,,h="",U,m="",u=""]=process.argv,{codec:k}=JSON.parse(U),Q=require("@ffmpeg-installer/ffmpeg"),D=require("fluent-ffmpeg");D.setFfmpegPath(Q.path);const W=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function f(e,t,o){for(const s of(0,n.readdirSync)(e,{withFileTypes:!0})){const r=String(s.name).normalize("NFC");if(W.test(r))continue;if(s.isDirectory()){o(r);continue}const c=(0,i.resolve)(e,r);t(c,r)}}function $(e,t,o=!0){if((0,n.existsSync)(e)||console.error(`chkUpdate err path1=${e}=`),!(0,n.existsSync)(t))return o;const s=(0,n.statSync)(e,{bigint:!0}),r=(0,n.statSync)(t,{bigint:!0});return s.mtimeMs>r.mtimeMs}const p=/\.(mp3|wav)$/,P=__filename+"on";let a={sum:{baseSize:0,optSize:0,pathSndOpt:"",pathSndBase:""},hSize:{}};const _=()=>{if(!(0,n.existsSync)(P))return;const e={...a};a=(0,n.readJsonSync)(P,{encoding:"utf8"}),e.sum={...a.sum};for(const t in a.hSize){const{fld_nm:o,ext:s,baseSize:r,optSize:c}=a.hSize[t],S=o+"."+s;(0,n.existsSync)((0,i.resolve)(m,S))||(0,n.existsSync)((0,i.resolve)(u,S))?e.hSize[t]=a.hSize[t]:(e.sum.baseSize-=r,e.sum.optSize-=c)}a=e},X=(e=-1)=>{const t=Object.entries(a.hSize);t.sort((o,s)=>{const r=o[0],c=s[0];return r<c?-1:r>c?1:0}),a.hSize=Object.fromEntries(t),(0,n.writeJsonSync)(P,a,{encoding:"utf8"}),e>-1&&process.exit(e)},l=new G.default({concurrency:20,autoStart:!1});let x=0;const z=async()=>{x=l.size,console.log((0,O.styleText)(["bgGreen","black"],`fn:cnv_mat_snd.ts start: ${x} tasks`)),l.start(),await l.onIdle(),X(0)};let y=()=>{const e=l.size;if(!(e%20>0)){if(e===0){y=()=>{};return}console.log((0,O.styleText)(["bgGreen","black"],`fn:cnv_mat_snd.ts ${e}/${x} tasks`))}};const Y="."+k,F="."+(k==="opus"?"m4a":k);function b(e,t,o=!0){l.add(async()=>{const{dir:s,name:r}=(0,i.parse)(e);o?await(0,n.move)(e,t,{overwrite:!0}):await Promise.allSettled(["m4a","aac","ogg"].map(w=>(0,n.remove)(s+"/"+r+"."+w)));const{dir:c,ext:S}=(0,i.parse)(t),d=c+"/"+r+Y,v=a.hSize[r]??={fld_nm:(0,i.basename)(s)+"/"+r,baseSize:0,optSize:0,ext:""};await new Promise(w=>D(t).save(d).on("error",T=>console.error(T)).on("end",async(T,H)=>{const j=(0,n.statSync)(t).size,E=(0,n.statSync)(d).size;a.hSize[r]={...v,baseSize:j,optSize:E,ext:S.slice(1)},a.sum.baseSize+=j,a.sum.optSize+=E,await(0,n.move)(d,s+"/"+r+F,{overwrite:!0}),y(),w()}))})}switch(h){case"enable":(0,n.ensureDir)(u),f(m,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,n.ensureDir)(t),f((0,i.resolve)(m,e),(o,s)=>{if(p.test(s)){b(o,(0,i.resolve)(t,s));return}},()=>{})}),z();break;case"disable":f(u,()=>{},e=>{f((0,i.resolve)(u,e),(t,o)=>{if(!p.test(o))return;const s=(0,i.resolve)(m,e,o);l.add(async()=>{await(0,n.move)(t,s,{overwrite:!0}),y()});const r=s.slice(0,-3);["m4a","aac","ogg"].forEach(c=>l.add(async()=>{await(0,n.remove)(r+c),y()}))},()=>{})}),z();break;case"reconv":_(),a.sum.baseSize=a.sum.optSize=0;for(const{ext:e,fld_nm:t}of Object.values(a.hSize))b((0,i.resolve)(m,t+"."+e),(0,i.resolve)(u,t+"."+e),!1);z();break;case"prj_scan":_(),(0,n.ensureDir)(u),f(m,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,n.ensureDir)(t),f((0,i.resolve)(m,e),(o,s)=>{if(p.test(s)){b(o,(0,i.resolve)(t,s));return}},()=>{})}),z();break;case"base_scan":_(),f(u,()=>{},e=>{const t=(0,i.resolve)(u,e);(0,n.ensureDir)(t);const o=(0,i.resolve)(m,e);f(t,(s,r)=>{if(!p.test(s))return;const c=(0,i.resolve)(o,r.replace(p,F));if(!$(s,c))return;const S=(0,i.parse)(c).name;if(S in a.hSize){const{baseSize:d=0,optSize:v=0}=a.hSize[S];a.sum.baseSize-=d,a.sum.optSize-=v}b(c,s,!1)},()=>{})}),z();break;default:{_();const{dir:e,name:t,ext:o}=(0,i.parse)(h),s={...a.hSize[t],fld_nm:(0,i.basename)(e)+"/"+t,ext:o.slice(1)};a.sum.baseSize-=s.baseSize,a.sum.optSize-=s.optSize,b(h,m,!!u),z()}break}
