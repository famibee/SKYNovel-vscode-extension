var W=Object.create;var P=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var X=(e,s)=>{for(var a in s)P(e,a,{get:s[a],enumerable:!0})},F=(e,s,a,f)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of q(s))!D.call(e,t)&&t!==a&&P(e,t,{get:()=>s[t],enumerable:!(f=L(s,t))||f.enumerable});return e};var U=(e,s,a)=>(a=e!=null?W(C(e)):{},F(s||!e||!e.__esModule?P(a,"default",{value:e,enumerable:!0}):a,e)),V=e=>F(P({},"__esModule",{value:!0}),e);var Z={};X(Z,{chkUpdate:()=>B});module.exports=V(Z);var o=require("node:path"),k=require("node:util"),n=require("fs-extra"),J=U(require("p-queue"));const[,,$,A,b,l=""]=process.argv,I=require("sharp");I.cache(!1);const H=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function p(e,s,a){for(const f of(0,n.readdirSync)(e,{withFileTypes:!0})){const t=String(f.name).normalize("NFC");if(H.test(t))continue;if(f.isDirectory()){a(t);continue}const i=(0,o.resolve)(e,t);s(i,t)}}function g(e,s,a,f=!0,t=e){try{if(!(0,n.existsSync)(e)){console.error(`No change, No replace src:${e}`);return}const i=(0,n.readFileSync)(e,{encoding:"utf8"}),c=String(i.replace(s,a));i!==c?(0,n.writeFileSync)(t,c):f&&console.log((0,k.styleText)("magentaBright",`replaceFile fail by same:${e}`))}catch(i){console.error(`replaceFile src:${e} ${i}`)}}function B(e,s,a=!0){if((0,n.existsSync)(e)||console.error(`chkUpdate err path1=${e}=`),!(0,n.existsSync)(s))return a;const f=(0,n.statSync)(e,{bigint:!0}),t=(0,n.statSync)(s,{bigint:!0});return f.mtimeMs>t.mtimeMs}const E=/\.(jpe?g|png)$/,O=/\.(htm|html)$/,R=/\w+\/\*WEBP\*\//g,v=/\.json$/,N=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,j='$1$2.webp","image_bkup":"$2.$3"',Q=/webp","image_bkup":".+(jpe?g|png)"/,Y='$1"',x=__filename+"on";let r={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const T=()=>{if(!(0,n.existsSync)(x))return;const e={...r};r=(0,n.readJsonSync)(x,{encoding:"utf8"}),e.sum={...r.sum};for(const s in r.hSize){const{fld_nm:a,ext:f,baseSize:t,webpSize:i}=r.hSize[s],c=a+"."+f;(0,n.existsSync)((0,o.resolve)(b,c))||(0,n.existsSync)((0,o.resolve)(l,c))?e.hSize[s]=r.hSize[s]:(e.sum.baseSize-=t,e.sum.webpSize-=i)}r=e},K=(e=-1)=>{const s=Object.entries(r.hSize);s.sort((a,f)=>{const t=a[0],i=f[0];return t<i?-1:t>i?1:0}),r.hSize=Object.fromEntries(s),(0,n.writeJsonSync)(x,r,{encoding:"utf8"}),e>-1&&process.exit(e)},S=new J.default({concurrency:50,autoStart:!1});let G=0;const w=async()=>{G=S.size,console.log((0,k.styleText)(["bgGreen","black"],`fn:cnv_mat_pic.ts start: ${G} tasks`)),S.start(),await S.onIdle(),K(0)};let z=()=>{const e=S.size;if(!(e%50>0)){if(e===0){z=()=>{};return}console.log((0,k.styleText)(["bgGreen","black"],`fn:cnv_mat_pic.ts ${e}/${G} tasks`))}};function h(e,s,a=!0){S.add(async()=>{a&&await(0,n.move)(e,s,{overwrite:!0});const{dir:f,name:t}=(0,o.parse)(e),{dir:i,ext:c}=(0,o.parse)(s),u=i+"/"+t+".webp",m=r.hSize[t]??={fld_nm:(0,o.basename)(f)+"/"+t,baseSize:0,webpSize:0,ext:""},_=await I(s).webp({quality:Number(m.webp_q??A)}).toFile(u);await(0,n.move)(u,f+"/"+t+".webp",{overwrite:!0});const d=(0,n.statSync)(s).size,y=_.size;r.hSize[t]={...m,baseSize:d,webpSize:y,ext:c.slice(1)},r.sum.baseSize+=d,r.sum.webpSize+=y,z()})}switch($){case"enable":(0,n.ensureDir)(l),p(b,()=>{},t=>{const i=(0,o.resolve)(l,t);(0,n.ensureDir)(i),p((0,o.resolve)(b,t),(c,u)=>{if(E.test(u)){h(c,(0,o.resolve)(i,u));return}if(O.test(u)){S.add(()=>{g(c,R,"true/*WEBP*/",!1),z()});return}v.test(u)&&S.add(()=>{g(c,N,j),z()})},()=>{})}),w();break;case"disable":p(l,()=>{},t=>{p((0,o.resolve)(l,t),(i,c)=>{if(!E.test(c))return;const u=(0,o.resolve)(b,t,c);S.add(async()=>{await(0,n.move)(i,u,{overwrite:!0}),z()});const{name:m}=(0,o.parse)(c),_=(0,o.resolve)(b,t,m+".webp");S.add(async()=>{await(0,n.remove)(_),z()})},()=>{})}),p(b,()=>{},t=>{p((0,o.resolve)(b,t),(i,c)=>{if(O.test(c)){R.lastIndex=0,S.add(()=>{g(i,R,"false/*WEBP*/",!1),z()});return}v.test(c)&&S.add(()=>{g(i,Q,Y),z()})},()=>{})}),w();break;case"reconv":T(),r.sum.baseSize=r.sum.webpSize=0;for(const{ext:t,fld_nm:i}of Object.values(r.hSize))h((0,o.resolve)(b,i+"."+t),(0,o.resolve)(l,i+"."+t),!1);w();break;case"prj_scan":T(),(0,n.ensureDir)(l),p(b,()=>{},t=>{const i=(0,o.resolve)(l,t);(0,n.ensureDir)(i),p((0,o.resolve)(b,t),(c,u)=>{if(E.test(u)){const m=(0,o.parse)(u).name;if(m in r.hSize){const{baseSize:_=0,webpSize:d=0}=r.hSize[m];r.sum.baseSize-=_,r.sum.webpSize-=d}h(c,(0,o.resolve)(i,u));return}if(O.test(u)){S.add(()=>{g(c,R,"true/*WEBP*/",!1),z()});return}v.test(u)&&S.add(()=>{g(c,N,j),z()})},()=>{})}),w();break;case"base_scan":T(),p(l,()=>{},t=>{const i=(0,o.resolve)(l,t);(0,n.ensureDir)(i);const c=(0,o.resolve)(b,t);p(i,(u,m)=>{if(!E.test(u))return;const _=(0,o.resolve)(c,m.replace(E,".webp"));if(!B(u,_))return;const d=(0,o.parse)(m).name;if(d in r.hSize){const{baseSize:y=0,webpSize:M=0}=r.hSize[d];r.sum.baseSize-=y,r.sum.webpSize-=M}h(_,u,!1)},()=>{})}),w();break;default:T();const{dir:e,name:s,ext:a}=(0,o.parse)($),f={...r.hSize[s],fld_nm:(0,o.basename)(e)+"/"+s,ext:a.slice(1)};r.sum.baseSize-=f.baseSize,r.sum.webpSize-=f.webpSize,h($,b,!!l),w();break}
