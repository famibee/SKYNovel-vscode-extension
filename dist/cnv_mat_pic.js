var r=require("path"),t=require("fs-extra");const[,,_,R,m,p=""]=process.argv,T=require("sharp"),$=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function f(e,n,s){(0,t.readdirSync)(e,{withFileTypes:!0}).forEach(i=>{const o=String(i.name).normalize("NFC");if($.test(o))return;if(i.isDirectory()){s(o);return}const l=(0,r.resolve)(e,o);n(l,o)})}function S(e,n,s,i=e){try{if(!(0,t.existsSync)(e)){console.error(`replaceFile no exists src:${e}`);return}const o=(0,t.readFileSync)(e,{encoding:"utf8"}),l=String(o.replace(n,s));o!==l&&(0,t.writeFileSync)(i,l)}catch(o){console.error(`replaceFile src:${e} ${o}`)}}const E=/\.(jpe?g|png)$/,C=/\.webp$/,P=/\.(htm|html)$/,b=/\w+\/\*WEBP\*\//g,v=/\.json$/,F=/("image"\s*:\s*")(.+)\.(jpe?g|png)"/,G=/webp","image_bkup":".+(jpe?g|png)"/,u=__filename+"on";let c={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const g=(e=-1)=>{(0,t.writeJsonSync)(u,c,{encoding:"utf8"}),e>-1&&process.exit(e)},a=[];function h(e,n,s=""){a.push(async()=>{s!=="no_move"&&await(0,t.move)(e,n,{overwrite:!0});const{dir:i,name:o,ext:l}=(0,r.parse)(e),{dir:x}=(0,r.parse)(n),w=x+"/"+o+".webp",d=c.hSize[o]??={fld_nm:(0,r.basename)(i)+"/"+o,baseSize:0,webpSize:0,ext:""},N=await T(n).webp({quality:Number(d.webp_q??R)}).toFile(w);await(0,t.move)(w,i+"/"+o+".webp",{overwrite:!0});const z=(0,t.statSync)(n).size,y=N.size;c.hSize[o]={...d,baseSize:z,webpSize:y,ext:l.slice(1)},c.sum.baseSize+=z,c.sum.webpSize+=y})}switch(_){case"restore":f(m,()=>{},e=>{f((0,r.resolve)(m,e),(n,s)=>{if(C.test(s)){const i=(0,r.resolve)(p,e,s).slice(0,-4);["jpg","jpeg","png"].forEach(o=>{(0,t.existsSync)(i+o)&&a.push(()=>(0,t.remove)(n))});return}P.test(s)&&(b.lastIndex=0,a.push(async()=>S(n,b,"false/*WEBP*/"))),v.test(s)&&a.push(async()=>S(n,G,'$1"'))},()=>{})}),f(p,()=>{},e=>{const n=(0,r.resolve)(m,e);f((0,r.resolve)(p,e),(s,i)=>a.push(()=>(0,t.move)(s,(0,r.resolve)(n,i),{overwrite:!0})),()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>(0,t.removeSync)(p)).then(()=>g(0));break;case"all_no_move":(0,t.existsSync)(u)&&(c=(0,t.readJsonSync)(u,{encoding:"utf8"}),c.sum.baseSize=c.sum.webpSize=0);for(const e in c.hSize){const n=c.hSize[e],s="."+n.ext;!E.test(s)||h((0,r.resolve)(m,n.fld_nm+s),(0,r.resolve)(p,n.fld_nm+s),"no_move")}Promise.allSettled(a.map(e=>e())).then(()=>g(0));break;case"all":(0,t.ensureDir)(p),f(m,()=>{},e=>{const n=(0,r.resolve)(p,e);(0,t.ensureDir)(n),f((0,r.resolve)(m,e),(s,i)=>{if(E.test(i)){h(s,(0,r.resolve)(n,i));return}P.test(i)&&a.push(async()=>S(s,b,"true/*WEBP*/")),v.test(i)&&a.push(async()=>S(s,F,'$1$2.webp","image_bkup":"$2.$3"'))},()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>g(0));break;default:{(0,t.existsSync)(u)&&(c=(0,t.readJsonSync)(u,{encoding:"utf8"}));const{dir:e,name:n,ext:s}=(0,r.parse)(_),i={...c.hSize[n],fld_nm:(0,r.basename)(e)+"/"+n,ext:s.slice(1)};c.sum.baseSize-=i.baseSize,c.sum.webpSize-=i.webpSize,h(_,m,p),Promise.allSettled(a.map(o=>o())).then(()=>g(0))}break}
