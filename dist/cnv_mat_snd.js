var D=Object.create;var T=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var L=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of $(t))!I.call(e,o)&&o!==i&&T(e,o,{get:()=>t[o],enumerable:!(s=E(t,o))||s.enumerable});return e};var q=(e,t,i)=>(i=e!=null?D(C(e)):{},L(t||!e||!e.__esModule?T(i,"default",{value:e,enumerable:!0}):i,e));var a=require("path"),n=require("fs-extra"),F=q(require("p-queue"));const[,,w,J,d,m=""]=process.argv,{codec:h}=JSON.parse(J),A=require("@ffmpeg-installer/ffmpeg"),N=require("fluent-ffmpeg");N.setFfmpegPath(A.path);const B=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function l(e,t,i){for(const s of(0,n.readdirSync)(e,{withFileTypes:!0})){const o=String(s.name).normalize("NFC");if(B.test(o))continue;if(s.isDirectory()){i(o);continue}const c=(0,a.resolve)(e,o);t(c,o)}}const _=/\.(mp3|wav)$/,u=__filename+"on";let r={sum:{baseSize:0,optSize:0,pathSndOpt:"",pathSndBase:""},hSize:{}};const G=(e=-1)=>{const t=Object.entries(r.hSize);t.sort((i,s)=>{const o=i[0],c=s[0];return o<c?-1:o>c?1:0}),r.hSize=Object.fromEntries(t),(0,n.writeJsonSync)(u,r,{encoding:"utf8"}),e>-1&&process.exit(e)},S=new F.default({concurrency:20,autoStart:!1});let P=0;const p=async()=>{P=S.size,console.error(`fn:cnv_mat_snd.ts start: ${P} tasks`),S.start(),await S.onIdle(),G(0)};let v=()=>{const e=S.size;if(!(e%20>0)){if(e===0){v=()=>{};return}console.error(`fn:cnv_mat_snd.ts ${e}/${P} tasks`)}};const M="."+h,j="."+(h==="opus"?"m4a":h);function b(e,t,i=""){S.add(async()=>{const{dir:s,name:o,ext:c}=(0,a.parse)(e);i==="no_move"?await Promise.allSettled(["m4a","aac","ogg"].map(y=>(0,n.remove)(s+"/"+o+"."+y))):await(0,n.move)(e,t,{overwrite:!0});const{dir:g}=(0,a.parse)(t),f=g+"/"+o+M,z=r.hSize[o]??={fld_nm:(0,a.basename)(s)+"/"+o,baseSize:0,optSize:0,ext:""};await new Promise(y=>N(t).save(f).on("error",x=>console.error(x)).on("end",async(x,R)=>{const O=(0,n.statSync)(t).size,k=(0,n.statSync)(f).size;r.hSize[o]={...z,baseSize:O,optSize:k,ext:c.slice(1)},r.sum.baseSize+=O,r.sum.optSize+=k,await(0,n.move)(f,s+"/"+o+j,{overwrite:!0}),v(),y()}))})}switch(w){case"restore":l(m,()=>{},e=>{l((0,a.resolve)(m,e),(t,i)=>{if(!_.test(i))return;const s=(0,a.resolve)(d,e,i);S.add(async()=>{await(0,n.move)(t,s,{overwrite:!0}),v()});const o=s.slice(0,-3);["m4a","aac","ogg"].forEach(c=>S.add(async()=>{await(0,n.remove)(o+c),v()}))},()=>{})}),p();break;case"all_recnv":(0,n.existsSync)(u)&&(r=(0,n.readJsonSync)(u,{encoding:"utf8"}),r.sum.baseSize=r.sum.optSize=0);for(const e of Object.values(r.hSize)){const t="."+e.ext;_.test(t)&&b((0,a.resolve)(d,e.fld_nm+t),(0,a.resolve)(m,e.fld_nm+t),"no_move")}p();break;case"minimum_of_all":(0,n.existsSync)(u)&&(r=(0,n.readJsonSync)(u,{encoding:"utf8"})),l(m,()=>{},e=>{const t=(0,a.resolve)(m,e);(0,n.ensureDir)(t);const i=(0,a.resolve)(d,e);l(t,(s,o)=>{if(!_.test(s))return;const c=(0,a.resolve)(i,o.replace(_,j));if((0,n.existsSync)(c)){const f=(0,n.statSync)(s).mtimeMs,z=(0,n.statSync)(c).mtimeMs;if(f<z)return}const g=(0,a.parse)(c).name;if(g in r.hSize){const{baseSize:f=0,optSize:z=0}=r.hSize[g];r.sum.baseSize-=f,r.sum.optSize-=z}b(c,s,"no_move")},()=>{})}),p();break;case"all":(0,n.ensureDir)(m),l(d,()=>{},e=>{const t=(0,a.resolve)(m,e);(0,n.ensureDir)(t),l((0,a.resolve)(d,e),(i,s)=>{if(_.test(s)){b(i,(0,a.resolve)(t,s));return}},()=>{})}),p();break;default:{(0,n.existsSync)(u)&&(r=(0,n.readJsonSync)(u,{encoding:"utf8"}));const{dir:e,name:t,ext:i}=(0,a.parse)(w),s={...r.hSize[t],fld_nm:(0,a.basename)(e)+"/"+t,ext:i.slice(1)};r.sum.baseSize-=s.baseSize,r.sum.optSize-=s.optSize,b(w,d,m),p()}break}
