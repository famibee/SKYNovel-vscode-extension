"use strict";var _=require("child_process"),n=require("fs-extra"),y=require("os"),g=require("path");const[,,...O]=process.argv,u=O.includes("--minify"),l=process.platform==="win32",c={},T=(e=-1)=>{(0,n.writeJsonSync)(__filename+"on",c,{encoding:"utf8"}),e>-1&&process.exit(e)},w=u?async(e,t,s)=>{try{const i=__filename.slice(0,-3)+"_"+t+".txt";await(0,n.writeFile)(i,s,{encoding:"utf8"}),s=s.replaceAll('"','\\"'),await new Promise((o,d)=>(0,_.exec)(`pyftsubset "${e.inp}" --text-file="${i}" --layout-features='*' --flavor=woff2 --output-file="${e.out}" --verbose`,async(f,b,a)=>{if(f){const p=`${t} \u51FA\u529B\u30A8\u30E9\u30FC\uFF1A`+f.message.replace(/--text-file=[^\n]+/,"...");console.error(p),e.err+=p+`
`,d();return}await(0,n.writeFile)(i,a,{encoding:"utf8"}),a.includes("Missing glyphs for requested Unicodes:")&&(e.err+=`${t} \u51FA\u529B\u8B66\u544A\uFF1A\u30D5\u30A9\u30F3\u30C8\u30D5\u30A1\u30A4\u30EB\u306B\u542B\u307E\u308C\u306A\u3044\u6587\u5B57\u304C\u3042\u308A\u307E\u3057\u305F\u3002\u30ED\u30B0\u3092\u78BA\u8A8D\uFF08Missing glyphs ...\uFF09\u3057\u3066\u4E0B\u3055\u3044\u3002
`),o()}))}catch(i){i instanceof Error?e.err+=i.message.replace(/--text-file=[^\n]+/,"...")+`
`:e.err+=`err pyftsubset "${e.inp}"`}}:e=>(0,n.copy)(e.inp,e.out),r=require("./font.json"),m=[],{username:S}=(0,y.userInfo)(),$="core/font",F=l?`C:/Users/${S}/AppData/Local/Microsoft/Windows/Fonts`:`/Users/${S}/Library/Fonts`,P=l?"C:/Windows/Fonts":"/Library/Fonts";for(const[e,t]of Object.entries(r)){const s=String(t.inp).replace("::PATH_PRJ_FONTS::",$).replace("::PATH_USER_FONTS::",F).replace("::PATH_OS_FONTS::",P),i=`doc/prj/script/${e}${u?".woff2":(0,g.extname)(s)}`,o=c[e]={inp:s,out:i,iSize:1,oSize:1,err:""};if(!(0,n.existsSync)(s)){o.err=`\u5909\u63DB\u5931\u6557\u3067\u3059\u3002\u5165\u529B\u30D5\u30A1\u30A4\u30EB ${r[e].inp.slice(20)} \u304C\u5B58\u5728\u3059\u308B\u304B\u78BA\u8A8D\u3057\u3066\u304F\u3060\u3055\u3044`;continue}m.push(w(o,e,r[e].txt))}Promise.allSettled(m).then(()=>{for(const[e,t]of Object.entries(c)){const{inp:s,out:i}=t;if(t.inp=r[e].inp,!(0,n.existsSync)(i)){t.err+=`\u5909\u63DB\u5931\u6557\u3067\u3059\u3002\u51FA\u529B\u30D5\u30A1\u30A4\u30EB ${t.out} \u304C\u5B58\u5728\u3057\u307E\u305B\u3093`;continue}t.iSize=(0,n.statSync)(s).size,t.oSize=(0,n.statSync)(i).size}T(0)});
