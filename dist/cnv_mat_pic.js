var i=require("path"),t=require("fs-extra");const[,,g,R,p,u=""]=process.argv,$=require("sharp"),F=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function m(e,s,o){for(const r of(0,t.readdirSync)(e,{withFileTypes:!0})){const n=String(r.name).normalize("NFC");if(F.test(n))continue;if(r.isDirectory()){o(n);continue}const l=(0,i.resolve)(e,n);s(l,n)}}function S(e,s,o,r=e){try{if(!(0,t.existsSync)(e)){console.error(`replaceFile no exists src:${e}`);return}const n=(0,t.readFileSync)(e,{encoding:"utf8"}),l=String(n.replace(s,o));n!==l&&(0,t.writeFileSync)(r,l)}catch(n){console.error(`replaceFile src:${e} ${n}`)}}const b=/\.(jpe?g|png)$/,E=/\.(htm|html)$/,d=/\w+\/\*WEBP\*\//g,v=/\.json$/,I=/("image"\s*:\s*")(.+)\.(jpe?g|png)"/,T=/webp","image_bkup":".+(jpe?g|png)"/,f=__filename+"on";let c={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const _=(e=-1)=>{(0,t.writeJsonSync)(f,c,{encoding:"utf8"}),e>-1&&process.exit(e)},a=[];function w(e,s,o=""){a.push(async()=>{o!=="no_move"&&await(0,t.move)(e,s,{overwrite:!0});const{dir:r,name:n,ext:l}=(0,i.parse)(e),{dir:x}=(0,i.parse)(s),h=x+"/"+n+".webp",P=c.hSize[n]??={fld_nm:(0,i.basename)(r)+"/"+n,baseSize:0,webpSize:0,ext:""},G=await $(s).webp({quality:Number(P.webp_q??R)}).toFile(h);await(0,t.move)(h,r+"/"+n+".webp",{overwrite:!0});const z=(0,t.statSync)(s).size,y=G.size;c.hSize[n]={...P,baseSize:z,webpSize:y,ext:l.slice(1)},c.sum.baseSize+=z,c.sum.webpSize+=y})}switch(g){case"restore":m(u,()=>{},e=>{m((0,i.resolve)(u,e),(s,o)=>{if(b.test(o)){const r=(0,i.resolve)(p,e,o);a.push(()=>(0,t.move)(s,r,{overwrite:!0}));const{name:n}=(0,i.parse)(o),l=(0,i.resolve)(p,e,n+".webp");a.push(()=>(0,t.remove)(l));return}},()=>{})}),m(p,()=>{},e=>{m((0,i.resolve)(p,e),(s,o)=>{if(E.test(o)){d.lastIndex=0,a.push(async()=>S(s,d,"false/*WEBP*/"));return}v.test(o)&&a.push(async()=>S(s,T,'$1"'))},()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>_(0));break;case"all_no_move":(0,t.existsSync)(f)&&(c=(0,t.readJsonSync)(f,{encoding:"utf8"}),c.sum.baseSize=c.sum.webpSize=0);for(const e of Object.values(c.hSize)){const s="."+e.ext;!b.test(s)||w((0,i.resolve)(p,e.fld_nm+s),(0,i.resolve)(u,e.fld_nm+s),"no_move")}Promise.allSettled(a.map(e=>e())).then(()=>_(0));break;case"all":(0,t.ensureDir)(u),m(p,()=>{},e=>{const s=(0,i.resolve)(u,e);(0,t.ensureDir)(s),m((0,i.resolve)(p,e),(o,r)=>{if(b.test(r)){w(o,(0,i.resolve)(s,r));return}E.test(r)&&a.push(async()=>S(o,d,"true/*WEBP*/")),v.test(r)&&a.push(async()=>S(o,I,'$1$2.webp","image_bkup":"$2.$3"'))},()=>{})}),Promise.allSettled(a.map(e=>e())).then(()=>_(0));break;default:{(0,t.existsSync)(f)&&(c=(0,t.readJsonSync)(f,{encoding:"utf8"}));const{dir:e,name:s,ext:o}=(0,i.parse)(g),r={...c.hSize[s],fld_nm:(0,i.basename)(e)+"/"+s,ext:o.slice(1)};c.sum.baseSize-=r.baseSize,c.sum.webpSize-=r.webpSize,w(g,p,u),Promise.allSettled(a.map(n=>n())).then(()=>_(0))}break}
