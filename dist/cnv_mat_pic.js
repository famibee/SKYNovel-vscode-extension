var j=Object.create;var F=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var L=(t,r,f,S)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of J(r))!W.call(t,e)&&e!==f&&F(t,e,{get:()=>r[e],enumerable:!(S=B(r,e))||S.enumerable});return t};var q=(t,r,f)=>(f=t!=null?j(M(t)):{},L(r||!t||!t.__esModule?F(f,"default",{value:t,enumerable:!0}):f,t));var i=require("path"),s=require("fs-extra"),N=q(require("p-queue"));const[,,O,C,b,p=""]=process.argv,D=require("sharp"),X=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function l(t,r,f){for(const S of(0,s.readdirSync)(t,{withFileTypes:!0})){const e=String(S.name).normalize("NFC");if(X.test(e))continue;if(S.isDirectory()){f(e);continue}const n=(0,i.resolve)(t,e);r(n,e)}}function g(t,r,f,S=!0,e=t){try{if(!(0,s.existsSync)(t)){console.error(`No change, No replace src:${t}`);return}const n=(0,s.readFileSync)(t,{encoding:"utf8"}),c=String(n.replace(r,f));n!==c?(0,s.writeFileSync)(e,c):S&&console.error(`replaceFile fail by same:${t}`)}catch(n){console.error(`replaceFile src:${t} ${n}`)}}const h=/\.(jpe?g|png)$/,$=/\.(htm|html)$/,P=/\w+\/\*WEBP\*\//g,v=/\.json$/,G=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,I='$1$2.webp","image_bkup":"$2.$3"',V=/webp","image_bkup":".+(jpe?g|png)"/,A='$1"',k=__filename+"on";let o={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const R=()=>{if(!(0,s.existsSync)(k))return;const t={...o};o=(0,s.readJsonSync)(k,{encoding:"utf8"}),t.sum={...o.sum};for(const r in o.hSize){const{fld_nm:f,ext:S,baseSize:e,webpSize:n}=o.hSize[r],c=f+"."+S;(0,s.existsSync)((0,i.resolve)(b,c))||(0,s.existsSync)((0,i.resolve)(p,c))?t.hSize[r]=o.hSize[r]:(t.sum.baseSize-=e,t.sum.webpSize-=n)}o=t},H=(t=-1)=>{const r=Object.entries(o.hSize);r.sort((f,S)=>{const e=f[0],n=S[0];return e<n?-1:e>n?1:0}),o.hSize=Object.fromEntries(r),(0,s.writeJsonSync)(k,o,{encoding:"utf8"}),t>-1&&process.exit(t)},u=new N.default({concurrency:50,autoStart:!1});let x=0;const E=async()=>{x=u.size,console.error(`fn:cnv_mat_pic.ts start: ${x} tasks`),u.start(),await u.onIdle(),H(0)};let z=()=>{const t=u.size;if(!(t%50>0)){if(t===0){z=()=>{};return}console.error(`fn:cnv_mat_pic.ts ${t}/${x} tasks`)}};function y(t,r,f=!0){u.add(async()=>{f&&await(0,s.move)(t,r,{overwrite:!0});const{dir:S,name:e}=(0,i.parse)(t),{dir:n,ext:c}=(0,i.parse)(r),a=n+"/"+e+".webp",m=o.hSize[e]??={fld_nm:(0,i.basename)(S)+"/"+e,baseSize:0,webpSize:0,ext:""},_=await D(r).webp({quality:Number(m.webp_q??C)}).toFile(a);await(0,s.move)(a,S+"/"+e+".webp",{overwrite:!0});const d=(0,s.statSync)(r).size,w=_.size;o.hSize[e]={...m,baseSize:d,webpSize:w,ext:c.slice(1)},o.sum.baseSize+=d,o.sum.webpSize+=w,z()})}switch(O){case"enable":(0,s.ensureDir)(p),l(b,()=>{},e=>{const n=(0,i.resolve)(p,e);(0,s.ensureDir)(n),l((0,i.resolve)(b,e),(c,a)=>{if(h.test(a)){y(c,(0,i.resolve)(n,a));return}if($.test(a)){u.add(()=>{g(c,P,"true/*WEBP*/",!1),z()});return}v.test(a)&&u.add(()=>{g(c,G,I),z()})},()=>{})}),E();break;case"disable":l(p,()=>{},e=>{l((0,i.resolve)(p,e),(n,c)=>{if(!h.test(c))return;const a=(0,i.resolve)(b,e,c);u.add(async()=>{await(0,s.move)(n,a,{overwrite:!0}),z()});const{name:m}=(0,i.parse)(c),_=(0,i.resolve)(b,e,m+".webp");u.add(async()=>{await(0,s.remove)(_),z()})},()=>{})}),l(b,()=>{},e=>{l((0,i.resolve)(b,e),(n,c)=>{if($.test(c)){P.lastIndex=0,u.add(()=>{g(n,P,"false/*WEBP*/",!1),z()});return}v.test(c)&&u.add(()=>{g(n,V,A),z()})},()=>{})}),E();break;case"reconv":R(),o.sum.baseSize=o.sum.webpSize=0;for(const{ext:e,fld_nm:n}of Object.values(o.hSize))y((0,i.resolve)(b,n+"."+e),(0,i.resolve)(p,n+"."+e),!1);E();break;case"prj_scan":R(),(0,s.ensureDir)(p),l(b,()=>{},e=>{const n=(0,i.resolve)(p,e);(0,s.ensureDir)(n),l((0,i.resolve)(b,e),(c,a)=>{if(h.test(a)){const m=(0,i.parse)(a).name;if(m in o.hSize){const{baseSize:_=0,webpSize:d=0}=o.hSize[m];o.sum.baseSize-=_,o.sum.webpSize-=d}y(c,(0,i.resolve)(n,a));return}if($.test(a)){u.add(()=>{g(c,P,"true/*WEBP*/",!1),z()});return}v.test(a)&&u.add(()=>{g(c,G,I),z()})},()=>{})}),E();break;case"base_scan":R(),l(p,()=>{},e=>{const n=(0,i.resolve)(p,e);(0,s.ensureDir)(n);const c=(0,i.resolve)(b,e);l(n,(a,m)=>{if(!h.test(a))return;const _=(0,i.resolve)(c,m.replace(h,".webp"));if((0,s.existsSync)(_)){const w=(0,s.statSync)(a).mtimeMs,T=(0,s.statSync)(_).mtimeMs;if(w<T)return}const d=(0,i.parse)(m).name;if(d in o.hSize){const{baseSize:w=0,webpSize:T=0}=o.hSize[d];o.sum.baseSize-=w,o.sum.webpSize-=T}y(_,a,!1)},()=>{})}),E();break;default:R();const{dir:t,name:r,ext:f}=(0,i.parse)(O),S={...o.hSize[r],fld_nm:(0,i.basename)(t)+"/"+r,ext:f.slice(1)};o.sum.baseSize-=S.baseSize,o.sum.webpSize-=S.webpSize,y(O,b,!!p),E();break}
