var F=Object.create;var $=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var C=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of G(t))!I.call(e,o)&&o!==s&&$(e,o,{get:()=>t[o],enumerable:!(i=k(t,o))||i.enumerable});return e};var B=(e,t,s)=>(s=e!=null?F(j(e)):{},C(t||!e||!e.__esModule?$(s,"default",{value:e,enumerable:!0}):s,e));var r=require("path"),n=require("fs-extra"),T=B(require("p-queue"));const[,,P,J,u,m=""]=process.argv,M=require("sharp"),W=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function l(e,t,s){for(const i of(0,n.readdirSync)(e,{withFileTypes:!0})){const o=String(i.name).normalize("NFC");if(W.test(o))continue;if(i.isDirectory()){s(o);continue}const a=(0,r.resolve)(e,o);t(a,o)}}function z(e,t,s,i=!0,o=e){try{if(!(0,n.existsSync)(e)){console.error(`No change, No replace src:${e}`);return}const a=(0,n.readFileSync)(e,{encoding:"utf8"}),S=String(a.replace(t,s));a!==S?(0,n.writeFileSync)(o,S):i&&console.error(`replaceFile fail by same:${e}`)}catch(a){console.error(`replaceFile src:${e} ${a}`)}}const g=/\.(jpe?g|png)$/,N=/\.(htm|html)$/,y=/\w+\/\*WEBP\*\//g,O=/\.json$/,L=/("image"\s*:\s*")([^.]+(?:\.\d+x\d+)?).*\.(jpe?g|png)"/,q='$1$2.webp","image_bkup":"$2.$3"',V=/webp","image_bkup":".+(jpe?g|png)"/,D='$1"',p=__filename+"on";let c={sum:{baseSize:0,webpSize:0,pathImgCmpWebP:"",pathImgCmpBase:""},hSize:{}};const A=(e=-1)=>{const t=Object.entries(c.hSize);t.sort((s,i)=>{const o=s[0],a=i[0];return o<a?-1:o>a?1:0}),c.hSize=Object.fromEntries(t),(0,n.writeJsonSync)(p,c,{encoding:"utf8"}),e>-1&&process.exit(e)},f=new T.default({concurrency:50,autoStart:!1});let v=0;const w=async()=>{v=f.size,console.error(`fn:cnv_mat_pic.ts start: ${v} tasks`),f.start(),await f.onIdle(),A(0)};let _=()=>{const e=f.size;if(!(e%50>0)){if(e===0){_=()=>{};return}console.error(`fn:cnv_mat_pic.ts ${e}/${v} tasks`)}};function E(e,t,s=""){f.add(async()=>{s!=="no_move"&&await(0,n.move)(e,t,{overwrite:!0});const{dir:i,name:o,ext:a}=(0,r.parse)(e),{dir:S}=(0,r.parse)(t),b=S+"/"+o+".webp",d=c.hSize[o]??={fld_nm:(0,r.basename)(i)+"/"+o,baseSize:0,webpSize:0,ext:""},x=await M(t).webp({quality:Number(d.webp_q??J)}).toFile(b);await(0,n.move)(b,i+"/"+o+".webp",{overwrite:!0});const h=(0,n.statSync)(t).size,R=x.size;c.hSize[o]={...d,baseSize:h,webpSize:R,ext:a.slice(1)},c.sum.baseSize+=h,c.sum.webpSize+=R,_()})}switch(P){case"restore":l(m,()=>{},e=>{l((0,r.resolve)(m,e),(t,s)=>{if(!g.test(s))return;const i=(0,r.resolve)(u,e,s);f.add(async()=>{await(0,n.move)(t,i,{overwrite:!0}),_()});const{name:o}=(0,r.parse)(s),a=(0,r.resolve)(u,e,o+".webp");f.add(async()=>{await(0,n.remove)(a),_()})},()=>{})}),l(u,()=>{},e=>{l((0,r.resolve)(u,e),(t,s)=>{if(N.test(s)){y.lastIndex=0,f.add(()=>{z(t,y,"false/*WEBP*/",!1),_()});return}O.test(s)&&f.add(()=>{z(t,V,D),_()})},()=>{})}),w();break;case"all_recnv":(0,n.existsSync)(p)&&(c=(0,n.readJsonSync)(p,{encoding:"utf8"}),c.sum.baseSize=c.sum.webpSize=0);for(const e of Object.values(c.hSize)){const t="."+e.ext;g.test(t)&&E((0,r.resolve)(u,e.fld_nm+t),(0,r.resolve)(m,e.fld_nm+t),"no_move")}w();break;case"minimum_of_all":(0,n.existsSync)(p)&&(c=(0,n.readJsonSync)(p,{encoding:"utf8"})),l(m,()=>{},e=>{const t=(0,r.resolve)(m,e);(0,n.ensureDir)(t);const s=(0,r.resolve)(u,e);l(t,(i,o)=>{if(!g.test(i))return;const a=(0,r.resolve)(s,o.replace(g,".webp"));if((0,n.existsSync)(a)){const b=(0,n.statSync)(i).mtimeMs,d=(0,n.statSync)(a).mtimeMs;if(b<d)return}const S=(0,r.parse)(a).name;if(S in c.hSize){const{baseSize:b=0,webpSize:d=0}=c.hSize[S];c.sum.baseSize-=b,c.sum.webpSize-=d}E(a,i,"no_move")},()=>{})}),w();break;case"all":(0,n.ensureDir)(m),l(u,()=>{},e=>{const t=(0,r.resolve)(m,e);(0,n.ensureDir)(t),l((0,r.resolve)(u,e),(s,i)=>{if(g.test(i)){E(s,(0,r.resolve)(t,i));return}if(N.test(i)){f.add(()=>{z(s,y,"true/*WEBP*/",!1),_()});return}O.test(i)&&f.add(()=>{z(s,L,q),_()})},()=>{})}),w();break;default:{(0,n.existsSync)(p)&&(c=(0,n.readJsonSync)(p,{encoding:"utf8"}));const{dir:e,name:t,ext:s}=(0,r.parse)(P),i={...c.hSize[t],fld_nm:(0,r.basename)(e)+"/"+t,ext:s.slice(1)};c.sum.baseSize-=i.baseSize,c.sum.webpSize-=i.webpSize,E(P,u,m),w()}break}
