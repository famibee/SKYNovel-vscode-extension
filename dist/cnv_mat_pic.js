var r=require("path"),e=require("fs-extra");const[,,f,d,b,S=""]=process.argv,v=require("sharp"),N=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function l(n,c,p){(0,e.readdirSync)(n,{withFileTypes:!0}).forEach(s=>{const t=String(s.name).normalize("NFC");if(N.test(t))return;if(s.isDirectory()){p(t);return}const i=(0,r.resolve)(n,t);c(i,t)})}function m(n,c,p,s=n){try{if(!(0,e.existsSync)(n)){console.error(`replaceFile no exists src:${n}`);return}const t=(0,e.readFileSync)(n,{encoding:"utf8"}),i=String(t.replace(c,p));t!==i&&(0,e.writeFileSync)(s,i)}catch(t){console.error(`replaceFile src:${n} ${t}`)}}const R=/\.(jpe?g|png)$/,$=/\.webp$/,y=/\.(htm|html)$/,_=/\w+\/\*WEBP\*\//g,E=/\.json$/,F=/("image"\s*:\s*")(.+)\.(jpe?g|png)"/,G=/webp","image_bkup":".+(jpe?g|png)"/;let u={sum:{baseSize:0,webpSize:0},hSize:{}};const h=(n=-1)=>{(0,e.writeJsonSync)(__filename+"on",u,{encoding:"utf8"}),n>-1&&process.exit(n)},a=[];function P(n,c,p=""){a.push(async()=>{p!=="no_move"&&await(0,e.move)(n,c,{overwrite:!0});const{dir:s,name:t}=(0,r.parse)(n),{dir:i}=(0,r.parse)(c),o=i+"/"+t+".webp",g=await v(c).webp({quality:Number(d)}).toFile(o);await(0,e.move)(o,s+"/"+t+".webp",{overwrite:!0});const w=(0,e.statSync)(c).size,z=g.size;u.hSize[t]={baseSize:w,webpSize:z},u.sum.baseSize+=w,u.sum.webpSize+=z})}switch(f){case"restore":l(b,()=>{},s=>{l((0,r.resolve)(b,s),(t,i)=>{if($.test(i)){const o=(0,r.resolve)(S,s,i).slice(0,-4);["jpg","jpeg","png"].forEach(g=>{(0,e.existsSync)(o+g)&&a.push(()=>(0,e.remove)(t))});return}y.test(i)&&(_.lastIndex=0,a.push(async()=>m(t,_,"false/*WEBP*/"))),E.test(i)&&a.push(async()=>m(t,G,'$1"'))},()=>{})}),l(S,()=>{},s=>{const t=(0,r.resolve)(b,s);l((0,r.resolve)(S,s),(i,o)=>{a.push(()=>(0,e.move)(i,(0,r.resolve)(t,o),{overwrite:!0}))},()=>{})}),Promise.allSettled(a.map(s=>s())).then(()=>(0,e.removeSync)(S)).then(()=>h(0));break;case"all":(0,e.ensureDir)(S),l(b,()=>{},s=>{const t=(0,r.resolve)(S,s);(0,e.ensureDir)(t),l((0,r.resolve)(b,s),(i,o)=>{if(R.test(o)){P(i,(0,r.resolve)(t,o));return}y.test(o)&&a.push(async()=>m(i,_,"true/*WEBP*/")),E.test(o)&&a.push(async()=>m(i,F,'$1$2.webp","image_bkup":"$2.$3"'))},()=>{})}),Promise.allSettled(a.map(s=>s())).then(()=>h(0));break;default:const n=__filename+"on";(0,e.existsSync)(n)&&(u=(0,e.readJsonSync)(n,{encoding:"utf8"}));const{name:c}=(0,r.parse)(f),p=u.hSize[c]??{baseSize:0,webpSize:0};u.sum.baseSize-=p.baseSize,u.sum.webpSize-=p.webpSize,P(f,b,S),Promise.allSettled(a.map(s=>s())).then(()=>h(0));break}
