var o=require("vscode-languageserver/node"),x=require("vscode-languageserver-textdocument");const n=(0,o.createConnection)(o.ProposedFeatures.all);console.log=n.console.log.bind(n.console),console.error=n.console.error.bind(n.console),process.on("unhandledRejection",e=>{n.console.error(`Unhandled exception ${e}`)});const s=new o.TextDocuments(x.TextDocument);let m=!1,p=!1,d=!1;n.onInitialize(e=>{const t=e.capabilities;m=!!(t.workspace&&!!t.workspace.configuration),p=!!(t.workspace&&!!t.workspace.workspaceFolders),d=!!(t.textDocument&&t.textDocument.publishDiagnostics&&t.textDocument.publishDiagnostics.relatedInformation);const i={capabilities:{textDocumentSync:o.TextDocumentSyncKind.Incremental,completionProvider:{resolveProvider:!0,triggerCharacters:["["," ","="]}}};return p&&(i.capabilities.workspace={workspaceFolders:{supported:!0}}),i}),n.onInitialized(()=>{m&&n.client.register(o.DidChangeConfigurationNotification.type,void 0),p&&n.workspace.onDidChangeWorkspaceFolders(e=>{console.log("Workspace folder change event received.")}),T()});const f={maxNumberOfProblems:1e3};let C=f;const g=new Map;n.onDidChangeConfiguration(e=>{m?g.clear():C=e.settings.SKYNovelLangSrv||f,s.all().forEach(h)});function b(e){if(!m)return Promise.resolve(C);let t=g.get(e);return t||(t=n.workspace.getConfiguration({scopeUri:e,section:"SKYNovelLangSrv"}),g.set(e,t)),t}s.onDidClose(e=>g.delete(e.document.uri)),s.onDidChangeContent(e=>h(e.document));async function h(e){const t=await b(e.uri),i=e.getText(),a=/\b[A-Z]{2,}\b/g;let r,c=0;const u=[];for(;(r=a.exec(i))&&c<t.maxNumberOfProblems;){c++;const l={severity:o.DiagnosticSeverity.Warning,range:{start:e.positionAt(r.index),end:e.positionAt(r.index+r[0].length)},message:`${r[0]} is all uppercase.`,source:"ex"};d&&(l.relatedInformation=[{location:{uri:e.uri,range:{...l.range}},message:"Spelling matters"},{location:{uri:e.uri,range:{...l.range}},message:"Particularly for names"}]),u.push(l)}n.sendDiagnostics({uri:e.uri,diagnostics:u})}n.onDidChangeWatchedFiles(e=>{console.log("onDidChangeWatchedFiles !"),e.changes.forEach(t=>console.log(`  type:${t.type} uri:${t.uri.slice(-32)}`))});function T(){const e=require("../dist/md.json"),t={title:"\u300C\u30B9\u30AF\u30EA\u30D7\u30C8\u518D\u635C\u67FB\u300D\u300C\u5F15\u6570\u306E\u8AAC\u660E\u300D",command:"extension.skynovel.scanScr_trgParamHints"};for(const i in e){const a=e[i],r=a.comment?{kind:"markdown",value:`$(book)[\u30BF\u30B0\u30EA\u30D5\u30A1\u30EC\u30F3\u30B9](https://famibee.github.io/SKYNovel/tag.html#${i})

---
${a.comment}`}:"";a.snippet.forEach(c=>D.push({label:c.nm,kind:o.CompletionItemKind.Snippet,detail:a.detail,command:t,documentation:r}))}S=D}let D=[],S=[];n.onCompletion(e=>{const t=s.get(e.textDocument.uri);if(!t)return[];const i=e.position,a=t.getText({start:{line:i.line,character:i.character-1},end:i});return console.log(`fn:lsp.ts line:274 trgChr:${a}:`),a==="["?S:[]}),n.onCompletionResolve(e=>(e.data===1?(e.detail="TypeScript details",e.documentation="TypeScript documentation"):e.data===2&&(e.detail="JavaScript details",e.documentation="JavaScript documentation"),e)),s.listen(n),n.listen();
